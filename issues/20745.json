{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20745",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20745/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20745/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20745/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/20745",
  "id": 1025411000,
  "node_id": "I_kwDOCFbutM49Hoe4",
  "number": 20745,
  "title": "Lambda @startup behaviour changed since quarkus version 2.3.0?",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1326073020,
      "node_id": "MDU6TGFiZWwxMzI2MDczMDIw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/amazon-lambda",
      "name": "area/amazon-lambda",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/155",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/155",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/155/labels",
    "id": 7262270,
    "node_id": "MI_kwDOCFbutM4AbtA-",
    "number": 155,
    "title": "2.3.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 82,
    "state": "closed",
    "created_at": "2021-10-18T08:24:48Z",
    "updated_at": "2021-12-07T21:29:09Z",
    "due_on": null,
    "closed_at": "2021-10-20T13:14:36Z"
  },
  "comments": 2,
  "created_at": "2021-10-13T15:41:46Z",
  "updated_at": "2021-10-18T09:36:36Z",
  "closed_at": "2021-10-13T20:45:40Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nWe have some regression when using quarkus 2.3.0 instead of 2.2.3 using the quarkus-amazon-lambda component.\r\n\r\nWe noticed that on Startup of \"SSLSettingsConfigurator\" in quarkus 2.2.3 works correctly. The trust and keystore are loaded directly before our lambda is serving any request.\r\n\r\nWe noticed that on Startup of \"SSLSettingsConfigurator\" in quarkus 2.3.0 is not working correctly The trust is loaded then   our lambda is serving a request and then the keystore is loaded. \r\n\r\n_```\r\n@Priority(1)\r\n@Startup\r\n@Singleton\r\npublic class SSLSettingsConfigurator {\r\n\r\n\r\n     @PostConstruct\r\n       void init()  {\r\n\r\n     }\r\n \r\n}\r\n```_\r\n\r\nThe keystore and trust store are loaded in the @Postconstruct. To be complete... before loading the keystore we retrieve a a secret from the AWS SSM store.\r\n\r\n\r\nWas there any change in the @Startup since 2.3.0?\r\n\r\n\r\n\n\n### Expected behavior\n\nSame behaviour are in quarkus 2.2.3\n\n### Actual behavior\n\nIn our case the keystore is loaded far too late.\n\n### How to Reproduce?\n\nThis is our code in the @postconstruct:\r\n\r\n\r\n\r\n```\r\n\r\n....\r\n\r\nprivate static final String SSLCONTEXT_ALGORITHM = \"TLSv1.3\"; \r\n  private static final String TRUSTSTORE_TYPE = \"JKS\";  \r\n\r\n@PostConstruct\r\n  void init() throws NoSuchAlgorithmException, CertificateException, KeyStoreException, IOException, UnrecoverableKeyException, KeyManagementException {\r\n        \r\n             \r\n      var trustStore = load(.....);\r\n      var tmfactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\r\n      tmfactory.init(trustStore);     \r\n      trustManagers = tmfactory.getTrustManagers();\r\n \r\n    }    \r\n    \r\n      \r\n      var keyStore = load(..........);   \r\n      var kmfactory = KeyManagerFactory.getInstance( KeyManagerFactory.getDefaultAlgorithm());\r\n      kmfactory.init(keyStore, \"\".toCharArray());\r\n      keyManagers = kmfactory.getKeyManagers();\r\n\r\n    }\r\n      \r\n    var sslContext = SSLContext.getInstance(SSLCONTEXT_ALGORITHM); \r\n       \r\n    sslContext.init(keyManagers,trustManagers, new java.security.SecureRandom());  \r\n    \r\n    SSLContext.setDefault(sslContext); \r\n\r\n    HttpsURLConnection.setDefaultSSLSocketFactory(sslContext.getSocketFactory());\r\n      \r\n  }\r\n\r\n private KeyStore load(String storePath,String password,String storeType) throws NoSuchAlgorithmException, CertificateException, IOException, KeyStoreException {\r\n   var keystore = KeyStore.getInstance(storeType);    \r\n   \r\n   var url = SSLSettingsConfigurator.class.getResource(storePath);\r\n   Objects.requireNonNull(url,String.format(STORE_NOT_FOUND, storePath));\r\n  \r\n   keystore.load(url.openStream(), password.toCharArray());\r\n   return keystore;\r\n }\r\n```\n\n### Output of `uname -a` or `ver`\n\n->AWS native graalvm\n\n### Output of `java -version`\n\n->AWS native graalvm\n\n### GraalVM version (if different from Java)\n\n21.2.0\n\n### Quarkus version or git rev\n\n2.3.0\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.3 (ff8e977a158738155dc465c6a97ffaf31982d739)\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20745/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20745/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
