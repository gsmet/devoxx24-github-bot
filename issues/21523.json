{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21523",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21523/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21523/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21523/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/21523",
  "id": 1056465040,
  "node_id": "I_kwDOCFbutM4--GCQ",
  "number": 21523,
  "title": "amazon-lambda fails when paired with oidc-client in dev mode",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 985346625,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjU=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/invalid",
      "name": "triage/invalid",
      "color": "e4e669",
      "default": false,
      "description": "This doesn't seem right"
    },
    {
      "id": 1287515315,
      "node_id": "MDU6TGFiZWwxMjg3NTE1MzE1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kotlin",
      "name": "area/kotlin",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1326073020,
      "node_id": "MDU6TGFiZWwxMzI2MDczMDIw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/amazon-lambda",
      "name": "area/amazon-lambda",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1479557456,
      "node_id": "MDU6TGFiZWwxNDc5NTU3NDU2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/oidc",
      "name": "area/oidc",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 8,
  "created_at": "2021-11-17T18:33:12Z",
  "updated_at": "2021-11-19T14:47:25Z",
  "closed_at": "2021-11-19T14:45:33Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI'm attempting to call an api from an Amazon Lambda. The api is authenticated by OIDC, so with help from @sberyozkin [in zulip](https://quarkusio.zulipchat.com/#narrow/stream/187030-users/topic/.E2.9C.94.20OAuth.202.20authorization.20for.20RestClient), I got OIDC working through a regular jaxrs Resource. But when attempting to switch this out for a RequestHandler (or RequestStreamHandler, it didn't matter when I tested with the example repo provided below), it fails with this error message:\r\n\r\n```\r\n[INFO] Scanning for projects...\r\n[INFO] \r\n[INFO] ------------------< org.acme:rest-client-lambda-bug >-------------------\r\n[INFO] Building rest-client-lambda-bug 1.0.0-SNAPSHOT\r\n[INFO] --------------------------------[ jar ]---------------------------------\r\n[INFO] \r\n[INFO] --- maven-clean-plugin:2.5:clean (default-clean) @ rest-client-lambda-bug ---\r\n[INFO] Deleting /Users/tyler/Documents/dev/work/temp/rest-client-lambda-bug/target\r\n[INFO] \r\n[INFO] --- quarkus-maven-plugin:2.4.2.Final:dev (default-cli) @ rest-client-lambda-bug ---\r\n[INFO] Invoking io.quarkus.platform:quarkus-maven-plugin:2.4.2.Final:generate-code) @ rest-client-lambda-bug\r\n[INFO] Invoking org.apache.maven.plugins:maven-resources-plugin:2.6:resources) @ rest-client-lambda-bug\r\n[INFO] Using 'UTF-8' encoding to copy filtered resources.\r\n[INFO] Copying 2 resources\r\n[INFO] Invoking org.jetbrains.kotlin:kotlin-maven-plugin:1.5.31:compile) @ rest-client-lambda-bug\r\n[INFO] Applied plugin: 'all-open'\r\n[INFO] Invoking org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile) @ rest-client-lambda-bug\r\n[INFO] Changes detected - recompiling the module!\r\n[INFO] Invoking org.apache.maven.plugins:maven-resources-plugin:2.6:testResources) @ rest-client-lambda-bug\r\n[INFO] Using 'UTF-8' encoding to copy filtered resources.\r\n[INFO] skip non existing resourceDirectory /Users/tyler/Documents/dev/work/temp/rest-client-lambda-bug/src/test/resources\r\n[INFO] Invoking org.jetbrains.kotlin:kotlin-maven-plugin:1.5.31:test-compile) @ rest-client-lambda-bug\r\n[WARNING] No sources found skipping Kotlin compile\r\n[INFO] Invoking org.apache.maven.plugins:maven-compiler-plugin:3.8.1:testCompile) @ rest-client-lambda-bug\r\n[INFO] Changes detected - recompiling the module!\r\nListening for transport dt_socket at address: 5005\r\n2021-11-17 11:27:52,988 INFO  [io.qua.ama.lam.run.MockEventServer] (build-26) Mock Lambda Event Server Started\r\n__  ____  __  _____   ___  __ ____  ______ \r\n --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ \r\n -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\\ \\   \r\n--\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/   \r\n2021-11-17 11:27:54,059 INFO  [io.qua.ama.lam.run.AbstractLambdaPollLoop] (Lambda Thread (DEVELOPMENT)) Listening on: http://localhost:8080/_lambda_/2018-06-01/runtime/invocation/next\r\n\r\n2021-11-17 11:27:54,057 INFO  [io.quarkus] (Quarkus Main Thread) rest-client-lambda-bug 1.0.0-SNAPSHOT on JVM (powered by Quarkus 2.4.2.Final) started in 1.939s. Listening on: http://localhost:8080\r\n2021-11-17 11:27:54,061 INFO  [io.quarkus] (Quarkus Main Thread) Profile dev activated. Live Coding activated.\r\n2021-11-17 11:27:54,061 INFO  [io.quarkus] (Quarkus Main Thread) Installed features: [amazon-lambda, cdi, kotlin, oidc-client, oidc-client-filter, rest-client, rest-client-jackson, smallrye-context-propagation, vertx]\r\n2021-11-17 11:28:22,036 ERROR [io.qua.ama.lam.run.AbstractLambdaPollLoop] (Lambda Thread (DEVELOPMENT)) Error running lambda (DEVELOPMENT): java.net.NoRouteToHostException: Can't assign requested address (Address not available)\r\n        at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n        at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n        at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1974)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1969)\r\n        at java.base/java.security.AccessController.doPrivileged(Native Method)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1968)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1536)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1520)\r\n        at java.base/java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:527)\r\n        at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:83)\r\n        at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: java.net.NoRouteToHostException: Can't assign requested address (Address not available)\r\n        at java.base/java.net.PlainSocketImpl.socketConnect(Native Method)\r\n        at java.base/java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:399)\r\n        at java.base/java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:242)\r\n        at java.base/java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:224)\r\n        at java.base/java.net.Socket.connect(Socket.java:609)\r\n        at java.base/java.net.Socket.connect(Socket.java:558)\r\n        at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:182)\r\n        at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:474)\r\n        at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:569)\r\n        at java.base/sun.net.www.http.HttpClient.<init>(HttpClient.java:242)\r\n        at java.base/sun.net.www.http.HttpClient.New(HttpClient.java:341)\r\n        at java.base/sun.net.www.http.HttpClient.New(HttpClient.java:362)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:1253)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1187)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1081)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:1015)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1592)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1520)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:3099)\r\n        at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:82)\r\n        ... 1 more\r\n\r\n\r\n2021-11-17 11:28:22,122 ERROR [io.qua.run.StartupContext] (Lambda Thread (DEVELOPMENT)) Running a shutdown task failed: java.lang.IllegalStateException: Unable to unregister all message consumer methods\r\n        at io.quarkus.vertx.runtime.VertxRecorder.unregisterMessageConsumers(VertxRecorder.java:181)\r\n        at io.quarkus.vertx.runtime.VertxRecorder$1.run(VertxRecorder.java:51)\r\n        at io.quarkus.runtime.StartupContext.runAllInReverseOrder(StartupContext.java:83)\r\n        at io.quarkus.runtime.StartupContext.close(StartupContext.java:72)\r\n        at io.quarkus.runner.ApplicationImpl.doStop(ApplicationImpl.zig:858)\r\n        at io.quarkus.runtime.Application.stop(Application.java:203)\r\n        at io.quarkus.runtime.Application.stop(Application.java:155)\r\n        at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:144)\r\n        at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: java.lang.InterruptedException\r\n        at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1343)\r\n        at java.base/java.util.concurrent.CountDownLatch.await(CountDownLatch.java:232)\r\n        at io.quarkus.vertx.runtime.VertxRecorder.unregisterMessageConsumers(VertxRecorder.java:178)\r\n        ... 8 more\r\n\r\n\r\n2021-11-17 11:28:22,146 INFO  [io.quarkus] (Lambda Thread (DEVELOPMENT)) rest-client-lambda-bug stopped in 0.044s\r\n2021-11-17 11:28:22,149 INFO  [io.qua.ama.lam.run.AbstractLambdaPollLoop] (Lambda Thread (DEVELOPMENT)) Lambda polling thread complete (DEVELOPMENT)\r\n\r\n--\r\n```\r\n\r\n[reproducer repo](https://github.com/snowe2010/quarkus-oidc-lambda-bug)\r\n\r\n\r\n@patriot1burke, @sberyozkin asked me to tag you.\r\n\r\n### Expected behavior\r\n\r\nI expect the lambda handler to make the exact same call as the Resource (it should fail with not-found, since the oidc client isn't configured. if the oidc client is configured it should actually make the call and succeed). \r\n\r\n### Actual behavior\r\n\r\nActual behavior is that it throws a very strange error indicating that it can't find some route (what route? I don't know, it fails when the oidc client route is provided as well as when it's not provided)\r\n\r\n```\r\n\r\n2021-11-17 11:28:22,036 ERROR [io.qua.ama.lam.run.AbstractLambdaPollLoop] (Lambda Thread (DEVELOPMENT)) Error running lambda (DEVELOPMENT): java.net.NoRouteToHostException: Can't assign requested address (Address not available)\r\n        at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n        at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n        at java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1974)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection$10.run(HttpURLConnection.java:1969)\r\n        at java.base/java.security.AccessController.doPrivileged(Native Method)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getChainedException(HttpURLConnection.java:1968)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1536)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1520)\r\n        at java.base/java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:527)\r\n        at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:83)\r\n        at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: java.net.NoRouteToHostException: Can't assign requested address (Address not available)\r\n        at java.base/java.net.PlainSocketImpl.socketConnect(Native Method)\r\n        at java.base/java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:399)\r\n        at java.base/java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:242)\r\n        at java.base/java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:224)\r\n        at java.base/java.net.Socket.connect(Socket.java:609)\r\n        at java.base/java.net.Socket.connect(Socket.java:558)\r\n        at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:182)\r\n        at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:474)\r\n        at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:569)\r\n        at java.base/sun.net.www.http.HttpClient.<init>(HttpClient.java:242)\r\n        at java.base/sun.net.www.http.HttpClient.New(HttpClient.java:341)\r\n        at java.base/sun.net.www.http.HttpClient.New(HttpClient.java:362)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getNewHttpClient(HttpURLConnection.java:1253)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1187)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1081)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.connect(HttpURLConnection.java:1015)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1592)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1520)\r\n        at java.base/sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:3099)\r\n        at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:82)\r\n        ... 1 more\r\n\r\n\r\n2021-11-17 11:28:22,122 ERROR [io.qua.run.StartupContext] (Lambda Thread (DEVELOPMENT)) Running a shutdown task failed: java.lang.IllegalStateException: Unable to unregister all message consumer methods\r\n        at io.quarkus.vertx.runtime.VertxRecorder.unregisterMessageConsumers(VertxRecorder.java:181)\r\n        at io.quarkus.vertx.runtime.VertxRecorder$1.run(VertxRecorder.java:51)\r\n        at io.quarkus.runtime.StartupContext.runAllInReverseOrder(StartupContext.java:83)\r\n        at io.quarkus.runtime.StartupContext.close(StartupContext.java:72)\r\n        at io.quarkus.runner.ApplicationImpl.doStop(ApplicationImpl.zig:858)\r\n        at io.quarkus.runtime.Application.stop(Application.java:203)\r\n        at io.quarkus.runtime.Application.stop(Application.java:155)\r\n        at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:144)\r\n        at java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: java.lang.InterruptedException\r\n        at java.base/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1343)\r\n        at java.base/java.util.concurrent.CountDownLatch.await(CountDownLatch.java:232)\r\n        at io.quarkus.vertx.runtime.VertxRecorder.unregisterMessageConsumers(VertxRecorder.java:178)\r\n        ... 8 more\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nFrom the readme of the [reproducer repo](https://github.com/snowe2010/quarkus-oidc-lambda-bug):\r\n\r\nDemonstrating the bug:\r\n\r\nSteps:\r\n* run with `mvn clean quarkus:dev`\r\n* just wait. The error message will show up after a few seconds. You don't need to do anything. \r\n* comment out the lambda handler, the imports for the lambda handler, and the amazon-lambda dependency in the pom\r\n* uncomment the Resource\r\n* run the command \r\n```bash\r\ncurl --header \"Content-Type: application/json\" \\\r\n        --data '{}' \\\r\n        http://localhost:8080/test\r\n```\r\nto see it 'succeed' (won't actually succeed since no oidc details are set up, but demonstrates the issue, no error is thrown on startup)\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nDarwin SR-MB-300245 21.1.0 Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:23 PDT 2021; root:xnu-8019.41.5~1/RELEASE_X86_64 x86_64\r\n\r\n### Output of `java -version`\r\n\r\ngraalvm-21.0.0+java11 (see .tool-versions file)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\ngraalvm-21.0.0+java11 (see .tool-versions file)\r\n\r\n### Quarkus version or git rev\r\n\r\n2.4.2.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nmvn 3.8.1 (see .tool-versions file)\r\n\r\n### Additional information\r\n\r\n[reproducer in zip form (in case I ever delete the example repo)](https://github.com/quarkusio/quarkus/files/7556953/rest-client-lambda-bug.zip)\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21523/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21523/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
