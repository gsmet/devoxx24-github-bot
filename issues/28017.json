{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/28017",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/28017/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/28017/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/28017/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/28017",
  "id": 1376107023,
  "node_id": "I_kwDOCFbutM5SBboP",
  "number": 28017,
  "title": "Regression: Programmatic OpenTelemetry spans get ignored",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2236031412,
      "node_id": "MDU6TGFiZWwyMjM2MDMxNDEy",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/tracing",
      "name": "area/tracing",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/206",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/206",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/206/labels",
    "id": 8420367,
    "node_id": "MI_kwDOCFbutM4AgHwP",
    "number": 206,
    "title": "2.14.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 224,
    "state": "closed",
    "created_at": "2022-09-14T06:18:10Z",
    "updated_at": "2023-05-15T13:54:56Z",
    "due_on": null,
    "closed_at": "2022-10-26T12:52:36Z"
  },
  "comments": 17,
  "created_at": "2022-09-16T15:29:02Z",
  "updated_at": "2022-09-30T08:29:17Z",
  "closed_at": "2022-09-30T08:29:14Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\n**NOTE:** This is a regression in Quarkus 2.13.0.CR1. In previous releases this has always worked as expected.\r\n\r\nBackground: In our application we store the OpenTelemetry context of incoming REST calls and then use it as the parent in calls which are triggered by a schedule. The schedule does this by programmatically creating a new span with the original span's `Context` as parent and then activates the span. When now within this span a RestEasy Reactive Client call is used to call some API, the corresponding CLIENT span ignores the programmatically created span and in fact has no parent span. In previous releases the CLIENT span would reference the programmatically created span as its parent.\r\n\r\nThe programmatic logic to create a span looks something like this (see `org.acme.MyScheduler#scheduled()` in attached test for details):\r\n```java\r\nSpan span = tracer.spanBuilder(\"scheduler\").setParent(context).startSpan();\r\ntry (Scope ignore = context.makeCurrent(); Scope ignore1 = span.makeCurrent()) {\r\n    response = client.hello(addressee);\r\n    span.end();\r\n}\r\n```\r\n\r\n### Expected behavior\r\n\r\nProgrammatic creation of spans should work as it did in previous Quarkus releases.\r\n\r\n### Actual behavior\r\n\r\nSee description.\r\n\r\nHere are the spans (serialized JSON) created by the attached example project:\r\n```json\r\n{\r\n  \"resource\": {\r\n    \"attributes\": [\r\n      {\r\n        \"key\": \"service.name\",\r\n        \"value\": {\r\n          \"stringValue\": \"code-with-quarkus\"\r\n        }\r\n      },\r\n      {\r\n        \"key\": \"service.version\",\r\n        \"value\": {\r\n          \"stringValue\": \"1.0.0-SNAPSHOT\"\r\n        }\r\n      },\r\n      {\r\n        \"key\": \"telemetry.sdk.language\",\r\n        \"value\": {\r\n          \"stringValue\": \"java\"\r\n        }\r\n      },\r\n      {\r\n        \"key\": \"telemetry.sdk.name\",\r\n        \"value\": {\r\n          \"stringValue\": \"opentelemetry\"\r\n        }\r\n      },\r\n      {\r\n        \"key\": \"telemetry.sdk.version\",\r\n        \"value\": {\r\n          \"stringValue\": \"1.17.0\"\r\n        }\r\n      },\r\n      {\r\n        \"key\": \"webengine.name\",\r\n        \"value\": {\r\n          \"stringValue\": \"Quarkus\"\r\n        }\r\n      },\r\n      {\r\n        \"key\": \"webengine.version\",\r\n        \"value\": {\r\n          \"stringValue\": \"2.13.0.CR1\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"scopeSpans\": [\r\n    {\r\n      \"scope\": {\r\n        \"name\": \"io.quarkus.opentelemetry\"\r\n      },\r\n      \"spans\": [\r\n        {\r\n          \"traceId\": \"62ffe5f3278ee2dbefabc499f50037e2\",\r\n          \"spanId\": \"5f78270f084c18c7\",\r\n          \"parentSpanId\": \"a49e8f9f5b8e4d77\",\r\n          \"name\": \"/hello\",\r\n          \"kind\": \"SPAN_KIND_SERVER\",\r\n          \"startTimeUnixNano\": \"1663341640147360000\",\r\n          \"endTimeUnixNano\": \"1663341640191058401\",\r\n          \"attributes\": [\r\n            {\r\n              \"key\": \"http.response_content_length\",\r\n              \"value\": {\r\n                \"intValue\": \"28\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.route\",\r\n              \"value\": {\r\n                \"stringValue\": \"/hello\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.user_agent\",\r\n              \"value\": {\r\n                \"stringValue\": \"Apache-HttpClient/4.5.13 (Java/17.0.4)\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.flavor\",\r\n              \"value\": {\r\n                \"stringValue\": \"1.1\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.target\",\r\n              \"value\": {\r\n                \"stringValue\": \"/hello\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.status_code\",\r\n              \"value\": {\r\n                \"intValue\": \"200\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.client_ip\",\r\n              \"value\": {\r\n                \"stringValue\": \"127.0.0.1\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.scheme\",\r\n              \"value\": {\r\n                \"stringValue\": \"http\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.host\",\r\n              \"value\": {\r\n                \"stringValue\": \"localhost:8081\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.method\",\r\n              \"value\": {\r\n                \"stringValue\": \"GET\"\r\n              }\r\n            }\r\n          ],\r\n          \"events\": [],\r\n          \"links\": [],\r\n          \"status\": {}\r\n        },\r\n        {\r\n          \"traceId\": \"3042707be1f4a888f1f52c1fd49f5520\",\r\n          \"spanId\": \"56cbdfd8da10b8b3\",\r\n          \"parentSpanId\": \"f2d8926f2e017182\",\r\n          \"name\": \"/hello/internal\",\r\n          \"kind\": \"SPAN_KIND_SERVER\",\r\n          \"startTimeUnixNano\": \"1663341641109469200\",\r\n          \"endTimeUnixNano\": \"1663341641115058800\",\r\n          \"attributes\": [\r\n            {\r\n              \"key\": \"http.response_content_length\",\r\n              \"value\": {\r\n                \"intValue\": \"11\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.route\",\r\n              \"value\": {\r\n                \"stringValue\": \"/hello/internal\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.user_agent\",\r\n              \"value\": {\r\n                \"stringValue\": \"Resteasy Reactive Client\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.flavor\",\r\n              \"value\": {\r\n                \"stringValue\": \"1.1\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.target\",\r\n              \"value\": {\r\n                \"stringValue\": \"/hello/internal\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.status_code\",\r\n              \"value\": {\r\n                \"intValue\": \"200\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.client_ip\",\r\n              \"value\": {\r\n                \"stringValue\": \"127.0.0.1\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.scheme\",\r\n              \"value\": {\r\n                \"stringValue\": \"http\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.host\",\r\n              \"value\": {\r\n                \"stringValue\": \"localhost:8081\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.method\",\r\n              \"value\": {\r\n                \"stringValue\": \"GET\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.request_content_length\",\r\n              \"value\": {\r\n                \"intValue\": \"5\"\r\n              }\r\n            }\r\n          ],\r\n          \"events\": [],\r\n          \"links\": [],\r\n          \"status\": {}\r\n        },\r\n        {\r\n          \"traceId\": \"3042707be1f4a888f1f52c1fd49f5520\",\r\n          \"spanId\": \"f2d8926f2e017182\",\r\n          \"name\": \"HTTP GET\",\r\n          \"kind\": \"SPAN_KIND_CLIENT\",\r\n          \"startTimeUnixNano\": \"1663341641105501300\",\r\n          \"endTimeUnixNano\": \"1663341641119615600\",\r\n          \"attributes\": [\r\n            {\r\n              \"key\": \"http.response_content_length\",\r\n              \"value\": {\r\n                \"intValue\": \"11\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.user_agent\",\r\n              \"value\": {\r\n                \"stringValue\": \"Resteasy Reactive Client\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.status_code\",\r\n              \"value\": {\r\n                \"intValue\": \"200\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.method\",\r\n              \"value\": {\r\n                \"stringValue\": \"GET\"\r\n              }\r\n            },\r\n            {\r\n              \"key\": \"http.url\",\r\n              \"value\": {\r\n                \"stringValue\": \"http://localhost:8081/hello/internal\"\r\n              }\r\n            }\r\n          ],\r\n          \"events\": [],\r\n          \"links\": [],\r\n          \"status\": {}\r\n        },\r\n        {\r\n          \"traceId\": \"62ffe5f3278ee2dbefabc499f50037e2\",\r\n          \"spanId\": \"10611f1988f86ede\",\r\n          \"parentSpanId\": \"5f78270f084c18c7\",\r\n          \"name\": \"scheduler\",\r\n          \"kind\": \"SPAN_KIND_INTERNAL\",\r\n          \"startTimeUnixNano\": \"1663341641000663901\",\r\n          \"endTimeUnixNano\": \"1663341641123223601\",\r\n          \"attributes\": [],\r\n          \"events\": [],\r\n          \"links\": [],\r\n          \"status\": {}\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nRun `mvn verify` in the attached test application: [code-with-quarkus.zip](https://github.com/quarkusio/quarkus/files/9607293/code-with-quarkus.zip)\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\n_No response_\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.13.0.CR1\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/28017/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/28017/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
