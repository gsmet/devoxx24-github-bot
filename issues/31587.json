{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31587",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31587/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31587/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31587/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/31587",
  "id": 1608734559,
  "node_id": "I_kwDOCFbutM5f41df",
  "number": 31587,
  "title": "RESTEasy Reactive SSE doesn't provide method annotations, nor actual headers to `MessageBodyWriter`",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2552031458,
      "node_id": "MDU6TGFiZWwyNTUyMDMxNDU4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/rest",
      "name": "area/rest",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/246",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/246",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/246/labels",
    "id": 9296662,
    "node_id": "MI_kwDOCFbutM4AjdsW",
    "number": 246,
    "title": "3.0.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 115,
    "state": "closed",
    "created_at": "2023-04-18T08:50:05Z",
    "updated_at": "2023-05-15T14:00:32Z",
    "due_on": null,
    "closed_at": "2023-04-26T09:04:58Z"
  },
  "comments": 14,
  "created_at": "2023-03-03T14:22:30Z",
  "updated_at": "2023-07-26T16:53:06Z",
  "closed_at": "2023-04-21T15:46:50Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nThe current implementation of RESTEasy Reactive Server Sent Events (SSE) doesn't provide the method annotations, nor actual headers to the implementations of [`MessageBodyWriter#writeTo`](https://jakarta.ee/specifications/platform/8/apidocs/javax/ws/rs/ext/messagebodywriter#writeTo-T-java.lang.Class-java.lang.reflect.Type-java.lang.annotation.Annotation:A-javax.ws.rs.core.MediaType-javax.ws.rs.core.MultivaluedMap-java.io.OutputStream-).\r\n\r\nThis prevents the implementations of `MessageBodyWriter` knowing they are supposed to serialize the object for SSE, where setting headers make no sense.\r\n\r\nAlso, it makes sense to warn people that those headers will be dropped. For example, to check if the headers been changed after calling write, we can log a WARN message.\r\n\r\nFurthermore, the RESTEasy Classic properly passes the proper annotations. See example here: https://github.com/resteasy/resteasy/blob/0b6e61b27efe52988523821158253a2a28ca8fc9/resteasy-core/src/main/java/org/jboss/resteasy/core/interception/jaxrs/AbstractWriterInterceptorContext.java#L267-L268\r\n\r\nSee related issue: https://github.com/cloudevents/sdk-java/issues/533\r\n\r\nFollow up to https://github.com/quarkusio/quarkus/pull/31560\r\n\r\n### Expected behavior\r\n\r\nHeaders and method annotations are passed to the `MessageBodyWriter` allowing to make proper decisions.\r\n\r\nThe HTTP response should be:\r\n\r\n```http\r\nHTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nX-SSE-Content-Type: application/json\r\ntransfer-encoding: chunked\r\n\r\ndata:{\r\n    \"data\": {\r\n        \"play\": {\r\n            \"game\": 33,\r\n            \"id\": \"1ceb74b8-2431-6785-388e-758f8f0c074f\"\r\n        },\r\n        \"score\": 140\r\n    },\r\n    \"datacontenttype\": \"application/json\",\r\n    \"id\": \"2\",\r\n    \"source\": \"//localhost/dev\",\r\n    \"specversion\": \"1.0\",\r\n    \"type\": \"com.redhat.openshift.knative.showcase.events.Endpoint\"\r\n}\r\n\r\ndata:{\r\n    \"data\": {\r\n        \"play\": {\r\n            \"game\": 148,\r\n            \"id\": \"e943fdd3-ecc0-353d-a505-16270926258d\"\r\n        },\r\n        \"score\": 296\r\n    },\r\n    \"datacontenttype\": \"application/json\",\r\n    \"id\": \"1\",\r\n    \"source\": \"//localhost/dev\",\r\n    \"specversion\": \"1.0\",\r\n    \"type\": \"com.redhat.openshift.knative.showcase.events.Endpoint\"\r\n}\r\n\r\ndata:{\r\n    \"data\": {\r\n        \"play\": {\r\n            \"game\": 61,\r\n            \"id\": \"7b4cd7fc-85b5-828b-2bd1-39de5a8d386a\"\r\n        },\r\n        \"score\": 65\r\n    },\r\n    \"datacontenttype\": \"application/json\",\r\n    \"id\": \"0\",\r\n    \"source\": \"//localhost/dev\",\r\n    \"specversion\": \"1.0\",\r\n    \"type\": \"com.redhat.openshift.knative.showcase.events.Endpoint\"\r\n}\r\n\r\n```\r\n\r\n### Actual behavior\r\n\r\nThe empty headers and annotations are passed to the `MessageBodyWriter`.\r\n\r\nThe HTTP response is:\r\n\r\n```http\r\nHTTP/1.1 200 OK\r\nContent-Type: text/event-stream\r\nX-SSE-Content-Type: application/json\r\ntransfer-encoding: chunked\r\n\r\ndata:{\r\n    \"play\": {\r\n        \"game\": 33,\r\n        \"id\": \"1ceb74b8-2431-6785-388e-758f8f0c074f\"\r\n    },\r\n    \"score\": 140\r\n}\r\n\r\ndata:{\r\n    \"play\": {\r\n        \"game\": 148,\r\n        \"id\": \"e943fdd3-ecc0-353d-a505-16270926258d\"\r\n    },\r\n    \"score\": 296\r\n}\r\n\r\ndata:{\r\n    \"play\": {\r\n        \"game\": 61,\r\n        \"id\": \"7b4cd7fc-85b5-828b-2bd1-39de5a8d386a\"\r\n    },\r\n    \"score\": 65\r\n}\r\n\r\n```\r\n\r\n### How to Reproduce?\r\n\r\n1. Use cloudevents-http-restful-ws library, as it has `MessageBodyWriter` implemtation which looks for `StructuredEncoding` annotation in the annotations list. If that annotation isn't found, binary encoding is used. The binary encoding writes the event headers as HTTP headers and event data as body. In the case of SSE, this makes no sense.\r\n2. Define REST endpoint that will produce SSE of return type `Multi<CloudEvent>`.\r\n3. Call such an endpoint. You will see a list of events bodies (the headers are missing)\r\n\r\n```java\r\n@GET\r\n@RestStreamElementType(MediaType.APPLICATION_JSON)\r\nMulti<CloudEvent> events() {\r\n  return Multi.createFrom().iterable(events);\r\n}\r\n```\r\n\r\nSee also: https://github.com/cardil/openshift-knative-showcase/commit/15e00429c459abf655fb483a27f467d598ae173e\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux thinkpad-t590 6.1.13-200.fc37.x86_64 #1 SMP PREEMPT_DYNAMIC Wed Feb 22 17:53:57 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\n```\r\nopenjdk version \"17.0.5\" 2022-10-18\r\nOpenJDK Runtime Environment Temurin-17.0.5+8 (build 17.0.5+8)\r\nOpenJDK 64-Bit Server VM Temurin-17.0.5+8 (build 17.0.5+8, mixed mode, sharing)\r\n```\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.13.5.Final-redhat-00002\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.7 (b89d5959fcde851dcb1c8946a785a163f14e1e29)\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31587/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31587/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
