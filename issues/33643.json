{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33643",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33643/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33643/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33643/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/33643",
  "id": 1728123367,
  "node_id": "I_kwDOCFbutM5nARHn",
  "number": 33643,
  "title": "RolesAllowed and OIDC broken in 2.16.0-Final and 3.0.4-Final with KeyCloak",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1479557456,
      "node_id": "MDU6TGFiZWwxNDc5NTU3NDU2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/oidc",
      "name": "area/oidc",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 3289887215,
      "node_id": "MDU6TGFiZWwzMjg5ODg3MjE1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/keycloak",
      "name": "area/keycloak",
      "color": "0366d6",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/253",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/253",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/253/labels",
    "id": 9468628,
    "node_id": "MI_kwDOCFbutM4AkHrU",
    "number": 253,
    "title": "3.1.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 83,
    "state": "closed",
    "created_at": "2023-05-31T16:27:01Z",
    "updated_at": "2023-06-28T14:05:39Z",
    "due_on": null,
    "closed_at": "2023-06-07T11:17:31Z"
  },
  "comments": 12,
  "created_at": "2023-05-26T19:20:07Z",
  "updated_at": "2023-05-31T16:29:55Z",
  "closed_at": "2023-05-29T13:06:23Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI think the RolesAllowed annotation is broken in 3.x with Keycloak. I can't get it to work no matter what I try, I tried for both `web-app` and `service` type applications.\r\n\r\nI've tried the same code with 2.16.0-Final and 3.0.4-Final. Changing the `jakarta.*` back to `javax.*` to get to compile on 2.16.\r\n\r\nI found this issue which sounds similar : https://github.com/quarkusio/quarkus/issues/33602\r\n\r\nI'm hoping it is something simple to fix, since this would be a big regression bug that would break a lot of people I would imagine.\r\n\r\nAs a test I downloaded the code from this tutorial https://quarkus.io/guides/security-oidc-code-flow-authentication-tutorial and modified it to use the `RolesAllowed` for the `/tokens` endpoint.\r\n\r\nI checked in the code into: https://github.com/tmulle/Quarkus3OIDCRolesAllowedTest\r\n\r\nAnyway, when I run the app and hit the page `http://localhost:9090/tokens` I'm asked by Keycloak to log in..and I enter `alice` and `alice` and then I get the following messages in the console on the server.\r\n\r\nThe browser page is then blank and a `403` is in the network monitor.\r\n\r\nPutting the access token returned in `jwt.io` shows the `realm_access/roles` exists and my role of `user` is there.\r\n\r\n<img width=\"1424\" alt=\"Screenshot 2023-05-26 at 3 16 16 PM\" src=\"https://github.com/quarkusio/quarkus/assets/5183186/a55c9a5b-fb19-4c65-8c7a-bcb9cbcb4b39\">\r\n\r\nBut, from the TRACE output, notice the messages saying it can't find `realm_access/roles` BUT it clearly is in the Access Token.\r\n\r\n```\r\njava -Dquarkus.http.port=9090 -jar target/quarkus-app/quarkus-run.jar \r\n__  ____  __  _____   ___  __ ____  ______ \r\n --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ \r\n -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\\ \\   \r\n--\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/   \r\n2023-05-26 14:59:14,997 WARN  [io.qua.oid.run.TenantConfigContext] (vert.x-eventloop-thread-1) Secret key for encrypting tokens should be 32 characters long\r\n2023-05-26 14:59:15,021 WARN  [io.qua.run.log.LoggingSetupRecorder] (main) Log level TRACE for category 'io.quarkus.oidc' set below minimum logging level DEBUG, promoting it to DEBUG. Set the build time configuration property 'quarkus.log.category.\"io.quarkus.oidc\".min-level' to 'TRACE' to avoid this warning\r\n2023-05-26 14:59:15,101 INFO  [io.quarkus] (main) security-openid-connect-web-authentication-quickstart 1.0.0-SNAPSHOT on JVM (powered by Quarkus 3.0.4.Final) started in 1.104s. Listening on: http://0.0.0.0:9090\r\n2023-05-26 14:59:15,104 INFO  [io.quarkus] (main) Profile prod activated. \r\n2023-05-26 14:59:15,105 INFO  [io.quarkus] (main) Installed features: [cdi, oidc, resteasy-reactive, resteasy-reactive-jackson, security, smallrye-context-propagation, vertx]\r\n2023-05-26 14:59:19,821 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Starting an authentication challenge\r\n2023-05-26 14:59:19,823 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Authentication request redirect_uri parameter: http://localhost:9090/tokens\r\n2023-05-26 14:59:19,826 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) q_auth_ec8ba3e6-ad3b-469f-91ec-d20b8309e18e cookie 'max-age' parameter is set to 1800\r\n2023-05-26 14:59:19,827 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Code flow redirect to: http://localhost:8080/realms/quarkus/protocol/openid-connect/auth?response_type=code&client_id=frontend&scope=openid&redirect_uri=http%3A%2F%2Flocalhost%3A9090%2Ftokens&state=ec8ba3e6-ad3b-469f-91ec-d20b8309e18e\r\n2023-05-26 14:59:23,258 DEBUG [io.qua.oid.run.DefaultTenantConfigResolver] (vert.x-eventloop-thread-2) Registered TenantResolver has not provided the configuration for tenant 'ec8ba3e6-ad3b-469f-91ec-d20b8309e18e', using the default tenant\r\n2023-05-26 14:59:23,259 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) State cookie is present, processing an expected redirect from the OIDC provider\r\n2023-05-26 14:59:23,259 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Authorization code is present, completing the code flow\r\n2023-05-26 14:59:23,260 DEBUG [io.qua.oid.run.DefaultTenantConfigResolver] (vert.x-eventloop-thread-2) Registered TenantResolver has not provided the configuration for tenant 'ec8ba3e6-ad3b-469f-91ec-d20b8309e18e', using the default tenant\r\n2023-05-26 14:59:23,261 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Exchanging the authorization code for the tokens\r\n2023-05-26 14:59:23,261 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Token request redirect_uri parameter: http://localhost:9090/tokens\r\n2023-05-26 14:59:23,263 DEBUG [io.qua.oid.run.OidcProviderClient] (vert.x-eventloop-thread-2) Get token on: http://localhost:8080/realms/quarkus/protocol/openid-connect/token params: grant_type=authorization_code\r\ncode=709f81de-3dbc-4a39-be84-93e02efe2022.e159316e-b598-4b9f-83d2-4cc3ef54aced.0ac5df91-e044-4051-bd03-106a3a5fb9cc\r\nredirect_uri=http://localhost:9090/tokens\r\n headers: user-agent=Vert.x-WebClient/4.4.1\r\ncontent-type=application/x-www-form-urlencoded\r\naccept=application/json\r\nauthorization=Basic ZnJvbnRlbmQ6c2VjcmV0\r\n\r\n2023-05-26 14:59:23,292 DEBUG [io.qua.oid.run.OidcProviderClient] (vert.x-eventloop-thread-2) Request succeeded: {\"access_token\":\"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJMMGM5ZmUwdjgzQ3VYWTZ2bXYyaVJtQmM4VmxvdkZkbG8yR29IajN6YnZFIn0.eyJleHAiOjE2ODUxMjc1NjUsImlhdCI6MTY4NTEyNzU2MywiYXV0aF90aW1lIjoxNjg1MTI3NTYzLCJqdGkiOiIxNGQzMDhjYS1lYjFkLTQwOTItODA0Yy05ZjEyY2M4OWU3YjIiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL3F1YXJrdXMiLCJzdWIiOiJlYjQxMjNhMy1iNzIyLTQ3OTgtOWFmNS04OTU3ZjgyMzY1N2EiLCJ0eXAiOiJCZWFyZXIiLCJhenAiOiJmcm9udGVuZCIsInNlc3Npb25fc3RhdGUiOiJlMTU5MzE2ZS1iNTk4LTRiOWYtODNkMi00Y2MzZWY1NGFjZWQiLCJhY3IiOiIxIiwicmVhbG1fYWNjZXNzIjp7InJvbGVzIjpbInVzZXIiXX0sInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJlMTU5MzE2ZS1iNTk4LTRiOWYtODNkMi00Y2MzZWY1NGFjZWQiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsInByZWZlcnJlZF91c2VybmFtZSI6ImFsaWNlIn0.duql7Hp5mAFqd1tLnn5w9O0RbSvGSK-JKFVYHGIZ7F2b_LK8nZH7gvAr7XbooNvdUM9oC6z2yzchdRwfgYYFXMoNPYnsUZg2l7tTWFJfLZSvqkvGf_NUX_MccH59V4uEUds1taJAtvgIaOh5iwZ9CMO1PrIkisMCp5ufstdKfbb2arhwdJ4jhd3tutRqxiJrpTH_9ae-OfAgf8WualhjJyC6myZxp93rKZoba4tFjHU7JQxvXZ8Kz3PewyV34jEbBpLrOjDXef6bC1C9qJJXWCmkcK3tHia67DrInqygHn0P_Kap7uK6ZPkHFnRBmKdKjaXTFWRby7RqkiLhd5o11g\",\"expires_in\":2,\"refresh_expires_in\":2,\"refresh_token\":\"eyJhbGciOiJIUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI5YTJlZDAwNi1hYjcyLTQzMzItOWUxMC1lOTBmZmI0MDIxNzUifQ.eyJleHAiOjE2ODUxMjc1NjUsImlhdCI6MTY4NTEyNzU2MywianRpIjoiZDVjYmNhOTUtNmJhZC00OWMyLWFmNTUtMjFlZjdkM2JjOGY4IiwiaXNzIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9xdWFya3VzIiwiYXVkIjoiaHR0cDovL2xvY2FsaG9zdDo4MDgwL3JlYWxtcy9xdWFya3VzIiwic3ViIjoiZWI0MTIzYTMtYjcyMi00Nzk4LTlhZjUtODk1N2Y4MjM2NTdhIiwidHlwIjoiUmVmcmVzaCIsImF6cCI6ImZyb250ZW5kIiwic2Vzc2lvbl9zdGF0ZSI6ImUxNTkzMTZlLWI1OTgtNGI5Zi04M2QyLTRjYzNlZjU0YWNlZCIsInNjb3BlIjoib3BlbmlkIHByb2ZpbGUgZW1haWwiLCJzaWQiOiJlMTU5MzE2ZS1iNTk4LTRiOWYtODNkMi00Y2MzZWY1NGFjZWQifQ.gdbYbSo7QxK0vTrgu8P6jLU9250_3XJUFIOEc4JtzWY\",\"token_type\":\"Bearer\",\"id_token\":\"eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJMMGM5ZmUwdjgzQ3VYWTZ2bXYyaVJtQmM4VmxvdkZkbG8yR29IajN6YnZFIn0.eyJleHAiOjE2ODUxMjc1NjUsImlhdCI6MTY4NTEyNzU2MywiYXV0aF90aW1lIjoxNjg1MTI3NTYzLCJqdGkiOiJlNGZhY2QxMy0wZjE2LTRjOWEtOTE0NC1mNDJjNDk2ZmI3NDgiLCJpc3MiOiJodHRwOi8vbG9jYWxob3N0OjgwODAvcmVhbG1zL3F1YXJrdXMiLCJhdWQiOiJmcm9udGVuZCIsInN1YiI6ImViNDEyM2EzLWI3MjItNDc5OC05YWY1LTg5NTdmODIzNjU3YSIsInR5cCI6IklEIiwiYXpwIjoiZnJvbnRlbmQiLCJzZXNzaW9uX3N0YXRlIjoiZTE1OTMxNmUtYjU5OC00YjlmLTgzZDItNGNjM2VmNTRhY2VkIiwiYXRfaGFzaCI6Im1iRUxNTWJuZ3o5V2JBZTFYaU5oREEiLCJhY3IiOiIxIiwic2lkIjoiZTE1OTMxNmUtYjU5OC00YjlmLTgzZDItNGNjM2VmNTRhY2VkIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhbGljZSJ9.ZHVK0NRBQRjxTfGOT2pz34pscays-jneh7ppKfdh1b3pMAEfh-hTEUfIgjYyNuvHPekNzz_DUFRVhY26Br2OCyBg9G2JdPr2xUgyBPbO3p2_nn-_muzZyDmrnGFC1E_41fgJwtG2HfY1vUQqFnDNyUVKK_uP1uLAoZ74yT4aWbuUN9sqUdehL7_z5wwqVLmGJ9Nt-fq62DiQCFNV0blEvK2Kq8iD9ydHE_LRPyd4B2JiRYEgNEo0dTH6UjfNWY4uxlwEXloaENzE_Yw9BNDTJu63mLHs0dN_jh9baYkux-Ct87iKxyWQnh2pKX520MpOPDNBtndn24FWE3rOkORLaQ\",\"not-before-policy\":1684433761,\"session_state\":\"e159316e-b598-4b9f-83d2-4cc3ef54aced\",\"scope\":\"openid profile email\"}\r\n2023-05-26 14:59:23,309 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Authorization code has been exchanged, verifying ID token\r\n2023-05-26 14:59:23,310 DEBUG [io.qua.oid.run.OidcIdentityProvider] (vert.x-eventloop-thread-2) Starting creating SecurityIdentity\r\n2023-05-26 14:59:23,313 DEBUG [io.qua.oid.run.DefaultTenantConfigResolver] (vert.x-eventloop-thread-2) Registered TenantResolver has not provided the configuration for tenant 'ec8ba3e6-ad3b-469f-91ec-d20b8309e18e', using the default tenant\r\n2023-05-26 14:59:23,316 DEBUG [io.qua.oid.run.OidcIdentityProvider] (vert.x-eventloop-thread-2) Verifying the JWT token with the local JWK keys\r\n2023-05-26 14:59:23,445 DEBUG [io.qua.oid.run.OidcUtils] (vert.x-eventloop-thread-2) No claim exists at the path 'groups' at the path segment 'groups'\r\n2023-05-26 14:59:23,447 DEBUG [io.qua.oid.run.OidcUtils] (vert.x-eventloop-thread-2) No claim exists at the path 'realm_access/roles' at the path segment 'realm_access'\r\n2023-05-26 14:59:23,448 DEBUG [io.qua.oid.run.OidcUtils] (vert.x-eventloop-thread-2) No claim exists at the path 'resource_access/frontend/roles' at the path segment 'resource_access'\r\n2023-05-26 14:59:23,449 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) ID token has been verified, removing the existing session cookie if any and creating a new one\r\n2023-05-26 14:59:23,451 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) ID token is valid for 2 seconds\r\n2023-05-26 14:59:23,461 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) q_session cookie 'max-age' parameter is set to 2\r\n2023-05-26 14:59:23,463 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Removing code flow redirect parameters, final redirect URI: http://localhost:9090/tokens\r\n2023-05-26 14:59:23,463 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Starting the final redirect\r\n2023-05-26 14:59:23,473 DEBUG [io.qua.oid.run.DefaultTenantConfigResolver] (vert.x-eventloop-thread-2) Registered TenantResolver has not provided the configuration for tenant 'Default', using the default tenant\r\n2023-05-26 14:59:23,474 DEBUG [io.qua.oid.run.CodeAuthenticationMechanism] (vert.x-eventloop-thread-2) Session cookie is present, starting the reauthentication\r\n2023-05-26 14:59:23,475 DEBUG [io.qua.oid.run.DefaultTenantConfigResolver] (vert.x-eventloop-thread-2) Registered TenantResolver has not provided the configuration for tenant 'Default', using the default tenant\r\n2023-05-26 14:59:23,478 DEBUG [io.qua.oid.run.OidcIdentityProvider] (vert.x-eventloop-thread-2) Starting creating SecurityIdentity\r\n2023-05-26 14:59:23,480 DEBUG [io.qua.oid.run.DefaultTenantConfigResolver] (vert.x-eventloop-thread-2) Registered TenantResolver has not provided the configuration for tenant 'Default', using the default tenant\r\n2023-05-26 14:59:23,480 DEBUG [io.qua.oid.run.OidcIdentityProvider] (vert.x-eventloop-thread-2) Verifying the JWT token with the local JWK keys\r\n2023-05-26 14:59:23,484 DEBUG [io.qua.oid.run.OidcUtils] (vert.x-eventloop-thread-2) No claim exists at the path 'groups' at the path segment 'groups'\r\n2023-05-26 14:59:23,484 DEBUG [io.qua.oid.run.OidcUtils] (vert.x-eventloop-thread-2) No claim exists at the path 'realm_access/roles' at the path segment 'realm_access'\r\n2023-05-26 14:59:23,484 DEBUG [io.qua.oid.run.OidcUtils] (vert.x-eventloop-thread-2) No claim exists at the path 'resource_access/frontend/roles' at the path segment 'resource_access'\r\n^[[A^C2023-05-26 15:07:47,142 INFO  [io.quarkus] (Shutdown thread) security-openid-connect-web-authentication-quickstart stopped in 0.044s\r\n```\r\n\r\n### Expected behavior\r\n\r\nUser should be able to access the page and not get a 403 for a web-app or a 401 for backend services\r\n\r\n### Actual behavior\r\n\r\nError 403 is always returned even though the Access Token has the role defined\r\n\r\n### How to Reproduce?\r\n\r\n_No response_\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\nOpenJDK Runtime Environment Temurin-17.0.7+7 (build 17.0.7+7)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n3.0.4-Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nKeycloak info:\r\n<img width=\"1387\" alt=\"Screenshot 2023-05-26 at 4 28 09 PM\" src=\"https://github.com/quarkusio/quarkus/assets/5183186/f4a464bc-b2ee-4ec8-897f-3a8442ff46d0\">\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33643/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33643/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
