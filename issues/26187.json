{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/26187",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26187/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26187/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26187/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/26187",
  "id": 1273676766,
  "node_id": "I_kwDOCFbutM5L6sPe",
  "number": 26187,
  "title": "Resteasy-reactive runs out of direct buffer memory when processing large multipart messages",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2552031458,
      "node_id": "MDU6TGFiZWwyNTUyMDMxNDU4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/rest",
      "name": "area/rest",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/205",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/205",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/205/labels",
    "id": 8414394,
    "node_id": "MI_kwDOCFbutM4AgGS6",
    "number": 205,
    "title": "2.12.2.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 21,
    "state": "closed",
    "created_at": "2022-09-12T15:37:17Z",
    "updated_at": "2023-01-13T11:07:32Z",
    "due_on": null,
    "closed_at": "2022-09-13T12:10:57Z"
  },
  "comments": 25,
  "created_at": "2022-06-16T14:54:37Z",
  "updated_at": "2022-09-12T15:38:41Z",
  "closed_at": "2022-09-09T06:24:45Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nI have two Rest Reactive methods, one accepts File and another multipart of File and String. If running on resource limit machine(this behavior first arose on Github Actions), the second method fails with cryptic error while processing files of 2048 MB size, while the first handles larger(2054 MB) files without problems.\n\n### Expected behavior\n\nMethod should fail with more concise error or not fail at all.\n\n### Actual behavior\n\nMethod fails with this error:\r\n```\r\n2022-06-16T13:28:18.2721622Z 13:28:18,223 INFO  [app] 13:28:18,105 Request failed: java.io.IOException: java.io.IOException: java.lang.OutOfMemoryError: Direct buffer memory\r\n2022-06-16T13:28:18.2726667Z 13:28:18,224 INFO  [app] \tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream$VertxBlockingInput.readBlocking(VertxInputStream.java:253)\r\n2022-06-16T13:28:18.2730751Z 13:28:18,224 INFO  [app] \tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream.readIntoBuffer(VertxInputStream.java:120)\r\n2022-06-16T13:28:18.2735393Z 13:28:18,226 INFO  [app] \tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream.read(VertxInputStream.java:82)\r\n2022-06-16T13:28:18.2736182Z 13:28:18,227 INFO  [app] \tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream.read(VertxInputStream.java:70)\r\n2022-06-16T13:28:18.2795835Z 13:28:18,228 INFO  [app] \tat org.jboss.resteasy.reactive.server.core.multipart.MultiPartParserDefinition$MultiPartUploadHandler.parseBlocking(MultiPartParserDefinition.java:217)\r\n2022-06-16T13:28:18.2806940Z 13:28:18,228 INFO  [app] \tat org.jboss.resteasy.reactive.server.handlers.FormBodyHandler.handle(FormBodyHandler.java:88)\r\n2022-06-16T13:28:18.2811409Z 13:28:18,229 INFO  [app] \tat org.jboss.resteasy.reactive.server.handlers.FormBodyHandler.handle(FormBodyHandler.java:25)\r\n2022-06-16T13:28:18.2816304Z 13:28:18,229 INFO  [app] \tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:141)\r\n2022-06-16T13:28:18.2822693Z 13:28:18,229 INFO  [app] \tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$13.runWith(VertxCoreRecorder.java:545)\r\n2022-06-16T13:28:18.2826225Z 13:28:18,230 INFO  [app] \tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n2022-06-16T13:28:18.2830935Z 13:28:18,230 INFO  [app] \tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n2022-06-16T13:28:18.2836012Z 13:28:18,230 INFO  [app] \tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n2022-06-16T13:28:18.2888414Z 13:28:18,231 INFO  [app] \tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n2022-06-16T13:28:18.2892511Z 13:28:18,232 INFO  [app] \tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n2022-06-16T13:28:18.2898697Z 13:28:18,232 INFO  [app] \tat java.base/java.lang.Thread.run(Thread.java:829)\r\n2022-06-16T13:28:18.2899383Z 13:28:18,232 INFO  [app] \tSuppressed: java.io.IOException: java.io.IOException: java.lang.OutOfMemoryError: Direct buffer memory\r\n2022-06-16T13:28:18.2903591Z 13:28:18,232 INFO  [app] \t\tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream$VertxBlockingInput.readBlocking(VertxInputStream.java:253)\r\n2022-06-16T13:28:18.2904557Z 13:28:18,233 INFO  [app] \t\tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream.readIntoBuffer(VertxInputStream.java:120)\r\n2022-06-16T13:28:18.2914225Z 13:28:18,233 INFO  [app] \t\tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream.close(VertxInputStream.java:148)\r\n2022-06-16T13:28:18.2917218Z 13:28:18,233 INFO  [app] \t\tat org.jboss.resteasy.reactive.server.core.multipart.MultiPartParserDefinition$MultiPartUploadHandler.parseBlocking(MultiPartParserDefinition.java:214)\r\n2022-06-16T13:28:18.2921708Z 13:28:18,233 INFO  [app] \t\t... 10 more\r\n2022-06-16T13:28:18.2926611Z 13:28:18,233 INFO  [app] \tCaused by: java.io.IOException: java.lang.OutOfMemoryError: Direct buffer memory\r\n2022-06-16T13:28:18.2931355Z 13:28:18,234 INFO  [app] \t\tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream$VertxBlockingInput$2.handle(VertxInputStream.java:200)\r\n2022-06-16T13:28:18.2934186Z 13:28:18,234 INFO  [app] \t\tat org.jboss.resteasy.reactive.server.vertx.VertxInputStream$VertxBlockingInput$2.handle(VertxInputStream.java:196)\r\n2022-06-16T13:28:18.2938685Z 13:28:18,234 INFO  [app] \t\tat io.vertx.core.impl.AbstractContext.dispatch(AbstractContext.java:100)\r\n2022-06-16T13:28:18.2943012Z 13:28:18,235 INFO  [app] \t\tat io.vertx.core.http.impl.HttpEventHandler.handleException(HttpEventHandler.java:89)\r\n2022-06-16T13:28:18.2947915Z 13:28:18,235 INFO  [app] \t\tat io.vertx.core.http.impl.Http1xServerRequest.handleException(Http1xServerRequest.java:635)\r\n2022-06-16T13:28:18.2948945Z 13:28:18,235 INFO  [app] \t\tat io.vertx.core.http.impl.Http1xServerConnection.handleException(Http1xServerConnection.java:479)\r\n2022-06-16T13:28:18.2953455Z 13:28:18,235 INFO  [app] \t\tat io.vertx.core.net.impl.VertxHandler.exceptionCaught(VertxHandler.java:136)\r\n2022-06-16T13:28:18.2957910Z 13:28:18,235 INFO  [app] \t\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:302)\r\n2022-06-16T13:28:18.2964868Z 13:28:18,236 INFO  [app] \t\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:281)\r\n2022-06-16T13:28:18.2967697Z 13:28:18,236 INFO  [app] \t\tat io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:273)\r\n2022-06-16T13:28:18.2972847Z 13:28:18,236 INFO  [app] \t\tat io.netty.channel.DefaultChannelPipeline$HeadContext.exceptionCaught(DefaultChannelPipeline.java:1377)\r\n2022-06-16T13:28:18.2973933Z 13:28:18,238 INFO  [app] \t\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:302)\r\n2022-06-16T13:28:18.2980565Z 13:28:18,239 INFO  [app] \t\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:281)\r\n2022-06-16T13:28:18.2989152Z 13:28:18,239 INFO  [app] \t\tat io.netty.channel.DefaultChannelPipeline.fireExceptionCaught(DefaultChannelPipeline.java:907)\r\n2022-06-16T13:28:18.2994600Z 13:28:18,239 INFO  [app] \t\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.handleReadException(AbstractNioByteChannel.java:125)\r\n2022-06-16T13:28:18.2998533Z 13:28:18,239 INFO  [app] \t\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:177)\r\n2022-06-16T13:28:18.3004558Z 13:28:18,239 INFO  [app] \t\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:722)\r\n2022-06-16T13:28:18.3007277Z 13:28:18,239 INFO  [app] \t\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:658)\r\n2022-06-16T13:28:18.3014467Z 13:28:18,240 INFO  [app] \t\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:584)\r\n2022-06-16T13:28:18.3018855Z 13:28:18,240 INFO  [app] \t\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496)\r\n2022-06-16T13:28:18.3023471Z 13:28:18,240 INFO  [app] \t\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986)\r\n2022-06-16T13:28:18.3028808Z 13:28:18,240 INFO  [app] \t\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n2022-06-16T13:28:18.3032242Z 13:28:18,240 INFO  [app] \t\t... 2 more\r\n2022-06-16T13:28:18.3035985Z 13:28:18,240 INFO  [app] \tCaused by: java.lang.OutOfMemoryError: Direct buffer memory\r\n2022-06-16T13:28:18.3040268Z 13:28:18,240 INFO  [app] \t\tat java.base/java.nio.Bits.reserveMemory(Bits.java:175)\r\n2022-06-16T13:28:18.3044246Z 13:28:18,241 INFO  [app] \t\tat java.base/java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:118)\r\n2022-06-16T13:28:18.3048818Z 13:28:18,241 INFO  [app] \t\tat java.base/java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:317)\r\n2022-06-16T13:28:18.3049459Z 13:28:18,241 INFO  [app] \t\tat io.netty.buffer.PoolArena$DirectArena.allocateDirect(PoolArena.java:648)\r\n2022-06-16T13:28:18.3053956Z 13:28:18,241 INFO  [app] \t\tat io.netty.buffer.PoolArena$DirectArena.newChunk(PoolArena.java:623)\r\n2022-06-16T13:28:18.3054534Z 13:28:18,241 INFO  [app] \t\tat io.netty.buffer.PoolArena.allocateNormal(PoolArena.java:202)\r\n2022-06-16T13:28:18.3058583Z 13:28:18,241 INFO  [app] \t\tat io.netty.buffer.PoolArena.tcacheAllocateNormal(PoolArena.java:186)\r\n2022-06-16T13:28:18.3059067Z 13:28:18,241 INFO  [app] \t\tat io.netty.buffer.PoolArena.allocate(PoolArena.java:136)\r\n2022-06-16T13:28:18.3063255Z 13:28:18,242 INFO  [app] \t\tat io.netty.buffer.PoolArena.allocate(PoolArena.java:126)\r\n2022-06-16T13:28:18.3072936Z 13:28:18,242 INFO  [app] \t\tat io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:394)\r\n2022-06-16T13:28:18.3077717Z 13:28:18,242 INFO  [app] \t\tat io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:188)\r\n2022-06-16T13:28:18.3089443Z 13:28:18,246 INFO  [app] \t\tat io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:179)\r\n2022-06-16T13:28:18.3099295Z 13:28:18,246 INFO  [app] \t\tat io.netty.buffer.AbstractByteBufAllocator.ioBuffer(AbstractByteBufAllocator.java:140)\r\n2022-06-16T13:28:18.3111835Z 13:28:18,251 INFO  [app] \t\tat io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:120)\r\n2022-06-16T13:28:18.3123149Z 13:28:18,252 INFO  [app] \t\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:150)\r\n2022-06-16T13:28:18.3128101Z 13:28:18,252 INFO  [app] \t\t... 8 more\r\n2022-06-16T13:28:18.3139424Z 13:28:18,252 INFO  [app] \t[CIRCULAR REFERENCE:java.io.IOException: java.lang.OutOfMemoryError: Direct buffer memory]\r\n```\n\n### How to Reproduce?\n\nThis steps should be run on memory limited machine(preferably, VM)\r\n1. `git clone https://github.com/fedinskiy/quarkus-test-suite.git -b reproducer/multipart_oom tests`\r\n2. `cd tests`\r\n3. `mvn -Dall-modules -pl http/rest-client-reactive/ clean verify -Dit.test=LargeFileHandlingIT`\r\nTest `uploadMultipart` fails, tests `uploadBigFileThroughClient` and `uploadThroughClient` work.\n\n### Output of `uname -a` or `ver`\n\n4.18.0-372.9.1.el8.x86_64\n\n### Output of `java -version`\n\nopenjdk 11.0.13 2021-10-19 LTS(also temurin 11.0.15)\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.7.6, 2.9.1 and ca836996b345a6cad93a79a6d8600c5dd809ed92\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n 3.8.3, 3.8.4 and 3.8.6\n\n### Additional information\n\nCI logs:\r\nhttps://github.com/quarkus-qe/quarkus-test-suite/runs/6919232274?check_suite_focus=true\r\n\r\nOn 4G VM, which is described in the `environment` section, the test do not threw any errors, but hangs with warnings like these, but with different thread numbers:\r\n```\r\n12:55:30,733 INFO  [app] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread \"vert.x-eventloop-thread-2\"\r\n12:55:34,739 INFO  [app] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread \"vertx-blocked-thread-checker\"\r\n12:55:38,741 INFO  [app] Exception: java.lang.OutOfMemoryError thrown from the UncaughtExceptionHandler in thread \"executor-thread-0\"\r\n```",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/26187/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26187/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
