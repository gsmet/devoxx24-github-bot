{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31153",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31153/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31153/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31153/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/31153",
  "id": 1584243935,
  "node_id": "I_kwDOCFbutM5ebaTf",
  "number": 31153,
  "title": "Bug in Quarkus bytecode generation",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273027849,
      "node_id": "MDU6TGFiZWwxMjczMDI3ODQ5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/core",
      "name": "area/core",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/235",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/235",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/235/labels",
    "id": 9025446,
    "node_id": "MI_kwDOCFbutM4Aibem",
    "number": 235,
    "title": "3.0.0.Alpha5",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 253,
    "state": "closed",
    "created_at": "2023-02-09T14:26:03Z",
    "updated_at": "2023-11-12T17:44:08Z",
    "due_on": null,
    "closed_at": "2023-03-08T15:10:59Z"
  },
  "comments": 14,
  "created_at": "2023-02-14T14:14:44Z",
  "updated_at": "2023-02-16T02:13:31Z",
  "closed_at": "2023-02-16T02:13:27Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nHi all, I'm Ronald, the creator of [JobRunr](https://github.com/jobrunr/jobrunr), a Quartz replacement.\r\n\r\nJobRunr also integrates with Quarkus and to do so, I created a custom Quarkus Extension. I'm currently struggling with this extension.\r\n\r\nIn this extension, I've written a [RecurringJobsFinder](https://github.com/jobrunr/jobrunr/blob/bugfix/689/framework-support/jobrunr-quarkus-extension/deployment/src/main/java/org/jobrunr/quarkus/extension/deployment/RecurringJobsFinder.java) that searches for all methods annotated with @Recurring and schedules them using a recorder so that the bytecode is recorded.\r\n\r\nThis is all tested by means of integration tests here:\r\nhttps://github.com/jobrunr/jobrunr/blob/bugfix/689/framework-support/jobrunr-quarkus-extension/tests/src/main/java/org/jobrunr/quarkus/it/TestService.java#L20-L25\r\n\r\nAll of this mostly works fine but for one of these recurring jobs, I receive the following exception:\r\n\r\n```java\r\njava.lang.RuntimeException: Failed to start quarkus\r\njava.lang.RuntimeException: java.lang.RuntimeException: Failed to start quarkus\r\n    at io.quarkus.test.junit.QuarkusTestExtension.throwBootFailureException(QuarkusTestExtension.java:625)\r\n    at io.quarkus.test.junit.QuarkusTestExtension.interceptTestClassConstructor(QuarkusTestExtension.java:696)\r\n    at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)\r\n       ...\r\nCaused by: java.lang.RuntimeException: Failed to start quarkus\r\n    at io.quarkus.runner.ApplicationImpl.doStart(Unknown Source)\r\n    at io.quarkus.runtime.Application.start(Application.java:101)\r\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n    at io.quarkus.runner.bootstrap.StartupActionImpl.run(StartupActionImpl.java:253)\r\n    at io.quarkus.test.junit.QuarkusTestExtension.doJavaStart(QuarkusTestExtension.java:250)\r\n    at io.quarkus.test.junit.QuarkusTestExtension.ensureStarted(QuarkusTestExtension.java:592)\r\n    at io.quarkus.test.junit.QuarkusTestExtension.beforeAll(QuarkusTestExtension.java:640)\r\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.lambda$invokeBeforeAllCallbacks$12(ClassBasedTestDescriptor.java:395)\r\n    at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.invokeBeforeAllCallbacks(ClassBasedTestDescriptor.java:395)\r\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.before(ClassBasedTestDescriptor.java:211)\r\n    at org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.before(ClassBasedTestDescriptor.java:84)\r\n    at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:148)\r\n    ... 52 more\r\nCaused by: java.lang.UnsupportedOperationException\r\n    at java.base/java.util.Collections$UnmodifiableCollection.add(Collections.java:1060)\r\n    at io.quarkus.deployment.steps.JobRunrExtensionProcessor$findRecurringJobAnnotationsAndScheduleThem1351984528.deploy_0(Unknown Source)\r\n    at io.quarkus.deployment.steps.JobRunrExtensionProcessor$findRecurringJobAnnotationsAndScheduleThem1351984528.deploy(Unknown Source)\r\n    ... 68 more\r\n```\r\n\r\nThe bytecode generated by the `Recorder` is as follows (thanks @gastaldi!):\r\n```java\r\n    public void deploy_0(StartupContext var1, Object[] var2) {\r\n        JobRunrRecurringJobRecorder var4 = new JobRunrRecurringJobRecorder();\r\n        ArrayList var3 = new ArrayList();\r\n        JobDetails var6 = new JobDetails(\"org.jobrunr.quarkus.it.TestService\", (String)null, \"aRecurringJob\", (List)var3);\r\n        Object var5 = var1.getValue(\"proxykey93\");\r\n        var4.schedule((BeanContainer)var5, \"my-recurring-job\", var6, \"*/15 * * * *\", (String)null, (String)null);\r\n        ArrayList var7 = new ArrayList(1);\r\n        JobParameter var8 = new JobParameter(\"org.jobrunr.jobs.context.JobContext\", \"org.jobrunr.jobs.context.JobContext\", (Object)null);\r\n        ((Collection)var7).add(var8);\r\n        JobDetails var10 = new JobDetails(\"org.jobrunr.quarkus.it.TestService\", (String)null, \"anotherRecurringJob\", (List)var7);\r\n        ((Collection)var10.getJobParameters()).add(var8);\r\n        Object var9 = var1.getValue(\"proxykey93\");\r\n        var4.schedule((BeanContainer)var9, \"another-recurring-job-with-jobContext\", var10, (String)null, \"PT10M\", (String)null);\r\n    }\r\n```\r\n\r\nWe noticed that `var8` is added twice for some reason. As `((Collection)var10.getJobParameters())` returns an unmodifiable list, the second add fails. But, I do not understand the reason why the parameter is added twice in the first place as that will also cause problems later on in JobRunr (2 parameters where the method only expects 1).\r\n\r\n### Expected behavior\r\n\r\nThe parameter should only be added once.\r\n\r\n### Actual behavior\r\n\r\nThe parameter is added twice.\r\n\r\n### How to Reproduce?\r\n\r\n1. git clone https://github.com/jobrunr/jobrunr\r\n2. git checkout `bugfix/689`\r\n3. import project in Intellij\r\n4. Run test `./framework-support/jobrunr-quarkus-extension/tests/src/test/java/org/jobrunr/quarkus/it/JobRunrFunctionalityTest.java`\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nDarwin Ronalds-MacBook-Pro.local 21.6.0 Darwin Kernel Version 21.6.0: Thu Sep 29 20:13:56 PDT 2022; root:xnu-8020.240.7~1/RELEASE_ARM64_T6000 arm64\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"17.0.1\" 2021-10-19 OpenJDK Runtime Environment (build 17.0.1+12-39) OpenJDK 64-Bit Server VM (build 17.0.1+12-39, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.15.3\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nGradle 7.5.1\r\n\r\n### Additional information\r\n\r\nSee also the analysis of @gastaldi at https://quarkusio.zulipchat.com/#narrow/stream/187030-users/topic/JobRunr.20Quarkus.20extension.20-.20UnsupportedOperationException",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31153/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31153/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
