{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42591",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42591/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42591/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42591/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/42591",
  "id": 2470341289,
  "node_id": "I_kwDOCFbutM6TPmqp",
  "number": 42591,
  "title": "StringIndexOutOfBoundsException on OAuth2AuthMechanism",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/346",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/346",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/346/labels",
    "id": 11462153,
    "node_id": "MI_kwDOCFbutM4AruYJ",
    "number": 346,
    "title": "3.13.3",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 29,
    "state": "closed",
    "created_at": "2024-08-19T20:49:24Z",
    "updated_at": "2024-08-20T14:47:37Z",
    "due_on": null,
    "closed_at": "2024-08-20T10:46:01Z"
  },
  "comments": 3,
  "created_at": "2024-08-16T14:02:10Z",
  "updated_at": "2024-08-19T20:59:27Z",
  "closed_at": "2024-08-16T16:50:30Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nI'm seeing a `StringIndexOutOfBoundsException` when the Authorization header is not valid\n\n### Expected behavior\n\nIt should return an invalid header\n\n### Actual behavior\n\nthrowing `StringIndexOutOfBoundsException`\n\n### How to Reproduce?\n\nWe have an application deployed and we get the usual random worldpress requests trying to access our system, most of the requests don't cause any issues but from time to time we get a 500, the last time we saw the 500 error we noticed this error message on our logs `java.lang.StringIndexOutOfBoundsException: begin 7, end 6, length 6`. Looking at the entire error log we noticed that the error was being thrown inside `elytron-security-oauth2` more specifically in [here](https://github.com/quarkusio/quarkus/blob/main/extensions/elytron-security-oauth2/runtime/src/main/java/io/quarkus/elytron/security/oauth2/runtime/auth/OAuth2AuthMechanism.java#L45).\r\n\r\nWhat is causing this error is the fact that the _\"malicious\"_ user is not setting the Bearer token correctly. When the user sends an empty `Bearer ` the code throws an error. \n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n21\n\n### Quarkus version or git rev\n\n3.14.2\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\nThe error is caused by the string size not being checked before the substring method is called.\r\n\r\nPotential solution\r\n\r\n```\r\nString authHeader = context.request().headers().get(\"Authorization\");\r\nString bearerToken = null;\r\nif (authHeader != null && authHeader.length() > 7) {  // Ensure authHeader is long enough\r\n    bearerToken = authHeader.substring(7);\r\n}\r\nif (bearerToken != null && !bearerToken.isEmpty()) {\r\n    // Install the OAuth2 principal as the caller\r\n    return identityProviderManager\r\n            .authenticate(new TokenAuthenticationRequest(new TokenCredential(bearerToken, \"bearer\")));\r\n}\r\n// No suitable header has been found in this request,\r\nreturn Uni.createFrom().nullItem();\r\n```\r\n\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42591/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42591/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
