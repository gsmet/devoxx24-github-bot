{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42596",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42596/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42596/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42596/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/42596",
  "id": 2470523567,
  "node_id": "I_kwDOCFbutM6TQTKv",
  "number": 42596,
  "title": "Migrating from 3.2 to 3.8 fails if using Jackson ObjectMapper customization for Map serialization",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1425555736,
      "node_id": "MDU6TGFiZWwxNDI1NTU1NzM2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-orm",
      "name": "area/hibernate-orm",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate ORM"
    },
    {
      "id": 3267721944,
      "node_id": "MDU6TGFiZWwzMjY3NzIxOTQ0",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/jackson",
      "name": "area/jackson",
      "color": "0366d6",
      "default": false,
      "description": "Issues related to Jackson (JSON library)"
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 13,
  "created_at": "2024-08-16T15:48:32Z",
  "updated_at": "2024-08-17T11:31:02Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nSee reproducer here: https://github.com/andrewazores/quarkus-jackson-map-format\r\n\r\nUsing Jackson customization as per https://quarkus.io/guides/rest-json#json.\r\n\r\nWhen using Quarkus 3.2, this simple reproducer works as expected:\r\n\r\n```bash\r\n$ http -f :8080/models name=foo\r\nHTTP/1.1 200 OK\r\nContent-Type: application/json;charset=UTF-8\r\ncontent-length: 64\r\n\r\n{\r\n    \"id\": 1,\r\n    \"labels\": [\r\n        {\r\n            \"key\": \"hello\",\r\n            \"value\": \"world\"\r\n        }\r\n    ],\r\n    \"name\": \"foo\"\r\n}\r\n```\r\n\r\nThat is, the `Map<String, String> labels` field of the Model gets serialized into a list of key-value objects.\r\n\r\nWhen upgrading to the next LTS (3.8), I would hope that this still works.\r\n\r\n### Expected behavior\r\n\r\nDoing `quarkus update -S 3.8` and repeating the reproducer test should yield the same result.\r\n\r\n### Actual behavior\r\n\r\nAfter doing `quarkus update -S 3.8` and repeating the test, there are exceptions:\r\n\r\n```\r\n$ http -f :8080/models name=foo\r\nHTTP/1.1 500 Internal Server Error\r\ncontent-length: 6786\r\ncontent-type: application/json; charset=utf-8\r\n\r\n{\r\n    \"details\": \"Error id 5b1465c9-7270-4a8c-a7c5-6cf4e392a955-1, java.lang.IllegalArgumentException: Could not deserialize string to java type: JsonJavaType(java.util.Map<java.lang.String, java.lang.String>)\",\r\n    \"stack\": \"java.lang.IllegalArgumentException: Could not deserialize string to java type: JsonJavaType(java.util.Map<java.lang.String, java.lang.String>)\\n\\tat org.hibernate.type.format.jackson.JacksonJsonFormatMapper.fromString(JacksonJsonFormatMapper.java:42)\\n\\tat org.hibernate.type.descriptor.java.spi.FormatMapperBasedJavaType.fromString(FormatMapperBasedJavaType.java:61)\\n\\tat org.hibernate.type.descriptor.java.spi.FormatMapperBasedJavaType.deepCopy(FormatMapperBasedJavaType.java:110)\\n\\tat org.hibernate.type.AbstractStandardBasicType.deepCopy(AbstractStandardBasicType.java:295)\\n\\tat org.hibernate.type.AbstractStandardBasicType.deepCopy(AbstractStandardBasicType.java:291)\\n\\tat org.hibernate.type.TypeHelper.deepCopy(TypeHelper.java:52)\\n\\tat org.hibernate.event.internal.AbstractSaveEventListener.cloneAndSubstituteValues(AbstractSaveEventListener.java:359)\\n\\tat org.hibernate.event.internal.AbstractSaveEventListener.performSaveOrReplicate(AbstractSaveEventListener.java:301)\\n\\tat org.hibernate.event.internal.AbstractSaveEventListener.performSave(AbstractSaveEventListener.java:219)\\n\\tat org.hibernate.event.internal.AbstractSaveEventListener.saveWithGeneratedId(AbstractSaveEventListener.java:134)\\n\\tat org.hibernate.event.internal.DefaultPersistEventListener.entityIsTransient(DefaultPersistEventListener.java:175)\\n\\tat org.hibernate.event.internal.DefaultPersistEventListener.persist(DefaultPersistEventListener.java:93)\\n\\tat org.hibernate.event.internal.DefaultPersistEventListener.onPersist(DefaultPersistEventListener.java:77)\\n\\tat org.hibernate.event.internal.DefaultPersistEventListener.onPersist(DefaultPersistEventListener.java:54)\\n\\tat org.hibernate.event.service.internal.EventListenerGroupImpl.fireEventOnEachListener(EventListenerGroupImpl.java:127)\\n\\tat org.hibernate.internal.SessionImpl.firePersist(SessionImpl.java:758)\\n\\tat org.hibernate.internal.SessionImpl.persist(SessionImpl.java:742)\\n\\tat io.quarkus.hibernate.orm.runtime.session.TransactionScopedSession.persist(TransactionScopedSession.java:145)\\n\\tat org.hibernate.engine.spi.SessionLazyDelegator.persist(SessionLazyDelegator.java:281)\\n\\tat org.hibernate.Session_OpdLahisOZ9nWRPXMsEFQmQU03A_Synthetic_ClientProxy.persist(Unknown Source)\\n\\tat io.quarkus.hibernate.orm.panache.common.runtime.AbstractJpaOperations.persist(AbstractJpaOperations.java:101)\\n\\tat io.quarkus.hibernate.orm.panache.common.runtime.AbstractJpaOperations.persist(AbstractJpaOperations.java:96)\\n\\tat io.quarkus.hibernate.orm.panache.PanacheEntityBase.persist(PanacheEntityBase.java:53)\\n\\tat org.acme.ModelsResource.create(ModelsResource.java:33)\\n\\tat org.acme.ModelsResource_Subclass.create$$superforward(Unknown Source)\\n\\tat org.acme.ModelsResource_Subclass$$function$$2.apply(Unknown Source)\\n\\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:73)\\n\\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:62)\\n\\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:136)\\n\\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:107)\\n\\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.doIntercept(TransactionalInterceptorRequired.java:38)\\n\\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.intercept(TransactionalInterceptorBase.java:61)\\n\\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.intercept(TransactionalInterceptorRequired.java:32)\\n\\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired_Bean.intercept(Unknown Source)\\n\\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\\n\\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:30)\\n\\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:27)\\n\\tat org.acme.ModelsResource_Subclass.create(Unknown Source)\\n\\tat org.acme.ModelsResource$quarkusrestinvoker$create_79c9f3126233a8a5542a248da47e1408f1af01a5.invoke(Unknown Source)\\n\\tat org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\\n\\tat io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\\n\\tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\\n\\tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:582)\\n\\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\\n\\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\\n\\tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\\n\\tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\\n\\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\\n\\tat java.base/java.lang.Thread.run(Thread.java:840)\\nCaused by: com.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot deserialize value of type `java.util.LinkedHashMap<java.lang.String,java.lang.String>` from Array value (token `JsonToken.START_ARRAY`)\\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 1]\\n\\tat com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:59)\\n\\tat com.fasterxml.jackson.databind.DeserializationContext.reportInputMismatch(DeserializationContext.java:1767)\\n\\tat com.fasterxml.jackson.databind.DeserializationContext.handleUnexpectedToken(DeserializationContext.java:1541)\\n\\tat com.fasterxml.jackson.databind.deser.std.StdDeserializer._deserializeFromArray(StdDeserializer.java:222)\\n\\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:457)\\n\\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:32)\\n\\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\\n\\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4905)\\n\\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3848)\\n\\tat org.hibernate.type.format.jackson.JacksonJsonFormatMapper.fromString(JacksonJsonFormatMapper.java:39)\\n\\t... 48 more\"\r\n}\r\n```\r\n\r\nThe devserver stack trace is more readable of course:\r\n\r\n```\r\n2024-08-16 11:44:02,040 ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (executor-thread-1) HTTP Request to /models failed, error id: 5b1465c9-7270-4a8c-a7c5-6cf4e392a955-1: java.lang.IllegalArgumentException: Could not deserialize string to java type: JsonJavaType(java.util.Map<java.lang.String, java.lang.String>)\r\n\tat org.hibernate.type.format.jackson.JacksonJsonFormatMapper.fromString(JacksonJsonFormatMapper.java:42)\r\n\tat org.hibernate.type.descriptor.java.spi.FormatMapperBasedJavaType.fromString(FormatMapperBasedJavaType.java:61)\r\n\tat org.hibernate.type.descriptor.java.spi.FormatMapperBasedJavaType.deepCopy(FormatMapperBasedJavaType.java:110)\r\n\tat org.hibernate.type.AbstractStandardBasicType.deepCopy(AbstractStandardBasicType.java:295)\r\n\tat org.hibernate.type.AbstractStandardBasicType.deepCopy(AbstractStandardBasicType.java:291)\r\n\tat org.hibernate.type.TypeHelper.deepCopy(TypeHelper.java:52)\r\n\tat org.hibernate.event.internal.AbstractSaveEventListener.cloneAndSubstituteValues(AbstractSaveEventListener.java:359)\r\n\tat org.hibernate.event.internal.AbstractSaveEventListener.performSaveOrReplicate(AbstractSaveEventListener.java:301)\r\n\tat org.hibernate.event.internal.AbstractSaveEventListener.performSave(AbstractSaveEventListener.java:219)\r\n\tat org.hibernate.event.internal.AbstractSaveEventListener.saveWithGeneratedId(AbstractSaveEventListener.java:134)\r\n\tat org.hibernate.event.internal.DefaultPersistEventListener.entityIsTransient(DefaultPersistEventListener.java:175)\r\n\tat org.hibernate.event.internal.DefaultPersistEventListener.persist(DefaultPersistEventListener.java:93)\r\n\tat org.hibernate.event.internal.DefaultPersistEventListener.onPersist(DefaultPersistEventListener.java:77)\r\n\tat org.hibernate.event.internal.DefaultPersistEventListener.onPersist(DefaultPersistEventListener.java:54)\r\n\tat org.hibernate.event.service.internal.EventListenerGroupImpl.fireEventOnEachListener(EventListenerGroupImpl.java:127)\r\n\tat org.hibernate.internal.SessionImpl.firePersist(SessionImpl.java:758)\r\n\tat org.hibernate.internal.SessionImpl.persist(SessionImpl.java:742)\r\n\tat io.quarkus.hibernate.orm.runtime.session.TransactionScopedSession.persist(TransactionScopedSession.java:145)\r\n\tat org.hibernate.engine.spi.SessionLazyDelegator.persist(SessionLazyDelegator.java:281)\r\n\tat org.hibernate.Session_OpdLahisOZ9nWRPXMsEFQmQU03A_Synthetic_ClientProxy.persist(Unknown Source)\r\n\tat io.quarkus.hibernate.orm.panache.common.runtime.AbstractJpaOperations.persist(AbstractJpaOperations.java:101)\r\n\tat io.quarkus.hibernate.orm.panache.common.runtime.AbstractJpaOperations.persist(AbstractJpaOperations.java:96)\r\n\tat io.quarkus.hibernate.orm.panache.PanacheEntityBase.persist(PanacheEntityBase.java:53)\r\n\tat org.acme.ModelsResource.create(ModelsResource.java:33)\r\n\tat org.acme.ModelsResource_Subclass.create$$superforward(Unknown Source)\r\n\tat org.acme.ModelsResource_Subclass$$function$$2.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:73)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:62)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:136)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:107)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.doIntercept(TransactionalInterceptorRequired.java:38)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.intercept(TransactionalInterceptorBase.java:61)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.intercept(TransactionalInterceptorRequired.java:32)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:30)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:27)\r\n\tat org.acme.ModelsResource_Subclass.create(Unknown Source)\r\n\tat org.acme.ModelsResource$quarkusrestinvoker$create_79c9f3126233a8a5542a248da47e1408f1af01a5.invoke(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n\tat io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n\tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n\tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:582)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\r\n\tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n\tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:840)\r\nCaused by: com.fasterxml.jackson.databind.exc.MismatchedInputException: Cannot deserialize value of type `java.util.LinkedHashMap<java.lang.String,java.lang.String>` from Array value (token `JsonToken.START_ARRAY`)\r\n at [Source: REDACTED (`StreamReadFeature.INCLUDE_SOURCE_IN_LOCATION` disabled); line: 1, column: 1]\r\n\tat com.fasterxml.jackson.databind.exc.MismatchedInputException.from(MismatchedInputException.java:59)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.reportInputMismatch(DeserializationContext.java:1767)\r\n\tat com.fasterxml.jackson.databind.DeserializationContext.handleUnexpectedToken(DeserializationContext.java:1541)\r\n\tat com.fasterxml.jackson.databind.deser.std.StdDeserializer._deserializeFromArray(StdDeserializer.java:222)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:457)\r\n\tat com.fasterxml.jackson.databind.deser.std.MapDeserializer.deserialize(MapDeserializer.java:32)\r\n\tat com.fasterxml.jackson.databind.deser.DefaultDeserializationContext.readRootValue(DefaultDeserializationContext.java:342)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper._readMapAndClose(ObjectMapper.java:4905)\r\n\tat com.fasterxml.jackson.databind.ObjectMapper.readValue(ObjectMapper.java:3848)\r\n\tat org.hibernate.type.format.jackson.JacksonJsonFormatMapper.fromString(JacksonJsonFormatMapper.java:39)\r\n\t... 48 more\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nSee reproducer here: https://github.com/andrewazores/quarkus-jackson-map-format\r\n\r\n1. Clone reproducer\r\n2. `quarkus dev`\r\n3. `http -f :8080/models name=foo`\r\n4. Stop devserver\r\n5. `quarkus update -S 3.8`\r\n6. `quarkus dev`\r\n7. `http -f :8080/models name=foo`\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"17.0.12\" 2024-07-16 OpenJDK Runtime Environment (Red_Hat-17.0.12.0.7-2) (build 17.0.12+7) OpenJDK 64-Bit Server VM (Red_Hat-17.0.12.0.7-2) (build 17.0.12+7, mixed mode, sharing)\r\n\r\n### Quarkus version or git rev\r\n\r\n3.2.12 , 3.8.5\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n3.9.1\r\n\r\n### Additional information\r\n\r\nIt seems that in 3.2, the ObjectMapper instance that I am customizing is either a different instance, or is not used by Panache/Hibernate. Whereas in 3.8, the customization I apply (which I want for the purposes of my REST API and the format desired by the API client) becomes incorrectly applied to some other internals.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42596/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42596/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
