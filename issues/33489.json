{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33489",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33489/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33489/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33489/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/33489",
  "id": 1717081957,
  "node_id": "I_kwDOCFbutM5mWJdl",
  "number": 33489,
  "title": "@QuarkusTest hang during shutdown",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1375177076,
      "node_id": "MDU6TGFiZWwxMzc1MTc3MDc2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/testing",
      "name": "area/testing",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 2744442223,
      "node_id": "MDU6TGFiZWwyNzQ0NDQyMjIz",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/needs-reproducer",
      "name": "triage/needs-reproducer",
      "color": "FDE078",
      "default": false,
      "description": "We are waiting for a reproducer."
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 8,
  "created_at": "2023-05-19T11:16:33Z",
  "updated_at": "2023-08-31T07:58:09Z",
  "closed_at": "2023-08-31T07:58:08Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nOcassionally when running @QuarkusTest tests either through maven or IDE the application hangs during shutdown.\r\nOur team is using camel-quarkus 2.16.0 (quarkus 2.16.0.Final, camel 3.20.1) and only sometimes (which suggests some kind of race condition or similiar issue?) we get the following in logs:\r\n```\r\n2023-05-17T15:18:28,197+0200 | INFO  |                                      | Apache Camel 3.20.1 (*****) shutdown in 91ms (uptime:3s)\r\n2023-05-17T15:18:28,221+0200 | INFO  |                                      | ***** stopped in 0.129s\r\n@QuarkusTest has detected a hang, as there has been no test activity in PT10M\r\nTo configure this timeout use the quarkus.test.hang-detection-timeout config property\r\nA stack trace is below to help diagnose the potential hang\r\n=== Stack Trace ===\r\nThread main: WAITING\r\n  Waiting on java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync@7a12d696\r\n  Stack:\r\n    java.base@11.0.14.1/jdk.internal.misc.Unsafe.park(Native Method)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.LockSupport.park(LockSupport.java:194)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:885)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:917)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1240)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.ReentrantReadWriteLock$WriteLock.lock(ReentrantReadWriteLock.java:959)\r\n    app//io.quarkus.paths.ArchivePathTree$OpenArchivePathTree.close(ArchivePathTree.java:264)\r\n    app//io.quarkus.bootstrap.classloading.PathTreeClassPathElement.close(PathTreeClassPathElement.java:180)\r\n    app//io.quarkus.bootstrap.classloading.QuarkusClassLoader.close(QuarkusClassLoader.java:640)\r\n    app//io.quarkus.bootstrap.app.CuratedApplication.close(CuratedApplication.java:418)\r\n    io.quarkus.runner.bootstrap.StartupActionImpl$5.close(StartupActionImpl.java:283)\r\n    io.quarkus.runner.bootstrap.RunningQuarkusApplicationImpl.close(RunningQuarkusApplicationImpl.java:35)\r\n    app//io.quarkus.test.junit.QuarkusTestExtension$4.close(QuarkusTestExtension.java:284)\r\n    app//io.quarkus.test.junit.QuarkusTestExtension$ExtensionState.doClose(QuarkusTestExtension.java:1216)\r\n    app//io.quarkus.test.junit.QuarkusTestExtensionState.close(QuarkusTestExtensionState.java:42)\r\n    app//org.junit.jupiter.engine.execution.ExtensionValuesStore$$Lambda$2049/0x0000000841121040.execute(Unknown Source)\r\n    app//org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    app//org.junit.jupiter.engine.execution.ExtensionValuesStore.lambda$closeAllStoredCloseableValues$3(ExtensionValuesStore.java:68)\r\n    app//org.junit.jupiter.engine.execution.ExtensionValuesStore$$Lambda$2020/0x0000000841075440.accept(Unknown Source)\r\n    java.base@11.0.14.1/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n    java.base@11.0.14.1/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195)\r\n    java.base@11.0.14.1/java.util.stream.SortedOps$RefSortingSink$$Lambda$708/0x0000000840492c40.accept(Unknown Source)\r\n    java.base@11.0.14.1/java.util.ArrayList.forEach(ArrayList.java:1541)\r\n    java.base@11.0.14.1/java.util.stream.SortedOps$RefSortingSink.end(SortedOps.java:395)\r\n    java.base@11.0.14.1/java.util.stream.Sink$ChainedReference.end(Sink.java:258)\r\n    java.base@11.0.14.1/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:485)\r\n    java.base@11.0.14.1/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)\r\n    java.base@11.0.14.1/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n    java.base@11.0.14.1/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n    java.base@11.0.14.1/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n    java.base@11.0.14.1/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497)\r\n    app//org.junit.jupiter.engine.execution.ExtensionValuesStore.closeAllStoredCloseableValues(ExtensionValuesStore.java:68)\r\n    app//org.junit.jupiter.engine.descriptor.AbstractExtensionContext.close(AbstractExtensionContext.java:80)\r\n    app//org.junit.jupiter.engine.execution.JupiterEngineExecutionContext.close(JupiterEngineExecutionContext.java:53)\r\n    app//org.junit.jupiter.engine.descriptor.JupiterEngineDescriptor.cleanUp(JupiterEngineDescriptor.java:70)\r\n    app//org.junit.jupiter.engine.descriptor.JupiterEngineDescriptor.cleanUp(JupiterEngineDescriptor.java:31)\r\n    app//org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$cleanUp$10(NodeTestTask.java:167)\r\n    app//org.junit.platform.engine.support.hierarchical.NodeTestTask$$Lambda$2015/0x0000000841076040.execute(Unknown Source)\r\n    app//org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n    app//org.junit.platform.engine.support.hierarchical.NodeTestTask.cleanUp(NodeTestTask.java:167)\r\n    app//org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:98)\r\n    app//org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)\r\n    app//org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n    app//org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:147)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:127)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:90)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:55)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator$$Lambda$304/0x0000000840107040.accept(Unknown Source)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:102)\r\n    app//org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:54)\r\n    app//org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:114)\r\n    app//org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:86)\r\n    app//org.junit.platform.launcher.core.DefaultLauncherSession$DelegatingLauncher.execute(DefaultLauncherSession.java:86)\r\n    app//org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:55)\r\n    app//org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:223)\r\n    app//org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:175)\r\n    app//org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:139)\r\n    app//org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:456)\r\n    app//org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:169)\r\n    app//org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:595)\r\n    app//org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:581)\r\nThread Reference Handler: RUNNABLE\r\n  Stack:\r\n    java.base@11.0.14.1/java.lang.ref.Reference.waitForReferencePendingList(Native Method)\r\n    java.base@11.0.14.1/java.lang.ref.Reference.processPendingReferences(Reference.java:241)\r\n    java.base@11.0.14.1/java.lang.ref.Reference$ReferenceHandler.run(Reference.java:213)\r\nThread Finalizer: WAITING\r\n  Waiting on java.lang.ref.ReferenceQueue$Lock@7e2d4d0c\r\n  Stack:\r\n    java.base@11.0.14.1/java.lang.Object.wait(Native Method)\r\n    java.base@11.0.14.1/java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:155)\r\n    java.base@11.0.14.1/java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:176)\r\n    java.base@11.0.14.1/java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:170)\r\nThread Signal Dispatcher: RUNNABLE\r\n  Stack:\r\nThread Common-Cleaner: TIMED_WAITING\r\n  Stack:\r\n    java.base@11.0.14.1/java.lang.Object.wait(Native Method)\r\n    java.base@11.0.14.1/java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:155)\r\n    java.base@11.0.14.1/jdk.internal.ref.CleanerImpl.run(CleanerImpl.java:148)\r\n    java.base@11.0.14.1/java.lang.Thread.run(Thread.java:829)\r\n    java.base@11.0.14.1/jdk.internal.misc.InnocuousThread.run(InnocuousThread.java:161)\r\nThread surefire-forkedjvm-stream-flusher: TIMED_WAITING\r\n  Stack:\r\n    java.base@11.0.14.1/jdk.internal.misc.Unsafe.park(Native Method)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:234)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2123)\r\n    java.base@11.0.14.1/java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:1182)\r\n    java.base@11.0.14.1/java.util.concurrent.ScheduledThreadPoolExecutor$DelayedWorkQueue.take(ScheduledThreadPoolExecutor.java:899)\r\n    java.base@11.0.14.1/java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1054)\r\n    java.base@11.0.14.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1114)\r\n    java.base@11.0.14.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n    java.base@11.0.14.1/java.lang.Thread.run(Thread.java:829)\r\nThread surefire-forkedjvm-command-thread: RUNNABLE\r\n  Stack:\r\n    java.base@11.0.14.1/java.io.FileInputStream.readBytes(Native Method)\r\n    java.base@11.0.14.1/java.io.FileInputStream.read(FileInputStream.java:279)\r\n    java.base@11.0.14.1/java.io.BufferedInputStream.read1(BufferedInputStream.java:290)\r\n    java.base@11.0.14.1/java.io.BufferedInputStream.read(BufferedInputStream.java:351)\r\n    java.base@11.0.14.1/java.io.BufferedInputStream.fill(BufferedInputStream.java:252)\r\n    java.base@11.0.14.1/java.io.BufferedInputStream.read1(BufferedInputStream.java:292)\r\n    java.base@11.0.14.1/java.io.BufferedInputStream.read(BufferedInputStream.java:351)\r\n    app//org.apache.maven.surefire.api.util.internal.Channels$3.readImpl(Channels.java:217)\r\n    app//org.apache.maven.surefire.api.util.internal.AbstractNoninterruptibleReadableChannel.read(AbstractNoninterruptibleReadableChannel.java:54)\r\n    app//org.apache.maven.surefire.api.stream.AbstractStreamDecoder.read(AbstractStreamDecoder.java:484)\r\n    app//org.apache.maven.surefire.api.stream.AbstractStreamDecoder.read(AbstractStreamDecoder.java:470)\r\n    app//org.apache.maven.surefire.api.stream.AbstractStreamDecoder.readMessageType(AbstractStreamDecoder.java:118)\r\n    app//org.apache.maven.surefire.booter.stream.CommandDecoder.decode(CommandDecoder.java:87)\r\n    app//org.apache.maven.surefire.booter.spi.CommandChannelDecoder.decode(CommandChannelDecoder.java:67)\r\n    app//org.apache.maven.surefire.booter.CommandReader$CommandRunnable.run(CommandReader.java:345)\r\n    java.base@11.0.14.1/java.lang.Thread.run(Thread.java:829)\r\nThread Quarkus hang detection timer thread: RUNNABLE\r\n  Stack:\r\n    java.management@11.0.14.1/sun.management.ThreadImpl.dumpThreads0(Native Method)\r\n    java.management@11.0.14.1/sun.management.ThreadImpl.dumpAllThreads(ThreadImpl.java:521)\r\n    java.management@11.0.14.1/sun.management.ThreadImpl.dumpAllThreads(ThreadImpl.java:509)\r\n    app//io.quarkus.test.junit.QuarkusTestExtension$1.run(QuarkusTestExtension.java:152)\r\n    java.base@11.0.14.1/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n    java.base@11.0.14.1/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n    java.base@11.0.14.1/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\r\n    java.base@11.0.14.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n    java.base@11.0.14.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n    java.base@11.0.14.1/java.lang.Thread.run(Thread.java:829)\r\nThread testcontainers-ryuk: TIMED_WAITING\r\n  Stack:\r\n    java.base@11.0.14.1/java.lang.Object.wait(Native Method)\r\n    org.testcontainers.utility.RyukResourceReaper.lambda$null$0(RyukResourceReaper.java:102)\r\n    org.testcontainers.utility.RyukResourceReaper$$Lambda$1199/0x00000008407c9040.run(Unknown Source)\r\n    org.rnorth.ducttape.ratelimits.RateLimiter.doWhenReady(RateLimiter.java:27)\r\n    org.testcontainers.utility.RyukResourceReaper.lambda$maybeStart$1(RyukResourceReaper.java:88)\r\n    org.testcontainers.utility.RyukResourceReaper$$Lambda$1198/0x00000008407c8c40.run(Unknown Source)\r\n    java.base@11.0.14.1/java.lang.Thread.run(Thread.java:829)\r\nThread ForkJoinPool.commonPool-worker-17: WAITING\r\n  Waiting on java.util.concurrent.ForkJoinPool@1a8e1c8b\r\n  Stack:\r\n    java.base@11.0.14.1/jdk.internal.misc.Unsafe.park(Native Method)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.LockSupport.park(LockSupport.java:194)\r\n    java.base@11.0.14.1/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1628)\r\n    java.base@11.0.14.1/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)\r\nThread ForkJoinPool.commonPool-worker-7: TIMED_WAITING\r\n  Stack:\r\n    java.base@11.0.14.1/jdk.internal.misc.Unsafe.park(Native Method)\r\n    java.base@11.0.14.1/java.util.concurrent.locks.LockSupport.parkUntil(LockSupport.java:275)\r\n    java.base@11.0.14.1/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1619)\r\n    java.base@11.0.14.1/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:183)\r\nThread Attach Listener: RUNNABLE\r\n  Stack:\r\n=== End Stack Trace ===\r\n```\r\nNone of the threads are stuck in any of our classes and the most likely 'stuck' one is the MAIN thread trying to stop quarkus.\r\nAny ideas what might be the root cause, how to fix it or how to debug it to learn more?\r\n\r\nI can more or less reproduce the issue but it can take up to 10+ attempts running the test for it to reoccur.\r\nI believe the problem started to occur at some point after updating camel-quarkus, adding quarkus-jacoco and propely setting it up as explained in the guide here https://quarkus.io/guides/tests-with-coverage but skipping the parts about Integration Tests.\n\n### Expected behavior\n\n@QuarkusTest shutdown without issues.\n\n### Actual behavior\n\n@QuarkusTest hangs indefinitely (up to 1h in CI-CD after which the pipeline/job times out) during shutdown.\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n11\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.16.0.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33489/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33489/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
