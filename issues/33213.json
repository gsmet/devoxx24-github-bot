{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33213",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33213/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33213/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33213/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/33213",
  "id": 1701509218,
  "node_id": "I_kwDOCFbutM5lavhi",
  "number": 33213,
  "title": "Prefixed env vars used during build are included and required during runtime when using ConfigMapping",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273030910,
      "node_id": "MDU6TGFiZWwxMjczMDMwOTEw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/config",
      "name": "area/config",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/250",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/250",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/250/labels",
    "id": 9407630,
    "node_id": "MI_kwDOCFbutM4Aj4yO",
    "number": 250,
    "title": "3.2.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 244,
    "state": "closed",
    "created_at": "2023-05-17T07:29:12Z",
    "updated_at": "2023-11-15T13:59:38Z",
    "due_on": null,
    "closed_at": "2023-06-21T13:08:09Z"
  },
  "comments": 6,
  "created_at": "2023-05-09T07:25:17Z",
  "updated_at": "2023-06-13T11:34:27Z",
  "closed_at": "2023-06-13T11:34:19Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen using `ConfigMapping` all environment variables on the build machine starting with the prefix, that is not included in the conf, will be included in the build and required to be present when running the app.\r\n\r\n### Expected behavior\r\n\r\nThe build shouldn't include prefixed env vars that are not defined in the `ConfigMapping`, and you should be able to run the app even though you happen to have an env var on the build machine that looks like it should be mapped.\r\n\r\n### Actual behavior\r\n\r\nEven though `PREFIX_NEW` is not defined in the `ConfigMapping` it is required in order to run the app.\r\n\r\n```bash\r\nException in thread \"main\" java.lang.reflect.InvocationTargetException\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.doRun(QuarkusEntryPoint.java:61)\r\n\tat io.quarkus.bootstrap.runner.QuarkusEntryPoint.main(QuarkusEntryPoint.java:32)\r\nCaused by: java.lang.ExceptionInInitializerError\r\n\tat io.quarkus.runner.ApplicationImpl.<clinit>(Unknown Source)\r\n\tat java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n\tat java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:499)\r\n\tat java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:480)\r\n\tat io.quarkus.runtime.Quarkus.run(Quarkus.java:70)\r\n\tat io.quarkus.runtime.Quarkus.run(Quarkus.java:44)\r\n\tat io.quarkus.runtime.Quarkus.run(Quarkus.java:124)\r\n\tat io.quarkus.runner.GeneratedMain.main(Unknown Source)\r\n\t... 6 more\r\nCaused by: io.smallrye.config.ConfigValidationException: Configuration validation failed:\r\n\tprefix.new does not map to any root\r\n\tat io.smallrye.config.ConfigMappingProvider.mapConfigurationInternal(ConfigMappingProvider.java:979)\r\n\tat io.smallrye.config.ConfigMappingProvider.lambda$mapConfiguration$3(ConfigMappingProvider.java:935)\r\n\tat io.smallrye.config.SecretKeys.doUnlocked(SecretKeys.java:28)\r\n\tat io.smallrye.config.ConfigMappingProvider.mapConfiguration(ConfigMappingProvider.java:935)\r\n\tat io.smallrye.config.ConfigMappings.mapConfiguration(ConfigMappings.java:91)\r\n\tat io.smallrye.config.SmallRyeConfigBuilder.build(SmallRyeConfigBuilder.java:624)\r\n\tat io.quarkus.runtime.generated.Config.<clinit>(Unknown Source)\r\n\t... 16 more\r\n```\r\n\r\nIn the `ConfigMapping` I've only defined the property `test`. There is no mapping for `new`.\r\n\r\n### How to Reproduce?\r\n\r\n```bash\r\ngit clone git@github.com:rasmushaglund/quarkus-env-bug.git\r\ncd quarkus-env-bug\r\nexport PREFIX_NEW=hello && ./mvnw clean package && unset PREFIX_NEW && java -jar target/quarkus-app/quarkus-run.jar\r\n```\r\n\r\nWhen not using the env var it works as expected (make sure to unset all env var starting with `PREFIX_` first):\r\n```bash\r\ngit clone git@github.com:rasmushaglund/quarkus-env-bug.git\r\ncd quarkus-env-bug\r\n./mvnw clean package && java -jar target/quarkus-app/quarkus-run.jar\r\n```\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux bifrost 5.19.0-38-generic #39-Ubuntu SMP PREEMPT_DYNAMIC Fri Mar 17 17:33:16 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk 17.0.6 2023-01-17 OpenJDK Runtime Environment (build 17.0.6+10-Ubuntu-0ubuntu122.10) OpenJDK 64-Bit Server VM (build 17.0.6+10-Ubuntu-0ubuntu122.10, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n3.0.2.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.8 (4c87b05d9aedce574290d1acc98575ed5eb6cd39) Maven home: /home/rasmus/.m2/wrapper/dists/apache-maven-3.8.8-bin/67c30f74/apache-maven-3.8.8 Java version: 17.0.6, vendor: Private Build, runtime: /usr/lib/jvm/java-17-openjdk-amd64 Default locale: en_US, platform encoding: UTF-8 OS name: \"linux\", version: \"5.19.0-38-generic\", arch: \"amd64\", family: \"unix\"\r\n\r\n### Additional information\r\n\r\nI found out the bug because I have a `ConfigMapping` with a prefix, let's say, `server`, and then in the integration tests use the env var `SERVER_TOKEN` that isn't intended to be included in the mapping. I didn't expect the build process to try to map `SERVER_TOKEN` to the `ConfigMapping` `server.token` and then require `server.token` to be defined during runtime.\r\n\r\nImagine creating a `ConfigMapping` with the prefix \"http\" with properties like \"url\", \"port\" but the build server has the env var `HTTP_PROXY` set. That will build the app with the `HTTP_PROXY` env var included, and require `HTTP_PROXY` or `http.proxy` to be set in order to run the app, which is not intended.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33213/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33213/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
