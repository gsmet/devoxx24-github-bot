{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31899",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31899/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31899/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31899/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/31899",
  "id": 1627329619,
  "node_id": "I_kwDOCFbutM5g_xRT",
  "number": 31899,
  "title": "Default to the `pooled-lo` optimizer in Hibernate ORM",
  "labels": [
    {
      "id": 985346622,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjI=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/enhancement",
      "name": "kind/enhancement",
      "color": "a2eeef",
      "default": false,
      "description": "New feature or request"
    },
    {
      "id": 1273026509,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTA5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/persistence",
      "name": "area/persistence",
      "color": "FBCA04",
      "default": false,
      "description": "OBSOLETE, DO NOT USE"
    },
    {
      "id": 1425555736,
      "node_id": "MDU6TGFiZWwxNDI1NTU1NzM2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-orm",
      "name": "area/hibernate-orm",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate ORM"
    },
    {
      "id": 5080736243,
      "node_id": "LA_kwDOCFbutM8AAAABLtXh8w",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/quarkus-3",
      "name": "triage/quarkus-3",
      "color": "BA41B2",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/240",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/240",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/240/labels",
    "id": 9161556,
    "node_id": "MI_kwDOCFbutM4Ai8tU",
    "number": 240,
    "title": "3.0.0.Beta1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 94,
    "state": "closed",
    "created_at": "2023-03-15T07:49:49Z",
    "updated_at": "2023-05-15T13:59:51Z",
    "due_on": null,
    "closed_at": "2023-03-22T14:24:37Z"
  },
  "comments": 8,
  "created_at": "2023-03-16T12:01:05Z",
  "updated_at": "2023-03-20T13:56:08Z",
  "closed_at": "2023-03-20T13:56:02Z",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nTo be considered for Quarkus 3 as a way to address the infamous backwards-incompatible sequence changes in Hibernate ORM (see #31521)\r\n\r\nHibernate ORM defaults to the `pooled` optimizer, which assumes the pool of IDs it can use is between `<sequence value >-<increment size>+1` and `<sequence value>`.\r\n\r\nIt works, but has a significant downside: every time you restart a sequence manually (native SQL, import script) you have to take care to set the value to `max(id) + <increment size>`, otherwise Hibernate ORM will use incorrect IDs. E.g. if you your max id is 2 and you restart your sequence to 3, next time Hibernate ORM retrieves the sequence value it will assign IDs between `3-<increment size>+1` and `3`, which, with the default increment size of 50, leads to Hibernate ORM starting with negative IDs (`-46`, `-47`, ...) and eventually coming all the way back to **already assigned IDs**, i.e. `1`, `2`.\r\n\r\nSo, that can be surprising, and hence it's not a great default.\r\n\r\nHibernate ORM provides another optimizer, `pooled-lo`. That optimizer will assume the pool of IDs it can use is between `<sequence value>` and `<sequence value>+<increment size>-1`... which removes the problem mentioned above: if you restart your sequence to 3, Hibernate ORM will use IDs `3` to `52`, which is exactly what you'd naively assume.\r\n\r\nInterestingly, switching from the `pooled` optimizer to the `pooled-lo` optimizer... is a backwards-compatible change! If the `pooled` optimizer leaves the sequence with e.g. value `151` (intending to use values `101` to `151` in the next pool), then upon restarting after changing the optimizer, the `pooled-lo` optimizer will simply skip those values and use values `151` to `200` instead.\r\n\r\nSo, we could consider making the `pooled-lo` optimizer the default in Quarkus. The only problem would be if other actors hit the database and expect the `pooled` optimizer to be used; they might end up using IDs that the `pooled-lo` optimizer already used. We might consider this acceptable, since:\r\n\r\n1. Those collisions will lead to immediate error messages, assuming the DB has integrity constraints on primary keys (all DBs do, right? right?)\r\n2. People in this situation are probably advanced users who can debug this.\r\n\r\nSee https://docs.jboss.org/hibernate/orm/current/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators-optimizer for documentation about Hibernate ORM optimizers.\r\n\r\n### Implementation ideas\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31899/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31899/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
