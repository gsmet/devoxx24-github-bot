{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33069",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33069/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33069/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33069/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/33069",
  "id": 1692779421,
  "node_id": "I_kwDOCFbutM5k5cOd",
  "number": 33069,
  "title": "AppCDS build step with JDK 17 source/target uses absolute classpath",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273027849,
      "node_id": "MDU6TGFiZWwxMjczMDI3ODQ5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/core",
      "name": "area/core",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/245",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/245",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/245/labels",
    "id": 9272809,
    "node_id": "MI_kwDOCFbutM4AjX3p",
    "number": 245,
    "title": "3.1.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 1,
    "closed_issues": 189,
    "state": "closed",
    "created_at": "2023-04-12T07:42:31Z",
    "updated_at": "2024-04-17T06:04:35Z",
    "due_on": null,
    "closed_at": "2023-05-17T12:28:33Z"
  },
  "comments": 1,
  "created_at": "2023-05-02T17:02:42Z",
  "updated_at": "2023-05-09T18:14:30Z",
  "closed_at": "2023-05-09T18:14:25Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen creating an AppCDS jsa archive Quarkus' `AppCDSBuildStep` class uses absolute paths for the class path when the dynamic archive is being dumped with `-XX:ArchiveClassesAtExit=<jsa-file>`. This makes the feature less usable, since on systems where the exact same classpath would be available, yet the **absolute** path to the jar file is different mapping the CDS archive fails.\r\n\r\nThe JDK is smart enough to handle the relative class path use-case, thus, using relative paths would be the preferred option. Using the older `-Xshare:dump` with classlist file doesn't seem to have that problem.\r\n\r\n### Expected behavior\r\n\r\nAppCDS archive usable if JDK matches, classpath matches, yet the absolute path to the jar(s) is different.\r\n\r\n### Actual behavior\r\n\r\nJVM fails to map the CDS archive. Example with `-Xshare:on` so as to provoke a JVM start error when mapping fails:\r\n\r\n```\r\n$ java -Xlog:cds,class+path -Xshare:on -XX:SharedArchiveFile=app-cds.jsa -jar getting-started-1.0.0-SNAPSHOT-runner.jar \r\n[0.001s][info][class,path] bootstrap loader class path=/usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/modules\r\n[0.005s][info][cds       ] trying to map /usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/server/classes.jsa\r\n[0.005s][info][cds       ] Opened archive /usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/server/classes.jsa.\r\n[0.005s][info][cds       ] Archive was created with UseCompressedOops = 1, UseCompressedClassPointers = 1\r\n[0.005s][info][cds       ] Core region alignment: 4096\r\n[0.005s][info][cds       ] trying to map app-cds.jsa\r\n[0.005s][info][cds       ] Opened archive app-cds.jsa.\r\n[0.005s][info][cds       ] Archive was created with UseCompressedOops = 1, UseCompressedClassPointers = 1\r\n[0.005s][info][cds       ] Reserved archive_space_rs [0x0000000800000000 - 0x0000000801c00000] (29360128) bytes\r\n[0.005s][info][cds       ] Reserved class_space_rs   [0x0000000801c00000 - 0x0000000841c00000] (1073741824) bytes\r\n[0.005s][info][cds       ] Mapped static  region #0 at base 0x0000000800000000 top 0x0000000800458000 (ReadWrite)\r\n[0.005s][info][cds       ] Mapped static  region #1 at base 0x0000000800458000 top 0x0000000800be1000 (ReadOnly)\r\n[0.005s][info][class,path] Expecting BOOT path=/usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/modules\r\n[0.005s][info][class,path] Expecting -Djava.class.path=\r\n[0.005s][info][class,path] checking shared classpath entry: /usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/modules\r\n[0.005s][info][class,path] ok\r\n[0.005s][info][cds       ] Mapped dynamic region #0 at base 0x0000000800be1000 top 0x0000000801180000 (ReadWrite)\r\n[0.005s][info][cds       ] Mapped dynamic region #1 at base 0x0000000801180000 top 0x0000000801941000 (ReadOnly)\r\n[0.005s][info][class,path] Expecting BOOT path=/usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/modules\r\n[0.005s][info][class,path] Expecting -Djava.class.path=/home/sgehwolf/Documents/openjdk/quarkus/quarkus-quickstarts/getting-started/target/getting-started-1.0.0-SNAPSHOT-runner.jar\r\n[0.005s][info][class,path] checking shared classpath entry: /usr/lib/jvm/java-17-openjdk-17.0.6.0.10-1.fc37.x86_64/lib/modules\r\n[0.005s][info][class,path] ok\r\n[0.005s][info][class,path] checking shared classpath entry: /home/sgehwolf/Documents/openjdk/quarkus/quarkus-quickstarts/getting-started/target/getting-started-1.0.0-SNAPSHOT-runner.jar\r\n[0.005s][info][class,path] ok\r\n[0.005s][info][class,path] [APP classpath mismatch, actual: -Djava.class.path=getting-started-1.0.0-SNAPSHOT-runner.jar\r\nAn error has occurred while processing the shared archive file.\r\nshared class paths mismatch (hint: enable -Xlog:class+path=info to diagnose the failure)\r\nError occurred during initialization of VM\r\nUnable to use shared archive.\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nReproducer\r\n\r\n1. Build with `-Dmaven.compiler.source=17 -Dmaven.compiler.target=17 -Dquarkus.package.create-appcds=true -Dquarkus.package.type=uber-jar` (e.g. `getting-started` from quarkus-quickstarts)\r\n2. `cd target`\r\n3. `mkdir test && cp -a app-cds.jsa getting-started*.jar test && cd test`\r\n4. `java -Xshare:on -XX:SharedArchiveFile=app-cds.jsa -jar getting-started-1.0.0-SNAPSHOT-runner.jar`\r\n\r\nNote that if run from the `target` folder, not the subfolder `test` (i.e. build time identical), using the CDS archive works.\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\n17.0.7\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n6c7268b90a6f0d76cea39c3ad4520526e66275d9\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nmaven\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33069/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33069/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
