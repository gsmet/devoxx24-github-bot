{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27208",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27208/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27208/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27208/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/27208",
  "id": 1333439193,
  "node_id": "I_kwDOCFbutM5PeqrZ",
  "number": 27208,
  "title": "quarkus lambda function.zip does not contain UPX compressed bootstrap file using gradle",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1326073020,
      "node_id": "MDU6TGFiZWwxMzI2MDczMDIw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/amazon-lambda",
      "name": "area/amazon-lambda",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/203",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/203",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/203/labels",
    "id": 8338033,
    "node_id": "MI_kwDOCFbutM4Afzpx",
    "number": 203,
    "title": "2.11.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 46,
    "state": "closed",
    "created_at": "2022-08-23T15:38:25Z",
    "updated_at": "2023-01-13T10:56:46Z",
    "due_on": null,
    "closed_at": "2022-08-24T09:02:44Z"
  },
  "comments": 2,
  "created_at": "2022-08-09T15:36:28Z",
  "updated_at": "2022-08-23T15:43:22Z",
  "closed_at": "2022-08-10T13:34:51Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nwhen running:\r\n\r\n`./gradlew build -Dquarkus.package.type=native -Dquarkus.native.compression.level=7 -D\r\nquarkus.native.native-image-xmx=10g -x check`\r\n\r\nMy expectation is that the generated function.zip file would contain the UPX packed runner but the uncompressed runner is included in the zip\n\n### Expected behavior\n\nThe function.zip should contain the UPX compressed runner\n\n### Actual behavior\n\nthe function.zip file contains the uncompressed original runner\n\n### How to Reproduce?\n\nusing gradlew 7.5.1. against quarkus 2.11.2.FINAL with UPX installed on linux (either 3.95 or 3.96) build any native binary using the gradle commandline:\r\n\r\n`./gradlew build -Dquarkus.package.type=native -Dquarkus.native.compression.level=7 -D\r\nquarkus.native.native-image-xmx=10g -x check`\r\n\r\n\r\nbuild.gradle contains:\r\n    id 'io.quarkus' version '2.11.2.Final'\r\n\r\n...\r\n    implementation(enforcedPlatform('io.quarkus:quarkus-bom:2.11.2.Final'))\n\n### Output of `uname -a` or `ver`\n\nLinux DEVICE-D113HSFM 5.10.102.1-microsoft-standard-WSL2 #1 SMP Wed Mar 2 00:30:59 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux (but also other native ubuntu)\n\n### Output of `java -version`\n\nopenjdk 17.0.4 2022-07-19 OpenJDK Runtime Environment GraalVM CE 22.2.0 (build 17.0.4+8-jvmci-22.2-b06) OpenJDK 64-Bit Server VM GraalVM CE 22.2.0 (build 17.0.4+8-jvmci-22.2-b06, mixed mode, sharing)\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.11.2.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n```------------------------------------------------------------ Gradle 7.5.1 ------------------------------------------------------------  Build time:   2022-08-05 21:17:56 UTC Revision:     d1daa0cbf1a0103000b71484e1dbfe096e095918  Kotlin:       1.6.21 Groovy:       3.0.10 Ant:          Apache Ant(TM) version 1.10.11 compiled on July 10 2021 JVM:          17.0.4 (GraalVM Community 17.0.4+8-jvmci-22.2-b06) OS:           Linux 5.10.102.1-microsoft-standard-WSL2 amd64```\n\n### Additional information\n\nThis did used to work, but upgrading to the latest versions of everything we can find does not appear to fix anything. We are seeing the original runner added to the function.zip and whilst the UPX process is running, and the runner is the UPX compressed runner on the disk when the build completes it is not in the function.zip\r\n\r\n```\r\nWARNING: Unknown module: org.graalvm.nativeimage.llvm specified to --add-exports\r\nWARNING: Unknown module: org.graalvm.nativeimage.llvm specified to --add-exports\r\nWARNING: Unknown module: org.graalvm.nativeimage.llvm specified to --add-exports\r\n========================================================================================================================\r\nGraalVM Native Image: Generating 'yada-yada-unspecified-runner' (executable)...\r\n========================================================================================================================\r\n[1/7] Initializing...                                                                                   (16.1s @ 0.31GB)\r\n Version info: 'GraalVM 22.2.0 Java 17 CE'                                                                              \r\n Java version info: '17.0.4+8-jvmci-22.2-b06'                                                                           \r\n C compiler: gcc (linux, x86_64, 9.4.0)                                                                                 \r\n Garbage collector: Serial GC\r\n 4 user-specific feature(s)\r\n - io.quarkus.runner.Feature\r\n - io.quarkus.runtime.graal.DisableLoggingFeature\r\n - io.quarkus.runtime.graal.ResourcesFeature\r\n - org.graalvm.home.HomeFinderFeature: Finds GraalVM paths and its version number\r\n[2/7] Performing analysis...  [*********]                                                               (95.9s @ 1.76GB)\r\n  28,192 (96.03%) of 29,356 classes reachable                                                                           \r\n  41,800 (75.88%) of 55,084 fields reachable                                                                            \r\n 154,280 (73.55%) of 209,765 methods reachable                                                                          \r\n   4,306 classes, 14,569 fields, and 75,832 methods registered for reflection\r\n      65 classes,    75 fields, and    56 methods registered for JNI access\r\n       4 native libraries: dl, pthread, rt, z\r\n[3/7] Building universe...                                                                               (4.9s @ 2.85GB)\r\n[4/7] Parsing methods...      [****]                                                                    (16.1s @ 2.21GB)\r\n[5/7] Inlining methods...     [****]                                                                     (5.0s @ 3.45GB)\r\n[6/7] Compiling methods...    [*********]                                                               (88.3s @ 2.22GB)\r\n[7/7] Creating image...                                                                                 (20.2s @ 3.92GB)\r\n  49.91MB (35.55%) for code area:   126,542 compilation units                                                           \r\n  90.18MB (64.22%) for image heap:  619,857 objects and 7,109 resources                                                 \r\n 332.48KB ( 0.23%) for other data                                                                                       \r\n 140.41MB in total\r\n------------------------------------------------------------------------------------------------------------------------\r\nTop 10 packages in code area:                               Top 10 object types in image heap:\r\n  11.56MB software.amazon.awssdk.services.ssm.model           33.85MB byte[] for embedded resources\r\n   4.87MB software.amazon.awssdk.services.dynamodb.model       9.98MB byte[] for code metadata\r\n   3.34MB software.amazon.awssdk.services.eventbridge.model    6.99MB byte[] for java.lang.String\r\n   1.86MB com.oracle.svm.core.code                             6.96MB java.lang.Class\r\n   1.63MB sun.security.ssl                                     6.08MB byte[] for reflection metadata\r\n   1.30MB com.oracle.svm.core.reflect                          4.46MB java.lang.String\r\n   1.03MB java.util                                            3.66MB byte[] for general heap data\r\n 977.70KB software.amazon.awssdk.services.sqs.model            3.62MB c.oracle.svm.core.reflect.SubstrateMethodAccessor\r\n 856.77KB software.amazon.awssdk.services.dynamodb             2.37MB com.oracle.svm.core.hub.DynamicHubCompanion\r\n 736.04KB com.sun.crypto.provider                              1.79MB java.lang.Object[]\r\n  20.77MB for 499 more packages                                9.95MB for 11431 more object types\r\n------------------------------------------------------------------------------------------------------------------------\r\n                        15.8s (6.1% of total time) in 59 GCs | Peak RSS: 5.84GB | CPU load: 5.39                        \r\n------------------------------------------------------------------------------------------------------------------------\r\nProduced artifacts:                                                                                                     \r\nyada-yada--update-unspecified-native-image-source-jar/yada-yada--update-unspecified-runner (executable)\r\n yada-yada-unspecified-native-image-source-jar/yada-yada--unspecified-runner.build_artifacts.txt (txt)\r\n========================================================================================================================\r\nFinished generating 'yada-yada-unspecified-runner' in 4m 15s.\r\n                       Ultimate Packer for eXecutables                       \r\n                          Copyright (C) 1996 - 2018                          \r\nUPX 3.95        Markus Oberhumer, Laszlo Molnar & John Reiser   Aug 26th 2018\r\n\r\n        File size         Ratio      Format      Name\r\n   --------------------   ------   -----------   -----------\r\n 147102264 ->  34487024   23.44%   linux/amd64   yada-yada-unspecified-runner\r\n\r\nPacked 1 file.\r\n\r\nDeprecated Gradle features were used in this build, making it incompatible with Gradle 8.0.\r\n\r\n```\r\n\r\nThe stack trace above is from my WSL build but the Ubuntu/Jenkins builds show the same outputs with UPX 3.96\r\n\r\nThe function.zip contains a bootsrap file of  147102264 bytes not the expected 34487024 bytes",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27208/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27208/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
