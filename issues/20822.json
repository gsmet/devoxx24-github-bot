{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20822",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20822/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20822/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20822/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/20822",
  "id": 1028789668,
  "node_id": "I_kwDOCFbutM49UhWk",
  "number": 20822,
  "title": "Memory leak with Resteasy byte response?",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1282147660,
      "node_id": "MDU6TGFiZWwxMjgyMTQ3NjYw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/resteasy-classic",
      "name": "area/resteasy-classic",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/152",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/152",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/152/labels",
    "id": 7239525,
    "node_id": "MI_kwDOCFbutM4Abndl",
    "number": 152,
    "title": "2.5.0.CR1",
    "description": "",
    "creator": {
      "login": "aloubyansky",
      "id": 323379,
      "node_id": "MDQ6VXNlcjMyMzM3OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/323379?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aloubyansky",
      "html_url": "https://github.com/aloubyansky",
      "followers_url": "https://api.github.com/users/aloubyansky/followers",
      "following_url": "https://api.github.com/users/aloubyansky/following{/other_user}",
      "gists_url": "https://api.github.com/users/aloubyansky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aloubyansky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aloubyansky/subscriptions",
      "organizations_url": "https://api.github.com/users/aloubyansky/orgs",
      "repos_url": "https://api.github.com/users/aloubyansky/repos",
      "events_url": "https://api.github.com/users/aloubyansky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aloubyansky/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 305,
    "state": "closed",
    "created_at": "2021-10-11T08:43:12Z",
    "updated_at": "2022-01-07T16:32:59Z",
    "due_on": null,
    "closed_at": "2021-11-10T17:25:22Z"
  },
  "comments": 11,
  "created_at": "2021-10-18T08:25:45Z",
  "updated_at": "2021-10-25T04:52:40Z",
  "closed_at": "2021-10-25T04:52:38Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI implement a rest API that should return binary content.\r\nAfter calling the service a bunch of times (depends on the response size), it runs out of memory and returns an OOM exception: \"org.jboss.resteasy.spi.UnhandledException: java.lang.OutOfMemoryError: Direct buffer memory\".\r\n\r\n### Expected behavior\r\n\r\nI expect the used DirectBufferMemory to be freed at some point.\r\n\r\n### Actual behavior\r\n\r\nThe DirectBufferMemory is not released and therefore grows with each request.\r\n\r\nSending requests with curl (without doing anything with the response) leads to memory increase.\r\n\r\nI investigated some heap dumps and it seems like netty.PoolChunk instances prevent the DirectByteBuffer objects from being removed.\r\n\r\n### How to Reproduce?\r\n\r\nI reproduced the behavior with some small changes to the getting-started project's GreetingResource. It now produces \"image/png\" instead of \"application/json\" and basically loads a file and returns it as byte array. The code of the GreetingResource.java is the following:\r\n\r\n```\r\npackage org.acme.getting.started;\r\n\r\nimport javax.ws.rs.GET;\r\nimport javax.ws.rs.Path;\r\nimport javax.ws.rs.Produces;\r\nimport javax.ws.rs.core.Response;\r\nimport java.io.IOException;\r\nimport java.nio.file.Files;\r\nimport java.nio.file.Paths;\r\n\r\n@Path(\"/hello\")\r\npublic class GreetingResource {\r\n\r\n    @GET()\r\n    @Produces({\"image/png\", \"application/json\"})\r\n    public Response hello() {\r\n        try {\r\n            // The big.png file is a 30MB binary file.\r\n            byte[] fileContent = Files.readAllBytes(Paths.get(\".\", \"target\", \"classes\", \"files\", \"big.png\"));\r\n            return Response.ok(fileContent).build();\r\n        } catch (IOException e) {\r\n            e.printStackTrace();\r\n        }\r\n        return Response.noContent().build();\r\n    }\r\n}\r\n```\r\n\r\nAfter starting Quarkus dev mode on my local computer I can send approximately 300 curl requests (that do just fire and forget) until the service runs out of memory:\r\n\r\n`curl --request GET \"http://localhost:8080/hello\" -w 'http_status: %{http_code}\\n' -s`\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\n11.0.7\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.3.0\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.1\r\n\r\n### Additional information\r\n\r\n[Quarkus-getting-started.zip](https://github.com/quarkusio/quarkus/files/7364233/Quarkus-getting-started.zip)\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20822/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20822/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
