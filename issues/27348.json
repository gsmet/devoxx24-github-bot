{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27348",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27348/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27348/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27348/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/27348",
  "id": 1342488104,
  "node_id": "I_kwDOCFbutM5QBL4o",
  "number": 27348,
  "title": "Unexpected 401 due to AuthenticationCompletionException is thrown in OIDC Authorization Code Flow",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1479557456,
      "node_id": "MDU6TGFiZWwxNDc5NTU3NDU2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/oidc",
      "name": "area/oidc",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/235",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/235",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/235/labels",
    "id": 9025446,
    "node_id": "MI_kwDOCFbutM4Aibem",
    "number": 235,
    "title": "3.0.0.Alpha5",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 253,
    "state": "closed",
    "created_at": "2023-02-09T14:26:03Z",
    "updated_at": "2023-11-12T17:44:08Z",
    "due_on": null,
    "closed_at": "2023-03-08T15:10:59Z"
  },
  "comments": 26,
  "created_at": "2022-08-18T02:30:56Z",
  "updated_at": "2023-04-27T02:43:18Z",
  "closed_at": "2023-02-13T19:20:24Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nHi guys,\r\n\r\nI have an application where Quarkus OIDC Extension is enabled to protect  HTTP endpoints using OIDC Authorization Code Flow .\r\n\r\n**_Case 1:_**\r\n\r\n- Step 1:  I open a tab in my web browser and I try to reach a protected endpoint. I'm redirected to the OIDC provider login form to provide my credential **=> OK**\r\n-  Step 2: I don't fill up the form and I open another tab in my web browser to reach, the same or any other protected endpoint. A 401 is returned due to AuthenticationCompletionException **=> KO** https://github.com/quarkusio/quarkus/blob/9381f2ef1b15453f4cbc6b9819478379e03962d0/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java#L131\r\n\r\nI was expecting to be redirected to the OIDC provider login form to provide my credential.\r\n\r\n**_Case 2:_**\r\n\r\n- Step 1: I'm successfully  authenticated in my webapp using OIDC Authorization Code Flow.\r\n- Step 2: I open another tab in my web browser to browse another page of my webapp. **=> OK**\r\n- Step3: I leave for a long lunch break and both my webapp session cookie and my OIDC provider session cookie expires. **=> OK**\r\n- Step4: After the break, in both tabs in my web browser, my webapp frontend automatically tries to reach \"concurrently\" a protected endpoint. **In both tabs** I'm redirected to the OIDC provider login form to provide my credential **=> OK**\r\n-  Step 5: I fill up the form in tab 1 and a 401 is returned due to AuthenticationCompletionException **=> KO** https://github.com/quarkusio/quarkus/blob/9381f2ef1b15453f4cbc6b9819478379e03962d0/extensions/oidc/runtime/src/main/java/io/quarkus/oidc/runtime/CodeAuthenticationMechanism.java#L131\r\n\r\nI was expecting to be successfully authenticated and redirected to the protected endpoint.\r\n\r\n**_Proposal:_**\r\n\r\nAccording to me:\r\n \r\n- In case 1, the error occurs because state cookie `q_auth` exists but there is no `state` query param in the current URI.\r\nMy proposal here would be first to invoke method `CodeAuthenticationMechanism.processRedirectFromOidc(...)` only when the current URI is the OIDC `redirect_uri` instead of doing it for every incoming request with a the state cookie `q_auth`.\r\nSo: \r\n  - when the current URI is not the OIDC `redirect_uri`, a 302 should be send with a fresh state cookie named like `q_auth_{state}`  where `{state}` is the value of the `state` query param sent to the OIDC provider. \r\n  - when the current URI is the OIDC `redirect_uri`, the method  `CodeAuthenticationMechanism.processRedirectFromOidc(...)` should be invoked and the `state` check should be performed by checking at least if any request cookie `q_auth_{state}` exists. \r\n\r\n- In case 2, the error occurs because the state cookie `q_auth` created by tab1 has been overriden by the one created by tab2 leading to a value mismatch when performing `state` check.\r\n  The proposal I made for case 1 with the dedicated  `q_auth_{state}` cookie allows to fix this case too.\r\n\r\nWDYT ?\r\n\r\nThanks\r\n\r\n-Nicolas\n\n### Expected behavior\n\n_No response_\n\n### Actual behavior\n\n_No response_\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n_No response_\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27348/reactions",
    "total_count": 4,
    "+1": 4,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27348/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
