{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/26603",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26603/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26603/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26603/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/26603",
  "id": 1297285864,
  "node_id": "I_kwDOCFbutM5NUwLo",
  "number": 26603,
  "title": "Kafka dev service redpanda container failing with Text file busy",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1658790125,
      "node_id": "MDU6TGFiZWwxNjU4NzkwMTI1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kafka",
      "name": "area/kafka",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/196",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/196",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/196/labels",
    "id": 8208830,
    "node_id": "MI_kwDOCFbutM4AfUG-",
    "number": 196,
    "title": "2.10.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 33,
    "state": "closed",
    "created_at": "2022-07-18T13:45:45Z",
    "updated_at": "2023-01-13T10:37:02Z",
    "due_on": null,
    "closed_at": "2022-07-19T11:12:20Z"
  },
  "comments": 2,
  "created_at": "2022-07-07T11:45:35Z",
  "updated_at": "2022-07-18T14:02:22Z",
  "closed_at": "2022-07-07T13:56:18Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nWhile using the Kafka Dev service I entered into a racing condition on the writing of the startup redpanda.sh script and its execution resulting in the following stacktrace:\r\n\r\n```\r\n2022-07-07 09:04:17,861 INFO  [org.jbo.threads] (main)  JBoss Threads version 3.4.2.Final-redhat-00001\r\n2022-07-07 09:04:18,933 WARN  [org.tes.uti.TestcontainersConfiguration] (build-11)  Attempted to read Testcontainers configuration file at file:/home/acs_dev/.testcontainers.properties but the file was not found. Exception message: FileNotFoundException: /home/acs_dev/.testcontainers.properties (No such file or directory)\r\n2022-07-07 09:04:19,179 WARN  [io.qua.mic.dep.bin.mpm.MicroprofileMetricsProcessor] (build-21)  This application uses the MP Metrics API. The micrometer extension currently provides a compatibility layer that supports the MP Metrics API, but metric names and recorded values will be different. Note that the MP Metrics compatibility layer will move to a different extension in the future.\r\n2022-07-07 09:04:19,193 INFO  [io.qua.sma.rea.kaf.dep.SmallRyeReactiveMessagingKafkaProcessor] (build-33)  Generating Jackson serializer for type com.amadeus.middleware.multipayload.MultiPayload\r\n2022-07-07 09:04:19,681 INFO  [org.tes.doc.DockerClientProviderStrategy] (build-11)  Found Docker environment with Environment variables, system properties and defaults. Resolved dockerHost=unix:///var/run/swb_docker.sock\r\n2022-07-07 09:04:19,704 INFO  [org.tes.DockerClientFactory] (build-11)  Docker host IP address is 192.168.0.1\r\n2022-07-07 09:04:19,743 INFO  [org.tes.DockerClientFactory] (build-11)  Connected to docker: \r\n  Server Version: 20.10.17\r\n  API Version: 1.41\r\n  Operating System: RHEV\r\n  Total Memory: 16027 MB\r\n2022-07-07 09:04:19,752 INFO  [org.tes.uti.ImageNameSubstitutor] (build-11)  Image name substitution will be performed by: DefaultImageNameSubstitutor (composite of 'ConfigurationFileImageNameSubstitutor' and 'PrefixingImageNameSubstitutor')\r\n2022-07-07 09:04:19,754 WARN  [org.tes.uti.ConfigurationFileImageNameSubstitutor] (build-11)  Image name testcontainers/ryuk:0.3.3 was substituted by configuration to dockerhub.rnd.amadeus.net:5002/testcontainers/ryuk:0.3.3. This approach is deprecated and will be removed in the future\r\n2022-07-07 09:04:19,755 INFO  [org.tes.uti.ImageNameSubstitutor] (build-11)  Using dockerhub.rnd.amadeus.net:5002/testcontainers/ryuk:0.3.3 as a substitute image for testcontainers/ryuk:0.3.3 (using image substitutor: DefaultImageNameSubstitutor (composite of 'ConfigurationFileImageNameSubstitutor' and 'PrefixingImageNameSubstitutor'))\r\n2022-07-07 09:04:19,798 INFO  [org.tes.uti.RegistryAuthLocator] (build-11)  Failure when attempting to lookup auth config. Please ignore if you don't have images in an authenticated registry. Details: (dockerImageName: dockerhub.rnd.amadeus.net:5002/testcontainers/ryuk:0.3.3, configFile: /home/acs_dev/.docker/config.json. Falling back to docker-java default behaviour. Exception message: /home/acs_dev/.docker/config.json (No such file or directory)\r\n2022-07-07 09:04:20,382 INFO  [org.tes.DockerClientFactory] (build-11)  Ryuk started - will monitor and terminate Testcontainers containers on JVM exit\r\n2022-07-07 09:04:20,383 INFO  [org.tes.DockerClientFactory] (build-11)  Checking the system...\r\n2022-07-07 09:04:20,384 INFO  [org.tes.DockerClientFactory] (build-11)  ?? Docker server version should be at least 1.6.0\r\n2022-07-07 09:04:20,466 INFO  [org.tes.DockerClientFactory] (build-11)  ?? Docker environment should have more than 2GB free disk space\r\n2022-07-07 09:04:20,654 INFO  [doc.rnd.ama.net.1.3]] (build-11)  Creating container for image: dockerhub.rnd.amadeus.net:5002/vectorized/redpanda:v22.1.3\r\n2022-07-07 09:04:20,788 INFO  [doc.rnd.ama.net.1.3]] (build-11)  Container dockerhub.rnd.amadeus.net:5002/vectorized/redpanda:v22.1.3 is starting: e5dd590d0ec804d7c41a6a10e639e9eeed49c4fe14a2b036dc3337e27e2766d5\r\n2022-07-07 09:04:21,531 ERROR [doc.rnd.ama.net.1.3]] (build-11)  Could not start container: java.lang.IllegalStateException: Container did not start correctly.\r\n\tat org.testcontainers.containers.GenericContainer.tryStart(GenericContainer.java:463)\r\n\tat org.testcontainers.containers.GenericContainer.lambda$doStart$0(GenericContainer.java:331)\r\n\tat org.rnorth.ducttape.unreliables.Unreliables.retryUntilSuccess(Unreliables.java:81)\r\n\tat org.testcontainers.containers.GenericContainer.doStart(GenericContainer.java:329)\r\n\tat org.testcontainers.containers.GenericContainer.start(GenericContainer.java:317)\r\n\tat io.quarkus.kafka.client.deployment.DevServicesKafkaProcessor.lambda$startKafka$5(DevServicesKafkaProcessor.java:240)\r\n\tat java.base/java.util.Optional.orElseGet(Optional.java:364)\r\n\tat io.quarkus.kafka.client.deployment.DevServicesKafkaProcessor.startKafka(DevServicesKafkaProcessor.java:248)\r\n\tat io.quarkus.kafka.client.deployment.DevServicesKafkaProcessor.startKafkaDevService(DevServicesKafkaProcessor.java:103)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat io.quarkus.deployment.ExtensionLoader$2.execute(ExtensionLoader.java:882)\r\n\tat io.quarkus.builder.BuildContext.run(BuildContext.java:277)\r\n\tat org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n\tat org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\n2022-07-07 09:04:21,554 ERROR [doc.rnd.ama.net.1.3]] (build-11)  Log output from the failed container:\r\nsh: 1: /var/lib/redpanda/redpanda.sh: Text file busy\r\n```\n\n### Expected behavior\n\nThe dev services / redpanda container start correctly and the QuarkusTest depending on it executes correctly.\n\n### Actual behavior\n\nIn a racing condition the following startup line:\r\n\r\n```sh\r\nsh -c \"while [ ! -f /var/lib/redpanda/redpanda.sh ]; do sleep 0.1; done; /var/lib/redpanda/redpanda.sh\r\n```\r\n\r\nfails with:\r\n\r\n```\r\nsh: 1: /var/lib/redpanda/redpanda.sh: Text file busy\r\n```\r\n\r\nIn DevservicesKafkaProcessor we can see that a methods transfers this shell script contents after the docker container has been started, probably to inject configuration from Java.\r\n\r\nI think the pb is that in my case is that the contents are still being written on disk while the condition of existence already becomes true and the startup comand gets executed. Indeed the Test file busy error is raised when executing an executable file that is being edited.\n\n### How to Reproduce?\n\nAs said it is not systematic... Happens only rarely.\n\n### Output of `uname -a` or `ver`\n\nLinux 5.13.0-52-generic #59~20.04.1-Ubuntu SMP Thu Jun 16 21:21:28 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\n\n### Output of `java -version`\n\nopenjdk version \"11.0.15\" 2022-04-19 OpenJDK Runtime Environment (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1) OpenJDK 64-Bit Server VM (build 11.0.15+10-Ubuntu-0ubuntu0.20.04.1, mixed mode, sharing)\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n8ecbe2c5282b26227139798e610cb98a176db974\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.5 (3599d3414f046de2324203b78ddcf9b5e4388aa0) Maven home: /home/edeweerd/bin/apache-maven-3.8.5 Java version: 11.0.13.0.1, vendor: Oracle Corporation, runtime: /home/edeweerd/bin/java-11.0.3-oracle Default locale: en_US, platform encoding: UTF-8 OS name: \"linux\", version: \"5.13.0-52-generic\", arch: \"amd64\", family: \"unix\"\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/26603/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26603/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
