{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41461",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41461/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41461/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41461/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/41461",
  "id": 2374949415,
  "node_id": "I_kwDOCFbutM6Njton",
  "number": 41461,
  "title": "Quarkus Scheduler, when calling a token-protected endpoint (keycloak) fails to refresh the token",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1321590926,
      "node_id": "MDU6TGFiZWwxMzIxNTkwOTI2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/scheduler",
      "name": "area/scheduler",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1479557456,
      "node_id": "MDU6TGFiZWwxNDc5NTU3NDU2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/oidc",
      "name": "area/oidc",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1676631606,
      "node_id": "MDU6TGFiZWwxNjc2NjMxNjA2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/windows",
      "name": "env/windows",
      "color": "edea47",
      "default": false,
      "description": "Impacts Windows machines"
    },
    {
      "id": 3289887215,
      "node_id": "MDU6TGFiZWwzMjg5ODg3MjE1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/keycloak",
      "name": "area/keycloak",
      "color": "0366d6",
      "default": false,
      "description": null
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/335",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/335",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/335/labels",
    "id": 11174659,
    "node_id": "MI_kwDOCFbutM4AqoMD",
    "number": 335,
    "title": "3.13.0.CR1",
    "description": "",
    "creator": {
      "login": "quarkusbot",
      "id": 61254497,
      "node_id": "MDQ6VXNlcjYxMjU0NDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/61254497?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/quarkusbot",
      "html_url": "https://github.com/quarkusbot",
      "followers_url": "https://api.github.com/users/quarkusbot/followers",
      "following_url": "https://api.github.com/users/quarkusbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/quarkusbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/quarkusbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/quarkusbot/subscriptions",
      "organizations_url": "https://api.github.com/users/quarkusbot/orgs",
      "repos_url": "https://api.github.com/users/quarkusbot/repos",
      "events_url": "https://api.github.com/users/quarkusbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/quarkusbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 241,
    "state": "closed",
    "created_at": "2024-06-12T08:02:47Z",
    "updated_at": "2024-07-19T11:47:06Z",
    "due_on": null,
    "closed_at": "2024-07-17T11:55:13Z"
  },
  "comments": 18,
  "created_at": "2024-06-26T10:20:49Z",
  "updated_at": "2024-07-03T08:40:01Z",
  "closed_at": "2024-07-03T08:39:57Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nUsing Quarkus Scheduler,  (@Scheduled). Used Latest Quarkus LTS 3.8.5\r\n\r\nInside scheduler method there is a RestClient calling an Token Protected API (eg. keycloak)\r\nWhen calling a token-protected endpoint (keycloak), fails to refresh the token  after the token expiration see image.\r\n\r\nI have FULLY reproduced the problem here, just git clone, START the application and wait 10 minutes:\r\nhttps://github.com/spirostz/quarkus_scheduler_token_problem\r\n\r\nThere is **no problem** when calling the same endpoint **outside Quarkus Scheduler**. Also reproduced in a test in the above repo.\r\n\r\n\r\n![image](https://github.com/quarkusio/quarkus/assets/11974067/c88f94cc-a839-48b2-a57c-74cd2a02f89f)\r\n\n\n### Expected behavior\n\nInside scheduler method, all calls to a token-protected endpoint should never fail with 401 error \n\n### Actual behavior\n\nInside scheduler method, all calls to a token-protected endpoint should respond without error when \n\n### How to Reproduce?\n\n1 Clone the https://github.com/spirostz/quarkus_scheduler_token_problem\r\n2 Start the Application\r\n3 Wait 10 minutes and you will see the error in the logs\n\n### Output of `uname -a` or `ver`\n\nMINGW64_NT-10.0-22631 spirospc 3.3.3-341.x86_64 2022-01-17 11:45 UTC x86_64 Msys\n\n### Output of `java -version`\n\njava version \"17.0.8\" 2023-07-18 LTS Java(TM) SE Runtime Environment (build 17.0.8+9-LTS-211) Java HotSpot(TM) 64-Bit Server VM (build 17.0.8+9-LTS-211, mixed mode, sharing)\n\n### Quarkus version or git rev\n\n3.8.5\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nMaven home: C:\\tools\\apache-maven-3.8.5-bin\\apache-maven-3.8.5 Java version: 17.0.8, vendor: Oracle Corporation, runtime: C:\\Program Files\\Java\\jdk-17 Default locale: en_US, platform encoding: Cp1252 OS name: \"windows 11\", version: \"10.0\", arch: \"amd64\", family: \"windows\"\n\n### Additional information\n\n**### logs containing the failure:**\r\n\r\n2024-06-26 13:07:48,052 INFO  [org.tes.doc.DockerClientProviderStrategy] (build-42) Loaded org.testcontainers.dockerclient.NpipeSocketClientProviderStrategy from ~/.testcontainers.properties, will try it first\r\n2024-06-26 13:07:48,262 INFO  [org.tes.doc.DockerClientProviderStrategy] (build-42) Found Docker environment with local Npipe socket (npipe:////./pipe/docker_engine)\r\n2024-06-26 13:07:48,264 INFO  [org.tes.DockerClientFactory] (build-42) Docker host IP address is localhost\r\n2024-06-26 13:07:48,279 INFO  [org.tes.DockerClientFactory] (build-42) Connected to docker: \r\n  Server Version: 26.1.4\r\n  API Version: 1.45\r\n  Operating System: Docker Desktop\r\n  Total Memory: 11964 MB\r\n2024-06-26 13:07:48,293 INFO  [org.tes.ima.PullPolicy] (build-42) Image pull policy will be performed by: DefaultPullPolicy()\r\n2024-06-26 13:07:48,295 INFO  [org.tes.uti.ImageNameSubstitutor] (build-42) Image name substitution will be performed by: DefaultImageNameSubstitutor (composite of 'ConfigurationFileImageNameSubstitutor' and 'PrefixingImageNameSubstitutor')\r\n2024-06-26 13:07:48,299 INFO  [org.tes.DockerClientFactory] (build-42) Checking the system...\r\n2024-06-26 13:07:48,300 INFO  [org.tes.DockerClientFactory] (build-42) ?? Docker server version should be at least 1.6.0\r\n2024-06-26 13:07:48,323 INFO  [io.qua.oid.dep.dev.key.KeycloakDevServicesProcessor] (build-42) Using Quarkus powered Keycloak distribution\r\n2024-06-26 13:07:48,343 INFO  [tc.qua.io/.0.4] (build-42) Creating container for image: quay.io/keycloak/keycloak:24.0.4\r\n2024-06-26 13:07:48,540 INFO  [org.tes.uti.RegistryAuthLocator] (build-42) Credential helper/store (docker-credential-desktop) does not have credentials for quay.io\r\n2024-06-26 13:07:48,548 INFO  [tc.tes.6.0] (build-42) Creating container for image: testcontainers/ryuk:0.6.0\r\n2024-06-26 13:07:48,620 INFO  [org.tes.uti.RegistryAuthLocator] (build-42) Credential helper/store (docker-credential-desktop) does not have credentials for https://index.docker.io/v1/\r\n2024-06-26 13:07:48,741 INFO  [tc.tes.6.0] (build-42) Container testcontainers/ryuk:0.6.0 is starting: 05f3bb0109b1548459d17c5443e581751ea5b3d17e9e79abc461924137459be0\r\n2024-06-26 13:07:49,326 INFO  [tc.tes.6.0] (build-42) Container testcontainers/ryuk:0.6.0 started in PT0.777672S\r\n2024-06-26 13:07:49,404 INFO  [tc.qua.io/.0.4] (build-42) Container quay.io/keycloak/keycloak:24.0.4 is starting: 621159e8996b1bfc69a27f226783bd47dad769e01496c13be5ed26e790461524\r\n2024-06-26 13:08:11,118 INFO  [tc.qua.io/.0.4] (build-42) Container quay.io/keycloak/keycloak:24.0.4 started in PT22.7750323S\r\n2024-06-26 13:08:13,555 INFO  [io.qua.oid.dep.dev.key.KeycloakDevServicesProcessor] (build-42) Dev Services for Keycloak started.\r\n__  ____  __  _____   ___  __ ____  ______ \r\n --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ \r\n -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\\ \\   \r\n--\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/   \r\n2024-06-26 13:08:14,874 INFO  [io.quarkus] (Quarkus Main Thread) code-with-quarkus 1.0.0-SNAPSHOT on JVM (powered by Quarkus 3.8.5) started in 28.167s. Listening on: http://localhost:8080\r\n2024-06-26 13:08:14,876 INFO  [io.quarkus] (Quarkus Main Thread) Profile dev activated. Live Coding activated.\r\n2024-06-26 13:08:14,877 INFO  [io.quarkus] (Quarkus Main Thread) Installed features: [cdi, keycloak-authorization, oidc, oidc-client, oidc-client-filter, resteasy, resteasy-client, resteasy-client-jackson, scheduler, security, smallrye-context-propagation, vertx]\r\n2024-06-26 13:08:30,200 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:09:00,004 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:09:30,008 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:10:00,000 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:10:30,006 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:11:00,014 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:11:30,008 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:12:00,007 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:12:30,001 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:13:00,011 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:13:30,012 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:14:00,005 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:14:30,009 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:15:00,010 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:15:30,014 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:16:00,003 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:16:30,002 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:17:00,002 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:17:30,000 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:18:00,000 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:18:30,004 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:18:30,022 ERROR [io.qua.sch.com.run.StatusEmitterInvoker] (vert.x-worker-thread-1) Error occurred while executing task for trigger CronTrigger [id=1_org.acme.Schedule#schedule, cron=0/30 * * * * ?, gracePeriod=PT1S, timeZone=null]: java.util.concurrent.CompletionException: jakarta.ws.rs.WebApplicationException: Unknown error, status code 401\r\n\tat java.base/java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:332)\r\n\tat java.base/java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:347)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:874)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:887)\r\n\tat java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2325)\r\n\tat java.base/java.util.concurrent.CompletableFuture$MinimalStage.whenComplete(CompletableFuture.java:2902)\r\n\tat io.quarkus.scheduler.common.runtime.DefaultInvoker.invoke(DefaultInvoker.java:24)\r\n\tat io.quarkus.scheduler.common.runtime.StatusEmitterInvoker.invoke(StatusEmitterInvoker.java:35)\r\n\tat io.quarkus.scheduler.runtime.SimpleScheduler$ScheduledTask.doInvoke(SimpleScheduler.java:443)\r\n\tat io.quarkus.scheduler.runtime.SimpleScheduler$ScheduledTask$2.call(SimpleScheduler.java:425)\r\n\tat io.quarkus.scheduler.runtime.SimpleScheduler$ScheduledTask$2.call(SimpleScheduler.java:422)\r\n\tat io.vertx.core.impl.ContextImpl.lambda$executeBlocking$0(ContextImpl.java:178)\r\n\tat io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:279)\r\n\tat io.vertx.core.impl.ContextImpl.lambda$internalExecuteBlocking$2(ContextImpl.java:210)\r\n\tat org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\r\n\tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n\tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: jakarta.ws.rs.WebApplicationException: Unknown error, status code 401\r\n\tat org.jboss.resteasy.microprofile.client.DefaultResponseExceptionMapper.toThrowable(DefaultResponseExceptionMapper.java:42)\r\n\tat org.jboss.resteasy.microprofile.client.ExceptionMapping$HandlerException.mapException(ExceptionMapping.java:60)\r\n\tat io.quarkus.restclient.runtime.QuarkusProxyInvocationHandler.invoke(QuarkusProxyInvocationHandler.java:172)\r\n\tat jdk.proxy5/jdk.proxy5.$Proxy90.call(Unknown Source)\r\n\tat org.acme.Schedule.schedule(Schedule.java:17)\r\n\tat org.acme.Schedule_ClientProxy.schedule(Unknown Source)\r\n\tat org.acme.Schedule_ScheduledInvoker_schedule_dce0524c3f1de653f83719900424446459b7c471.invokeBean(Unknown Source)\r\n\t... 15 more\r\n\r\n2024-06-26 13:19:00,005 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:19:30,013 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client\r\n2024-06-26 13:20:00,009 INFO  [org.acm.Schedule] (vert.x-worker-thread-1) Calling client",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41461/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41461/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
