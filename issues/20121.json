{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20121",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20121/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20121/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20121/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/20121",
  "id": 995463698,
  "node_id": "I_kwDOCFbutM47VZIS",
  "number": 20121,
  "title": "CurrentVertxRequest is not set for coroutine routes",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1287515315,
      "node_id": "MDU6TGFiZWwxMjg3NTE1MzE1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kotlin",
      "name": "area/kotlin",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 2552031458,
      "node_id": "MDU6TGFiZWwyNTUyMDMxNDU4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/rest",
      "name": "area/rest",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/152",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/152",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/152/labels",
    "id": 7239525,
    "node_id": "MI_kwDOCFbutM4Abndl",
    "number": 152,
    "title": "2.5.0.CR1",
    "description": "",
    "creator": {
      "login": "aloubyansky",
      "id": 323379,
      "node_id": "MDQ6VXNlcjMyMzM3OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/323379?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/aloubyansky",
      "html_url": "https://github.com/aloubyansky",
      "followers_url": "https://api.github.com/users/aloubyansky/followers",
      "following_url": "https://api.github.com/users/aloubyansky/following{/other_user}",
      "gists_url": "https://api.github.com/users/aloubyansky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/aloubyansky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/aloubyansky/subscriptions",
      "organizations_url": "https://api.github.com/users/aloubyansky/orgs",
      "repos_url": "https://api.github.com/users/aloubyansky/repos",
      "events_url": "https://api.github.com/users/aloubyansky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/aloubyansky/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 305,
    "state": "closed",
    "created_at": "2021-10-11T08:43:12Z",
    "updated_at": "2022-01-07T16:32:59Z",
    "due_on": null,
    "closed_at": "2021-11-10T17:25:22Z"
  },
  "comments": 3,
  "created_at": "2021-09-14T00:35:15Z",
  "updated_at": "2021-11-10T08:45:34Z",
  "closed_at": "2021-11-10T08:45:23Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nUsing RestEasy Reactive, you can easily get the current request by injecting an instance of \"RoutingContext\" and then calling \".request()\" on it in your routing methods.\r\n\r\nHowever, this doesn't work for suspending functions with Kotlin. It seems like the CurrentVertxRequest isn't set when Quarkus uses the coroutine dispatcher, perhaps similar to this: https://github.com/quarkusio/quarkus/pull/13371\r\n\r\nThe error I get is:\r\n```\r\njavax.enterprise.inject.IllegalProductException: Normal scoped producer method may not return null: io.quarkus.vertx.http.runtime.CurrentVertxRequest.getCurrent()\r\n```\r\n\r\nHere is some actual code:\r\n```\r\n@Path(\"/test\")\r\nclass TestApi {\r\n    @Inject\r\n    lateinit var ctx: RoutingContext\r\n\r\n    @GET\r\n    @Path(\"/coroutine\")\r\n    @Produces(MediaType.TEXT_PLAIN)\r\n    suspend fun test(): String {\r\n        println(ctx.request().headers()) // Error\r\n        return \"hello\"\r\n    }\r\n\r\n    @GET\r\n    @Path(\"/normal\")\r\n    @Produces(MediaType.TEXT_PLAIN)\r\n    fun test2(): String {\r\n        println(ctx.request().headers()) // Works!\r\n        return \"hello\"\r\n    }\r\n}\r\n```\n\n### Expected behavior\n\nNo error is thrown when accessing the current request from a coroutine route.\n\n### Actual behavior\n\nAn error is thrown when accessing the current request from a coroutine route.\n\n### How to Reproduce?\n\nSee description\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\nAdoptOpenJdk 11\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.2.0 final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n------------------------------------------------------------ Gradle 6.8.3 ------------------------------------------------------------  Build time:   2021-02-22 16:13:28 UTC Revision:     9e26b4a9ebb910eaa1b8da8ff8575e514bc61c78  Kotlin:       1.4.20 Groovy:       2.5.12 Ant:          Apache Ant(TM) version 1.10.9 compiled on September 27 2020 JVM:          16.0.1 (Oracle Corporation 16.0.1+9-24) OS:           Windows 10 10.0 amd64\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20121/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20121/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
