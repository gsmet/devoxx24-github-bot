{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/40155",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40155/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40155/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40155/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/40155",
  "id": 2252799110,
  "node_id": "I_kwDOCFbutM6GRvyG",
  "number": 40155,
  "title": "@Blocking on a standard grpc service run on a single thread",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2062531368,
      "node_id": "MDU6TGFiZWwyMDYyNTMxMzY4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/grpc",
      "name": "area/grpc",
      "color": "0366d6",
      "default": false,
      "description": "gRPC"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/323",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/323",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/323/labels",
    "id": 10825140,
    "node_id": "MI_kwDOCFbutM4ApS20",
    "number": 323,
    "title": "3.11.0.CR1",
    "description": "",
    "creator": {
      "login": "quarkusbot",
      "id": 61254497,
      "node_id": "MDQ6VXNlcjYxMjU0NDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/61254497?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/quarkusbot",
      "html_url": "https://github.com/quarkusbot",
      "followers_url": "https://api.github.com/users/quarkusbot/followers",
      "following_url": "https://api.github.com/users/quarkusbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/quarkusbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/quarkusbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/quarkusbot/subscriptions",
      "organizations_url": "https://api.github.com/users/quarkusbot/orgs",
      "repos_url": "https://api.github.com/users/quarkusbot/repos",
      "events_url": "https://api.github.com/users/quarkusbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/quarkusbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 180,
    "state": "closed",
    "created_at": "2024-04-16T10:59:06Z",
    "updated_at": "2024-08-07T12:38:09Z",
    "due_on": null,
    "closed_at": "2024-05-15T13:36:12Z"
  },
  "comments": 12,
  "created_at": "2024-04-19T11:59:04Z",
  "updated_at": "2024-04-24T06:33:02Z",
  "closed_at": "2024-04-24T06:33:00Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nIf I implement a standard grpc service (not mutiny) and annotate it with `@Blocking` then requests are correctly dispatched to the core thread pool instead of the event loop. However, requests are always dispatched to the same core thread. This results in effectively only being able to process 1 request at a time.\r\n\r\nI've tried increasing `quarkus.thread-pool.core-threads` but it is having no effect.\r\n\r\n### Expected behavior\r\n\r\nRequests are dispatched to a new/free threads.\r\n\r\n### Actual behavior\r\n\r\nRequests are dispatched to the same thread and queued.\r\n\r\n### How to Reproduce?\r\n\r\nCreate grpc starter app\r\n\r\nAdd proto:\r\n\r\n```\r\nsyntax = \"proto3\";\r\n\r\noption java_multiple_files = true;\r\noption java_package = \"org.acme\";\r\n\r\npackage hello;\r\n\r\nservice StandardBlockingGrpcService {\r\n  rpc Invoke (Request) returns (Response) {}\r\n}\r\n\r\nmessage Request {\r\n  int32 id = 1;\r\n}\r\n\r\nmessage Response {\r\n  int32 id = 1;\r\n}\r\n```\r\n\r\nAdd service implementation:\r\n\r\n```\r\nclass GrpcServices {\r\n  private static final Logger logger = LoggerFactory.getLogger(GrpcServices.class);\r\n\r\n  @GrpcService\r\n  @Blocking\r\n  static class StandardBlocking extends StandardBlockingGrpcServiceImplBase {\r\n    @Override\r\n    public void invoke(Request request, StreamObserver<Response> responseObserver) {\r\n      logger.info(\"start: {}\", request.getId());\r\n      try {\r\n        Thread.sleep(Duration.ofSeconds(2).toMillis());\r\n      } catch (InterruptedException e) {\r\n        Thread.currentThread().interrupt();\r\n        throw new RuntimeException(e);\r\n      }\r\n      responseObserver.onNext(Response.newBuilder().setId(request.getId()).build());\r\n      responseObserver.onCompleted();\r\n      logger.info(\"end: {}\", request.getId());\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAdd test:\r\n\r\n```\r\n@QuarkusTest\r\nclass GrpcServicesTest {\r\n  private static final Logger logger = LoggerFactory.getLogger(GrpcServicesTest.class);\r\n\r\n  @GrpcClient\r\n  StandardBlockingGrpcServiceBlockingStub standardBlocking;\r\n\r\n  ExecutorService executor = Executors.newCachedThreadPool();\r\n\r\n  @Test\r\n  void standardBlockingTest() {\r\n    var futures = IntStream.range(0, 5)\r\n        .mapToObj(i -> CompletableFuture.runAsync(() -> standardBlocking(i), executor))\r\n        .toArray(CompletableFuture[]::new);\r\n    CompletableFuture.allOf(futures).join();\r\n  }\r\n\r\n  void standardBlocking(int id) {\r\n    logger.info(\"start: {}\", id);\r\n    standardBlocking.invoke(Request.newBuilder().setId(id).build());\r\n    logger.info(\"end: {}\", id);\r\n  }\r\n}\r\n```\r\n\r\nLog output:\r\n\r\n```\r\n2024-04-19 12:53:53,209 WARN  [io.qua.grp.run.GrpcServerRecorder] (main) Using legacy gRPC support, with separate new HTTP server instance. Switch to single HTTP server instance usage with quarkus.grpc.server.use-separate-server=false property\r\n2024-04-19 12:53:53,236 WARN  [io.qua.virtual-threads] (vert.x-eventloop-thread-0) You weren't able to create an executor that spawns virtual threads, the default blocking executor will be used, please check that your JDK is compatible with virtual threads\r\n2024-04-19 12:53:53,273 INFO  [io.qua.grp.run.GrpcServerRecorder] (vert.x-eventloop-thread-1) Started gRPC server on 0.0.0.0:9001 [TLS enabled: false]\r\n2024-04-19 12:53:53,294 INFO  [io.quarkus] (main) code-with-quarkus 1.0.0-SNAPSHOT on JVM (powered by Quarkus 3.6.9) started in 0.826s. Listening on: http://localhost:8081\r\n2024-04-19 12:53:53,295 INFO  [io.quarkus] (main) Profile test activated. \r\n2024-04-19 12:53:53,295 INFO  [io.quarkus] (main) Installed features: [cdi, grpc-client, grpc-server, smallrye-context-propagation, vertx]\r\n2024-04-19 12:53:53,300 INFO  [io.qua.grp.run.sup.Channels] (main) gRPC client standardBlocking created without configuration. We are assuming that it's created to test your gRPC services.\r\n2024-04-19 12:53:53,304 INFO  [io.qua.grp.run.sup.Channels] (main) Creating Netty gRPC channel ...\r\n2024-04-19 12:53:53,319 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-5) start: 4\r\n2024-04-19 12:53:53,319 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-2) start: 1\r\n2024-04-19 12:53:53,319 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-3) start: 2\r\n2024-04-19 12:53:53,319 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-4) start: 3\r\n2024-04-19 12:53:53,319 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-1) start: 0\r\n2024-04-19 12:53:53,389 INFO  [org.acm.GrpcServices] (executor-thread-4) start: 4\r\n2024-04-19 12:53:55,396 INFO  [org.acm.GrpcServices] (executor-thread-4) end: 4\r\n2024-04-19 12:53:55,397 INFO  [org.acm.GrpcServices] (executor-thread-4) start: 1\r\n2024-04-19 12:53:55,400 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-5) end: 4\r\n2024-04-19 12:53:57,400 INFO  [org.acm.GrpcServices] (executor-thread-4) end: 1\r\n2024-04-19 12:53:57,400 INFO  [org.acm.GrpcServices] (executor-thread-4) start: 3\r\n2024-04-19 12:53:57,403 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-2) end: 1\r\n2024-04-19 12:53:59,404 INFO  [org.acm.GrpcServices] (executor-thread-4) end: 3\r\n2024-04-19 12:53:59,405 INFO  [org.acm.GrpcServices] (executor-thread-4) start: 0\r\n2024-04-19 12:53:59,407 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-4) end: 3\r\n2024-04-19 12:54:01,409 INFO  [org.acm.GrpcServices] (executor-thread-4) end: 0\r\n2024-04-19 12:54:01,409 INFO  [org.acm.GrpcServices] (executor-thread-4) start: 2\r\n2024-04-19 12:54:01,410 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-1) end: 0\r\n2024-04-19 12:54:03,413 INFO  [org.acm.GrpcServices] (executor-thread-4) end: 2\r\n2024-04-19 12:54:03,415 INFO  [org.acm.GrpcServicesTest] (pool-8-thread-3) end: 2\r\n2024-04-19 12:54:03,438 INFO  [io.qua.grp.run.sup.Channels] (main) Shutting down gRPC channel ManagedChannelOrphanWrapper{delegate=ManagedChannelImpl{logId=4, target=dns:///0.0.0.0:9001}}\r\n2024-04-19 12:54:03,446 INFO  [io.quarkus] (main) code-with-quarkus stopped in 0.019s\r\n```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nDarwin <snip>-MacBook-Pro-16-inch-2023- 22.6.0 Darwin Kernel Version 22.6.0: Fri Sep 15 13:41:28 PDT 2023; root:xnu-8796.141.3.700.8~1/RELEASE_ARM64_T6020 arm64\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"11.0.19\" 2023-04-18 OpenJDK Runtime Environment Temurin-11.0.19+7 (build 11.0.19+7) OpenJDK 64-Bit Server VM Temurin-11.0.19+7 (build 11.0.19+7, mixed mode)\r\n\r\n### Quarkus version or git rev\r\n\r\n3.6.9\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.9.6 (bc0240f3c744dd6b6ec2920b3cd08dcc295161ae) Maven home: /opt/homebrew/Cellar/maven/3.9.6/libexec Java version: 11.0.19, vendor: Eclipse Adoptium, runtime: /Library/Java/JavaVirtualMachines/temurin-11.jdk/Contents/Home Default locale: en_GB, platform encoding: UTF-8 OS name: \"mac os x\", version: \"13.6\", arch: \"aarch64\", family: \"mac\"\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/40155/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40155/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
