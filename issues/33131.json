{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33131",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33131/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33131/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33131/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/33131",
  "id": 1696653781,
  "node_id": "I_kwDOCFbutM5lIOHV",
  "number": 33131,
  "title": "Quarkus 3.0.1.Final Kubenetes builds break stork",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1654772125,
      "node_id": "MDU6TGFiZWwxNjU0NzcyMTI1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kubernetes",
      "name": "area/kubernetes",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1676631606,
      "node_id": "MDU6TGFiZWwxNjc2NjMxNjA2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/windows",
      "name": "env/windows",
      "color": "edea47",
      "default": false,
      "description": "Impacts Windows machines"
    },
    {
      "id": 3830648795,
      "node_id": "LA_kwDOCFbutM7kUw_b",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/stork",
      "name": "area/stork",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/249",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/249",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/249/labels",
    "id": 9378470,
    "node_id": "MI_kwDOCFbutM4Ajxqm",
    "number": 249,
    "title": "3.0.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 36,
    "state": "closed",
    "created_at": "2023-05-09T16:07:50Z",
    "updated_at": "2023-06-28T14:01:59Z",
    "due_on": null,
    "closed_at": "2023-05-10T11:32:56Z"
  },
  "comments": 5,
  "created_at": "2023-05-04T20:26:11Z",
  "updated_at": "2023-05-10T07:05:01Z",
  "closed_at": "2023-05-10T06:59:43Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nWe use the Quarkus Kubernetes client to generate Kubernetes yaml files that are then deployed.  The generated service configuration includes http(80->8008) and https(443->8443).  This part works fine. \r\n\r\n However when an other application uses `quarkus.stork.my-service.service-discovery.type=kubernetes` to connect to the child service, it will fail with a 500 `jakarta.ws.rs.ProcessingException: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /10.0.54.217:80` error.  It's important to note that the port number it tries to connect to is 80 instead of the expected 8080 for a Java application.  The IP address belongs to the correct Pod, it's just trying to use a port that is not open.\r\n \r\n I've tested adding `quarkus.http.insecure-requests=disabled` when building the child deployments.  This prevents the generated service from having the https 443 port open but prevents the application from actually starting since we use SSL termination at the LB and there is no SSL cert for it.  This seems to be related to https://github.com/quarkusio/quarkus/wiki/Migration-Guide-3.0#the-https-container-port-is-added-to-generated-pod-resources\n\n### Expected behavior\n\nThe parent service should be able to connect to connect to the child service without issues.\n\n### Actual behavior\n\nThe parent service fails with a 500 error like this: \r\n`ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (executor-thread-1) HTTP Request to /api failed, error id: c404dda1-543a-4a7d-992f-5453d4af5513-4: jakarta.ws.rs.ProcessingException: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /10.0.54.217:80\r\n        at org.jboss.resteasy.reactive.client.handlers.ClientSendRequestHandler$3.accept(ClientSendRequestHandler.java:223)\r\n        at org.jboss.resteasy.reactive.client.handlers.ClientSendRequestHandler$3.accept(ClientSendRequestHandler.java:215)\r\n        at io.smallrye.context.impl.wrappers.SlowContextualConsumer.accept(SlowContextualConsumer.java:21)\r\n        at io.smallrye.mutiny.helpers.UniCallbackSubscriber.onFailure(UniCallbackSubscriber.java:62)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at org.jboss.resteasy.reactive.client.AsyncResultUni.lambda$subscribe$1(AsyncResultUni.java:37)\r\n        at io.vertx.core.impl.future.FutureImpl$3.onFailure(FutureImpl.java:153)\r\n        at io.vertx.core.impl.future.FutureBase.lambda$emitFailure$1(FutureBase.java:69)\r\n        at io.vertx.core.impl.EventLoopContext.execute(EventLoopContext.java:86)\r\n        at io.vertx.core.impl.DuplicatedContext.execute(DuplicatedContext.java:163)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:66)\r\n        at io.vertx.core.impl.future.FutureImpl.tryFail(FutureImpl.java:230)\r\n        at io.vertx.core.impl.future.PromiseImpl.tryFail(PromiseImpl.java:23)\r\n        at io.vertx.core.http.impl.HttpClientImpl.lambda$doRequest$6(HttpClientImpl.java:689)\r\n        at io.vertx.core.net.impl.pool.Endpoint.lambda$getConnection$0(Endpoint.java:52)\r\n        at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint$Request.handle(SharedClientHttpStreamEndpoint.java:162)\r\n        at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint$Request.handle(SharedClientHttpStreamEndpoint.java:123)\r\n        at io.vertx.core.impl.EventLoopContext.emit(EventLoopContext.java:55)\r\n        at io.vertx.core.impl.ContextBase.emit(ContextBase.java:239)\r\n        at io.vertx.core.net.impl.pool.SimpleConnectionPool$ConnectFailed$1.run(SimpleConnectionPool.java:384)\r\n        at io.vertx.core.net.impl.pool.CombinerExecutor.submit(CombinerExecutor.java:56)\r\n        at io.vertx.core.net.impl.pool.SimpleConnectionPool.execute(SimpleConnectionPool.java:245)\r\n        at io.vertx.core.net.impl.pool.SimpleConnectionPool.lambda$connect$2(SimpleConnectionPool.java:259)\r\n        at io.vertx.core.http.impl.SharedClientHttpStreamEndpoint.lambda$connect$2(SharedClientHttpStreamEndpoint.java:104)\r\n        at io.vertx.core.impl.future.FutureImpl$3.onFailure(FutureImpl.java:153)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:75)\r\n        at io.vertx.core.impl.future.FutureImpl.tryFail(FutureImpl.java:230)\r\n        at io.vertx.core.impl.future.Composition$1.onFailure(Composition.java:66)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:75)\r\n        at io.vertx.core.impl.future.FailedFuture.addListener(FailedFuture.java:98)\r\n        at io.vertx.core.impl.future.Composition.onFailure(Composition.java:55)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:75)\r\n        at io.vertx.core.impl.future.FutureImpl.tryFail(FutureImpl.java:230)\r\n        at io.vertx.core.impl.future.PromiseImpl.tryFail(PromiseImpl.java:23)\r\n        at io.vertx.core.impl.EventLoopContext.emit(EventLoopContext.java:55)\r\n        at io.vertx.core.impl.ContextBase.emit(ContextBase.java:239)\r\n        at io.vertx.core.net.impl.NetClientImpl.failed(NetClientImpl.java:339)\r\n        at io.vertx.core.net.impl.NetClientImpl.lambda$connectInternal2$6(NetClientImpl.java:311)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:557)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:492)\r\n        at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:636)\r\n        at io.netty.util.concurrent.DefaultPromise.setFailure0(DefaultPromise.java:629)\r\n        at io.netty.util.concurrent.DefaultPromise.setFailure(DefaultPromise.java:110)\r\n        at io.vertx.core.net.impl.ChannelProvider.lambda$handleConnect$0(ChannelProvider.java:157)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListeners0(DefaultPromise.java:583)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:559)\r\n        at io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:492)\r\n        at io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:636)\r\n        at io.netty.util.concurrent.DefaultPromise.setFailure0(DefaultPromise.java:629)\r\n        at io.netty.util.concurrent.DefaultPromise.tryFailure(DefaultPromise.java:118)\r\n        at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.fulfillConnectPromise(AbstractNioChannel.java:321)\r\n        at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:337)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:776)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /10.0.54.217:80\r\nCaused by: java.net.ConnectException: Connection refused\r\n        at java.base/sun.nio.ch.Net.pollConnect(Native Method)\r\n        at java.base/sun.nio.ch.Net.pollConnectNow(Net.java:672)\r\n        at java.base/sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:946)\r\n        at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:337)\r\n        at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:334)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:776)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)`\n\n### How to Reproduce?\n\n1) Using the quickstart here: https://github.com/quarkusio/quarkus-quickstarts/tree/main/stork-kubernetes-quickstart, update kubernetes-setup.yml and add \r\n\r\n```\r\n    - name: https\r\n      port: 443\r\n      targetPort: 8443\r\n```\r\nto the service's ports list.\r\n2) Deploy everything as normal\r\n3) Try going to `/api` to test it.\n\n### Output of `uname -a` or `ver`\n\nWindows\n\n### Output of `java -version`\n\nopenjdk 17.0.2 2022-01-18\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n_No response_\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.9.0 (9b58d2bad23a66be161c4664ef21ce219c2c8584)\n\n### Additional information\n\nQuickstart parent application was created using `mvn package -Dquarkus.container-image.build=true -Dquarkus.container-image.push=true` and deployed to an AWS EKS cluster running v1.24.10-eks-48e63af.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33131/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33131/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
