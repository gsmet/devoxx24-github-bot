{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/29575",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29575/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29575/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29575/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/29575",
  "id": 1469496356,
  "node_id": "I_kwDOCFbutM5Xlrwk",
  "number": 29575,
  "title": "Unexpected beans added to the index and affecting restarting the application",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273039603,
      "node_id": "MDU6TGFiZWwxMjczMDM5NjAz",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/devmode",
      "name": "area/devmode",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1282102389,
      "node_id": "MDU6TGFiZWwxMjgyMTAyMzg5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/arc",
      "name": "area/arc",
      "color": "0366d6",
      "default": false,
      "description": "Issue related to ARC (dependency injection)"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/220",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/220",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/220/labels",
    "id": 8714894,
    "node_id": "MI_kwDOCFbutM4AhPqO",
    "number": 220,
    "title": "2.15.0.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 38,
    "state": "closed",
    "created_at": "2022-12-02T18:02:10Z",
    "updated_at": "2022-12-14T09:33:38Z",
    "due_on": null,
    "closed_at": "2022-12-07T14:18:28Z"
  },
  "comments": 8,
  "created_at": "2022-11-30T11:41:23Z",
  "updated_at": "2022-12-06T18:37:35Z",
  "closed_at": "2022-12-05T16:20:55Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI did not manage to come up with a reproducer using a regular Quarkus application. But the issue happens if you try out this branch https://github.com/pedroigor/keycloak/tree/tmp-reactive.\r\n\r\nThat branch is about switching from Resteasy Classic to Reactive in Keycloak. The issue does not happen if using Resteasy Classic and I'm not sure what is the relation, if any.\r\n\r\nBasically, when reloading the application in dev mode or when running tests using the `QuarkusMainTestExtension`, reloading the application fails with this error:\r\n\r\n```\r\norg.junit.jupiter.api.extension.ParameterResolutionException: Failed to resolve parameter [io.quarkus.test.junit.main.LaunchResult arg0] in method [void org.keycloak.it.cli.StartCommandTest.testHttpEnabled(io.quarkus.test.junit.main.LaunchResult)]: java.lang.RuntimeException: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n    [error]: Build step io.quarkus.arc.deployment.ArcProcessor#validate threw an exception: javax.enterprise.inject.spi.DeploymentException: Found 8 deployment problems: \r\n[1] Ambiguous dependencies for type javax.transaction.TransactionManager and qualifiers [@Default]\r\n    - java member: io.quarkus.agroal.runtime.DataSources():transactionManager\r\n    - declared on CLASS bean [types=[io.quarkus.agroal.runtime.DataSources, java.lang.Object], qualifiers=[@Default, @Any], target=io.quarkus.agroal.runtime.DataSources]\r\n    - available beans:\r\n        - CLASS bean [types=[java.io.Serializable, javax.transaction.TransactionManager, com.arjuna.ats.jta.cdi.NarayanaTransactionManager, com.arjuna.ats.jta.cdi.DelegatingTransactionManager, java.lang.Object], qualifiers=[@Default, @Any], target=com.arjuna.ats.jta.cdi.NarayanaTransactionManager]\r\n        - CLASS bean [types=[javax.transaction.TransactionManager, java.io.Serializable, io.quarkus.narayana.jta.runtime.CDIDelegatingTransactionManager, java.lang.Object], qualifiers=[@Default, @Any], target=io.quarkus.narayana.jta.runtime.CDIDelegatingTransactionManager]\r\n```\r\n\r\nThe first start of the application works fine and only `CDIDelegatingTransactionManager` is available to resolve `TransactionManager` bean types. However, reloading the application causes the \r\n`com.arjuna.ats.jta.cdi.NarayanaTransactionManager` to also be recognized as a potential resolver hence failing with that error.\r\n\r\nIf we remove the `com.arjuna.ats.jta.cdi.NarayanaTransactionManager` at build time from our extension, the issue does not happen:\r\n\r\n```\r\nbuildTimeConditionBuildItemBuildProducer.produce(new BuildTimeConditionBuildItem(index.getIndex().getClassByName(DotName.createSimple(\"com.arjuna.ats.jta.cdi.NarayanaTransactionManager\")), false));`\r\n```\r\n\r\n### Expected behavior\r\n\r\nBeing able to reload the application without introducing beans that otherwise should be excluded.\r\n\r\n### Actual behavior\r\n\r\nFailing to reload the application as per the description.\r\n\r\n### How to Reproduce?\r\n\r\n* Checkout this branch https://github.com/pedroigor/keycloak/tree/tmp-reactive-bean-issue\r\n* mvn -Pdistribution -DskipTests clean install\r\n* cd quarkus/server\r\n* mvn quarkus:dev -Dquarkus.args=start-dev\r\n* After starting Keycloak in dev mode, force a restart (type `s`)\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux fedora 6.0.9-200.fc36.x86_64 #1 SMP PREEMPT_DYNAMIC Wed Nov 16 17:50:45 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"18.0.2.1\" 2022-08-18 OpenJDK Runtime Environment (build 18.0.2.1+1-1) OpenJDK 64-Bit Server VM (build 18.0.2.1+1-1, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.14.1.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/29575/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29575/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
