{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/40885",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40885/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40885/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40885/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/40885",
  "id": 2323718833,
  "node_id": "I_kwDOCFbutM6KgSKx",
  "number": 40885,
  "title": "[BUG] Reactive MSSQL client randomly loses connection on large queries.",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2955124662,
      "node_id": "MDU6TGFiZWwyOTU1MTI0NjYy",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/reactive-sql-clients",
      "name": "area/reactive-sql-clients",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 4,
  "created_at": "2024-05-29T16:19:03Z",
  "updated_at": "2024-07-15T10:22:16Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nHello everyone,\r\n\r\nI want to file a bug report on the reactive MS-SQL client. We run a fully reactive Quarkus app on Azure using Azure SQL as a database. We used Quarkus 3.10.2 and implemented all database-related logic using Panache Reactive and Mutiny. For the most part, everything works as expected. However, for some queries that return a large set of results, the connection to the database closes randomly. This does not always happen for these queries, but it does most of the time.\r\n\r\nWe then get one of two exceptions: either \r\n```\r\n2024-05-29 16:56:35,949 ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (vert.x-eventloop-thread-0) HTTP Request to /admin/api/dashboard/attempts/survey-results failed, error id: f80705bf-1495-4015-9438-97c8a508dc19-46: org.hibernate.HibernateException: java.net.SocketException: Connection reset\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.convertException(ReactiveDeferredResultSetAccess.java:229)\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.lambda$executeQuery$2(ReactiveDeferredResultSetAccess.java:176)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.lambda$executeQuery$3(ReactiveDeferredResultSetAccess.java:175)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.executeQuery(ReactiveDeferredResultSetAccess.java:151)\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.getReactiveResultSet(ReactiveDeferredResultSetAccess.java:78)\r\n        at org.hibernate.reactive.sql.exec.spi.ReactiveValuesResultSet.lambda$processNext$1(ReactiveValuesResultSet.java:89)\r\n        at org.hibernate.reactive.sql.exec.spi.ReactiveValuesResultSet.advance(ReactiveValuesResultSet.java:129)\r\n        at org.hibernate.reactive.sql.exec.spi.ReactiveValuesResultSet.processNext(ReactiveValuesResultSet.java:88)\r\n        at org.hibernate.reactive.sql.exec.spi.ReactiveValuesResultSet.next(ReactiveValuesResultSet.java:78)\r\n        at org.hibernate.reactive.sql.exec.spi.ReactiveRowProcessingState.next(ReactiveRowProcessingState.java:56)\r\n        at org.hibernate.reactive.sql.results.spi.ReactiveListResultsConsumer.lambda$consume$2(ReactiveListResultsConsumer.java:106)\r\n        at org.hibernate.reactive.util.async.impl.AsyncTrampoline.lambda$asyncWhile$1(AsyncTrampoline.java:215)\r\n        at org.hibernate.reactive.util.async.impl.AsyncTrampoline$TrampolineInternal.unroll(AsyncTrampoline.java:121)\r\n        at org.hibernate.reactive.util.async.impl.AsyncTrampoline$TrampolineInternal.trampoline(AsyncTrampoline.java:102)\r\n        at org.hibernate.reactive.util.async.impl.AsyncTrampoline.asyncWhile(AsyncTrampoline.java:197)\r\n        at org.hibernate.reactive.util.async.impl.AsyncTrampoline.asyncWhile(AsyncTrampoline.java:215)\r\n        at org.hibernate.reactive.util.impl.CompletionStages.whileLoop(CompletionStages.java:424)\r\n        at org.hibernate.reactive.sql.results.spi.ReactiveListResultsConsumer.consume(ReactiveListResultsConsumer.java:106)\r\n        at org.hibernate.reactive.sql.exec.internal.StandardReactiveSelectExecutor.lambda$doExecuteQuery$4(StandardReactiveSelectExecutor.java:204)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n        at org.hibernate.reactive.sql.exec.internal.StandardReactiveSelectExecutor.doExecuteQuery(StandardReactiveSelectExecutor.java:148)\r\n        at org.hibernate.reactive.sql.exec.internal.StandardReactiveSelectExecutor.executeQuery(StandardReactiveSelectExecutor.java:118)\r\n        at org.hibernate.reactive.sql.exec.internal.StandardReactiveSelectExecutor.list(StandardReactiveSelectExecutor.java:86)\r\n        at org.hibernate.reactive.sql.exec.internal.StandardReactiveSelectExecutor.list(StandardReactiveSelectExecutor.java:76)\r\n        at org.hibernate.reactive.query.sqm.internal.ConcreteSqmSelectReactiveQueryPlan.lambda$listInterpreter$2(ConcreteSqmSelectReactiveQueryPlan.java:102)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n        at org.hibernate.reactive.query.sqm.internal.ConcreteSqmSelectReactiveQueryPlan.lambda$listInterpreter$3(ConcreteSqmSelectReactiveQueryPlan.java:101)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n        at org.hibernate.reactive.query.sqm.internal.ConcreteSqmSelectReactiveQueryPlan.listInterpreter(ConcreteSqmSelectReactiveQueryPlan.java:99)\r\n        at org.hibernate.reactive.query.sqm.internal.ConcreteSqmSelectReactiveQueryPlan.lambda$new$0(ConcreteSqmSelectReactiveQueryPlan.java:82)\r\n        at org.hibernate.reactive.query.sqm.internal.ConcreteSqmSelectReactiveQueryPlan.withCacheableSqmInterpretation(ConcreteSqmSelectReactiveQueryPlan.java:165)\r\n        at org.hibernate.reactive.query.sqm.internal.ConcreteSqmSelectReactiveQueryPlan.reactivePerformList(ConcreteSqmSelectReactiveQueryPlan.java:122)\r\n        at org.hibernate.reactive.query.sqm.internal.ReactiveQuerySqmImpl.doReactiveList(ReactiveQuerySqmImpl.java:200)\r\n        at org.hibernate.reactive.query.spi.ReactiveAbstractSelectionQuery.doReactiveList(ReactiveAbstractSelectionQuery.java:295)\r\n        at org.hibernate.reactive.query.spi.ReactiveAbstractSelectionQuery.reactiveList(ReactiveAbstractSelectionQuery.java:184)\r\n        at org.hibernate.reactive.query.sqm.internal.ReactiveQuerySqmImpl.reactiveList(ReactiveQuerySqmImpl.java:154)\r\n        at org.hibernate.reactive.query.ReactiveSelectionQuery.getReactiveResultList(ReactiveSelectionQuery.java:43)\r\n        at io.smallrye.context.impl.wrappers.SlowContextualSupplier.get(SlowContextualSupplier.java:21)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage.subscribe(UniCreateFromCompletionStage.java:24)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n        at org.hibernate.reactive.context.impl.VertxContext.execute(VertxContext.java:91)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.subscribe(UniRunSubscribeOn.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.performInnerSubscription(UniOnItemTransformToUni.java:81)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.onItem(UniOnItemTransformToUni.java:57)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem$KnownItemSubscription.forward(UniCreateFromKnownItem.java:38)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem.subscribe(UniCreateFromKnownItem.java:23)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRetryAtMost$UniRetryAtMostProcessor.onFailure(UniRetryAtMost.java:74)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forwardResult(UniCreateFromCompletionStage.java:58)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:863)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:887)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2325)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:144)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forward(UniCreateFromCompletionStage.java:51)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage.subscribe(UniCreateFromCompletionStage.java:35)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n        at org.hibernate.reactive.context.impl.VertxContext.execute(VertxContext.java:91)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.subscribe(UniRunSubscribeOn.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.performInnerSubscription(UniOnItemTransformToUni.java:81)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.onItem(UniOnItemTransformToUni.java:57)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem$KnownItemSubscription.forward(UniCreateFromKnownItem.java:38)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem.subscribe(UniCreateFromKnownItem.java:23)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRetryAtMost$UniRetryAtMostProcessor.onFailure(UniRetryAtMost.java:74)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forwardResult(UniCreateFromCompletionStage.java:58)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:863)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:887)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2325)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:144)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forward(UniCreateFromCompletionStage.java:51)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage.subscribe(UniCreateFromCompletionStage.java:35)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n        at org.hibernate.reactive.context.impl.VertxContext.execute(VertxContext.java:91)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.subscribe(UniRunSubscribeOn.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.performInnerSubscription(UniOnItemTransformToUni.java:81)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.onItem(UniOnItemTransformToUni.java:57)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem$KnownItemSubscription.forward(UniCreateFromKnownItem.java:38)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem.subscribe(UniCreateFromKnownItem.java:23)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRetryAtMost$UniRetryAtMostProcessor.onFailure(UniRetryAtMost.java:74)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forwardResult(UniCreateFromCompletionStage.java:58)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:863)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:887)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2325)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:144)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forward(UniCreateFromCompletionStage.java:51)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage.subscribe(UniCreateFromCompletionStage.java:35)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n        at org.hibernate.reactive.context.impl.VertxContext.execute(VertxContext.java:91)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.subscribe(UniRunSubscribeOn.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.performInnerSubscription(UniOnItemTransformToUni.java:81)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.onItem(UniOnItemTransformToUni.java:57)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem$KnownItemSubscription.forward(UniCreateFromKnownItem.java:38)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem.subscribe(UniCreateFromKnownItem.java:23)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRetryAtMost$UniRetryAtMostProcessor.onFailure(UniRetryAtMost.java:74)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forwardResult(UniCreateFromCompletionStage.java:58)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:863)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:887)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2325)\r\n        at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:144)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forward(UniCreateFromCompletionStage.java:51)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage.subscribe(UniCreateFromCompletionStage.java:35)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n        at org.hibernate.reactive.context.impl.VertxContext.execute(VertxContext.java:91)\r\n        at io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.subscribe(UniRunSubscribeOn.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.performInnerSubscription(UniOnItemTransformToUni.java:81)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni$UniOnItemTransformToUniProcessor.onItem(UniOnItemTransformToUni.java:57)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem$KnownItemSubscription.forward(UniCreateFromKnownItem.java:38)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromKnownItem.subscribe(UniCreateFromKnownItem.java:23)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n        at io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n        at io.smallrye.mutiny.operators.uni.UniRetryAtMost$UniRetryAtMostProcessor.onFailure(UniRetryAtMost.java:74)\r\n        at io.smallrye.mutiny.operators.uni.UniOperatorProcessor.onFailure(UniOperatorProcessor.java:55)\r\n        at io.smallrye.mutiny.operators.uni.builders.UniCreateFromCompletionStage$CompletionStageUniSubscription.forwardResult(UniCreateFromCompletionStage.java:58)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:863)\r\n        at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:841)\r\n        at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n        at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2162)\r\n        at org.hibernate.reactive.util.async.impl.AsyncTrampoline$TrampolineInternal.lambda$unroll$0(AsyncTrampoline.java:123)\r\n        at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:863)\r\n        at java.base/java.util.concurrent.CompletableFuture$UniWhenComplete.tryFire(CompletableFuture.java:841)\r\n        at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n        at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2162)\r\n        at io.vertx.core.Future.lambda$toCompletionStage$3(Future.java:583)\r\n        at io.vertx.core.impl.future.FutureImpl$4.onFailure(FutureImpl.java:188)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:81)\r\n        at io.vertx.core.impl.future.FutureImpl.tryFail(FutureImpl.java:278)\r\n        at io.vertx.sqlclient.impl.QueryResultBuilder.tryFail(QueryResultBuilder.java:94)\r\n        at io.vertx.core.Promise.fail(Promise.java:89)\r\n        at io.vertx.core.Promise.handle(Promise.java:53)\r\n        at io.vertx.core.Promise.handle(Promise.java:29)\r\n        at io.vertx.core.impl.future.FutureImpl$4.onFailure(FutureImpl.java:188)\r\n        at io.vertx.core.impl.future.FutureBase.lambda$emitFailure$1(FutureBase.java:75)\r\n        at io.vertx.core.impl.ContextImpl.execute(ContextImpl.java:298)\r\n        at io.vertx.core.impl.DuplicatedContext.execute(DuplicatedContext.java:171)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:72)\r\n        at io.vertx.core.impl.future.FutureImpl.tryFail(FutureImpl.java:278)\r\n        at io.vertx.core.impl.future.PromiseImpl.onFailure(PromiseImpl.java:54)\r\n        at io.vertx.core.impl.future.PromiseImpl.handle(PromiseImpl.java:43)\r\n        at io.vertx.core.impl.future.PromiseImpl.handle(PromiseImpl.java:23)\r\n        at io.vertx.sqlclient.impl.command.CommandResponse.fire(CommandResponse.java:46)\r\n        at io.vertx.sqlclient.impl.SocketConnectionBase.handleMessage(SocketConnectionBase.java:324)\r\n        at io.vertx.mssqlclient.impl.MSSQLSocketConnection.handleMessage(MSSQLSocketConnection.java:164)\r\n        at io.vertx.sqlclient.impl.SocketConnectionBase.lambda$init$0(SocketConnectionBase.java:137)\r\n        at io.vertx.core.impl.ContextImpl.emit(ContextImpl.java:328)\r\n        at io.vertx.core.impl.ContextImpl.emit(ContextImpl.java:321)\r\n        at io.vertx.core.net.impl.NetSocketImpl.handleMessage(NetSocketImpl.java:388)\r\n        at io.vertx.core.net.impl.ConnectionBase.read(ConnectionBase.java:159)\r\n        at io.vertx.core.net.impl.VertxHandler.channelRead(VertxHandler.java:153)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\r\n        at io.vertx.mssqlclient.impl.codec.TdsMessageCodec.fail(TdsMessageCodec.java:71)\r\n        at io.vertx.mssqlclient.impl.codec.TdsMessageCodec.fail(TdsMessageCodec.java:63)\r\n        at io.vertx.mssqlclient.impl.codec.TdsMessageCodec.exceptionCaught(TdsMessageCodec.java:53)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:346)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:325)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:317)\r\n        at io.netty.handler.ssl.SslHandler.exceptionCaught(SslHandler.java:1204)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:346)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:325)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:317)\r\n        at io.netty.channel.DefaultChannelPipeline$HeadContext.exceptionCaught(DefaultChannelPipeline.java:1377)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:346)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:325)\r\n        at io.netty.channel.DefaultChannelPipeline.fireExceptionCaught(DefaultChannelPipeline.java:907)\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.handleReadException(AbstractNioByteChannel.java:125)\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:177)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: java.net.SocketException: Connection reset\r\n        at java.base/sun.nio.ch.SocketChannelImpl.throwConnectionReset(SocketChannelImpl.java:394)\r\n        at java.base/sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:426)\r\n        at io.netty.buffer.PooledByteBuf.setBytes(PooledByteBuf.java:255)\r\n        at io.netty.buffer.AbstractByteBuf.writeBytes(AbstractByteBuf.java:1132)\r\n        at io.netty.channel.socket.nio.NioSocketChannel.doReadBytes(NioSocketChannel.java:357)\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:151)\r\n        ... 8 more\r\n```\r\n\r\nor \r\n\r\n```\r\n2024-05-29 16:56:35,341 ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (vert.x-eventloop-thread-0) HTTP Request to /admin/api/dashboard/attempts/survey-results failed, error id: f80705bf-1495-4015-9438-97c8a508dc19-45: org.hibernate.HibernateException: io.vertx.core.impl.NoStackTraceThrowable: Connection is not active now, current status: CLOSED\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.convertException(ReactiveDeferredResultSetAccess.java:229)\r\n        at org.hibernate.reactive.sql.results.internal.ReactiveDeferredResultSetAccess.lambda$executeQuery$2(ReactiveDeferredResultSetAccess.java:176)\r\n        at java.base/java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1150)\r\n        at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n        at java.base/java.util.concurrent.CompletableFuture.completeExceptionally(CompletableFuture.java:2162)\r\n        at io.vertx.core.Future.lambda$toCompletionStage$3(Future.java:583)\r\n        at io.vertx.core.impl.future.FutureImpl$4.onFailure(FutureImpl.java:188)\r\n        at io.vertx.core.impl.future.FutureBase.emitFailure(FutureBase.java:81)\r\n        at io.vertx.core.impl.future.FutureImpl.tryFail(FutureImpl.java:278)\r\n        at io.vertx.sqlclient.impl.QueryResultBuilder.tryFail(QueryResultBuilder.java:94)\r\n        at io.vertx.core.Promise.fail(Promise.java:89)\r\n        at io.vertx.core.Promise.handle(Promise.java:53)\r\n        at io.vertx.core.Promise.handle(Promise.java:29)\r\n        at io.vertx.core.impl.future.FutureImpl$4.onFailure(FutureImpl.java:188)\r\n        at io.vertx.core.impl.future.FutureBase.lambda$emitFailure$1(FutureBase.java:75)\r\n        at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:173)\r\n        at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:166)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: io.vertx.core.impl.NoStackTraceThrowable: Connection is not active now, current status: CLOSED\r\n```\r\n\r\nThe problem occurred much more often in the beginning, but most previous occurrences could be solved by setting the following config parameter:\r\n`quarkus.datasource.reactive.mssql.packet-size=8000`\r\n\r\nNonetheless, it still happens from time to time. I basically played around with all the config parameters and have no clue what to do. I guess it is a bug in the framework.\r\n\r\nThese are my other db-related config parameters:\r\n```\r\nquarkus.datasource.reactive.idle-timeout=PT30M\r\nquarkus.datasource.reactive.max-lifetime=PT60M\r\nhibernate.vertx.pool.idle_timeout=PT30M\r\nquarkus.datasource.reactive.max-size = 30\r\nquarkus.datasource.reactive.cache-prepared-statements = true\r\nquarkus.datasource.reactive.mssql.packet-size=8000\r\nquarkus.datasource.reactive.mssql.ssl=true\r\nquarkus.hibernate-orm.database.generation=update\r\nquarkus.datasource.db-kind=mssql\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\nThe expected behaviour should be that my query executes without any problem deterministically.\r\n\r\nThe object which we want to get out of the DB with the query (happens with other objects as well, though):\r\n```\r\npackage science.edutec.neobridge.entities.survey;\r\n\r\nimport org.hibernate.annotations.Cache;\r\nimport org.hibernate.annotations.CacheConcurrencyStrategy;\r\n\r\nimport io.quarkus.hibernate.reactive.panache.PanacheEntity;\r\n\r\nimport jakarta.persistence.Entity;\r\nimport jakarta.persistence.FetchType;\r\nimport jakarta.persistence.Index;\r\nimport jakarta.persistence.JoinColumn;\r\nimport jakarta.persistence.Lob;\r\nimport jakarta.persistence.ManyToOne;\r\nimport jakarta.persistence.Table;\r\nimport science.edutec.neobridge.entities.meta.AssessmentPhaseInSession;\r\n\r\n@Entity\r\n@Table(indexes = {\r\n    @Index(name = \"byApisId\", columnList = \"phase_in_session_id\")\r\n})\r\npublic class ExternalSurveyAnswer extends PanacheEntity {\r\n    @Lob\r\n    public String content;\r\n\r\n    @ManyToOne(fetch = FetchType.EAGER)\r\n    @JoinColumn(name=\"question_id\")\r\n    @Cache(usage = CacheConcurrencyStrategy.READ_WRITE)\r\n    public ExternalSurveyQuestion surveyQuestion;\r\n\r\n    @ManyToOne(fetch = FetchType.EAGER)\r\n    @JoinColumn(name=\"phase_in_session_id\")\r\n    @Cache(usage = CacheConcurrencyStrategy.READ_WRITE)\r\n    public AssessmentPhaseInSession phase;\r\n}\r\n```\r\n\r\n### Actual behavior\r\n\r\nAs seen in the bug description.\r\n\r\n### How to Reproduce?\r\n\r\nIt is hard to reproduce because it does not occur deterministically. However, it continually occurs for very large queries. To reproduce it, fill a table in AzureSQL with around 300k rows, then query around 20k of them. \r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\njava version \"17.0.8\" 2023-07-18 LTS Java(TM) SE Runtime Environment (build 17.0.8+9-LTS-211) Java HotSpot(TM) 64-Bit Server VM (build 17.0.8+9-LTS-211, mixed mode, sharing)\r\n\r\n### Quarkus version or git rev\r\n\r\n3.11\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/40885/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/40885/timeline",
  "performed_via_github_app": null,
  "state_reason": "reopened"
}
