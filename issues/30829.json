{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/30829",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30829/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30829/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30829/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/30829",
  "id": 1568636604,
  "node_id": "I_kwDOCFbutM5df368",
  "number": 30829,
  "title": "Quarkus S2I native binary can't be used with OpenShift build configuration",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1654772125,
      "node_id": "MDU6TGFiZWwxNjU0NzcyMTI1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kubernetes",
      "name": "area/kubernetes",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 6,
  "created_at": "2023-02-02T19:15:20Z",
  "updated_at": "2023-02-14T16:33:44Z",
  "closed_at": "2023-02-14T16:33:43Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI use OpenShift `BuildConfig` with S2I native binary to build Quarkus application. Previously I used `ubi-quarkus-native-s2i:22.2-java17` (still works), but after https://github.com/quarkusio/quarkus/pull/27997 I tried to switch to `ubi-quarkus-native-binary-s2i:2.0` which never builds application (never runs `mvn package`), instead it immediately looks for `*-runner` which obviously does not exist.\r\n\r\nDid I misunderstood change, please? Is `ubi-quarkus-native-binary-s2i` replacement for `ubi-quarkus-native-s2i`? `ubi-quarkus-graalvmce-s2i` doesn't work either.\r\n\r\n### Expected behavior\r\n\r\nThere should be a way to use s2i, but `ubi-quarkus-native-s2i` hasn't been updated for 4 months, 22.3 is not available and clearly different image repository should be used.\r\n\r\n### Actual behavior\r\n\r\nBuild fails with\r\n```bash\r\nGenerating dockerfile with builder image quay.io/quarkus/ubi-quarkus-native-binary-s2i:2.0\r\nAdding transient rw bind mount for /run/secrets/rhsm\r\nSTEP 1/10: FROM quay.io/quarkus/ubi-quarkus-native-binary-s2i:2.0\r\nSTEP 2/10: LABEL \"io.openshift.build.commit.id\"=\"00641b691281cac0daa66c952110b7c9aa189736\"       \"io.openshift.build.commit.ref\"=\"main\"       \"io.openshift.build.commit.message\"=\"[RELEASE] - Bump version to 2.16.1.Final\"       \"io.openshift.build.source-location\"=\"https://github.com/quarkusio/quarkus-quickstarts.git\"       \"io.openshift.build.source-context-dir\"=\"getting-started\"       \"io.openshift.build.image\"=\"quay.io/quarkus/ubi-quarkus-native-binary-s2i:2.0\"       \"io.openshift.build.commit.author\"=\"Guillaume Smet <guillaume.smet@gmail.com>\"       \"io.openshift.build.commit.date\"=\"Wed Feb 1 17:56:36 2023 +0100\"\r\nSTEP 3/10: ENV MAVEN_S2I_ARTIFACT_DIRS=\"target/quarkus-app\"     S2I_SOURCE_DEPLOYMENTS_FILTER=\"app lib quarkus quarkus-run.jar\"     JAVA_OPTIONS=\"-Dquarkus.http.host=0.0.0.0\"     AB_JOLOKIA_OFF=\"true\"     JAVA_APP_JAR=\"/deployments/quarkus-run.jar\"     OPENSHIFT_BUILD_NAME=\"app-1\"     OPENSHIFT_BUILD_NAMESPACE=\"mvavrik-s2i-debug\"     OPENSHIFT_BUILD_SOURCE=\"https://github.com/quarkusio/quarkus-quickstarts.git\"     OPENSHIFT_BUILD_COMMIT=\"00641b691281cac0daa66c952110b7c9aa189736\"     MAVEN_ARGS=\"-s /configuration/settings.xml -DskipTests=true -DskipITs=true -Dquarkus.platform.version=2.16.1.Final -Dquarkus-plugin.version=2.16.1.Final -Dquarkus.platform.group-id=io.quarkus -Dquarkus.platform.version=2.16.1.Final -Dquarkus.platform.group-id=io.quarkus -Dquarkus-plugin.version=2.16.1.Final\"\r\nSTEP 4/10: USER root\r\nSTEP 5/10: COPY upload/src /tmp/src\r\nSTEP 6/10: COPY upload/injections/var/run/configs/openshift.io/build/settings-mvn /configuration\r\nSTEP 7/10: RUN chown -R 1001:0 /tmp/src /configuration\r\nSTEP 8/10: USER 1001\r\nSTEP 9/10: RUN /usr/libexec/s2i/assemble\r\n+ SRC_DIR=/tmp/src/\r\n+ echo 'Building with uploaded src from /tmp/src/'\r\nBuilding with uploaded src from /tmp/src/\r\nAssemblying\r\n+ echo Assemblying\r\n++ ls '/tmp/src//*-runner'\r\n++ wc -l\r\nls: cannot access '/tmp/src//*-runner': No such file or directory\r\n+ '[' 0 -eq 1 ']'\r\n+ echo 'Could not locate a native image. Have you build a native image using mvn -Pnative before?'\r\nCould not locate a native image. Have you build a native image using mvn -Pnative before?\r\n+ exit 1\r\nerror: build error: error building at STEP \"RUN /usr/libexec/s2i/assemble\": error while running runtime: exit status 1\r\n```\r\n\r\n\r\n### How to Reproduce?\r\n\r\nReproducer:\r\n\r\nSteps to reproduce the behavior:\r\n1. `oc new-project mvavrik-s2i-debug`\r\n2. `oc apply -f settings-mvn.yml`\r\n3. `oc apply -f openshift.yml `\r\n4. `oc logs bc/app -n mvavrik-s2i-debug`\r\n5. (once you collected information) `oc delete project mvavrik-s2i-debug`\r\n\r\nPrerequisities:\r\n1. create file `settings-mvn.yml` with following content\r\n```\r\napiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: settings-mvn\r\ndata:\r\n  settings.xml: |\r\n    <?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n    <settings xmlns=\"http://maven.apache.org/SETTINGS/1.0.0\"\r\n        xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n        xsi:schemaLocation=\"http://maven.apache.org/SETTINGS/1.0.0 http://maven.apache.org/xsd/settings-1.0.0.xsd\">\r\n        <profiles>\r\n            <profile>\r\n                <id>redhat</id>\r\n                <repositories>\r\n                    <repository>\r\n                        <id>redhat</id>\r\n                        <name>Repository for Redhat dependencies</name>\r\n                        <url>https://maven.repository.redhat.com/ga/</url>\r\n                    </repository>\r\n                </repositories>\r\n                <pluginRepositories>\r\n                    <pluginRepository>\r\n                        <id>redhat</id>\r\n                        <name>Repository for Redhat dependencies</name>\r\n                        <url>https://maven.repository.redhat.com/ga/</url>\r\n                    </pluginRepository>\r\n                </pluginRepositories>\r\n            </profile>\r\n            <profile>\r\n                <id>customRemoteRepository</id>\r\n                <repositories>\r\n                    <repository>\r\n                        <id>internal.s2i.maven.remote.repository</id>\r\n                        <url>${internal.s2i.maven.remote.repository}</url>\r\n                        <snapshots>\r\n                            <enabled>false</enabled>\r\n                        </snapshots>\r\n                    </repository>\r\n                </repositories>\r\n                <pluginRepositories>\r\n                    <pluginRepository>\r\n                        <id>internal.s2i.maven.remote.repository</id>\r\n                        <url>${internal.s2i.maven.remote.repository}</url>\r\n                        <snapshots>\r\n                            <enabled>false</enabled>\r\n                        </snapshots>\r\n                    </pluginRepository>\r\n                </pluginRepositories>\r\n            </profile>\r\n        </profiles>\r\n        <activeProfiles>\r\n            <activeProfile>customRemoteRepository</activeProfile>\r\n            <activeProfile>redhat</activeProfile>\r\n        </activeProfiles>\r\n    </settings>\r\n```\r\n2. create `openshift.yml` with following content\r\n```\r\n---\r\napiVersion: \"v1\"\r\nkind: \"List\"\r\nitems:\r\n- apiVersion: \"image.openshift.io/v1\"\r\n  kind: \"ImageStream\"\r\n  metadata:\r\n    labels:\r\n      scenarioId: \"OpenShiftS2iQuickstartUsingDefaultsIT-1675362556927\"\r\n    name: \"app\"\r\n    namespace: \"mvavrik-s2i-debug\"\r\n  spec:\r\n    lookupPolicy:\r\n      local: false\r\n- apiVersion: \"build.openshift.io/v1\"\r\n  kind: \"BuildConfig\"\r\n  metadata:\r\n    labels:\r\n      scenarioId: \"OpenShiftS2iQuickstartUsingDefaultsIT-1675362556927\"\r\n    name: \"app\"\r\n    namespace: \"mvavrik-s2i-debug\"\r\n  spec:\r\n    output:\r\n      to:\r\n        kind: \"ImageStreamTag\"\r\n        name: \"app:latest\"\r\n    source:\r\n      configMaps:\r\n      - configMap:\r\n          name: \"settings-mvn\"\r\n        destinationDir: \"/configuration\"\r\n      contextDir: \"getting-started\"\r\n      git:\r\n        uri: \"https://github.com/quarkusio/quarkus-quickstarts.git\"\r\n      type: \"Git\"\r\n    strategy:\r\n      sourceStrategy:\r\n        env:\r\n        - name: \"MAVEN_ARGS\"\r\n          value: \"-s /configuration/settings.xml -DskipTests=true -DskipITs=true -Dquarkus.platform.version=2.16.1.Final\\\r\n            \\ -Dquarkus-plugin.version=2.16.1.Final -Dquarkus.platform.group-id=io.quarkus\\\r\n            \\ -Dquarkus.platform.version=2.16.1.Final -Dquarkus.platform.group-id=io.quarkus\\\r\n            \\ -Dquarkus-plugin.version=2.16.1.Final\"\r\n        from:\r\n          kind: \"DockerImage\"\r\n          name: \"quay.io/quarkus/ubi-quarkus-native-binary-s2i:2.0\"\r\n      type: \"Source\"\r\n    triggers:\r\n    - type: \"ConfigChange\"\r\n    - imageChange: {}\r\n      type: \"ImageChange\"\r\n- apiVersion: \"apps.openshift.io/v1\"\r\n  kind: \"DeploymentConfig\"\r\n  metadata:\r\n    labels:\r\n      scenarioId: \"OpenShiftS2iQuickstartUsingDefaultsIT-1675362556927\"\r\n    name: \"app\"\r\n    namespace: \"mvavrik-s2i-debug\"\r\n  spec:\r\n    replicas: 1\r\n    selector:\r\n      name: \"app\"\r\n    template:\r\n      metadata:\r\n        labels:\r\n          name: \"app\"\r\n          tsLogWatch: \"app\"\r\n          scenarioId: \"OpenShiftS2iQuickstartUsingDefaultsIT-1675362556927\"\r\n        namespace: \"mvavrik-s2i-debug\"\r\n      spec:\r\n        containers:\r\n        - env:\r\n          - name: \"quarkus.log.console.format\"\r\n            value: \"%d{HH:mm:ss,SSS} %s%e%n\"\r\n          image: \"app:latest\"\r\n          name: \"app\"\r\n          ports:\r\n          - containerPort: 8080\r\n            protocol: \"TCP\"\r\n    test: false\r\n    triggers:\r\n    - type: \"ConfigChange\"\r\n    - imageChangeParams:\r\n        automatic: true\r\n        containerNames:\r\n        - \"app\"\r\n        from:\r\n          kind: \"ImageStreamTag\"\r\n          name: \"app:latest\"\r\n      type: \"ImageChange\"\r\n- apiVersion: \"v1\"\r\n  kind: \"Service\"\r\n  metadata:\r\n    labels:\r\n      scenarioId: \"OpenShiftS2iQuickstartUsingDefaultsIT-1675362556927\"\r\n    name: \"app\"\r\n    namespace: \"mvavrik-s2i-debug\"\r\n  spec:\r\n    ports:\r\n    - name: \"8080-tcp\"\r\n      port: 8080\r\n      protocol: \"TCP\"\r\n      targetPort: 8080\r\n    selector:\r\n      name: \"app\"\r\n- apiVersion: \"route.openshift.io/v1\"\r\n  kind: \"Route\"\r\n  metadata:\r\n    labels:\r\n      scenarioId: \"OpenShiftS2iQuickstartUsingDefaultsIT-1675362556927\"\r\n    name: \"app\"\r\n    namespace: \"mvavrik-s2i-debug\"\r\n  spec:\r\n    to:\r\n      name: \"app\"\r\n```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux\r\n\r\n### Output of `java -version`\r\n\r\nOpenJDK Runtime Environment Temurin-17.0.5+8 (build 17.0.5+8)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n22.3\r\n\r\n### Quarkus version or git rev\r\n\r\n2.16.1.FInal\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.6 (84538c9988a25aec085021c365c560670ad80f63)\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/30829/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30829/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
