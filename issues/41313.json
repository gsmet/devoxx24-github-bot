{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41313",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41313/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41313/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41313/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/41313",
  "id": 2362526956,
  "node_id": "I_kwDOCFbutM6M0Uzs",
  "number": 41313,
  "title": "Pinned thread on Vault fetch secret",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 13,
  "created_at": "2024-06-19T14:26:57Z",
  "updated_at": "2024-08-02T13:12:36Z",
  "closed_at": "2024-08-02T13:12:36Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nI detected the following thread pinning:\r\n\r\n```\r\nThread[#831,ForkJoinPool-1-worker-23,5,CarrierThreads]\r\njava.base/java.lang.VirtualThread$VThreadContinuation.onPinned(VirtualThread.java:183)\r\njava.base/jdk.internal.vm.Continuation.onPinned0(Continuation.java:393)\r\njava.base/java.lang.VirtualThread.park(VirtualThread.java:582)\r\njava.base/java.lang.System$2.parkVirtualThread(System.java:2643)\r\njava.base/jdk.internal.misc.VirtualThreads.park(VirtualThreads.java:54)\r\njava.base/java.util.concurrent.locks.LockSupport.park(LockSupport.java:219)\r\njava.base/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:754)\r\njava.base/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1099)\r\njava.base/java.util.concurrent.CountDownLatch.await(CountDownLatch.java:230)\r\nio.smallrye.mutiny.operators.uni.UniBlockingAwait.await(UniBlockingAwait.java:67)\r\nio.smallrye.mutiny.groups.UniAwait.atMost(UniAwait.java:65)\r\nio.smallrye.mutiny.groups.UniAwait.indefinitely(UniAwait.java:46)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.fetchSecrets(VaultConfigSource.java:141)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.lambda$fetchSecrets$2(VaultConfigSource.java:136)\r\njava.base/java.util.ArrayList.forEach(ArrayList.java:1596)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.fetchSecrets(VaultConfigSource.java:136)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.lambda$fetchSecrets$1(VaultConfigSource.java:132)\r\njava.base/java.util.HashMap.forEach(HashMap.java:1429)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.fetchSecrets(VaultConfigSource.java:132)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.getSecretConfig(VaultConfigSource.java:87)\r\nio.quarkus.vault.runtime.config.VaultConfigSource.getValue(VaultConfigSource.java:64)\r\nio.smallrye.config.SmallRyeConfigSources$ConfigValueConfigSourceWrapper.getConfigValue(SmallRyeConfigSources.java:73)\r\nio.smallrye.config.SmallRyeConfigSources.getValue(SmallRyeConfigSources.java:36)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.SecretKeysConfigSourceInterceptor.getValue(SecretKeysConfigSourceInterceptor.java:26)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.ProfileConfigSourceInterceptor.getProfileValue(ProfileConfigSourceInterceptor.java:51)\r\nio.smallrye.config.ProfileConfigSourceInterceptor.getValue(ProfileConfigSourceInterceptor.java:36)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.LoggingConfigSourceInterceptor.getValue(LoggingConfigSourceInterceptor.java:26)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.quarkus.smallrye.openapi.runtime.OpenApiConfigMapping.getValue(OpenApiConfigMapping.java:32)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.RelocateConfigSourceInterceptor.getValue(RelocateConfigSourceInterceptor.java:25)\r\nio.quarkus.smallrye.openapi.runtime.OpenApiConfigMapping.getValue(OpenApiConfigMapping.java:32)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.ExpressionConfigSourceInterceptor.getValue(ExpressionConfigSourceInterceptor.java:43)\r\nio.smallrye.config.ExpressionConfigSourceInterceptor.getValue(ExpressionConfigSourceInterceptor.java:35)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.quarkus.opentelemetry.runtime.config.OTelFallbackConfigSourceInterceptor.getValue(OTelFallbackConfigSourceInterceptor.java:45)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.SecretKeysHandlerConfigSourceInterceptor.getValue(SecretKeysHandlerConfigSourceInterceptor.java:26)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.FallbackConfigSourceInterceptor.getValue(FallbackConfigSourceInterceptor.java:24)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.quarkus.opentelemetry.runtime.config.MpTelemetryRelocateConfigSourceInterceptor$1.getValue(MpTelemetryRelocateConfigSourceInterceptor.java:26)\r\nio.smallrye.config.SmallRyeConfigSourceInterceptorContext.proceed(SmallRyeConfigSourceInterceptorContext.java:25)\r\nio.smallrye.config.SmallRyeConfig.getConfigValue(SmallRyeConfig.java:382)\r\nio.smallrye.config.SmallRyeConfig.getValue(SmallRyeConfig.java:302)\r\nio.smallrye.config.SmallRyeConfig.getOptionalValue(SmallRyeConfig.java:399)\r\nio.quarkus.restclient.config.RestClientConfig.getConfigValue(RestClientConfig.java:390)\r\nio.quarkus.restclient.config.RestClientConfig.load(RestClientConfig.java:340)\r\nio.quarkus.restclient.config.RestClientsConfig.lambda$getClientConfig$0(RestClientsConfig.java:318)\r\njava.base/java.util.concurrent.ConcurrentHashMap.computeIfAbsent(ConcurrentHashMap.java:1708) <== monitors:1\r\nio.quarkus.restclient.config.RestClientsConfig.getClientConfig(RestClientsConfig.java:318)\r\nio.quarkus.rest.client.reactive.runtime.RestClientCDIDelegateBuilder.clientConfigByClassName(RestClientCDIDelegateBuilder.java:409)\r\nio.quarkus.rest.client.reactive.runtime.RestClientCDIDelegateBuilder.configureBaseUrl(RestClientCDIDelegateBuilder.java:377)\r\nio.quarkus.rest.client.reactive.runtime.RestClientCDIDelegateBuilder.configureBuilder(RestClientCDIDelegateBuilder.java:68)\r\nio.quarkus.rest.client.reactive.runtime.RestClientCDIDelegateBuilder.build(RestClientCDIDelegateBuilder.java:63)\r\nio.quarkus.rest.client.reactive.runtime.RestClientCDIDelegateBuilder.createDelegate(RestClientCDIDelegateBuilder.java:46)\r\nio.quarkus.rest.client.reactive.runtime.RestClientReactiveCDIWrapperBase.delegate(RestClientReactiveCDIWrapperBase.java:76)\r\nio.quarkus.rest.client.reactive.runtime.RestClientReactiveCDIWrapperBase.<init>(RestClientReactiveCDIWrapperBase.java:30)\r\n... // business code\r\nio.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:119)\r\nio.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:38)\r\nio.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:35)\r\nio.quarkus.arc.generator.Default_jakarta_enterprise_context_ApplicationScoped_ContextInstances.c54(Unknown Source)\r\nio.quarkus.arc.generator.Default_jakarta_enterprise_context_ApplicationScoped_ContextInstances.computeIfAbsent(Unknown Source)\r\nio.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:35)\r\nio.quarkus.arc.impl.ClientProxies.getApplicationScopedDelegate(ClientProxies.java:21)\r\n... // business code\r\njava.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\r\njava.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\r\njava.base/java.util.Spliterators$ArraySpliterator.forEachRemaining(Spliterators.java:1024)\r\njava.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\njava.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\njava.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:921)\r\njava.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\njava.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:682)\r\n... // business code\r\njava.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184)\r\njava.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\r\njava.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1708)\r\njava.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\r\njava.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\njava.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:151)\r\njava.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:174)\r\njava.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\njava.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n... // business code\r\nio.smallrye.reactive.messaging.providers.AbstractMediator.lambda$invokeBlocking$15(AbstractMediator.java:190)\r\nio.smallrye.context.impl.wrappers.SlowContextualSupplier.get(SlowContextualSupplier.java:21)\r\nio.smallrye.mutiny.operators.uni.builders.UniCreateFromDeferredSupplier.subscribe(UniCreateFromDeferredSupplier.java:25)\r\nio.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\nio.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\nio.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\njava.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\njava.base/java.lang.VirtualThread.run(VirtualThread.java:309)\r\n```\r\n\r\nwe have not identified any native blocking calls in our business code.\r\nwhat could cause this pinning?\r\nI tried creating a reproducer, with no luck.\r\nmay be that is an issue with the vault extension, but I do not see any native call. or in the business code?\r\nhow can we investigate this issue?\n\n### Expected behavior\n\n_No response_\n\n### Actual behavior\n\n_No response_\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### Quarkus version or git rev\n\n3.9.5\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41313/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41313/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
