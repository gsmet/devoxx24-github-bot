{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32463",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32463/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32463/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32463/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/32463",
  "id": 1657078923,
  "node_id": "I_kwDOCFbutM5ixQSL",
  "number": 32463,
  "title": "Quarkus 2.16.6: MQTT Connector allways starts dev services although all config is provided",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1676631606,
      "node_id": "MDU6TGFiZWwxNjc2NjMxNjA2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/windows",
      "name": "env/windows",
      "color": "edea47",
      "default": false,
      "description": "Impacts Windows machines"
    },
    {
      "id": 2955097667,
      "node_id": "MDU6TGFiZWwyOTU1MDk3NjY3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/devservices",
      "name": "area/devservices",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/288",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/288",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/288/labels",
    "id": 10189838,
    "node_id": "MI_kwDOCFbutM4Am3wO",
    "number": 288,
    "title": "3.7.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 432,
    "state": "closed",
    "created_at": "2023-11-15T08:06:53Z",
    "updated_at": "2024-05-17T12:27:49Z",
    "due_on": null,
    "closed_at": "2024-01-17T13:52:08Z"
  },
  "comments": 6,
  "created_at": "2023-04-06T09:55:11Z",
  "updated_at": "2023-11-30T09:46:23Z",
  "closed_at": "2023-11-30T09:46:19Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nSince Quarkus 2.16.6, you cannot start quarkusDev without having a running docker when you use the MQTT connector. Even though I configured everything required to connect to my external MQTT provider, Quarkus tries to start the MQTT dev services and crashes when you don't have docker running. \r\n\r\nMy config (also see reproducer below) to a public test broker:\r\n\r\n```\r\nmp.messaging.incoming.consumer1.connector=smallrye-mqtt\r\nmp.messaging.incoming.consumer1.host=public.mqtthq.com\r\nmp.messaging.incoming.consumer1.port=1883\r\nmp.messaging.incoming.consumer1.topic=arconsis/#\r\n```\r\n\r\nWith Quarkus 2.16.5.Final, the application did start and not crash. \r\n\r\nA workaround is to disable devservices with this config:\r\n\r\n```\r\nquarkus.devservices.enabled=false\r\n```\r\n\r\n### Expected behavior\r\n\r\nQuarkus should not start the dev services because I configured the required properties.\r\n\r\n### Actual behavior\r\n\r\nAt startup, Quarkus crashes if you do not have docker running because it tries to start dev services. This is the exception:\r\n\r\n```\r\n2023-04-06 11:48:29,298 INFO  [org.tes.doc.DockerClientProviderStrategy] (build-1) Loaded org.testcontainers.dockerclient.NpipeSocketClientProviderStrategy from ~/.testcontainers.properties, will try it first\r\n2023-04-06 11:48:29,326 INFO  [org.tes.doc.DockerMachineClientProviderStrategy] (build-1) docker-machine executable was not found on PATH ([ ... ])\r\n2023-04-06 11:48:29,327 ERROR [org.tes.doc.DockerClientProviderStrategy] (build-1) Could not find a valid Docker environment. Please check configuration. Attempted configurations were:\r\nAs no valid configuration was found, execution cannot continue.\r\nSee https://www.testcontainers.org/on_failure.html for more details.\r\n2023-04-06 11:48:29,531 INFO  [org.tes.uti.ImageNameSubstitutor] (build-1) Image name substitution will be performed by: DefaultImageNameSubstitutor (composite of 'ConfigurationFileImageNameSubstitutor' and 'PrefixingImageNameSubstitutor')\r\n2023-04-06 11:48:29,550 INFO  [io.qua.dep.dev.IsolatedDevModeMain] (main) Attempting to start live reload endpoint to recover from previous Quarkus startup failure\r\n2023-04-06 11:48:29,608 ERROR [io.qua.dep.dev.IsolatedDevModeMain] (main) Failed to start quarkus: java.lang.RuntimeException: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n\t[error]: Build step io.quarkus.smallrye.reactivemessaging.mqtt.deployment.MqttDevServicesProcessor#startMqttDevService threw an exception: java.lang.RuntimeException: java.lang.IllegalStateException: Previous attempts to find a Docker environment failed. Will not retry. Please see logs and check configuration\r\n\tat io.quarkus.smallrye.reactivemessaging.mqtt.deployment.MqttDevServicesProcessor.startMqttDevService(MqttDevServicesProcessor.java:98)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:909)\r\n\tat io.quarkus.builder.BuildContext.run(BuildContext.java:281)\r\n\tat org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n\tat org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\nCaused by: java.lang.IllegalStateException: Previous attempts to find a Docker environment failed. Will not retry. Please see logs and check configuration\r\n\tat org.testcontainers.dockerclient.DockerClientProviderStrategy.getFirstValidStrategy(DockerClientProviderStrategy.java:212)\r\n\tat org.testcontainers.DockerClientFactory.getOrInitializeStrategy(DockerClientFactory.java:150)\r\n\tat org.testcontainers.DockerClientFactory.client(DockerClientFactory.java:186)\r\n\tat org.testcontainers.DockerClientFactory$1.getDockerClient(DockerClientFactory.java:104)\r\n\tat com.github.dockerjava.api.DockerClientDelegate.listContainersCmd(DockerClientDelegate.java:188)\r\n\tat io.quarkus.devservices.common.ContainerLocator.lookup(ContainerLocator.java:32)\r\n\tat io.quarkus.devservices.common.ContainerLocator.locateContainer(ContainerLocator.java:45)\r\n\tat io.quarkus.smallrye.reactivemessaging.mqtt.deployment.MqttDevServicesProcessor.startMqttBroker(MqttDevServicesProcessor.java:175)\r\n\tat io.quarkus.smallrye.reactivemessaging.mqtt.deployment.MqttDevServicesProcessor.startMqttDevService(MqttDevServicesProcessor.java:81)\r\n\t... 11 more\r\n\r\n\tat io.quarkus.runner.bootstrap.AugmentActionImpl.runAugment(AugmentActionImpl.java:335)\r\n\tat io.quarkus.runner.bootstrap.AugmentActionImpl.createInitialRuntimeApplication(AugmentActionImpl.java:252)\r\n\tat io.quarkus.runner.bootstrap.AugmentActionImpl.createInitialRuntimeApplication(AugmentActionImpl.java:60)\r\n\tat io.quarkus.deployment.dev.IsolatedDevModeMain.firstStart(IsolatedDevModeMain.java:86)\r\n\tat io.quarkus.deployment.dev.IsolatedDevModeMain.accept(IsolatedDevModeMain.java:447)\r\n\tat io.quarkus.deployment.dev.IsolatedDevModeMain.accept(IsolatedDevModeMain.java:59)\r\n\tat io.quarkus.bootstrap.app.CuratedApplication.runInCl(CuratedApplication.java:149)\r\n\tat io.quarkus.bootstrap.app.CuratedApplication.runInAugmentClassLoader(CuratedApplication.java:104)\r\n\tat io.quarkus.deployment.dev.DevModeMain.start(DevModeMain.java:131)\r\n\tat io.quarkus.deployment.dev.DevModeMain.main(DevModeMain.java:62)\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nReproducer: \r\n[2023-04-06-mqtt-always-devservices.zip](https://github.com/quarkusio/quarkus/files/11168943/2023-04-06-mqtt-always-devservices.zip)\r\n\r\n1. Download and unzip the reproducer\r\n2. Stop your local docker\r\n3. start the reproducer with `./gradlew quarkusDev`\r\n4. See the crash in the console\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\nJDK17\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.16.6.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32463/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32463/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
