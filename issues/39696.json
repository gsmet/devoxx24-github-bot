{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/39696",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39696/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39696/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39696/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/39696",
  "id": 2208018312,
  "node_id": "I_kwDOCFbutM6Dm6-I",
  "number": 39696,
  "title": "Avoid ThreadLocals while using VirtualThreads",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 6031725549,
      "node_id": "LA_kwDOCFbutM8AAAABZ4TT7Q",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/virtual-threads",
      "name": "area/virtual-threads",
      "color": "0366d6",
      "default": false,
      "description": "Issue related to Java's Virtual Threads"
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 35,
  "created_at": "2024-03-26T11:46:36Z",
  "updated_at": "2024-04-30T08:07:00Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "Similarly to https://github.com/FasterXML/jackson-core/issues/919\r\n\r\nin quarkus we have few parts which are still using thread locals \r\n\r\neg running the test https://github.com/franz1981/fortune-benchmark/blob/main/fortune-virtual-thread-postgresql/src/test/java/me/escoffier/fortune/virtual/reactive/postgresql/test/FortuneApiTest.java\r\nadding the parameter `-Djdk.traceVirtualThreadLocals=true`\r\n\r\nshould report this stack trace (which ca be used in IDEA stack trace analyzer to fix the issues, one by one):\r\n```\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch2(VertxImpl.java:1372)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch(VertxImpl.java:1366)\r\n    io.vertx.core.impl.ContextInternal.beginDispatch(ContextInternal.java:301)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:43)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$IndexNode.keyOf(ZipFileSystem.java:2603)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.getInode(ZipFileSystem.java:1899)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.exists(ZipFileSystem.java:658)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipPath.exists(ZipPath.java:905)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystemProvider.exists(ZipFileSystemProvider.java:197)\r\n    java.base/java.nio.file.Files.exists(Files.java:2514)\r\n    io.quarkus.paths.DirectoryPathTree.apply(DirectoryPathTree.java:103)\r\n    io.quarkus.paths.ArchivePathTree$OpenArchivePathTree.apply(ArchivePathTree.java:262)\r\n    io.quarkus.paths.PathTreeWithManifest.apply(PathTreeWithManifest.java:74)\r\n    io.quarkus.paths.SharedArchivePathTree$CallerOpenPathTree.apply(SharedArchivePathTree.java:153)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement.lambda$getResource$1(PathTreeClassPathElement.java:106)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement.apply(PathTreeClassPathElement.java:114)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement.getResource(PathTreeClassPathElement.java:106)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:504)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:468)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch2(VertxImpl.java:1377)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch(VertxImpl.java:1366)\r\n    io.vertx.core.impl.ContextInternal.beginDispatch(ContextInternal.java:301)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:43)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.set(ThreadLocal.java:253)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$IndexNode.keyOf(ZipFileSystem.java:2606)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.getInode(ZipFileSystem.java:1899)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.exists(ZipFileSystem.java:658)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipPath.exists(ZipPath.java:905)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystemProvider.exists(ZipFileSystemProvider.java:197)\r\n    java.base/java.nio.file.Files.exists(Files.java:2514)\r\n    io.quarkus.paths.DirectoryPathTree.apply(DirectoryPathTree.java:103)\r\n    io.quarkus.paths.ArchivePathTree$OpenArchivePathTree.apply(ArchivePathTree.java:262)\r\n    io.quarkus.paths.PathTreeWithManifest.apply(PathTreeWithManifest.java:74)\r\n    io.quarkus.paths.SharedArchivePathTree$CallerOpenPathTree.apply(SharedArchivePathTree.java:153)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement.lambda$getResource$1(PathTreeClassPathElement.java:106)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement.apply(PathTreeClassPathElement.java:114)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement.getResource(PathTreeClassPathElement.java:106)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:504)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:468)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch2(VertxImpl.java:1377)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch(VertxImpl.java:1366)\r\n    io.vertx.core.impl.ContextInternal.beginDispatch(ContextInternal.java:301)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:43)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.getCarrierThreadLocal(ThreadLocal.java:181)\r\n    java.base/java.lang.System$2.getCarrierThreadLocal(System.java:2597)\r\n    java.base/jdk.internal.misc.CarrierThreadLocal.get(CarrierThreadLocal.java:39)\r\n    java.base/jdk.internal.misc.TerminatingThreadLocal.register(TerminatingThreadLocal.java:83)\r\n    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:233)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.getCarrierThreadLocal(ThreadLocal.java:181)\r\n    java.base/java.lang.System$2.getCarrierThreadLocal(System.java:2597)\r\n    java.base/jdk.internal.misc.CarrierThreadLocal.get(CarrierThreadLocal.java:39)\r\n    java.base/sun.nio.ch.Util.getTemporaryDirectBuffer(Util.java:230)\r\n    java.base/sun.nio.ch.IOUtil.read(IOUtil.java:303)\r\n    java.base/sun.nio.ch.IOUtil.read(IOUtil.java:283)\r\n    java.base/sun.nio.ch.FileChannelImpl.readInternal(FileChannelImpl.java:984)\r\n    java.base/sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:967)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.readFullyAt(ZipFileSystem.java:1241)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.readFullyAt(ZipFileSystem.java:1236)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$EntryInputStream.initDataPos(ZipFileSystem.java:2386)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$EntryInputStream.read(ZipFileSystem.java:2328)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$2.fill(ZipFileSystem.java:2278)\r\n    java.base/java.util.zip.InflaterInputStream.read(InflaterInputStream.java:175)\r\n    java.base/java.io.InputStream.readNBytes(InputStream.java:412)\r\n    java.base/java.io.InputStream.readAllBytes(InputStream.java:349)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.newByteChannel(ZipFileSystem.java:977)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipPath.newByteChannel(ZipPath.java:870)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystemProvider.newByteChannel(ZipFileSystemProvider.java:247)\r\n    java.base/java.nio.file.Files.newByteChannel(Files.java:379)\r\n    java.base/java.nio.file.Files.newByteChannel(Files.java:431)\r\n    java.base/java.nio.file.Files.readAllBytes(Files.java:3268)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement$Resource.getData(PathTreeClassPathElement.java:269)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:506)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:468)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch2(VertxImpl.java:1377)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch(VertxImpl.java:1366)\r\n    io.vertx.core.impl.ContextInternal.beginDispatch(ContextInternal.java:301)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:43)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.getCarrierThreadLocal(ThreadLocal.java:181)\r\n    java.base/java.lang.System$2.getCarrierThreadLocal(System.java:2597)\r\n    java.base/jdk.internal.misc.CarrierThreadLocal.get(CarrierThreadLocal.java:39)\r\n    java.base/sun.nio.ch.Util.getTemporaryDirectBuffer(Util.java:230)\r\n    java.base/sun.nio.ch.IOUtil.read(IOUtil.java:303)\r\n    java.base/sun.nio.ch.IOUtil.read(IOUtil.java:283)\r\n    java.base/sun.nio.ch.FileChannelImpl.readInternal(FileChannelImpl.java:984)\r\n    java.base/sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:967)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.readFullyAt(ZipFileSystem.java:1241)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.readFullyAt(ZipFileSystem.java:1236)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$EntryInputStream.initDataPos(ZipFileSystem.java:2386)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$EntryInputStream.read(ZipFileSystem.java:2328)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem$2.fill(ZipFileSystem.java:2278)\r\n    java.base/java.util.zip.InflaterInputStream.read(InflaterInputStream.java:175)\r\n    java.base/java.io.InputStream.readNBytes(InputStream.java:412)\r\n    java.base/java.io.InputStream.readAllBytes(InputStream.java:349)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystem.newByteChannel(ZipFileSystem.java:977)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipPath.newByteChannel(ZipPath.java:870)\r\n    jdk.zipfs/jdk.nio.zipfs.ZipFileSystemProvider.newByteChannel(ZipFileSystemProvider.java:247)\r\n    java.base/java.nio.file.Files.newByteChannel(Files.java:379)\r\n    java.base/java.nio.file.Files.newByteChannel(Files.java:431)\r\n    java.base/java.nio.file.Files.readAllBytes(Files.java:3268)\r\n    io.quarkus.bootstrap.classloading.PathTreeClassPathElement$Resource.getData(PathTreeClassPathElement.java:269)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:506)\r\n    io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:468)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch2(VertxImpl.java:1377)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch(VertxImpl.java:1366)\r\n    io.vertx.core.impl.ContextInternal.beginDispatch(ContextInternal.java:301)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:43)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.set(ThreadLocal.java:253)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch2(VertxImpl.java:1378)\r\n    io.vertx.core.impl.VertxImpl.beginDispatch(VertxImpl.java:1366)\r\n    io.vertx.core.impl.ContextInternal.beginDispatch(ContextInternal.java:301)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:43)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)\r\n    io.quarkus.arc.impl.InjectionPointProvider.set(InjectionPointProvider.java:29)\r\n    io.quarkus.arc.impl.ArcContainerImpl.beanInstanceHandle(ArcContainerImpl.java:556)\r\n    io.quarkus.arc.impl.ArcContainerImpl.beanInstanceHandle(ArcContainerImpl.java:539)\r\n    io.quarkus.arc.impl.ArcContainerImpl.beanInstanceHandle(ArcContainerImpl.java:572)\r\n    io.quarkus.arc.impl.ArcContainerImpl$3.get(ArcContainerImpl.java:331)\r\n    io.quarkus.arc.impl.ArcContainerImpl$3.get(ArcContainerImpl.java:328)\r\n    io.quarkus.arc.runtime.BeanContainerImpl$1.create(BeanContainerImpl.java:58)\r\n    io.quarkus.resteasy.reactive.common.runtime.ArcBeanFactory.createInstance(ArcBeanFactory.java:27)\r\n    org.jboss.resteasy.reactive.server.handlers.InstanceHandler.handle(InstanceHandler.java:26)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:139)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.set(ThreadLocal.java:253)\r\n    io.quarkus.arc.impl.InjectionPointProvider.set(InjectionPointProvider.java:33)\r\n    io.quarkus.arc.impl.ArcContainerImpl.beanInstanceHandle(ArcContainerImpl.java:556)\r\n    io.quarkus.arc.impl.ArcContainerImpl.beanInstanceHandle(ArcContainerImpl.java:539)\r\n    io.quarkus.arc.impl.ArcContainerImpl.beanInstanceHandle(ArcContainerImpl.java:572)\r\n    io.quarkus.arc.impl.ArcContainerImpl$3.get(ArcContainerImpl.java:331)\r\n    io.quarkus.arc.impl.ArcContainerImpl$3.get(ArcContainerImpl.java:328)\r\n    io.quarkus.arc.runtime.BeanContainerImpl$1.create(BeanContainerImpl.java:58)\r\n    io.quarkus.resteasy.reactive.common.runtime.ArcBeanFactory.createInstance(ArcBeanFactory.java:27)\r\n    org.jboss.resteasy.reactive.server.handlers.InstanceHandler.handle(InstanceHandler.java:26)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:139)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)\r\n    io.smallrye.context.SmallRyeThreadContext.getCurrentThreadContext(SmallRyeThreadContext.java:194)\r\n    io.smallrye.context.SmallRyeThreadContext.getCurrentThreadContextOrDefaultContexts(SmallRyeThreadContext.java:160)\r\n    io.smallrye.mutiny.context.DefaultContextPropagationInterceptor.getThreadContext(DefaultContextPropagationInterceptor.java:12)\r\n    io.smallrye.mutiny.context.BaseContextPropagationInterceptor.decorate(BaseContextPropagationInterceptor.java:33)\r\n    io.smallrye.mutiny.infrastructure.Infrastructure.decorate(Infrastructure.java:152)\r\n    io.smallrye.mutiny.vertx.AsyncResultUni.<init>(AsyncResultUni.java:21)\r\n    io.smallrye.mutiny.vertx.AsyncResultUni.toUni(AsyncResultUni.java:17)\r\n    io.vertx.mutiny.sqlclient.Pool.getConnection(Pool.java:115)\r\n    io.vertx.mutiny.pgclient.PgPool_Ly1M_jXJtinTvrqFDvbMm7TSXGc_Synthetic_ClientProxy.getConnection(Unknown Source)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository.listAll(FortuneRepository.java:53)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository_ClientProxy.listAll(Unknown Source)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource.getAllFortunes(FortuneResource.java:22)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource$quarkusrestinvoker$getAllFortunes_17630c6d41f1fd48ab8b75db07f293217742deee.invoke(Unknown Source)\r\n    org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.set(ThreadLocal.java:253)\r\n    io.smallrye.context.SmallRyeThreadContext.withThreadContext(SmallRyeThreadContext.java:93)\r\n    io.smallrye.context.impl.SlowActiveContextState.<init>(SlowActiveContextState.java:31)\r\n    io.smallrye.context.impl.SlowCapturedContextState.begin(SlowCapturedContextState.java:34)\r\n    io.smallrye.context.impl.SlowCapturedContextState.begin(SlowCapturedContextState.java:13)\r\n    io.smallrye.context.impl.wrappers.SlowContextualConsumer.accept(SlowContextualConsumer.java:20)\r\n    io.smallrye.mutiny.vertx.AsyncResultUni.subscribe(AsyncResultUni.java:31)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniBlockingAwait.await(UniBlockingAwait.java:60)\r\n    io.smallrye.mutiny.groups.UniAwait.atMost(UniAwait.java:65)\r\n    io.smallrye.mutiny.groups.UniAwait.indefinitely(UniAwait.java:46)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository.listAll(FortuneRepository.java:62)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository_ClientProxy.listAll(Unknown Source)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource.getAllFortunes(FortuneResource.java:22)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource$quarkusrestinvoker$getAllFortunes_17630c6d41f1fd48ab8b75db07f293217742deee.invoke(Unknown Source)\r\n    org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)\r\n    io.netty.util.internal.InternalThreadLocalMap.slowGet(InternalThreadLocalMap.java:130)\r\n    io.netty.util.internal.InternalThreadLocalMap.get(InternalThreadLocalMap.java:117)\r\n    io.netty.util.concurrent.FastThreadLocal.get(FastThreadLocal.java:136)\r\n    io.vertx.core.net.impl.pool.CombinerExecutor.submit(CombinerExecutor.java:85)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool.execute(SimpleConnectionPool.java:244)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool.acquire(SimpleConnectionPool.java:639)\r\n    io.vertx.sqlclient.impl.pool.SqlConnectionPool.acquire(SqlConnectionPool.java:239)\r\n    io.vertx.sqlclient.impl.PoolImpl.acquire(PoolImpl.java:176)\r\n    io.vertx.sqlclient.impl.PoolImpl.getConnection(PoolImpl.java:139)\r\n    io.vertx.sqlclient.impl.PoolImpl.getConnection(PoolImpl.java:126)\r\n    io.vertx.sqlclient.impl.PoolBase.getConnection(PoolBase.java:56)\r\n    io.vertx.pgclient.PgPool_7weXgYHcaRck_k2l7dGKfXZMdD8_Synthetic_ClientProxy.getConnection(Unknown Source)\r\n    io.vertx.mutiny.sqlclient.Pool.lambda$getConnection$11(Pool.java:116)\r\n    io.smallrye.context.impl.wrappers.SlowContextualConsumer.accept(SlowContextualConsumer.java:21)\r\n    io.smallrye.mutiny.vertx.AsyncResultUni.subscribe(AsyncResultUni.java:31)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniBlockingAwait.await(UniBlockingAwait.java:60)\r\n    io.smallrye.mutiny.groups.UniAwait.atMost(UniAwait.java:65)\r\n    io.smallrye.mutiny.groups.UniAwait.indefinitely(UniAwait.java:46)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository.listAll(FortuneRepository.java:62)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository_ClientProxy.listAll(Unknown Source)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource.getAllFortunes(FortuneResource.java:22)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource$quarkusrestinvoker$getAllFortunes_17630c6d41f1fd48ab8b75db07f293217742deee.invoke(Unknown Source)\r\n    org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.set(ThreadLocal.java:253)\r\n    io.netty.util.internal.InternalThreadLocalMap.slowGet(InternalThreadLocalMap.java:133)\r\n    io.netty.util.internal.InternalThreadLocalMap.get(InternalThreadLocalMap.java:117)\r\n    io.netty.util.concurrent.FastThreadLocal.get(FastThreadLocal.java:136)\r\n    io.vertx.core.net.impl.pool.CombinerExecutor.submit(CombinerExecutor.java:85)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool.execute(SimpleConnectionPool.java:244)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool.acquire(SimpleConnectionPool.java:639)\r\n    io.vertx.sqlclient.impl.pool.SqlConnectionPool.acquire(SqlConnectionPool.java:239)\r\n    io.vertx.sqlclient.impl.PoolImpl.acquire(PoolImpl.java:176)\r\n    io.vertx.sqlclient.impl.PoolImpl.getConnection(PoolImpl.java:139)\r\n    io.vertx.sqlclient.impl.PoolImpl.getConnection(PoolImpl.java:126)\r\n    io.vertx.sqlclient.impl.PoolBase.getConnection(PoolBase.java:56)\r\n    io.vertx.pgclient.PgPool_7weXgYHcaRck_k2l7dGKfXZMdD8_Synthetic_ClientProxy.getConnection(Unknown Source)\r\n    io.vertx.mutiny.sqlclient.Pool.lambda$getConnection$11(Pool.java:116)\r\n    io.smallrye.context.impl.wrappers.SlowContextualConsumer.accept(SlowContextualConsumer.java:21)\r\n    io.smallrye.mutiny.vertx.AsyncResultUni.subscribe(AsyncResultUni.java:31)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniBlockingAwait.await(UniBlockingAwait.java:60)\r\n    io.smallrye.mutiny.groups.UniAwait.atMost(UniAwait.java:65)\r\n    io.smallrye.mutiny.groups.UniAwait.indefinitely(UniAwait.java:46)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository.listAll(FortuneRepository.java:62)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository_ClientProxy.listAll(Unknown Source)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource.getAllFortunes(FortuneResource.java:22)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource$quarkusrestinvoker$getAllFortunes_17630c6d41f1fd48ab8b75db07f293217742deee.invoke(Unknown Source)\r\n    org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\nVirtualThread[#172,quarkus-virtual-thread-0]/runnable@ForkJoinPool-1-worker-1    java.base/java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:236)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:194)\r\n    java.base/java.lang.ThreadLocal.get(ThreadLocal.java:172)\r\n    com.intellij.rt.debugger.agent.CaptureStorage.capture(CaptureStorage.java:43)\r\n    io.netty.util.concurrent.SingleThreadEventExecutor.execute0(SingleThreadEventExecutor.java)\r\n    io.netty.util.concurrent.SingleThreadEventExecutor.execute(SingleThreadEventExecutor.java:817)\r\n    io.netty.util.concurrent.AbstractScheduledEventExecutor.schedule(AbstractScheduledEventExecutor.java:290)\r\n    io.netty.util.concurrent.AbstractScheduledEventExecutor.schedule(AbstractScheduledEventExecutor.java:205)\r\n    io.vertx.core.impl.VertxImpl.scheduleTimeout(VertxImpl.java:667)\r\n    io.vertx.core.impl.VertxImpl.scheduleTimeout(VertxImpl.java:678)\r\n    io.vertx.core.impl.ContextInternal.setTimer(ContextInternal.java:478)\r\n    io.vertx.sqlclient.impl.pool.SqlConnectionPool$1PoolRequest.onEnqueue(SqlConnectionPool.java:219)\r\n    io.vertx.sqlclient.impl.pool.SqlConnectionPool$1PoolRequest.onConnect(SqlConnectionPool.java:235)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool$Acquire$3.run(SimpleConnectionPool.java:593)\r\n    io.vertx.core.net.impl.pool.Task.runNextTasks(Task.java:43)\r\n    io.vertx.core.net.impl.pool.CombinerExecutor.submit(CombinerExecutor.java:91)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool.execute(SimpleConnectionPool.java:244)\r\n    io.vertx.core.net.impl.pool.SimpleConnectionPool.acquire(SimpleConnectionPool.java:639)\r\n    io.vertx.sqlclient.impl.pool.SqlConnectionPool.acquire(SqlConnectionPool.java:239)\r\n    io.vertx.sqlclient.impl.PoolImpl.acquire(PoolImpl.java:176)\r\n    io.vertx.sqlclient.impl.PoolImpl.getConnection(PoolImpl.java:139)\r\n    io.vertx.sqlclient.impl.PoolImpl.getConnection(PoolImpl.java:126)\r\n    io.vertx.sqlclient.impl.PoolBase.getConnection(PoolBase.java:56)\r\n    io.vertx.pgclient.PgPool_7weXgYHcaRck_k2l7dGKfXZMdD8_Synthetic_ClientProxy.getConnection(Unknown Source)\r\n    io.vertx.mutiny.sqlclient.Pool.lambda$getConnection$11(Pool.java:116)\r\n    io.smallrye.context.impl.wrappers.SlowContextualConsumer.accept(SlowContextualConsumer.java:21)\r\n    io.smallrye.mutiny.vertx.AsyncResultUni.subscribe(AsyncResultUni.java:31)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniOnItemTransformToUni.subscribe(UniOnItemTransformToUni.java:25)\r\n    io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n    io.smallrye.mutiny.operators.uni.UniBlockingAwait.await(UniBlockingAwait.java:60)\r\n    io.smallrye.mutiny.groups.UniAwait.atMost(UniAwait.java:65)\r\n    io.smallrye.mutiny.groups.UniAwait.indefinitely(UniAwait.java:46)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository.listAll(FortuneRepository.java:62)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneRepository_ClientProxy.listAll(Unknown Source)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource.getAllFortunes(FortuneResource.java:22)\r\n    me.escoffier.fortune.virtual.reactive.postgresql.FortuneResource$quarkusrestinvoker$getAllFortunes_17630c6d41f1fd48ab8b75db07f293217742deee.invoke(Unknown Source)\r\n    org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n    io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n    org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:147)\r\n    io.quarkus.virtual.threads.ContextPreservingExecutorService$ContextPreservingRunnable.run(ContextPreservingExecutorService.java:45)\r\n    java.base/java.util.concurrent.ThreadPerTaskExecutor$TaskRunner.run(ThreadPerTaskExecutor.java:314)\r\n    java.base/java.lang.VirtualThread.run(VirtualThread.java:311)\r\n\r\n```\r\nI think JDK 21 have a BUG on the mentioned property, because the stacks which contains\r\n\r\n```\r\njava.base/java.lang.ThreadLocal.getCarrierThreadLocal(ThreadLocal.java:181)\r\n```\r\nare absolutely fine. \r\nThis is a sign that most users didn't used this feature to make sure are not using thread locals on virtual thread(s) OR that loom is not that used (yet, which makes sense)  OR that thread local(s) is not widely used (which is unlikely, really).\r\n\r\nInstead, https://github.com/openjdk/jdk/blob/b9c76dedf4aa2248a5e561a535c9e3e181f7836a/src/jdk.zipfs/share/classes/jdk/nio/zipfs/ZipFileSystem.java#L2799 shows that OpenJDK still have to fix its own `ThreadLocal` usages as well, although, is not a big deal per-se, given that the number of class-loading operations should not keep on increasing during a run, in theory.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/39696/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39696/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
