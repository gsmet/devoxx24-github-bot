{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41233",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41233/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41233/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41233/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/41233",
  "id": 2355735808,
  "node_id": "I_kwDOCFbutM6Maa0A",
  "number": 41233,
  "title": "Class Loader still used while it's supposed to be closed",
  "labels": [
    {
      "id": 1654772125,
      "node_id": "MDU6TGFiZWwxNjU0NzcyMTI1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kubernetes",
      "name": "area/kubernetes",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 8,
  "created_at": "2024-06-16T12:35:20Z",
  "updated_at": "2024-08-08T13:15:36Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "As part of my work trying to improve the CL situation, I stumbled upon a few cases of $TITLE for which I would need some help.\r\n\r\nIn my patch, I introduce a safe guard throwing an exception when you are trying to load a class from a CL that has been previously closed.\r\nThe rationale is that we shouldn't load any class from a CL that has been closed.\r\n\r\nI already fixed a few of these problems... but I still have some going on that are a lot less easy to pinpoint.\r\n\r\nThese issues where all observed in this specific CI job run: https://github.com/gsmet/quarkus/actions/runs/9535653448/job/26281846636\r\n\r\n1. `io.vertx.core.impl.VertxImpl$1.operationComplete`\r\n\r\n```\r\n2024-06-16 12:05:59,044 WARN [io.net.uti.con.DefaultPromise] (globalEventExecutor-1-1) An exception was thrown by io.vertx.core.impl.VertxImpl$1.operationComplete(): java.lang.IllegalStateException: Class loader Augmentation Class Loader: PROD for minikube-with-defaults has been closed and may not be accessed anymore\r\nat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:723)\r\nat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:499)\r\nat io.vertx.core.impl.VertxImpl$1.operationComplete(VertxImpl.java:986)\r\nat io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)\r\nat io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:557)\r\nat io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:492)\r\nat io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:636)\r\nat io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:625)\r\nat io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:97)\r\nat io.netty.util.concurrent.MultithreadEventExecutorGroup$1.operationComplete(MultithreadEventExecutorGroup.java:117)\r\nat io.netty.util.concurrent.DefaultPromise.notifyListener0(DefaultPromise.java:590)\r\nat io.netty.util.concurrent.DefaultPromise.notifyListenersNow(DefaultPromise.java:557)\r\nat io.netty.util.concurrent.DefaultPromise.access$200(DefaultPromise.java:35)\r\nat io.netty.util.concurrent.DefaultPromise$1.run(DefaultPromise.java:503)\r\nat io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:173)\r\nat io.netty.util.concurrent.GlobalEventExecutor$TaskRunner.run(GlobalEventExecutor.java:262)\r\nat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\nat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nat java.base/java.lang.Thread.run(Thread.java:1583)\r\n```\r\n\r\nThis one is due to the delay to handle the graceful shutdown:\r\n\r\nFrom `io.vertx.core.impl.VertxImpl`:\r\n```java\r\n       eventLoopGroup.shutdownGracefully(0, 10, TimeUnit.SECONDS).addListener(new GenericFutureListener() {\r\n            @Override\r\n            public void operationComplete(io.netty.util.concurrent.Future future) throws Exception {\r\n              if (!future.isSuccess()) {\r\n                log.warn(\"Failure in shutting down event loop group\", future.cause());\r\n              }\r\n              if (metrics != null) {\r\n                metrics.close();\r\n              }\r\n              if (tracer != null) {\r\n                tracer.close();\r\n              }\r\n\r\n              checker.close();\r\n\r\n              if (completionHandler != null) {\r\n                eventLoopThreadFactory.newThread(() -> {\r\n                  completionHandler.handle(Future.succeededFuture());\r\n                }).start();\r\n              }\r\n            }\r\n          });\r\n```\r\n\r\nA more complete stacktrace:\r\n\r\n```\r\n[INFO] java.lang.IllegalArgumentException: io.vertx.core.impl\r\n[INFO]     at java.lang.ClassLoader.definePackage (ClassLoader.java:2215)\r\n[INFO]     at io.quarkus.bootstrap.classloading.QuarkusClassLoader.definePackage (QuarkusClassLoader.java:576)\r\n[INFO]     at io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass (QuarkusClassLoader.java:542)\r\n[INFO]     at io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass (QuarkusClassLoader.java:501)\r\n[INFO]     at java.lang.ClassLoader.defineClass1 (Native Method)\r\n[INFO]     at java.lang.ClassLoader.defineClass (ClassLoader.java:1017)\r\n[INFO]     at io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass (QuarkusClassLoader.java:543)\r\n[INFO]     at io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass (QuarkusClassLoader.java:501)\r\n[INFO]     at io.vertx.core.impl.TaskQueue.execute (TaskQueue.java:157)\r\n[INFO]     at io.vertx.core.impl.ContextImpl.internalExecuteBlocking (ContextImpl.java:217)\r\n[INFO]     at io.vertx.core.impl.ContextImpl.executeBlocking (ContextImpl.java:189)\r\n[INFO]     at io.vertx.core.impl.ContextImpl.executeBlockingInternal (ContextImpl.java:111)\r\n[INFO]     at io.vertx.core.impl.ContextInternal.executeBlockingInternal (ContextInternal.java:152)\r\n[INFO]     at io.vertx.core.impl.VertxInternal.executeBlockingInternal (VertxInternal.java:196)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.deleteCacheDirAndShutdown (VertxImpl.java:959)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.lambda$null$11 (VertxImpl.java:747)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.lambda$closeClusterManager$9 (VertxImpl.java:713)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl$4.onSuccess (FutureImpl.java:176)\r\n[INFO]     at io.vertx.core.impl.future.FutureBase.emitSuccess (FutureBase.java:66)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl.addListener (FutureImpl.java:231)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl.onComplete (FutureImpl.java:199)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.closeClusterManager (VertxImpl.java:708)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.lambda$null$12 (VertxImpl.java:745)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl$4.onSuccess (FutureImpl.java:176)\r\n[INFO]     at io.vertx.core.impl.future.FutureBase.emitSuccess (FutureBase.java:66)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl.addListener (FutureImpl.java:231)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl.onComplete (FutureImpl.java:199)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.lambda$null$13 (VertxImpl.java:744)\r\n[INFO]     at io.vertx.core.impl.resolver.DefaultResolverProvider.close (DefaultResolverProvider.java:34)\r\n[INFO]     at io.vertx.core.impl.AddressResolver.close (AddressResolver.java:118)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.lambda$null$14 (VertxImpl.java:741)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl$4.onSuccess (FutureImpl.java:176)\r\n[INFO]     at io.vertx.core.impl.future.FutureBase.emitSuccess (FutureBase.java:66)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl.addListener (FutureImpl.java:231)\r\n[INFO]     at io.vertx.core.impl.future.FutureImpl.onComplete (FutureImpl.java:199)\r\n[INFO]     at io.vertx.core.impl.VertxImpl.lambda$null$15 (VertxImpl.java:740)\r\n[INFO]     at io.vertx.core.impl.ContextImpl.emit (ContextImpl.java:328)\r\n[INFO]     at io.vertx.core.impl.ContextImpl.lambda$emit$5 (ContextImpl.java:335)\r\n[INFO]     at io.netty.util.concurrent.AbstractEventExecutor.runTask (AbstractEventExecutor.java:173)\r\n[INFO]     at io.netty.util.concurrent.AbstractEventExecutor.safeExecute (AbstractEventExecutor.java:166)\r\n[INFO]     at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks (SingleThreadEventExecutor.java:469)\r\n[INFO]     at io.netty.channel.nio.NioEventLoop.run (NioEventLoop.java:569)\r\n[INFO]     at io.netty.util.concurrent.SingleThreadEventExecutor$4.run (SingleThreadEventExecutor.java:994)\r\n[INFO]     at io.netty.util.internal.ThreadExecutorMap$2.run (ThreadExecutorMap.java:74)\r\n[INFO]     at io.netty.util.concurrent.FastThreadLocalRunnable.run (FastThreadLocalRunnable.java:30)\r\n[INFO]     at java.lang.Thread.run (Thread.java:840)\r\n```\r\n\r\n2. `io.quarkus.netty.deployment.JBossNettyLoggerFactory$JBossNettyInternalLogger.warn`\r\n\r\n```\r\n2024-06-16 12:04:49,958 WARN [io.net.cha.nio.NioEventLoop] (vert.x-eventloop-thread-0) Unexpected exception in the selector loop.: java.lang.IllegalStateException: Class loader Augmentation Class Loader: PROD for metrics has been closed and may not be accessed anymore\r\nat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:723)\r\nat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:499)\r\nat io.quarkus.netty.deployment.JBossNettyLoggerFactory$JBossNettyInternalLogger.warn(JBossNettyLoggerFactory.java:199)\r\nat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:168)\r\nat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:469)\r\nat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)\r\nat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:994)\r\nat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\nat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nat java.base/java.lang.Thread.run(Thread.java:1583)\r\n```\r\n\r\n3. `io.netty.util.concurrent.GlobalEventExecutor.startThread`\r\n\r\n```\r\n[INFO] java.lang.IllegalStateException: Class loader Augmentation Class Loader: PROD for kubernetes-docker-build-and-deploy-statefulset-0.1-SNAPSHOT has been closed and may not be accessed anymore\r\n[INFO] at io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen (QuarkusClassLoader.java:723)\r\n[INFO] at io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass (QuarkusClassLoader.java:499)\r\n[INFO] at io.netty.util.concurrent.GlobalEventExecutor.startThread (GlobalEventExecutor.java:239)\r\n[INFO] at io.netty.util.concurrent.GlobalEventExecutor.execute0 (GlobalEventExecutor.java:227)\r\n[INFO] at io.netty.util.concurrent.GlobalEventExecutor.execute (GlobalEventExecutor.java:221)\r\n[INFO] at io.netty.util.concurrent.DefaultPromise.safeExecute (DefaultPromise.java:862)\r\n[INFO] at io.netty.util.concurrent.DefaultPromise.notifyListeners (DefaultPromise.java:500)\r\n[INFO] at io.netty.util.concurrent.DefaultPromise.setValue0 (DefaultPromise.java:636)\r\n[INFO] at io.netty.util.concurrent.DefaultPromise.setSuccess0 (DefaultPromise.java:625)\r\n[INFO] at io.netty.util.concurrent.DefaultPromise.setSuccess (DefaultPromise.java:97)\r\n[INFO] at io.netty.util.concurrent.SingleThreadEventExecutor$4.run (SingleThreadEventExecutor.java:1056)\r\n[INFO] at io.netty.util.internal.ThreadExecutorMap$2.run (ThreadExecutorMap.java:74)\r\n[INFO] at io.netty.util.concurrent.FastThreadLocalRunnable.run (FastThreadLocalRunnable.java:30)\r\n```\r\n\r\nAnd related:\r\n\r\n```\r\n 2024-06-16 12:04:07,527 ERROR [io.net.uti.con.Def.rejectedExecution] (vert.x-acceptor-thread-0) Failed to submit a listener notification task. Event loop shut down?: java.lang.IllegalArgumentException: io.netty.util.concurrent\r\n\tat java.base/java.lang.ClassLoader.definePackage(ClassLoader.java:2215)\r\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.definePackage(QuarkusClassLoader.java:576)\r\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:542)\r\n\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:501)\r\n\tat io.netty.util.concurrent.GlobalEventExecutor.startThread(GlobalEventExecutor.java:239)\r\n\tat io.netty.util.concurrent.GlobalEventExecutor.execute0(GlobalEventExecutor.java:227)\r\n\tat io.netty.util.concurrent.GlobalEventExecutor.execute(GlobalEventExecutor.java:221)\r\n\tat io.netty.util.concurrent.DefaultPromise.safeExecute(DefaultPromise.java:862)\r\n\tat io.netty.util.concurrent.DefaultPromise.notifyListeners(DefaultPromise.java:500)\r\n\tat io.netty.util.concurrent.DefaultPromise.setValue0(DefaultPromise.java:636)\r\n\tat io.netty.util.concurrent.DefaultPromise.setSuccess0(DefaultPromise.java:625)\r\n\tat io.netty.util.concurrent.DefaultPromise.setSuccess(DefaultPromise.java:97)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:1056)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:840)\r\n```\r\n\r\n4. `io.micrometer.core.instrument.binder.jvm.JvmHeapPressureMetrics`\r\n\r\n```\r\njava.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for QuarkusTestNested1WithCommonCaseTest (QuarkusTest) has been closed and may not be accessed anymore\r\nat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:723)\r\nat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:499)\r\nat io.micrometer.core.instrument.binder.jvm.JvmHeapPressureMetrics.lambda$monitor$3(JvmHeapPressureMetrics.java:116)\r\nat java.management/sun.management.NotificationEmitterSupport.sendNotification(NotificationEmitterSupport.java:155)\r\nat jdk.management/com.sun.management.internal.GarbageCollectorExtImpl.createGCNotification(GarbageCollectorExtImpl.java:115)\r\n```\r\n\r\n5. Instrumentation reload test\r\n\r\n```\r\n2024-06-16T15:46:48.9763012Z 2024-06-16 15:46:48,905 INFO  [io.qua.dep.dev.fil.StaticFileManager] (vert.x-worker-thread-1) Ignoring module-info.java in dev mode, set the `quarkus.live-reload.ignore-module-info` property to `false` in your project descriptor (`pom.xml` or `build.gradle`) to disable this behavior.\r\n2024-06-16T15:46:49.1767168Z 2024-06-16 15:46:49,081 ERROR [io.qua.dep.dev.RuntimeUpdatesProcessor] (vert.x-worker-thread-1) Failed to replace classes via instrumentation: java.lang.IllegalStateException: Class loader Deployment Class Loader: DEV for acme-1.0-SNAPSHOT has been closed and may not be accessed anymore\r\n2024-06-16T15:46:49.1770682Z \tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:727)\r\n2024-06-16T15:46:49.1772859Z \tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.getElementsWithResource(QuarkusClassLoader.java:608)\r\n2024-06-16T15:46:49.1775071Z \tat io.quarkus.deployment.steps.ClassTransformingBuildStep$1.apply(ClassTransformingBuildStep.java:151)\r\n2024-06-16T15:46:49.1777149Z \tat io.quarkus.deployment.steps.ClassTransformingBuildStep$1.apply(ClassTransformingBuildStep.java:126)\r\n2024-06-16T15:46:49.1779287Z \tat io.quarkus.deployment.steps.ClassTransformingBuildStep.transform(ClassTransformingBuildStep.java:74)\r\n2024-06-16T15:46:49.1781372Z \tat io.quarkus.deployment.dev.IsolatedDevModeMain$2.apply(IsolatedDevModeMain.java:250)\r\n2024-06-16T15:46:49.1782968Z \tat io.quarkus.deployment.dev.IsolatedDevModeMain$2.apply(IsolatedDevModeMain.java:247)\r\n2024-06-16T15:46:49.1784749Z \tat io.quarkus.deployment.dev.RuntimeUpdatesProcessor.doScan(RuntimeUpdatesProcessor.java:502)\r\n2024-06-16T15:46:49.1786439Z \tat io.quarkus.deployment.dev.RuntimeUpdatesProcessor.doScan(RuntimeUpdatesProcessor.java:448)\r\n2024-06-16T15:46:49.1788237Z \tat io.quarkus.vertx.http.runtime.devmode.VertxHttpHotReplacementSetup$6.call(VertxHttpHotReplacementSetup.java:161)\r\n2024-06-16T15:46:49.1790223Z \tat io.quarkus.vertx.http.runtime.devmode.VertxHttpHotReplacementSetup$6.call(VertxHttpHotReplacementSetup.java:148)\r\n2024-06-16T15:46:49.1792376Z \tat io.vertx.core.impl.ContextImpl.lambda$executeBlocking$0(ContextImpl.java:178)\r\n2024-06-16T15:46:49.1793816Z \tat io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:279)\r\n2024-06-16T15:46:49.1795247Z \tat io.vertx.core.impl.ContextImpl.lambda$internalExecuteBlocking$2(ContextImpl.java:210)\r\n2024-06-16T15:46:49.1796526Z \tat org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n2024-06-16T15:46:49.1797817Z \tat org.jboss.threads.EnhancedQueueExecutor$Task.doRunWith(EnhancedQueueExecutor.java:2516)\r\n2024-06-16T15:46:49.1799430Z \tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2495)\r\n2024-06-16T15:46:49.1814784Z \tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1521)\r\n2024-06-16T15:46:49.1816132Z \tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:11)\r\n2024-06-16T15:46:49.1817469Z \tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:11)\r\n2024-06-16T15:46:49.1818968Z \tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n2024-06-16T15:46:49.1820118Z \tat java.base/java.lang.Thread.run(Thread.java:840)\r\n```\r\n\r\nThis is due to this piece of code in `ClassTransformingBuildStep` (usage of `cl`):\r\n\r\n```java\r\n        shutdown.addCloseTask(ClassTransformingBuildStep::reset, true);\r\n        lastTransformers = new BiFunction<String, byte[], byte[]>() {\r\n            @Override\r\n            public byte[] apply(String className, byte[] originalBytes) {\r\n\r\n                List<BytecodeTransformerBuildItem> classTransformers = bytecodeTransformers.get(className);\r\n                if (classTransformers == null) {\r\n                    return originalBytes;\r\n                }\r\n                boolean continueOnFailure = classTransformers.stream()\r\n                        .filter(a -> !a.isContinueOnFailure())\r\n                        .findAny().isEmpty();\r\n                List<BiFunction<String, ClassVisitor, ClassVisitor>> visitors = classTransformers.stream()\r\n                        .sorted(Comparator.comparingInt(BytecodeTransformerBuildItem::getPriority))\r\n                        .map(BytecodeTransformerBuildItem::getVisitorFunction)\r\n                        .filter(Objects::nonNull)\r\n                        .collect(Collectors.toList());\r\n                List<BiFunction<String, byte[], byte[]>> preVisitFunctions = classTransformers.stream()\r\n                        .sorted(Comparator.comparingInt(BytecodeTransformerBuildItem::getPriority))\r\n                        .map(BytecodeTransformerBuildItem::getInputTransformer)\r\n                        .filter(Objects::nonNull)\r\n                        .collect(Collectors.toList());\r\n                ClassLoader old = Thread.currentThread().getContextClassLoader();\r\n                try {\r\n                    Thread.currentThread().setContextClassLoader(transformCl);\r\n                    String classFileName = fromClassNameToResourceName(className);\r\n                    List<ClassPathElement> archives = cl.getElementsWithResource(classFileName);\r\n```\r\n\r\n6. Issues in `DevUIGrpcSmokeTest`\r\n\r\nHard to figure out what's going wrong here as we don't have the stacktraces handy.\r\n\r\n7. RESTEasy/Config in dev mode\r\n\r\n:white_check_mark: This one has been solved by a follow up commit.\r\n\r\n<details>\r\n\r\n```\r\n2024-06-16T15:34:06.2997052Z 2024-06-16 15:34:05,500 ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (executor-thread-1) HTTP Request to /max-body-size failed, error id: a52a04c2-20ea-427c-8809-68804e849435-1 [Error Occurred After Shutdown]: java.lang.ExceptionInInitializerError\r\n2024-06-16T15:34:06.3000384Z \tat org.jboss.resteasy.core.providerfactory.ResteasyProviderFactoryImpl.registerBuiltin(ResteasyProviderFactoryImpl.java:201)\r\n2024-06-16T15:34:06.3002613Z \tat org.jboss.resteasy.spi.ResteasyProviderFactory.getInstance(ResteasyProviderFactory.java:115)\r\n2024-06-16T15:34:06.3004440Z \tat io.quarkus.resteasy.runtime.standalone.RequestDispatcher.service(RequestDispatcher.java:91)\r\n2024-06-16T15:34:06.3006078Z \tat io.quarkus.resteasy.runtime.standalone.VertxRequestHandler.dispatch(VertxRequestHandler.java:151)\r\n2024-06-16T15:34:06.3007707Z \tat io.quarkus.resteasy.runtime.standalone.VertxRequestHandler$1.run(VertxRequestHandler.java:97)\r\n2024-06-16T15:34:06.3009191Z \tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:599)\r\n2024-06-16T15:34:06.3010602Z \tat org.jboss.threads.EnhancedQueueExecutor$Task.doRunWith(EnhancedQueueExecutor.java:2516)\r\n2024-06-16T15:34:06.3011953Z \tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2495)\r\n2024-06-16T15:34:06.3013305Z \tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1521)\r\n2024-06-16T15:34:06.3014580Z \tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:11)\r\n2024-06-16T15:34:06.3015847Z \tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:11)\r\n2024-06-16T15:34:06.3028336Z \tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n2024-06-16T15:34:06.3029607Z \tat java.base/java.lang.Thread.run(Thread.java:840)\r\n2024-06-16T15:34:06.3031526Z Caused by: java.lang.IllegalStateException: Class loader Quarkus Runtime ClassLoader: DEV for testChunkedLargeRequest() (QuarkusDevModeTest) restart no:0 has been closed and may not be accessed anymore\r\n2024-06-16T15:34:06.3034400Z \tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:727)\r\n2024-06-16T15:34:06.3036325Z \tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.getResources(QuarkusClassLoader.java:226)\r\n2024-06-16T15:34:06.3038011Z \tat java.base/java.util.ServiceLoader$LazyClassPathLookupIterator.nextProviderClass(ServiceLoader.java:1203)\r\n2024-06-16T15:34:06.3176043Z \tat java.base/java.util.ServiceLoader$LazyClassPathLookupIterator.hasNextService(ServiceLoader.java:1228)\r\n2024-06-16T15:34:06.3177925Z \tat java.base/java.util.ServiceLoader$LazyClassPathLookupIterator.hasNext(ServiceLoader.java:1273)\r\n2024-06-16T15:34:06.3179227Z \tat java.base/java.util.ServiceLoader$2.hasNext(ServiceLoader.java:1309)\r\n2024-06-16T15:34:06.3180271Z \tat java.base/java.util.ServiceLoader$3.hasNext(ServiceLoader.java:1393)\r\n2024-06-16T15:34:06.3181646Z \tat io.smallrye.config.SmallRyeConfigProviderResolver.getFactoryFor(SmallRyeConfigProviderResolver.java:102)\r\n2024-06-16T15:34:06.3183298Z \tat io.smallrye.config.SmallRyeConfigProviderResolver.getConfig(SmallRyeConfigProviderResolver.java:78)\r\n2024-06-16T15:34:06.3184881Z \tat io.smallrye.config.SmallRyeConfigProviderResolver.getConfig(SmallRyeConfigProviderResolver.java:66)\r\n2024-06-16T15:34:06.3186265Z \tat org.eclipse.microprofile.config.ConfigProvider.getConfig(ConfigProvider.java:85)\r\n2024-06-16T15:34:06.3188279Z \tat org.jboss.resteasy.microprofile.config.ConfigConfiguration.<init>(ConfigConfiguration.java:36)\r\n2024-06-16T15:34:06.3189993Z \tat org.jboss.resteasy.microprofile.config.ConfigConfigurationFactory.getConfiguration(ConfigConfigurationFactory.java:32)\r\n2024-06-16T15:34:06.3191645Z \tat org.jboss.resteasy.plugins.providers.RegisterBuiltin$5.run(RegisterBuiltin.java:178)\r\n2024-06-16T15:34:06.3193059Z \tat org.jboss.resteasy.plugins.providers.RegisterBuiltin$5.run(RegisterBuiltin.java:175)\r\n2024-06-16T15:34:06.3194411Z \tat java.base/java.security.AccessController.doPrivileged(AccessController.java:318)\r\n2024-06-16T15:34:06.3195855Z \tat org.jboss.resteasy.plugins.providers.RegisterBuiltin.isGZipEnabled(RegisterBuiltin.java:175)\r\n2024-06-16T15:34:06.3197355Z \tat org.jboss.resteasy.plugins.providers.RegisterBuiltin.<clinit>(RegisterBuiltin.java:37)\r\n```\r\n</details>\r\n\r\n9. Wiremock\r\n\r\n:white_check_mark: This one has been solved by a follow up commit.\r\n\r\n<details>\r\n\r\nGot it with Stork:\r\n\r\n```\r\n2024-06-16T16:23:09.0013999Z \tSuppressed: java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for StorkResponseTimeLoadBalancerTest (QuarkusUnitTest) has been closed and may not be accessed anymore\r\n2024-06-16T16:23:09.0016332Z \t\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:727)\r\n2024-06-16T16:23:09.0017924Z \t\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:503)\r\n2024-06-16T16:23:09.0019360Z \t\tat wiremock.org.eclipse.jetty.io.ManagedSelector.doStop(ManagedSelector.java:135)\r\n2024-06-16T16:23:09.0020806Z \t\tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:23:09.0022389Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.stop(ContainerLifeCycle.java:182)\r\n2024-06-16T16:23:09.0023989Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.doStop(ContainerLifeCycle.java:205)\r\n2024-06-16T16:23:09.0025461Z \t\tat wiremock.org.eclipse.jetty.io.SelectorManager.doStop(SelectorManager.java:280)\r\n2024-06-16T16:23:09.0026870Z \t\tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:23:09.0028472Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.stop(ContainerLifeCycle.java:182)\r\n2024-06-16T16:23:09.0030097Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.doStop(ContainerLifeCycle.java:205)\r\n2024-06-16T16:23:09.0031630Z \t\tat wiremock.org.eclipse.jetty.server.AbstractConnector.doStop(AbstractConnector.java:425)\r\n2024-06-16T16:23:09.0033181Z \t\tat wiremock.org.eclipse.jetty.server.AbstractNetworkConnector.doStop(AbstractNetworkConnector.java:82)\r\n2024-06-16T16:23:09.0034923Z \t\tat wiremock.org.eclipse.jetty.server.ServerConnector.doStop(ServerConnector.java:240)\r\n2024-06-16T16:23:09.0036442Z \t\tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:23:09.0037797Z \t\tat wiremock.org.eclipse.jetty.server.Server.doStop(Server.java:506)\r\n```\r\n\r\nAlso got it with REST Client:\r\n\r\n```\r\n2024-06-16T16:26:18.4058720Z ##[error]Exception in thread \"Thread-3842\" MultiException[java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore, java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore, java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore, java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore, java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore, java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore, java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore]\r\n2024-06-16T16:26:18.4070116Z \tat wiremock.org.eclipse.jetty.util.MultiException.ifExceptionThrow(MultiException.java:117)\r\n2024-06-16T16:26:18.4071515Z \tat wiremock.org.eclipse.jetty.server.Server.doStop(Server.java:531)\r\n2024-06-16T16:26:18.4072926Z \tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:26:18.4074522Z \tat com.github.tomakehurst.wiremock.jetty.JettyHttpServer.stop(JettyHttpServer.java:178)\r\n2024-06-16T16:26:18.4075921Z \tat com.github.tomakehurst.wiremock.WireMockServer.stop(WireMockServer.java:182)\r\n2024-06-16T16:26:18.4077330Z \tat com.github.tomakehurst.wiremock.WireMockServer.lambda$shutdown$3(WireMockServer.java:215)\r\n2024-06-16T16:26:18.4078476Z \tat java.base/java.lang.Thread.run(Thread.java:840)\r\n2024-06-16T16:26:18.4080249Z \tSuppressed: java.lang.IllegalStateException: Class loader Quarkus Base Runtime ClassLoader: TEST for TrustAllTest (QuarkusUnitTest) has been closed and may not be accessed anymore\r\n2024-06-16T16:26:18.4082406Z \t\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.ensureOpen(QuarkusClassLoader.java:727)\r\n2024-06-16T16:26:18.4084348Z \t\tat io.quarkus.bootstrap.classloading.QuarkusClassLoader.loadClass(QuarkusClassLoader.java:503)\r\n2024-06-16T16:26:18.4085850Z \t\tat wiremock.org.eclipse.jetty.io.ManagedSelector.doStop(ManagedSelector.java:135)\r\n2024-06-16T16:26:18.4087331Z \t\tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:26:18.4088957Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.stop(ContainerLifeCycle.java:182)\r\n2024-06-16T16:26:18.4090689Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.doStop(ContainerLifeCycle.java:205)\r\n2024-06-16T16:26:18.4092202Z \t\tat wiremock.org.eclipse.jetty.io.SelectorManager.doStop(SelectorManager.java:280)\r\n2024-06-16T16:26:18.4093675Z \t\tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:26:18.4095285Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.stop(ContainerLifeCycle.java:182)\r\n2024-06-16T16:26:18.4096931Z \t\tat wiremock.org.eclipse.jetty.util.component.ContainerLifeCycle.doStop(ContainerLifeCycle.java:205)\r\n2024-06-16T16:26:18.4098521Z \t\tat wiremock.org.eclipse.jetty.server.AbstractConnector.doStop(AbstractConnector.java:425)\r\n2024-06-16T16:26:18.4100470Z \t\tat wiremock.org.eclipse.jetty.server.AbstractNetworkConnector.doStop(AbstractNetworkConnector.java:82)\r\n2024-06-16T16:26:18.4102089Z \t\tat wiremock.org.eclipse.jetty.server.ServerConnector.doStop(ServerConnector.java:240)\r\n2024-06-16T16:26:18.4103614Z \t\tat wiremock.org.eclipse.jetty.util.component.AbstractLifeCycle.stop(AbstractLifeCycle.java:132)\r\n2024-06-16T16:26:18.4104900Z \t\tat wiremock.org.eclipse.jetty.server.Server.doStop(Server.java:506)\r\n2024-06-16T16:26:18.4105674Z \t\t... 5 more\r\n```\r\n\r\n</details>",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41233/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41233/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
