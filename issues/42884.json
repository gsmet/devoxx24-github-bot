{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42884",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42884/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42884/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42884/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/42884",
  "id": 2495602766,
  "node_id": "I_kwDOCFbutM6Uv-BO",
  "number": 42884,
  "title": "`CompiledJavaVersionBuildStep` may load a wrong class number with gradle",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026591,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTkx",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/gradle",
      "name": "area/gradle",
      "color": "0366d6",
      "default": false,
      "description": "Gradle"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/349",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/349",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/349/labels",
    "id": 11519060,
    "node_id": "MI_kwDOCFbutM4Ar8RU",
    "number": 349,
    "title": "3.14.2",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 1,
    "closed_issues": 66,
    "state": "open",
    "created_at": "2024-08-30T16:14:50Z",
    "updated_at": "2024-08-30T16:32:00Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 4,
  "created_at": "2024-08-29T21:23:26Z",
  "updated_at": "2024-08-30T16:31:55Z",
  "closed_at": "2024-08-30T15:14:03Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\n`CompiledJavaVersionBuildStep` will try to produce  a `CompiledJavaVersionBuildItem` by walking the build directory and finding the first java class it can get a java version from.\r\nThis is problematic as gradle often uses the `build/tmp/.cache` directory to unzip temporary files, that may contain classes and the version of these classes may be loaded instead of the ones from the project.\r\n\r\nThis can prevent some builds from using virtual threads with `@RunOnVirtualThread` for example.\r\n\r\n### Expected behavior\r\n\r\nThe java version should be retrieved from a class compiled by the gradle project.\r\n\r\n### Actual behavior\r\n\r\nThe java version is retrieved from the first found class, even from some temporary build directory\r\n\r\n### How to Reproduce?\r\n\r\nReproducer her [https://github.com/Malandril/quarkus-bug-virtual-jacoco.git](https://github.com/Malandril/quarkus-bug-virtual-jacoco.git)\r\n\r\nclone it then run \r\n`./gradlew test jacocoTestReport`\r\n\r\nIt should fail, because the `CompiledJavaVersionBuildStep` will load the version from a class in `build/tmp/.cache/expanded/zip_zipchecksum/org/jacoco/agent/package-info.class/package-info.class` which is of java 5 instead of java 21\r\n\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"21.0.2\" 2024-01-16\r\n\r\n### Quarkus version or git rev\r\n\r\n3.14.1\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nGradle 8.8\r\n\r\n### Additional information\r\n\r\nMaybe we could simply exclude hidden folders from the `SimpleFileVisitor` in the `CompiledJavaVersionBuildStep` ?\r\nThis would not ensure that a project class will be loaded, but would solve the issue with jacoco at lease",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42884/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42884/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
