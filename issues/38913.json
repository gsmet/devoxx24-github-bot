{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/38913",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38913/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38913/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38913/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/38913",
  "id": 2146010047,
  "node_id": "I_kwDOCFbutM5_6YO_",
  "number": 38913,
  "title": "ARJUNA012095: Abort of action id <ID> invoked while multiple threads active within it.",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1633508165,
      "node_id": "MDU6TGFiZWwxNjMzNTA4MTY1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/narayana",
      "name": "area/narayana",
      "color": "0366d6",
      "default": false,
      "description": "Transactions / Narayana"
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 2,
  "created_at": "2024-02-21T07:26:02Z",
  "updated_at": "2024-02-27T16:03:22Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nI have a Quarkus Application deployed as a Native executable on AWS Lambda. For some executions, the lambda time out after being in hung states for 900 seconds.\r\n\r\nFrom the logs I see below traces from transaction manager\r\n\r\n```\r\nARJUNA012117: TransactionReaper::check processing TX 0:ffffa9fe3dd5:ac33:65d4db9c:6 in state  RUN\r\n\r\nARJUNA012095: Abort of action id 0:ffffa9fe3dd5:ac33:65d4db9c:6 invoked while multiple threads active within it.\r\n\r\nARJUNA012381: Action id 0:ffffa9fe3dd5:ac33:65d4db9c:6 completed with multiple threads - thread Lambda Thread (NORMAL) was in progress with java.base@17.0.9/sun.nio.ch.SocketDispatcher.read0(Native Method)\r\njava.base@17.0.9/sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:47)\r\njava.base@17.0.9/sun.nio.ch.NioSocketImpl.tryRead(NioSocketImpl.java:266)\r\njava.base@17.0.9/sun.nio.ch.NioSocketImpl.implRead(NioSocketImpl.java:317)\r\njava.base@17.0.9/sun.nio.ch.NioSocketImpl.read(NioSocketImpl.java:355)\r\njava.base@17.0.9/sun.nio.ch.NioSocketImpl$1.read(NioSocketImpl.java:808)\r\njava.base@17.0.9/java.net.Socket$SocketInputStream.read(Socket.java:966)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel$ProxyInputStream.readInternal(IOBuffer.java:1197)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel$ProxyInputStream.read(IOBuffer.java:1183)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel$ProxyInputStream.readInternal(IOBuffer.java:1197)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel$ProxyInputStream.read(IOBuffer.java:1183)\r\njava.base@17.0.9/sun.security.ssl.SSLSocketInputRecord.read(SSLSocketInputRecord.java:484)\r\njava.base@17.0.9/sun.security.ssl.SSLSocketInputRecord.readHeader(SSLSocketInputRecord.java:478)\r\njava.base@17.0.9/sun.security.ssl.SSLSocketInputRecord.bytesInCompletePacket(SSLSocketInputRecord.java:70)\r\njava.base@17.0.9/sun.security.ssl.SSLSocketImpl.readApplicationRecord(SSLSocketImpl.java:1465)\r\njava.base@17.0.9/sun.security.ssl.SSLSocketImpl$AppInputStream.read(SSLSocketImpl.java:1069)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel$ProxyInputStream.readInternal(IOBuffer.java:1197)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel$ProxyInputStream.read(IOBuffer.java:1183)\r\ncom.microsoft.sqlserver.jdbc.TDSChannel.read(IOBuffer.java:2155)\r\ncom.microsoft.sqlserver.jdbc.TDSReader.readPacket(IOBuffer.java:6830)\r\ncom.microsoft.sqlserver.jdbc.TDSCommand.startResponse(IOBuffer.java:8075)\r\ncom.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.doExecutePreparedStatement(SQLServerPreparedStatement.java:646)\r\ncom.microsoft.sqlserver.jdbc.SQLServerPreparedStatement$PrepStmtExecCmd.doExecute(SQLServerPreparedStatement.java:567)\r\ncom.microsoft.sqlserver.jdbc.TDSCommand.execute(IOBuffer.java:7675)\r\ncom.microsoft.sqlserver.jdbc.SQLServerConnection.executeCommand(SQLServerConnection.java:4137)\r\ncom.microsoft.sqlserver.jdbc.SQLServerStatement.executeCommand(SQLServerStatement.java:272)\r\ncom.microsoft.sqlserver.jdbc.SQLServerStatement.executeStatement(SQLServerStatement.java:246)\r\ncom.microsoft.sqlserver.jdbc.SQLServerPreparedStatement.executeQuery(SQLServerPreparedStatement.java:485)\r\nio.agroal.pool.wrapper.PreparedStatementWrapper.executeQuery(PreparedStatementWrapper.java:78)\r\norg.hibernate.sql.results.jdbc.internal.DeferredResultSetAccess.executeQuery(DeferredResultSetAccess.java:239)\r\norg.hibernate.sql.results.jdbc.internal.DeferredResultSetAccess.getResultSet(DeferredResultSetAccess.java:163)\r\norg.hibernate.sql.results.jdbc.internal.JdbcValuesResultSetImpl.advanceNext(JdbcValuesResultSetImpl.java:254)\r\norg.hibernate.sql.results.jdbc.internal.JdbcValuesResultSetImpl.processNext(JdbcValuesResultSetImpl.java:134)\r\norg.hibernate.sql.results.jdbc.internal.AbstractJdbcValues.next(AbstractJdbcValues.java:19)\r\norg.hibernate.sql.results.internal.RowProcessingStateStandardImpl.next(RowProcessingStateStandardImpl.java:66)\r\norg.hibernate.sql.results.spi.ListResultsConsumer.consume(ListResultsConsumer.java:198)\r\norg.hibernate.sql.results.spi.ListResultsConsumer.consume(ListResultsConsumer.java:33)\r\norg.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.doExecuteQuery(JdbcSelectExecutorStandardImpl.java:361)\r\norg.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.executeQuery(JdbcSelectExecutorStandardImpl.java:168)\r\norg.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.list(JdbcSelectExecutorStandardImpl.java:93)\r\norg.hibernate.sql.exec.spi.JdbcSelectExecutor.list(JdbcSelectExecutor.java:31)\r\norg.hibernate.query.sqm.internal.ConcreteSqmSelectQueryPlan.lambda$new$0(ConcreteSqmSelectQueryPlan.java:110)\r\norg.hibernate.query.sqm.internal.ConcreteSqmSelectQueryPlan.withCacheableSqmInterpretation(ConcreteSqmSelectQueryPlan.java:303)\r\norg.hibernate.query.sqm.internal.ConcreteSqmSelectQueryPlan.performList(ConcreteSqmSelectQueryPlan.java:244)\r\norg.hibernate.query.sqm.internal.QuerySqmImpl.doList(QuerySqmImpl.java:518)\r\norg.hibernate.query.spi.AbstractSelectionQuery.list(AbstractSelectionQuery.java:367)\r\norg.hibernate.query.Query.getResultList(Query.java:119)\r\nio.quarkus.hibernate.orm.panache.common.runtime.CommonPanacheQueryImpl.list(CommonPanacheQueryImpl.java:280)\r\nio.quarkus.hibernate.orm.panache.runtime.PanacheQueryImpl.list(PanacheQueryImpl.java:149)\r\nabc.lambda.repository.DocReasonRepository_223c867134c84e0af66c676dd61fd7991ccf7a9eImpl.findAllByIdIn(Unknown Source)\r\nabc.lambda.repository.DocReasonRepository_223c867134c84e0af66c676dd61fd7991ccf7a9eImpl_ClientProxy.findAllByIdIn(Unknown Source)\r\nabc.lambda.service.TopicsAndReasonService.getExistingDocReasonEntityMap(TopicsAndReasonService.java:63)\r\nabc.lambda.service.TopicsAndReasonService_Subclass.getExistingDocReasonEntityMap$$superforward(Unknown Source)\r\nabc.lambda.service.TopicsAndReasonService_Subclass$$function$$1.apply(Unknown Source)\r\nio.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:73)\r\nio.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:62)\r\nio.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:136)\r\nio.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:107)\r\nio.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.doIntercept(TransactionalInterceptorRequired.java:38)\r\nio.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.intercept(TransactionalInterceptorBase.java:61)\r\nio.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.intercept(TransactionalInterceptorRequired.java:32)\r\nio.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired_Bean.intercept(Unknown Source)\r\nio.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\nio.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:30)\r\nio.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:27)\r\nabc.lambda.service.TopicsAndReasonService_Subclass.getExistingDocReasonEntityMap(Unknown Source)\r\nabc.lambda.service.TopicsAndReasonService.computeTopicsOrigin(TopicsAndReasonService.java:30)\r\nabc.lambda.service.TopicsAndReasonService_ClientProxy.computeTopicsOrigin(Unknown Source)\r\nabc.lambda.service.InternalTagProcessor.doInternalTagging(InternalTagProcessor.java:48)\r\nabc.lambda.service.InternalTagProcessor_ClientProxy.doInternalTagging(Unknown Source)\r\nabc.lambda.Handler.handleRequest(Handler.java:53)\r\nabc.lambda.Handler.handleRequest(Handler.java:25)\r\nio.quarkus.amazon.lambda.runtime.AmazonLambdaRecorder$1.processRequest(AmazonLambdaRecorder.java:167)\r\nio.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:142)\r\njava.base@17.0.9/java.lang.Thread.run(Thread.java:840)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:807)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.posix.thread.PosixPlatformThreads.pthreadStartRoutine(PosixPlatformThreads.java:210)\r\nARJUNA012108: CheckedAction::check - atomic action 0:ffffa9fe3dd5:ac33:65d4db9c:6 aborting with 1 threads active!\r\nDatasource '<default>': JDBC resources leaked: 0 ResultSet(s) and 1 Statement(s)\r\nARJUNA012117: TransactionReaper::check processing TX 0:ffffa9fe3dd5:ac33:65d4db9c:6 in state  CANCEL\r\nARJUNA012378: ReaperElement appears to be wedged: org.graalvm.nativeimage.builder/com.oracle.svm.core.posix.headers.Pthread.pthread_cond_wait(Pthread.java)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.posix.thread.PosixParker.park0(PosixPlatformThreads.java:361)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.posix.thread.PosixParker.park(PosixPlatformThreads.java:341)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.parkCurrentPlatformOrCarrierThread(PlatformThreads.java:907)\r\njava.base@17.0.9/jdk.internal.misc.Unsafe.park(Unsafe.java:56)\r\njava.base@17.0.9/java.util.concurrent.locks.LockSupport.park(LockSupport.java:211)\r\njava.base@17.0.9/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:715)\r\njava.base@17.0.9/java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:938)\r\njava.base@17.0.9/java.util.concurrent.locks.ReentrantLock$Sync.lock(ReentrantLock.java:153)\r\njava.base@17.0.9/java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:322)\r\ncom.microsoft.sqlserver.jdbc.SQLServerConnection.executeCommand(SQLServerConnection.java:4052)\r\ncom.microsoft.sqlserver.jdbc.SQLServerConnection.connectionCommand(SQLServerConnection.java:4268)\r\ncom.microsoft.sqlserver.jdbc.SQLServerConnection.rollback(SQLServerConnection.java:4474)\r\nio.agroal.pool.ConnectionHandler.transactionRollback(ConnectionHandler.java:368)\r\nio.agroal.narayana.LocalXAResource.rollback(LocalXAResource.java:85)\r\ncom.arjuna.ats.internal.jta.resources.arjunacore.XAResourceRecord.topLevelAbort(XAResourceRecord.java:338)\r\ncom.arjuna.ats.arjuna.coordinator.BasicAction.doAbort(BasicAction.java:3112)\r\ncom.arjuna.ats.arjuna.coordinator.BasicAction.doAbort(BasicAction.java:3091)\r\ncom.arjuna.ats.arjuna.coordinator.BasicAction.Abort(BasicAction.java:1709)\r\ncom.arjuna.ats.arjuna.coordinator.TwoPhaseCoordinator.cancel(TwoPhaseCoordinator.java:102)\r\ncom.arjuna.ats.arjuna.AtomicAction.cancel(AtomicAction.java:191)\r\ncom.arjuna.ats.arjuna.coordinator.TransactionReaper.doWork(TransactionReaper.java:407)\r\ncom.arjuna.ats.internal.arjuna.coordinator.ReaperWorkerThread.run(ReaperWorkerThread.java:63)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:807)\r\norg.graalvm.nativeimage.builder/com.oracle.svm.core.posix.thread.PosixPlatformThreads.pthreadStartRoutine(PosixPlatformThreads.java:210)\r\n\r\nARJUNA012117: TransactionReaper::check processing TX 0:ffffa9fe3dd5:ac33:65d4db9c:6 in state  CANCEL_INTERRUPTED\r\n\r\nARJUNA012120: TransactionReaper::check worker Thread[Transaction Reaper Worker 0,5,main] not responding to interrupt when cancelling TX 0:ffffa9fe3dd5:ac33:65d4db9c:6 -- worker marked as zombie and TX scheduled for mark-as-rollback\r\n```\r\n\r\nThe above exceptions were printed as warning and resulted in lambda being in hung state and eventually time out. I am trying understand the cause of failure, however I believe the exception should have been thrown rather than being swallowed so the code could handle the exception in reasonable way.\r\n\r\n\n\n### Expected behavior\n\nException should be thrown.\n\n### Actual behavior\n\nException is swallowed.\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n17\n\n### Quarkus version or git rev\n\n3.5.2\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/38913/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38913/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
