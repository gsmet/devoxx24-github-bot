{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/38721",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38721/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38721/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38721/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/38721",
  "id": 2127978676,
  "node_id": "I_kwDOCFbutM5-1mC0",
  "number": 38721,
  "title": "Java 21: @VirtualThreadUnit produces very slow tests",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1375177076,
      "node_id": "MDU6TGFiZWwxMzc1MTc3MDc2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/testing",
      "name": "area/testing",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 6031725549,
      "node_id": "LA_kwDOCFbutM8AAAABZ4TT7Q",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/virtual-threads",
      "name": "area/virtual-threads",
      "color": "0366d6",
      "default": false,
      "description": "Issue related to Java's Virtual Threads"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/310",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/310",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/310/labels",
    "id": 10578643,
    "node_id": "MI_kwDOCFbutM4AoWrT",
    "number": 310,
    "title": "3.7.4",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 45,
    "state": "closed",
    "created_at": "2024-02-19T17:04:48Z",
    "updated_at": "2024-07-13T17:07:53Z",
    "due_on": null,
    "closed_at": "2024-02-21T12:35:22Z"
  },
  "comments": 5,
  "created_at": "2024-02-09T23:33:23Z",
  "updated_at": "2024-02-19T17:06:21Z",
  "closed_at": "2024-02-13T13:05:35Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nOn a Java 21 project, following [this documentation](https://quarkus.io/blog/virtual-threads-3/), I added `@VirtualThreadUnit @ShouldNotPin` annotations on several tests to ensure there is no thread pinning due to using some external libs.\r\n\r\nAs result, my tests becomes very slow: 52 seconds for 32 tests, instead of 10 seconds without the `@VirtualThreadUnit` annotation.\r\n\r\n### Expected behavior\r\n\r\nThe overhead to detect thread pinning is reasonnable, **or** if this behaviour is inevitable, it is documented.\r\n\r\n### Actual behavior\r\n\r\nTests become way slower without any warning. This may lead this annotation to be unusable on large test suites. This it the cause for me to categorize this point into a bug and not an enhancement.\r\n\r\n### How to Reproduce?\r\n\r\n1. Create a new Quarkus project with sample code and no additional module.\r\n2. Add the `io.quarkus.junit5:junit5-virtual-threads` dependency\r\n3. ~~Add `@RunOnVirtualThread` on `GreetingResource#hello()`~~ _(edit: not mandatory – the result is the same without this annotation – but actual code should use this annotation)_\r\n4. Lanch the tests and check the time for them to run (~1.9 s on my desktop)\r\n5. Add `@VirtualThreadUnit @ShouldNotPin` to the `GreetingResourceTest`\r\n6. Lanch the tests and check the time for them to run (~6.6 s on my desktop)\r\n\r\nYou may use this project https://github.com/SpaceFox/test-quarkus-java21-tests to check the exact versions I used.\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux cthulhu 6.5.0-17-generic #17~22.04.1-Ubuntu SMP PREEMPT_DYNAMIC Tue Jan 16 14:32:32 UTC 2 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"21.0.2\" 2024-01-16 LTS OpenJDK Runtime Environment Corretto-21.0.2.13.1 (build 21.0.2+13-LTS) OpenJDK 64-Bit Server VM Corretto-21.0.2.13.1 (build 21.0.2+13-LTS, mixed mode, sharing)\r\n\r\n### Quarkus version or git rev\r\n\r\n3.7.2\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.9.6 (bc0240f3c744dd6b6ec2920b3cd08dcc295161ae) Maven home: /home/spacefox/.m2/wrapper/dists/apache-maven-3.9.6-bin/3311e1d4/apache-maven-3.9.6 Java version: 21.0.2, vendor: Amazon.com Inc., runtime: /home/spacefox/.jdks/corretto-21.0.2 Default locale: fr_FR, platform encoding: UTF-8 OS name: \"linux\", version: \"6.5.0-17-generic\", arch: \"amd64\", family: \"unix\"\r\n\r\n### Additional information\r\n\r\nTested with both Maven and Gradle, no notable difference.\r\n\r\nTested with temurin-21.0.1 and corretto-21.0.2, no notable difference.\r\n\r\nTested with ibm-semeru-21.0.2, `@VirtualThreadUnit` breaks the tests.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/38721/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38721/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
