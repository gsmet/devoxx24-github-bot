{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27995",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27995/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27995/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27995/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/27995",
  "id": 1375665456,
  "node_id": "I_kwDOCFbutM5R_v0w",
  "number": 27995,
  "title": "Scenarion with authorization using @ClientHeaderParam doesn't bild into native after move to reactive",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 985346621,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjE=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/duplicate",
      "name": "triage/duplicate",
      "color": "cfd3d7",
      "default": false,
      "description": "This issue or pull request already exists"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 21,
  "created_at": "2022-09-16T09:13:29Z",
  "updated_at": "2022-09-16T14:32:55Z",
  "closed_at": "2022-09-16T12:33:25Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI'm trying to migrate testing scenarios we have for quarkus-oidc-client-filter / quarkus-oidc-token-propagation / quarkus-rest-client into their reactive variants.\r\n\r\nChanges for the move are here: https://github.com/rsvoboda/quarkus-test-suite/commit/818b36371a7f511062377b869fe34407221537f7\r\n\r\nThis is followup work after https://github.com/quarkusio/quarkus/issues/27959 fix. I tried to check the app in native mode.\r\nAnd it fails to build the native app with `Detected an instance of Random/SplittableRandom class in the image heap` message, cc @geoand / @sberyozkin\r\n\r\n```\r\n========================================================================================================================\r\nGraalVM Native Image: Generating 'security-keycloak-oidc-client-extended-1.0.0-SNAPSHOT-runner' (executable)...\r\n========================================================================================================================\r\n[1/7] Initializing...                                                                                   (10.9s @ 0.27GB)\r\n Version info: 'GraalVM 22.2.0 Java 17 CE'\r\n Java version info: '17.0.4+8-jvmci-22.2-b06'\r\n C compiler: cc (apple, x86_64, 14.0.0)\r\n Garbage collector: Serial GC\r\n 4 user-specific feature(s)\r\n - io.quarkus.runner.Feature: Auto-generated class by Quarkus from the existing extensions\r\n - io.quarkus.runtime.graal.DisableLoggingFeature: Disables INFO logging during the analysis phase for the [org.jboss.threads] categories\r\n - io.quarkus.runtime.graal.ResourcesFeature: Register each line in META-INF/quarkus-native-resources.txt as a resource on Substrate VM\r\n - org.graalvm.home.HomeFinderFeature: Finds GraalVM paths and its version number\r\n[2/7] Performing analysis...  [*]                                                                       (29.4s @ 1.59GB)\r\n  13,750 (91.47%) of 15,033 classes reachable\r\n  20,134 (61.09%) of 32,960 fields reachable\r\n  68,521 (64.85%) of 105,662 methods reachable\r\n     511 classes,   157 fields, and 1,477 methods registered for reflection\r\n       1 native library: -framework CoreServices\r\n\r\nFatal error: com.oracle.graal.pointsto.util.AnalysisError$ParsingError: Error encountered while parsing org.apache.http.impl.auth.NTLMEngineImpl.getType3Message(java.lang.String, java.lang.String, java.lang.String, java.lang.String, byte[], int, java.lang.String, byte[])\r\nParsing context:\r\n   at org.apache.http.impl.auth.NTLMEngineImpl.getType3Message(NTLMEngineImpl.java:181)\r\n   at org.apache.http.impl.auth.NTLMEngineImpl.generateType3Msg(NTLMEngineImpl.java:2097)\r\n   at org.apache.http.impl.auth.NTLMScheme.authenticate(NTLMScheme.java:142)\r\n   at org.apache.http.impl.auth.AuthSchemeBase.authenticate(AuthSchemeBase.java:136)\r\n   at org.apache.http.impl.auth.HttpAuthenticator.doAuth(HttpAuthenticator.java:233)\r\n   at org.apache.http.impl.auth.HttpAuthenticator.generateAuthResponse(HttpAuthenticator.java:213)\r\n   at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:262)\r\n   at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)\r\n   at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\r\n   at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)\r\n   at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:108)\r\n   at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)\r\n   at org.keycloak.authorization.client.util.HttpMethod.execute(HttpMethod.java:84)\r\n   at org.keycloak.authorization.client.util.HttpMethodResponse$2.execute(HttpMethodResponse.java:50)\r\n   at org.keycloak.authorization.client.AuthzClient.<init>(AuthzClient.java:264)\r\n   at org.keycloak.authorization.client.AuthzClient.create(AuthzClient.java:94)\r\n   at io.quarkus.ts.security.keycloak.oidcclient.extended.restclient.ping.clients.LookupAuthorizationPongClient.lookupAuth(LookupAuthorizationPongClient.java:64)\r\n   at io.quarkus.ts.security.keycloak.oidcclient.extended.restclient.ping.clients.LookupAuthorizationPongClient$$deletePongById$$5.addHeaders(Unknown Source)\r\n   at io.quarkus.rest.client.reactive.runtime.MicroProfileRestClientRequestFilter.filter(MicroProfileRestClientRequestFilter.java:47)\r\n   at org.jboss.resteasy.reactive.client.spi.ResteasyReactiveClientRequestFilter.filter(ResteasyReactiveClientRequestFilter.java:11)\r\n   at org.jboss.resteasy.reactive.client.handlers.ClientRequestFilterRestHandler.handle(ClientRequestFilterRestHandler.java:24)\r\n   at org.jboss.resteasy.reactive.client.handlers.ClientRequestFilterRestHandler.handle(ClientRequestFilterRestHandler.java:9)\r\n   at org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.invokeHandler(AbstractResteasyReactiveContext.java:224)\r\n   at org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:140)\r\n   at org.jboss.resteasy.reactive.server.handlers.RestInitialHandler.beginProcessing(RestInitialHandler.java:49)\r\n   at org.jboss.resteasy.reactive.server.vertx.ResteasyReactiveVertxHandler.handle(ResteasyReactiveVertxHandler.java:17)\r\n   at org.jboss.resteasy.reactive.server.vertx.ResteasyReactiveVertxHandler.handle(ResteasyReactiveVertxHandler.java:7)\r\n   at io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\n   at io.vertx.core.impl.future.FutureImpl$ListenerArray.onSuccess(FutureImpl.java:262)\r\n   at io.vertx.core.impl.future.FutureBase.lambda$emitSuccess$0(FutureBase.java:54)\r\n   at io.vertx.core.impl.future.FutureBase$$Lambda$1392/0x00000007c1794000.run(Unknown Source)\r\n   at java.lang.Shutdown.runHooks(Shutdown.java:130)\r\n   at java.lang.Shutdown.shutdown(Shutdown.java:185)\r\n   at com.oracle.svm.core.jdk.RuntimeSupport.shutdown(RuntimeSupport.java:158)\r\n\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.util.AnalysisError.parsingError(AnalysisError.java:152)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.flow.MethodTypeFlow.createFlowsGraph(MethodTypeFlow.java:104)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.flow.MethodTypeFlow.ensureFlowsGraphCreated(MethodTypeFlow.java:83)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.flow.MethodTypeFlow.getOrCreateMethodFlowsGraph(MethodTypeFlow.java:65)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.typestate.DefaultStaticInvokeTypeFlow.update(DefaultStaticInvokeTypeFlow.java:64)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.PointsToAnalysis$1.run(PointsToAnalysis.java:635)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.util.CompletionExecutor.executeCommand(CompletionExecutor.java:193)\r\n\tat org.graalvm.nativeimage.pointsto/com.oracle.graal.pointsto.util.CompletionExecutor.lambda$executeService$0(CompletionExecutor.java:177)\r\n\tat java.base/java.util.concurrent.ForkJoinTask$RunnableExecuteAction.exec(ForkJoinTask.java:1395)\r\n\tat java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:373)\r\n\tat java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1182)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1655)\r\n\tat java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1622)\r\n\tat java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:165)\r\nCaused by: org.graalvm.compiler.java.BytecodeParser$BytecodeParserError: com.oracle.graal.pointsto.constraints.UnsupportedFeatureException: Detected an instance of Random/SplittableRandom class in the image heap. Instances created during image generation have cached seed values and don't behave as expected.  To see how this object got instantiated use --trace-object-instantiation=java.security.SecureRandom. The object was probably created by a class initializer and is reachable from a static field. You can request class initialization at image runtime by using the option --initialize-at-run-time=<class-name>. Or you can write your own initialization methods and call them explicitly from your main entry point.\r\n\tat parsing org.apache.http.impl.auth.NTLMEngineImpl.access$000(NTLMEngineImpl.java:51)\r\n```\r\n\r\nThe same app using non-reactive extensions works fine in native.\r\n\r\n### Expected behavior\r\n\r\nApplication builds into native\r\n\r\n### Actual behavior\r\n\r\nApplication fails to build into native\r\n\r\n### How to Reproduce?\r\n\r\n - clone https://github.com/rsvoboda/quarkus-test-suite\r\n - checkout `oidc-client-reactive-filter` branch\r\n - run `mvn clean verify -pl security/keycloak-oidc-client-extended -Dnative -Dall-modules -Dquarkus.native.container-build=false`\r\n\r\nYou can drop `-Dquarkus.native.container-build=false` if you are on Linux or don't mind using container based build of native image.\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nmacOS Monterey\r\n\r\n### Output of `java -version`\r\n\r\nJava 17\r\n\r\n### GraalVM version (if different from Java)\r\n\r\nGraalVM 22.2 Java17\r\n\r\n### Quarkus version or git rev\r\n\r\nQuarkus main\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27995/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27995/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
