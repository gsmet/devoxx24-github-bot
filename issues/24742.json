{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/24742",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24742/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24742/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24742/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/24742",
  "id": 1191973074,
  "node_id": "I_kwDOCFbutM5HDBDS",
  "number": 24742,
  "title": "Hibernate post-boot schema-validation fails with Google Spanner after upgrade to Quarkus 2.7.5",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026509,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTA5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/persistence",
      "name": "area/persistence",
      "color": "FBCA04",
      "default": false,
      "description": "OBSOLETE, DO NOT USE"
    },
    {
      "id": 1341157944,
      "node_id": "MDU6TGFiZWwxMzQxMTU3OTQ0",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/upstream",
      "name": "triage/upstream",
      "color": "7db4d8",
      "default": false,
      "description": "Used for issues which are caused by issues in upstream projects/dependency"
    },
    {
      "id": 1425555736,
      "node_id": "MDU6TGFiZWwxNDI1NTU1NzM2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-orm",
      "name": "area/hibernate-orm",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate ORM"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 16,
  "created_at": "2022-04-04T15:36:49Z",
  "updated_at": "2022-11-02T07:44:01Z",
  "closed_at": "2022-11-02T07:44:01Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen migrating from Quarkus version 1.13.6 to 2.7., I´m facing the following error:\r\n\r\n```\r\n2022-04-04 15:06:59,391 ERROR [io.qua.hib.orm.run.sch.SchemaManagementIntegrator] (Hibernate post-boot validation thread for <default>) Failed to validate Schema: Schema-validation: missing table [RentedCars]\r\n2022-04-04 15:06:59,703 ERROR [io.qua.hib.orm.run.sch.SchemaManagementIntegrator] (Hibernate post-boot validation thread for <default>) The following SQL may resolve the database issues, as generated by the Hibernate schema migration tool. WARNING: You must manually verify this SQL is correct, this is a best effort guess, do not copy/paste it without verifying that it does what you expect.\r\n```\r\n\r\nAfter googling, I saw there was an error with the same error at https://github.com/quarkusio/quarkus/issues/23445. But the version  I´m trying to use already contains the fix. Then I started to analyse and debug it, and then I´ve found that seems there is another bug.\r\n\r\n\r\n so let me give you some context information.\r\n\r\n* quarkus: 2.7.5-final\r\n* google-cloud-spanner-hibernate-dialect 1,5,2\r\n* google-cloud-spanner-jdbc: 2.5.6\r\n* Quarkus microservice with two databases: First and default with read and write access, second with only read access.\r\n* Database 1 (default) has table RentedCars and database 2 (read-database) Cars \r\n* application configuration\r\n```\r\n  datasource:\r\n    db-kind: other\r\n    jdbc:\r\n      url: jdbc:cloudspanner://localhost:9011/projects/test-integration/instances/test-integration/databases/test-integration;usePlainText=true\r\n      driver: com.google.cloud.spanner.jdbc.JdbcDriver\r\n    \"read-database\":\r\n      db-kind: other\r\n      jdbc:\r\n        url: jdbc:cloudspanner://localhost:9010/projects/test-integration/instances/test-integration/databases/test-integration;usePlainText=true\r\n        driver: com.google.cloud.spanner.jdbc.JdbcDriver\r\n  hibernate-orm:\r\n    datasource: <default>\r\n    dialect: com.google.cloud.spanner.hibernate.SpannerDialect\r\n    packages: com.renting.rent\r\n    \"read-database\":\r\n      datasource: read-database\r\n      dialect: com.google.cloud.spanner.hibernate.SpannerDialect\r\n      packages: com.renting.cars\r\n```\r\nTesting it,  I´ve seen that adding in the application configuration for the default\r\n```\r\n      database:\r\n        generation: update\r\n```\r\nThe table RentedCars is created in the second database. It explains why the table is not found in default because it checking in the wrong database.\r\n\r\nDebugging quarkus code, I´ve found that in SchemaManagementIntegrator.runPostBootValidation(..) when getting the validator for \"<default>\" the validator.tool.serviceRegistry.configurationsValues contains \r\nhibernate.ejb.persistenceUnitName -> read-database instead of \"<default>\" \r\n\r\n### Expected behavior\r\n\r\n_No response_\r\n\r\n### Actual behavior\r\n\r\n_No response_\r\n\r\n### How to Reproduce?\r\n\r\nconfigure in application-yml two databases which already define the tables, having **database generation** to **none** for both.\r\n\r\n1) Define databases as follow\r\n**database 1**\r\n```\r\nCREATE TABLE IF NOT EXISTS RentedCars (\r\n    CarId VARCHAR(64),\r\n    Start DATETIME,\r\n    End DATETIME\r\n);\r\n```\r\n\r\n**database 2**\r\n```\r\nCREATE TABLE IF NOT EXISTS Cars (\r\n    Id VARCHAR(64),\r\n    Description VARCHAR(255)\r\n);\r\n```\r\n2) Create a micro service with 2 entities (one for each table)\r\n3) Configure the datasources as shown in the bug description field to have each table in different databases\r\n4) Start the micro service\r\n\r\nAutomatically the error in shown \r\n\r\nI hope this helps to solve the issue.\r\n\r\nThanks in advance\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk 11.0.9 2020-10-20 LTS\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.7.5-final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\napache-maven-3.8.2\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/24742/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24742/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
