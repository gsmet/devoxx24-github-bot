{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/25848",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25848/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25848/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25848/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/25848",
  "id": 1251836217,
  "node_id": "I_kwDOCFbutM5KnYE5",
  "number": 25848,
  "title": "Deleting entity with `OneToOne` relation with `CascadeType.REMOVE` not working",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 985346625,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjU=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/invalid",
      "name": "triage/invalid",
      "color": "e4e669",
      "default": false,
      "description": "This doesn't seem right"
    },
    {
      "id": 1273026509,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTA5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/persistence",
      "name": "area/persistence",
      "color": "FBCA04",
      "default": false,
      "description": "OBSOLETE, DO NOT USE"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 9,
  "created_at": "2022-05-29T09:23:05Z",
  "updated_at": "2022-06-01T05:50:49Z",
  "closed_at": "2022-05-31T14:03:19Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nGiven 2 entities: `FruitEntity` and `FruitEntityDetail` related by `OneToOne` relation, deleting the parent `Fruit` entity is causing a foreign key error even when `CascadeType.REMOVE` is set on the related `FruitDetailEntity`.\r\n\r\n### Expected behavior\r\n\r\nDeleting Fruit should delete the related `FruitDetailEntity`.\r\n\r\n### Actual behavior\r\n\r\nGetting an error:\r\n\r\n```java\r\n2022-05-29 17:07:26,163 ERROR [org.acm.hib.orm.pan.ent.FruitEntityResource] (executor-thread-0) Failed to handle request: io.quarkus.arc.ArcUndeclaredThrowableException: Error invoking subclass method\r\n        at org.acme.hibernate.orm.panache.entity.FruitEntityResource_Subclass.delete(Unknown Source)\r\n        at org.acme.hibernate.orm.panache.entity.FruitEntityResource_ClientProxy.delete(Unknown Source)\r\n        at org.acme.hibernate.orm.panache.entity.FruitEntityResource$quarkusrestinvoker$delete_18d1eb030975eab2b5333faf64f47aa35d6f3940.invoke(Unknown Source)\r\n        at org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n        at org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:7)\r\n        at org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:141)\r\n        at io.quarkus.vertx.core.runtime.VertxCoreRecorder$13.runWith(VertxCoreRecorder.java:545)\r\n        at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n        at org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n        at org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n        at java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: javax.transaction.RollbackException: ARJUNA016053: Could not commit transaction.\r\n        at com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionImple.commitAndDisassociate(TransactionImple.java:1307)\r\n        at com.arjuna.ats.internal.jta.transaction.arjunacore.BaseTransaction.commit(BaseTransaction.java:128)\r\n        at io.quarkus.narayana.jta.runtime.CDIDelegatingTransactionManager.commit(CDIDelegatingTransactionManager.java:105)\r\n        at io.quarkus.narayana.jta.runtime.CDIDelegatingTransactionManager_Subclass.commit$$superforward1(Unknown Source)\r\n        at io.quarkus.narayana.jta.runtime.CDIDelegatingTransactionManager_Subclass$$function$$6.apply(Unknown Source)\r\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:54)\r\n        at io.quarkus.arc.runtime.devconsole.InvocationInterceptor.proceed(InvocationInterceptor.java:62)\r\n        at io.quarkus.arc.runtime.devconsole.InvocationInterceptor.monitor(InvocationInterceptor.java:49)\r\n        at io.quarkus.arc.runtime.devconsole.InvocationInterceptor_Bean.intercept(Unknown Source)\r\n        at io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:41)\r\n        at io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:32)\r\n        at io.quarkus.narayana.jta.runtime.CDIDelegatingTransactionManager_Subclass.commit(Unknown Source)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.endTransaction(TransactionalInterceptorBase.java:374)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:166)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:104)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.doIntercept(TransactionalInterceptorRequired.java:38)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.intercept(TransactionalInterceptorBase.java:58)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired.intercept(TransactionalInterceptorRequired.java:32)\r\n        at io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorRequired_Bean.intercept(Unknown Source)\r\n        at io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n        at io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:41)\r\n        at io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:32)\r\n        ... 13 more\r\nCaused by: javax.persistence.PersistenceException: org.hibernate.exception.ConstraintViolationException: could not execute statement\r\n        at org.hibernate.internal.ExceptionConverterImpl.convert(ExceptionConverterImpl.java:154)\r\n        at org.hibernate.internal.ExceptionConverterImpl.convert(ExceptionConverterImpl.java:181)\r\n        at org.hibernate.internal.ExceptionConverterImpl.convert(ExceptionConverterImpl.java:188)\r\n        at org.hibernate.internal.SessionImpl.doFlush(SessionImpl.java:1411)\r\n        at org.hibernate.internal.SessionImpl.managedFlush(SessionImpl.java:489)\r\n        at org.hibernate.internal.SessionImpl.flushBeforeTransactionCompletion(SessionImpl.java:3290)\r\n        at org.hibernate.internal.SessionImpl.beforeTransactionCompletion(SessionImpl.java:2425)\r\n        at org.hibernate.engine.jdbc.internal.JdbcCoordinatorImpl.beforeTransactionCompletion(JdbcCoordinatorImpl.java:449)\r\n        at org.hibernate.resource.transaction.backend.jta.internal.JtaTransactionCoordinatorImpl.beforeCompletion(JtaTransactionCoordinatorImpl.java:356)\r\n        at org.hibernate.resource.transaction.backend.jta.internal.synchronization.SynchronizationCallbackCoordinatorNonTrackingImpl.beforeCompletion(SynchronizationCallbackCoordinatorNonTrackingImpl.java:47)\r\n        at org.hibernate.resource.transaction.backend.jta.internal.synchronization.RegisteredSynchronization.beforeCompletion(RegisteredSynchronization.java:37)\r\n        at com.arjuna.ats.internal.jta.resources.arjunacore.SynchronizationImple.beforeCompletion(SynchronizationImple.java:76)\r\n        at com.arjuna.ats.arjuna.coordinator.TwoPhaseCoordinator.beforeCompletion(TwoPhaseCoordinator.java:360)\r\n        at com.arjuna.ats.arjuna.coordinator.TwoPhaseCoordinator.end(TwoPhaseCoordinator.java:91)\r\n        at com.arjuna.ats.arjuna.AtomicAction.commit(AtomicAction.java:162)\r\n        at com.arjuna.ats.internal.jta.transaction.arjunacore.TransactionImple.commitAndDisassociate(TransactionImple.java:1295)\r\n        ... 35 more\r\nCaused by: org.hibernate.exception.ConstraintViolationException: could not execute statement\r\n        at org.hibernate.exception.internal.SQLStateConversionDelegate.convert(SQLStateConversionDelegate.java:109)\r\n        at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:37)\r\n        at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:113)\r\n        at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:99)\r\n        at org.hibernate.engine.jdbc.internal.ResultSetReturnImpl.executeUpdate(ResultSetReturnImpl.java:200)\r\n        at org.hibernate.engine.jdbc.batch.internal.NonBatchingBatch.addToBatch(NonBatchingBatch.java:46)\r\n        at org.hibernate.persister.entity.AbstractEntityPersister.delete(AbstractEntityPersister.java:3698)\r\n        at org.hibernate.persister.entity.AbstractEntityPersister.delete(AbstractEntityPersister.java:3958)\r\n        at org.hibernate.action.internal.EntityDeleteAction.execute(EntityDeleteAction.java:123)\r\n        at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:604)\r\n        at org.hibernate.engine.spi.ActionQueue.lambda$executeActions$1(ActionQueue.java:478)\r\n        at java.base/java.util.LinkedHashMap.forEach(LinkedHashMap.java:684)\r\n        at org.hibernate.engine.spi.ActionQueue.executeActions(ActionQueue.java:475)\r\n        at org.hibernate.event.internal.AbstractFlushingEventListener.performExecutions(AbstractFlushingEventListener.java:344)\r\n        at org.hibernate.event.internal.DefaultFlushEventListener.onFlush(DefaultFlushEventListener.java:40)\r\n        at org.hibernate.event.service.internal.EventListenerGroupImpl.fireEventOnEachListener(EventListenerGroupImpl.java:107)\r\n        at org.hibernate.internal.SessionImpl.doFlush(SessionImpl.java:1407)\r\n        ... 47 more\r\nCaused by: org.h2.jdbc.JdbcSQLException: Referential integrity constraint violation: \"FK6WTK4L3GY1GN4V4WNS6RMHMUP: PUBLIC.FRUITDETAILSENTITY FOREIGN KEY(FRUIT_ID) REFERENCES PUBLIC.FRUITENTITY(ID) (4)\"; SQL statement:\r\ndelete from FruitEntity where id=? [23503-197]\r\n        at org.h2.message.DbException.gQLException(DbException.java:357)\r\n        at org.h2.message.DbException.get(DbException.java:179)\r\n        at org.h2.message.DbException.get(DbException.java:155)\r\n        at org.h2.constraint.ConstraintReferential.checkRow(ConstraintReferential.java:386)\r\n        at org.h2.constraint.ConstraintReferential.checkRowRefTable(ConstraintReferential.java:403)\r\n        at org.h2.constraint.ConstraintReferential.checkRow(ConstraintReferential.java:278)\r\n        at org.h2.table.Table.fireConstraints(Table.java:995)\r\n        at org.h2.table.Table.fireAfterRow(Table.java:1013)\r\n        at org.h2.command.dml.Delete.update(Delete.java:108)\r\n        at org.h2.command.CommandContainer.update(CommandContainer.java:102)\r\n        at org.h2.command.Command.executeUpdate(Command.java:261)\r\n        at org.h2.jdbc.JdbcPreparedStatement.executeUpdateInternal(JdbcPreparedStatement.java:199)\r\n        at org.h2.jdbc.JdbcPreparedStatement.executeUpdate(JdbcPreparedStatement.java:153)\r\n        at io.agroal.pool.wrapper.PreparedStatementWrapper.executeUpdate(PreparedStatementWrapper.java:88)\r\n        at org.hibernate.engine.jdbc.internal.ResultSetReturnImpl.executeUpdate(ResultSetReturnImpl.java:197)\r\n        ... 59 more\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nReproducer: https://github.com/omar-zahid/quarkus-panache-cascade-delete\r\n\r\nSteps to reproduce: \r\n\r\n1. Check out the code and run `quarkus dev`\r\n2. Add color as the detail for the fruit:\r\n\r\n```curl\r\ncurl --location --request POST 'http://localhost:8080/entity/fruits/details' \\\r\n--header 'Content-Type: application/json' \\\r\n--data-raw '{\r\n    \"fruit\":{ \"id\": 4},\r\n    \"color\": \"Red\"\r\n}'\r\n```\r\n3. Delete fruit ID number 4 by:\r\n\r\n```curl\r\ncurl --location --request DELETE 'http://localhost:8080/entity/fruits/4'\r\n```\r\n\r\nAt this point you'll be greeted by the error - 500 Internal Server Error:\r\n\r\n```\r\n{\r\n    \"exceptionType\": \"io.quarkus.arc.ArcUndeclaredThrowableException\",\r\n    \"code\": 500,\r\n    \"error\": \"Error invoking subclass method\"\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux MASTER 4.19.84-microsoft-standard #1 SMP Wed Nov 13 11:44:37 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"11.0.14.1\" 2022-02-08 OpenJDK Runtime Environment (build 11.0.14.1+1-Ubuntu-0ubuntu1.20.04) OpenJDK 64-Bit Server VM (build 11.0.14.1+1-Ubuntu-0ubuntu1.20.04, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.8.0 Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.4 (9b656c72d54e5bacbed989b64718c159fe39b537) Maven home: /home/omar/.m2/wrapper/dists/apache-maven-3.8.4-bin/52ccbt68d252mdldqsfsn03jlf/apache-maven-3.8.4 Java version: 11.0.14.1, vendor: Ubuntu, runtime: /usr/lib/jvm/java-11-openjdk-amd64 Default locale: en, platform encoding: UTF-8 OS name: \"linux\", version: \"4.19.84-microsoft-standard\", arch: \"amd64\", family: \"unix\"\r\n\r\n### Additional information\r\n\r\nSometimes, waiting for some period of time such as 10 to 15 minutes before deleting the resource works. Not sure why this is the case, so adding it as an additional information.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/25848/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25848/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
