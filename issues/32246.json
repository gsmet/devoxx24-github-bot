{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32246",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32246/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32246/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32246/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/32246",
  "id": 1646476663,
  "node_id": "I_kwDOCFbutM5iIz13",
  "number": 32246,
  "title": "Quarkus doesn't detect Docker rootless anymore",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1891982257,
      "node_id": "MDU6TGFiZWwxODkxOTgyMjU3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/container-image",
      "name": "area/container-image",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/249",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/249",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/249/labels",
    "id": 9378470,
    "node_id": "MI_kwDOCFbutM4Ajxqm",
    "number": 249,
    "title": "3.0.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 36,
    "state": "closed",
    "created_at": "2023-05-09T16:07:50Z",
    "updated_at": "2023-06-28T14:01:59Z",
    "due_on": null,
    "closed_at": "2023-05-10T11:32:56Z"
  },
  "comments": 12,
  "created_at": "2023-03-29T20:26:36Z",
  "updated_at": "2023-05-09T16:08:10Z",
  "closed_at": "2023-04-13T18:46:55Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nStarting from ``2.16.4.Final``, Quarkus cannot detect ```Docker rootless``` anymore. Reason for that is a faulty implemenation in ``ContainerRuntimeUtil.getRootlessStateFor``:\r\n\r\n\r\n```java\r\nprivate static boolean getRootlessStateFor(ContainerRuntime containerRuntime) {\r\n      ......\r\n            try (InputStream inputStream = rootlessProcess.getInputStream();\r\n                    InputStreamReader inputStreamReader = new InputStreamReader(inputStream);\r\n                    BufferedReader bufferedReader = new BufferedReader(inputStreamReader)) {\r\n                Predicate<String> stringPredicate;\r\n                // Docker includes just \"rootless\" under SecurityOptions, while podman includes \"rootless: <boolean>\"\r\n       --->  if (containerRuntime == ContainerRuntime.DOCKER)  {  <-- ContainerRuntime.DOCKER is null \r\n                    stringPredicate = line -> line.trim().equals(\"rootless\");\r\n                } else {\r\n                    stringPredicate = line -> line.trim().equals(\"rootless: true\");\r\n                }\r\n                return bufferedReader.lines().anyMatch(stringPredicate);\r\n            }\r\n        .....\r\n    }\r\n\r\n    /**\r\n     * Supported Container runtimes\r\n     */\r\n    public enum ContainerRuntime {\r\n        DOCKER,\r\n        PODMAN;\r\n\r\n        private final boolean rootless;\r\n\r\n        ContainerRuntime() {\r\n            this.rootless = getRootlessStateFor(this);\r\n        }\r\n\r\n        public String getExecutableName() {\r\n            return this.name().toLowerCase();\r\n        }\r\n\r\n        public boolean isRootless() {\r\n            return rootless;\r\n        }\r\n    }\r\n```\r\n\r\nThis condition ``containerRuntime == ContainerRuntime.DOCKER`` always evaluates to false, since ContainerRuntime.DOCKER is null. That's  because ``getRootlessStateFor`` is being called during constructor execution of ContainerRuntime. Thus we end up in the ``podman`` case, even when ``Docker`` is being detected!\r\n\r\n\r\n### Expected behavior\r\n\r\nQuarkus should detect ``Docker rootless`` properly :-)\r\n\r\n### Actual behavior\r\n\r\nQuarkus native container builds aren't working on Docker rootless anymore, because the rootless detection fails. Therefor the container isn't started as root, but rather non root which leads to file permission issues ..\r\n\r\n### How to Reproduce?\r\n\r\n_No response_\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n5.4.228 ...... x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\n17\r\n\r\n### GraalVM version (if different from Java)\r\n\r\nGraalVM 22.3.0 Java 17 CE\r\n\r\n### Quarkus version or git rev\r\n\r\n2.16.4.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nMaven 3.8.6\r\n\r\n### Additional information\r\n\r\n```\r\nDocker version 20.10.22, build 3a2c30b\r\nrunner@....:/$ docker info\r\nClient:\r\n Context:    default\r\n Debug Mode: false\r\n\r\nServer:\r\n Containers: 0\r\n  Running: 0\r\n  Paused: 0\r\n  Stopped: 0\r\n Images: 0\r\n Server Version: 20.10.22\r\n Storage Driver: vfs\r\n Logging Driver: json-file\r\n Cgroup Driver: none\r\n Cgroup Version: 1\r\n Plugins:\r\n  Volume: local\r\n  Network: bridge host ipvlan macvlan null overlay\r\n  Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog\r\n Swarm: inactive\r\n Runtimes: io.containerd.runc.v2 io.containerd.runtime.v1.linux runc\r\n Default Runtime: runc\r\n Init Binary: docker-init\r\n containerd version: 78f51771157abb6c9ed224c22013cdf09962315d\r\n runc version: v1.1.4-0-g5fd4c4d1\r\n init version: de40ad0\r\n Security Options:\r\n  seccomp\r\n   Profile: default\r\n  **rootless**\r\n Kernel Version: 5.4.228-132.418.amzn2.x86_64\r\n Operating System: Ubuntu 22.04.1 LTS (containerized)\r\n OSType: linux\r\n Architecture: x86_64\r\n CPUs: 4\r\n Total Memory: 15.34GiB\r\n Name: ......\r\n Docker Root Dir: /home/runner/.local/share/docker\r\n Debug Mode: false\r\n Registry: https://index.docker.io/v1/\r\n Labels: ...\r\n Experimental: false\r\n Insecure Registries:\r\n  127.0.0.0/8\r\n Live Restore Enabled: false\r\n Product License: Community Engine\r\n\r\nWARNING: Running in rootless-mode without cgroups. To enable cgroups in rootless-mode, you need to boot the system in cgroup v2 mode.\r\n```\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32246/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32246/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
