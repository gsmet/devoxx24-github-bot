{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/30424",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30424/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30424/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30424/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/30424",
  "id": 1536963047,
  "node_id": "I_kwDOCFbutM5bnDHn",
  "number": 30424,
  "title": "Building of container images with buildx causes build failures",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/231",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/231",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/231/labels",
    "id": 8975088,
    "node_id": "MI_kwDOCFbutM4AiPLw",
    "number": 231,
    "title": "2.16.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 74,
    "state": "closed",
    "created_at": "2023-01-27T17:04:23Z",
    "updated_at": "2023-05-15T13:59:09Z",
    "due_on": null,
    "closed_at": "2023-02-01T13:07:35Z"
  },
  "comments": 0,
  "created_at": "2023-01-17T20:00:05Z",
  "updated_at": "2023-01-27T17:51:00Z",
  "closed_at": "2023-01-19T14:06:54Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nAs of 2.15.0.Final, building and pushing container images with buildx is causing build failures.\r\n\r\nThe problem seems to be that Quarkus tries to push the container images from the host, although they've been built and pushed in buildx already. Because the images are not available in the host's local registry, the push attempt fails.\r\n\r\nHere's an example build log:\r\n\r\n```\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] Starting (local) container image build for jar using docker.\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] Executing the following command to build docker image: 'docker buildx build -f /REDACTED/bar/src/main/docker/Dockerfile.jvm --platform linux/amd64,linux/arm64 -t host.docker.internal:5005/foo/bar:1.0.0-SNAPSHOT -t host.docker.internal:5005/foo/bar:latest --push /REDACTED/bar'\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #1 [internal] load build definition from Dockerfile.jvm\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #1 transferring dockerfile: 5.39kB done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #1 DONE 0.0s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #2 [internal] load .dockerignore\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #2 transferring context: 115B done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #2 DONE 0.0s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #3 [linux/amd64 internal] load metadata for registry.access.redhat.com/ubi8/openjdk-17-runtime:latest\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #3 ...\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #4 [linux/arm64 internal] load metadata for registry.access.redhat.com/ubi8/openjdk-17-runtime:latest\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #4 DONE 1.3s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #3 [linux/amd64 internal] load metadata for registry.access.redhat.com/ubi8/openjdk-17-runtime:latest\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #3 DONE 1.5s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #5 [linux/amd64 1/2] FROM registry.access.redhat.com/ubi8/openjdk-17-runtime@sha256:9358f474bc99d4c65e1043990a0f8834aaa9974f27fe6c2ed88d6fa11a27a35a\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #5 resolve registry.access.redhat.com/ubi8/openjdk-17-runtime@sha256:9358f474bc99d4c65e1043990a0f8834aaa9974f27fe6c2ed88d6fa11a27a35a done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #5 DONE 0.0s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #6 [linux/arm64 1/2] FROM registry.access.redhat.com/ubi8/openjdk-17-runtime@sha256:9358f474bc99d4c65e1043990a0f8834aaa9974f27fe6c2ed88d6fa11a27a35a\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #6 resolve registry.access.redhat.com/ubi8/openjdk-17-runtime@sha256:9358f474bc99d4c65e1043990a0f8834aaa9974f27fe6c2ed88d6fa11a27a35a 0.0s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #6 DONE 0.0s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #7 [internal] load build context\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #7 transferring context: 116.88MB 2.5s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #7 DONE 2.5s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #6 [linux/arm64 1/2] FROM registry.access.redhat.com/ubi8/openjdk-17-runtime@sha256:9358f474bc99d4c65e1043990a0f8834aaa9974f27fe6c2ed88d6fa11a27a35a\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #6 CACHED\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #5 [linux/amd64 1/2] FROM registry.access.redhat.com/ubi8/openjdk-17-runtime@sha256:9358f474bc99d4c65e1043990a0f8834aaa9974f27fe6c2ed88d6fa11a27a35a\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #5 CACHED\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #8 [linux/amd64 2/2] COPY --chown=185 target/*-runner.jar /deployments/quarkus-run.jar\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #8 DONE 0.5s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #9 [linux/arm64 2/2] COPY --chown=185 target/*-runner.jar /deployments/quarkus-run.jar\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #9 DONE 0.5s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] \r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting to image\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting layers\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting layers 2.4s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting manifest sha256:a8b3772b2612de447814116b0202a28c18f35e65a588c6be9e680eea56e5bafd done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting config sha256:64b8bc2007f1255ebe4d3358c372555da80fd3133d956ca91dce1396e77de2aa done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting attestation manifest sha256:6779238e09865c565980594ce834d228881125b837f4b9f5ba817752b77bc2cb done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting manifest sha256:548b8c98021bc178c0427a8ad3c03647813e64c87b7e39cccaf8c24fbfe3d581 done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting config sha256:489c7dbd39adefb3fe7b9c53040b94c22fdb60f05101491d8d33229d62f20332\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting config sha256:489c7dbd39adefb3fe7b9c53040b94c22fdb60f05101491d8d33229d62f20332 done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting attestation manifest sha256:46a2550c0416c61875eb66cbc659b1559a73763275795fe276d74638b8937563 done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 exporting manifest list sha256:232246f8f7809e9d7bd57fbc03b53c60d92cb4bc85261b1838d06368f9571de6 done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 pushing layers\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 pushing layers 2.0s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 pushing manifest for host.docker.internal:5005/foo/bar:1.0.0-SNAPSHOT@sha256:232246f8f7809e9d7bd57fbc03b53c60d92cb4bc85261b1838d06368f9571de6 0.0s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 pushing layers 0.0s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 pushing manifest for host.docker.internal:5005/foo/bar:latest@sha256:232246f8f7809e9d7bd57fbc03b53c60d92cb4bc85261b1838d06368f9571de6 0.0s done\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] #10 DONE 4.5s\r\n[INFO] [io.quarkus.container.image.docker.deployment.DockerProcessor] Built container image host.docker.internal:5005/foo/bar:1.0.0-SNAPSHOT (linux/amd64,linux/arm64 platform(s))\r\n\r\n[INFO] [io.quarkus.deployment.util.ExecUtil] The push refers to repository [host.docker.internal:5005/foo/bar]\r\n[INFO] [io.quarkus.deployment.util.ExecUtil] An image does not exist locally with the tag: host.docker.internal:5005/foo/bar\r\n\r\n...\r\n\r\nError: [ERROR] \t[error]: Build step io.quarkus.container.image.docker.deployment.DockerProcessor#dockerBuildFromJar threw an exception: java.lang.RuntimeException: Execution of 'docker push host.docker.internal:5005/foo/bar:latest' failed. See docker output for more details\r\n```\r\n\r\nNote how both building and pushing the images with buildx succeeded. Yet the build is failing due to the redundant push attempt.\r\n\r\nI think the culprit is that there's a missing `!useBuildx` condition here, when Quarkus checks if it should push images:\r\n\r\nhttps://github.com/quarkusio/quarkus/blob/66f501aefb1e05ca9768f4d25f15628e3f0a4165/extensions/container-image/container-image-docker/deployment/src/main/java/io/quarkus/container/image/docker/deployment/DockerProcessor.java#L224-L230\r\n\r\n### Expected behavior\r\n\r\n_No response_\r\n\r\n### Actual behavior\r\n\r\n_No response_\r\n\r\n### How to Reproduce?\r\n\r\n1. Create a new Quarkus project with `container-image-docker` extension:\r\n```shell\r\nquarkus create app -x container-image-docker foo:bar:1.0.0-SNAPSHOT\r\n```\r\n2. Start a local Docker registry:\r\n```shell\r\ndocker run --rm -p 5005:5000 --name registry registry:2\r\n```\r\n3. Create a new buildx builder that allows for HTTP usage against the local registry:\r\n```shell\r\necho '[registry.\"host.docker.internal:5005\"]\\n  http = true' > buildkitd.toml\r\ndocker buildx create --use desktop-linux --config buildkitd.toml\r\n```\r\n4. Run the Quarkus build:\r\n```shell\r\ncd bar\r\nmvn clean install \\\r\n  -Dquarkus.container-image.additional-tags=latest \\\r\n  -Dquarkus.container-image.build=true \\\r\n  -Dquarkus.container-image.group=foo \\\r\n  -Dquarkus.container-image.registry=host.docker.internal:5005 \\\r\n  -DskipTests=true \\\r\n  -Dquarkus.container-image.push=true \\\r\n  -Dquarkus.docker.buildx.platform=linux/amd64,linux/arm64\r\n```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\n_No response_\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.15.0.Final - 2.15.3.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/30424/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/30424/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
