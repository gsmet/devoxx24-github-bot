{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32533",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32533/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32533/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32533/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/32533",
  "id": 1662336571,
  "node_id": "I_kwDOCFbutM5jFT47",
  "number": 32533,
  "title": "Exceptions with Hibernate Reactive under load",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2122256208,
      "node_id": "MDU6TGFiZWwyMTIyMjU2MjA4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-reactive",
      "name": "area/hibernate-reactive",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/246",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/246",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/246/labels",
    "id": 9296662,
    "node_id": "MI_kwDOCFbutM4AjdsW",
    "number": 246,
    "title": "3.0.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 115,
    "state": "closed",
    "created_at": "2023-04-18T08:50:05Z",
    "updated_at": "2023-05-15T14:00:32Z",
    "due_on": null,
    "closed_at": "2023-04-26T09:04:58Z"
  },
  "comments": 17,
  "created_at": "2023-04-11T12:01:58Z",
  "updated_at": "2023-04-25T04:50:09Z",
  "closed_at": "2023-04-24T21:12:37Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen using reactive panache and stressing the application with some tests, the application starts throwing exceptions:\r\n\r\n```\r\n2023-04-11 14:00:24,747 ERROR [org.jbo.res.rea.com.cor.AbstractResteasyReactiveContext] (vert.x-eventloop-thread-6) Request failed: javax.persistence.PersistenceException: org.hibernate.HibernateException: java.util.concurrent.CompletionException: java.lang.IllegalStateException: HR000069: Detected use of the reactive Session from a different Thread than the one which was used to open the reactive Session - this suggests an invalid integration; original thread [27]: 'vert.x-eventloop-thread-6' current Thread [23]: 'vert.x-eventloop-thread-2'\r\n\tat org.hibernate.internal.ExceptionConverterImpl.convert(ExceptionConverterImpl.java:154)\r\n\tat org.hibernate.internal.ExceptionConverterImpl.convert(ExceptionConverterImpl.java:181)\r\n\tat org.hibernate.reactive.session.impl.ReactiveExceptionConverter.convert(ReactiveExceptionConverter.java:31)\r\n\tat org.hibernate.reactive.session.impl.ReactiveSessionImpl.lambda$firePersist$19(ReactiveSessionImpl.java:708)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniHandle(CompletableFuture.java:934)\r\n\tat java.base/java.util.concurrent.CompletableFuture$UniHandle.tryFire(CompletableFuture.java:911)\r\n\tat java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n\tat java.base/java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2147)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniAcceptNow(CompletableFuture.java:757)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniAcceptStage(CompletableFuture.java:735)\r\n\tat java.base/java.util.concurrent.CompletableFuture.thenAccept(CompletableFuture.java:2182)\r\n\tat java.base/java.util.concurrent.CompletableFuture.thenAccept(CompletableFuture.java:144)\r\n\tat org.hibernate.reactive.id.impl.BlockingIdentifierGenerator.lambda$generate$1(BlockingIdentifierGenerator.java:94)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat org.hibernate.reactive.id.impl.BlockingIdentifierGenerator.lambda$generate$0(BlockingIdentifierGenerator.java:87)\r\n\tat java.base/java.util.concurrent.CompletableFuture$UniAccept.tryFire(CompletableFuture.java:718)\r\n\tat java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n\tat java.base/java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2147)\r\n\tat io.vertx.core.Future.lambda$toCompletionStage$3(Future.java:384)\r\n\tat io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\n\tat io.vertx.core.impl.future.FutureBase.emitSuccess(FutureBase.java:60)\r\n\tat io.vertx.core.impl.future.FutureImpl.tryComplete(FutureImpl.java:211)\r\n\tat io.vertx.core.impl.future.PromiseImpl.tryComplete(PromiseImpl.java:23)\r\n\tat io.vertx.sqlclient.impl.QueryResultBuilder.tryComplete(QueryResultBuilder.java:100)\r\n\tat io.vertx.sqlclient.impl.QueryResultBuilder.tryComplete(QueryResultBuilder.java:34)\r\n\tat io.vertx.core.Promise.complete(Promise.java:66)\r\n\tat io.vertx.core.Promise.handle(Promise.java:51)\r\n\tat io.vertx.core.Promise.handle(Promise.java:29)\r\n\tat io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\n\tat io.vertx.core.impl.future.FutureBase.emitSuccess(FutureBase.java:60)\r\n\tat io.vertx.core.impl.future.FutureImpl.tryComplete(FutureImpl.java:211)\r\n\tat io.vertx.core.impl.future.PromiseImpl.tryComplete(PromiseImpl.java:23)\r\n\tat io.vertx.core.impl.future.PromiseImpl.onSuccess(PromiseImpl.java:49)\r\n\tat io.vertx.core.impl.future.PromiseImpl.handle(PromiseImpl.java:41)\r\n\tat io.vertx.sqlclient.impl.TransactionImpl.lambda$wrap$0(TransactionImpl.java:72)\r\n\tat io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\n\tat io.vertx.core.impl.future.FutureBase.lambda$emitSuccess$0(FutureBase.java:54)\r\n\tat io.vertx.core.impl.EventLoopContext.execute(EventLoopContext.java:86)\r\n\tat io.vertx.core.impl.DuplicatedContext.execute(DuplicatedContext.java:163)\r\n\tat io.vertx.core.impl.future.FutureBase.emitSuccess(FutureBase.java:51)\r\n\tat io.vertx.core.impl.future.FutureImpl.tryComplete(FutureImpl.java:211)\r\n\tat io.vertx.core.impl.future.PromiseImpl.tryComplete(PromiseImpl.java:23)\r\n\tat io.vertx.core.impl.future.PromiseImpl.onSuccess(PromiseImpl.java:49)\r\n\tat io.vertx.core.impl.future.PromiseImpl.handle(PromiseImpl.java:41)\r\n\tat io.vertx.core.impl.future.PromiseImpl.handle(PromiseImpl.java:23)\r\n\tat io.vertx.sqlclient.impl.command.CommandResponse.fire(CommandResponse.java:46)\r\n\tat io.vertx.sqlclient.impl.SocketConnectionBase.handleMessage(SocketConnectionBase.java:292)\r\n\tat io.vertx.pgclient.impl.PgSocketConnection.handleMessage(PgSocketConnection.java:97)\r\n\tat io.vertx.sqlclient.impl.SocketConnectionBase.lambda$init$0(SocketConnectionBase.java:105)\r\n\tat io.vertx.core.impl.EventLoopContext.emit(EventLoopContext.java:55)\r\n\tat io.vertx.core.impl.ContextBase.emit(ContextBase.java:239)\r\n\tat io.vertx.core.net.impl.NetSocketImpl.handleMessage(NetSocketImpl.java:390)\r\n\tat io.vertx.core.net.impl.ConnectionBase.read(ConnectionBase.java:157)\r\n\tat io.vertx.core.net.impl.VertxHandler.channelRead(VertxHandler.java:153)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\r\n\tat io.netty.channel.CombinedChannelDuplexHandler$DelegatingChannelHandlerContext.fireChannelRead(CombinedChannelDuplexHandler.java:436)\r\n\tat io.vertx.pgclient.impl.codec.PgEncoder.lambda$write$0(PgEncoder.java:98)\r\n\tat io.vertx.pgclient.impl.codec.PgCommandCodec.handleReadyForQuery(PgCommandCodec.java:139)\r\n\tat io.vertx.pgclient.impl.codec.PgDecoder.decodeReadyForQuery(PgDecoder.java:237)\r\n\tat io.vertx.pgclient.impl.codec.PgDecoder.channelRead(PgDecoder.java:96)\r\n\tat io.netty.channel.CombinedChannelDuplexHandler.channelRead(CombinedChannelDuplexHandler.java:251)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1410)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\r\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:919)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:788)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:724)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:650)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: org.hibernate.HibernateException: java.util.concurrent.CompletionException: java.lang.IllegalStateException: HR000069: Detected use of the reactive Session from a different Thread than the one which was used to open the reactive Session - this suggests an invalid integration; original thread [27]: 'vert.x-eventloop-thread-6' current Thread [23]: 'vert.x-eventloop-thread-2'\r\n\t... 77 more\r\nCaused by: java.util.concurrent.CompletionException: java.lang.IllegalStateException: HR000069: Detected use of the reactive Session from a different Thread than the one which was used to open the reactive Session - this suggests an invalid integration; original thread [27]: 'vert.x-eventloop-thread-6' current Thread [23]: 'vert.x-eventloop-thread-2'\r\n\tat java.base/java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:315)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1194)\r\n\tat java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n\tat java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n\tat org.hibernate.reactive.event.impl.AbstractReactiveSaveEventListener.reactivePerformSaveOrReplicate(AbstractReactiveSaveEventListener.java:252)\r\n\tat org.hibernate.reactive.event.impl.AbstractReactiveSaveEventListener.lambda$reactivePerformSave$2(AbstractReactiveSaveEventListener.java:175)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n\tat java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2309)\r\n\tat java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:144)\r\n\tat org.hibernate.reactive.event.impl.AbstractReactiveSaveEventListener.reactivePerformSave(AbstractReactiveSaveEventListener.java:175)\r\n\tat org.hibernate.reactive.event.impl.AbstractReactiveSaveEventListener.lambda$reactiveSaveWithGeneratedId$0(AbstractReactiveSaveEventListener.java:125)\r\n\tat java.base/java.util.concurrent.CompletableFuture$UniCompose.tryFire(CompletableFuture.java:1150)\r\n\t... 73 more\r\nCaused by: java.lang.IllegalStateException: HR000069: Detected use of the reactive Session from a different Thread than the one which was used to open the reactive Session - this suggests an invalid integration; original thread [27]: 'vert.x-eventloop-thread-6' current Thread [23]: 'vert.x-eventloop-thread-2'\r\n\tat org.hibernate.reactive.common.InternalStateAssertions.assertCurrentThreadMatches(InternalStateAssertions.java:46)\r\n\tat org.hibernate.reactive.session.impl.ReactiveSessionImpl.threadCheck(ReactiveSessionImpl.java:158)\r\n\tat org.hibernate.reactive.session.impl.ReactiveSessionImpl.getReactiveActionQueue(ReactiveSessionImpl.java:168)\r\n\tat org.hibernate.reactive.event.impl.AbstractReactiveSaveEventListener.addInsertAction(AbstractReactiveSaveEventListener.java:343)\r\n\tat org.hibernate.reactive.event.impl.AbstractReactiveSaveEventListener.lambda$reactivePerformSaveOrReplicate$4(AbstractReactiveSaveEventListener.java:279)\r\n\tat java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1187)\r\n\t... 83 more\r\n```\r\n\r\n### Expected behavior\r\n\r\nApplication runs without throwing exceptions.\r\n\r\n### Actual behavior\r\n\r\nApplication throws exceptions.\r\n\r\n### How to Reproduce?\r\n\r\n1. Checkout [this `github.com` repository](https://github.com/turing85/quarkus-reactive-stress-test.git):\r\n    ```bash\r\n    git clone https://github.com/turing85/quarkus-reactive-stress-test.git\r\n    cd quarkus-reactive-stress-test\r\n    ```\r\n2. Deploy dependencies:\r\n     ```bash\r\n    docker-compose --file local-deployment/docker-compose.yml up -d\r\n    ```\r\n3. Build the application, configure JMeter to use one thread:\r\n    ```bash\r\n    ./mvnw --define jmeter.threads=1 clean package\r\n    ```\r\n4. Create the database schema:\r\n    ```bash\r\n    ./mwnw flyway:migrate\r\n    ```\r\n4. Start the application:\r\n    ```bash\r\n    java -jar target/quarkus-app/quarkus-run.jar\r\n    ```\r\n6. In a separate terminal, start the JMeter tests (we will call this terminal the test-terminal, and the terminal running the application the application-terminal):\r\n    ```bash\r\n    ./mvnw jmeter:jmeter\r\n    ```\r\n7. Observe that the tests finish without errors:\r\n    ```bash\r\n    ...\r\n    [INFO] summary =  10000 in 00:00:14 =  712.5/s Avg:     1 Min:     0 Max:   433 Err:     0 (0.00%)\r\n    ...\r\n    ```\r\n8. Switch back to the application-terminal, stop it, and rebuild the application, configure JMeter to use 4 threads, start the application:\r\n    ```bash\r\n    ./mvnw --define jmeter.threads=4 clean package\r\n    java -jar target/quarkus-app/quarkus-run.jar\r\n    ```\r\n9. Back to the test-terminal, re-execute the JMeter tests:\r\n    ```bash\r\n    ./mvnw jmeter:jmeter\r\n    ```\r\n10. Observe that there are errors in the tests:\r\n    ```bash\r\n    ...\r\n    [INFO] summary =  40000 in 00:00:13 = 3034.4/s Avg:     1 Min:     0 Max:   482 Err:   927 (2.32%)\r\n    ...\r\n    ```\r\n11. Find the stack trace mentioned above in the logs of the application-terminal\r\n12. In the test-terminal, Run the `wrk`-tests, with 1 thread and 1 connection:\r\n    ```bash\r\n    wrk/run.sh 1 1 30s\r\n    ```\r\n13. Observe that the tests finish without erros:\r\n     ```bash\r\n     ...\r\n     Non-2xx responses: 0 (0.00%)\r\n     ...\r\n     ```\r\n14. Re-run the tests, with 1 thread and 2 connections:\r\n    ```bash\r\n    wrk/run.sh 1 2 30s\r\n    ```\r\n15. Immediately switch back to the application-terminal and observe that, for some time, exceptions are thrown and then, the exceptions stop\r\n16. When the tests finish, switch back to the test-terminal, observe the (relatively low) error rate:\r\n    ```bash\r\n    ...\r\n    Non-2xx responses: 242 (0.12%)\r\n    ...\r\n    ```\r\n17. Re-run the `wrk`-tests, with 4 connections:\r\n    ```bash\r\n    wrk/run.sh 1 4 30s\r\n    ```\r\n18. Immediately switch back to the application-terminal, observe that the application prints stack traces constantly\r\n19. When the tests are finished, switch back to the test-terminal and observe the significantly higher error rate:\r\n    ```bash\r\n    ...\r\n    Non-2xx responses: 6597 (2.46%)\r\n    ...\r\n    ```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n`Linux <redacted> 5.15.0-52-generic #58-Ubuntu SMP Thu Oct 13 08:03:55 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n### Output of `java -version`\r\n```\r\nopenjdk version \"17.0.5\" 2022-10-18\r\nOpenJDK Runtime Environment Temurin-17.0.5+8 (build 17.0.5+8)\r\nOpenJDK 64-Bit Server VM Temurin-17.0.5+8 (build 17.0.5+8, mixed mode, sharing)\r\n```\r\n\r\n### GraalVM version (if different from Java)\r\n\r\nGraalVM Mandrel, Version `22.3.1.0-java17`\r\n\r\n### Quarkus version or git rev\r\n\r\n `2.16.6.Final`\r\n`3.0.0.CR2`\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n```\r\nApache Maven 3.8.7 (b89d5959fcde851dcb1c8946a785a163f14e1e29)\r\nMaven home: /home/marco/.m2/wrapper/dists/apache-maven-3.8.7-bin/678cc9d4/apache-maven-3.8.7\r\nJava version: 17.0.5, vendor: Eclipse Adoptium, runtime: /opt/java/mandrel/22.3.0.1-java17\r\nDefault locale: en_US, platform encoding: UTF-8\r\nOS name: \"linux\", version: \"5.15.0-52-generic\", arch: \"amd64\", family: \"unix\"\r\n```\r\n\r\n### Additional information\r\n\r\n- The errors disappear when we `export QUARKUS_VERTX_EVENT_LOOPS_POOL_SIZE=1` \r\n- The issue is similar to #23324, but in the case presented, no emitter is involved\r\n- The code for quarkus 3 is on [branch `quarkus-3` (`github.com`)](https://github.com/turing85/quarkus-reactive-stress-test/tree/quarkus-3)\r\n- The behaviour is also observabiel when the app is compiled natively, for both `2.x` and `3.x`\r\n- [Relevant `quarkusio.zupipchat.com` discussion](https://quarkusio.zulipchat.com/#narrow/stream/187038-dev/topic/problems.20with.20reactive.20panache.20under.20load)",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32533/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32533/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
