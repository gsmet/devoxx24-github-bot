{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/36973",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36973/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36973/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36973/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/36973",
  "id": 1985345594,
  "node_id": "I_kwDOCFbutM52Vfg6",
  "number": 36973,
  "title": "Azure Functions Http: corrupted request body",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1676631606,
      "node_id": "MDU6TGFiZWwxNjc2NjMxNjA2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/windows",
      "name": "env/windows",
      "color": "edea47",
      "default": false,
      "description": "Impacts Windows machines"
    },
    {
      "id": 5477822570,
      "node_id": "LA_kwDOCFbutM8AAAABRoDwag",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/azure-functions",
      "name": "area/azure-functions",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/328",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/328",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/328/labels",
    "id": 11051630,
    "node_id": "MI_kwDOCFbutM4AqKJu",
    "number": 328,
    "title": "3.8.5",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 112,
    "state": "closed",
    "created_at": "2024-05-14T13:22:35Z",
    "updated_at": "2024-06-05T11:10:12Z",
    "due_on": null,
    "closed_at": "2024-06-05T11:10:12Z"
  },
  "comments": 4,
  "created_at": "2023-11-09T10:42:30Z",
  "updated_at": "2024-05-22T13:52:02Z",
  "closed_at": "2024-05-17T15:52:20Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nUsing the `quarkus-azure-functions-http` extension it is possible that the http request body can be corrupted by using the wrong charset. This problem does not seem to appear when using the function in Azure on a consumption plan (Y1) but rather when using a premium plan (e.g. P1v3), both Linux.\r\nWe are not sure how consistent this can be reproduced but we have been observing this every time now when we switched between the two plans for troubleshooting. \r\n\r\nThe problem seems to originate from the fact that Azure (for whatever reason) uses a [string for the payload instead of a byte[]](https://github.com/quarkusio/quarkus/blob/7f5029944a47906715a32addac682435147c7f5e/extensions/azure-functions-http/runtime/src/main/java/io/quarkus/azure/functions/resteasy/runtime/Function.java#L21C132-L21C138). This is \"fixed\" by Quarkus by [calling `getBytes` on it](https://github.com/quarkusio/quarkus/blob/7f5029944a47906715a32addac682435147c7f5e/extensions/azure-functions-http/runtime/src/main/java/io/quarkus/azure/functions/resteasy/runtime/BaseFunction.java#L65) which uses the default charset.\r\n\r\nThe problem now is that if the payload was e.g. a json in `utf-8` before, the payload now could be in e.g `windows-1252` which results in the corrupted body in JAX-RS resources.\r\n\r\nI am not sure what the correct solution is. If Microsoft could provide a byte[] directly, there would not be any problem in the first place. The correct charset as far as I understand, would be to always use utf-8, because the java worker internally gets the request via a grpc string, which uses Protobuf, [where strings are always valid in utf-8](https://protobuf.dev/programming-guides/proto3/#scalar) (if I researched and understood everything correctly).\r\n\r\n\n\n### Expected behavior\n\nThe payload of a http request is read correctly, regardless on which AppServicePlan the Quarkus function is executed.\n\n### Actual behavior\n\nThe payload is corrupted which results in e.g. `Ä`, `Ü` and `Ö` being replaced by `?`, depending on which AppServicePlan the Quarkus function is executed.\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n17\n\n### Quarkus version or git rev\n\n3.4.3\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.8 (4c87b05d9aedce574290d1acc98575ed5eb6cd39)\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/36973/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36973/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
