{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33072",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33072/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33072/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33072/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/33072",
  "id": 1693093438,
  "node_id": "I_kwDOCFbutM5k6o4-",
  "number": 33072,
  "title": " Quarkus Native on(GraalVM) issue with ElasticSearch Java Client: No deserializer found in 'co.elastic.clients.elasticsearch.core.UpdateByQueryRequest._DESERIALIZER'",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2222769329,
      "node_id": "MDU6TGFiZWwyMjIyNzY5MzI5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/elasticsearch",
      "name": "area/elasticsearch",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 2260340367,
      "node_id": "MDU6TGFiZWwyMjYwMzQwMzY3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/mandrel",
      "name": "area/mandrel",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/253",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/253",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/253/labels",
    "id": 9468628,
    "node_id": "MI_kwDOCFbutM4AkHrU",
    "number": 253,
    "title": "3.1.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 83,
    "state": "closed",
    "created_at": "2023-05-31T16:27:01Z",
    "updated_at": "2023-06-28T14:05:39Z",
    "due_on": null,
    "closed_at": "2023-06-07T11:17:31Z"
  },
  "comments": 3,
  "created_at": "2023-05-02T21:00:03Z",
  "updated_at": "2023-05-31T16:31:15Z",
  "closed_at": "2023-05-31T16:24:33Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nUsing `Quarkus 3.0.1.Final` with `ElasticSearch 8.7`.  I've written a small piece of code to use ES's `update_by_query` feature:\r\n```\r\ntry (Reader query = new StringReader(/*my json query String*/)) {\r\n  var request = UpdateByQueryRequest.of(fn -> fn.index(index).withJson(query));\r\n\r\n  return client.updateByQuery(request);\r\n} catch (IOException e) {\r\n  throw new RuntimeException(e);\r\n}\r\n```\r\nThis actually works fine in normal jvm mode. However whenever I'm trying to run this is Quarkus Native(GraalVM) mode I'm getting Deserialization error.\r\n\r\nUsing Maven as the build tool and this is my dependencies:\r\n```\r\n\t<dependencies>\r\n\t\t<dependency>\r\n\t\t\t<groupId>io.quarkus</groupId>\r\n\t\t\t<artifactId>quarkus-arc</artifactId>\r\n\t\t</dependency>\r\n\t\t<dependency>\r\n\t\t\t<groupId>io.quarkus</groupId>\r\n\t\t\t<artifactId>quarkus-resteasy-reactive</artifactId>\r\n\t\t</dependency>\r\n\t\t<dependency>\r\n\t\t\t<groupId>io.quarkus</groupId>\r\n\t\t\t<artifactId>quarkus-resteasy-reactive-jackson</artifactId>\r\n\t\t</dependency>\r\n\t\t<dependency>\r\n\t\t\t<groupId>io.quarkus</groupId>\r\n\t\t\t<artifactId>quarkus-elasticsearch-java-client</artifactId>\r\n\t\t</dependency>\r\n\t</dependencies>\r\n```\n\n### Expected behavior\n\nIn Quarkus native mode the ElasticSearch java client should work just like JVM mode\n\n### Actual behavior\n\nGetting this error:\r\n```\r\nERROR [com.mab.cha.con.exc.ServerExceptionHandler] (vert.x-eventloop-thread-1) Unhandled error: java.lang.RuntimeException: No deserializer found in 'co.elastic.clients.elasticsearch.core.UpdateByQueryRequest._DESERIALIZER'\r\n\tat co.elastic.clients.json.JsonpMapperBase.findDeserializer(JsonpMapperBase.java:92)\r\n\tat co.elastic.clients.json.JsonpMapperBase.findDeserializer(JsonpMapperBase.java:78)\r\n\tat co.elastic.clients.util.WithJsonObjectBuilderBase.withJson(WithJsonObjectBuilderBase.java:44)\r\n\tat co.elastic.clients.json.WithJson.withJson(WithJson.java:57)\r\n\tat com.mabsisa.chalona.client.EsClient.lambda$0(EsClient.java:66)\r\n\tat co.elastic.clients.elasticsearch.core.UpdateByQueryRequest.of(UpdateByQueryRequest.java:212)\r\n\tat com.mabsisa.chalona.client.EsClient.updateByQuery(EsClient.java:66)\r\n\tat com.mabsisa.chalona.client.EsClient_Subclass.updateByQuery$$superforward(Unknown Source)\r\n\tat com.mabsisa.chalona.client.EsClient_Subclass$$function$$1.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:74)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:63)\r\n\tat io.smallrye.faulttolerance.FaultToleranceInterceptor.lambda$syncFlow$3(FaultToleranceInterceptor.java:257)\r\n\tat io.smallrye.faulttolerance.core.InvocationContext.call(InvocationContext.java:20)\r\n\tat io.smallrye.faulttolerance.core.Invocation.apply(Invocation.java:29)\r\n\tat io.smallrye.faulttolerance.core.retry.Retry.doApply(Retry.java:88)\r\n\tat io.smallrye.faulttolerance.core.retry.Retry.apply(Retry.java:42)\r\n\tat io.smallrye.faulttolerance.FaultToleranceInterceptor.syncFlow(FaultToleranceInterceptor.java:259)\r\n\tat io.smallrye.faulttolerance.FaultToleranceInterceptor.intercept(FaultToleranceInterceptor.java:186)\r\n\tat io.smallrye.faulttolerance.FaultToleranceInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n\tat com.mabsisa.chalona.client.EsClient_Subclass.updateByQuery(Unknown Source)\r\n\tat com.mabsisa.chalona.client.EsClient.updateByQuery(EsClient.java:77)\r\n\tat com.mabsisa.chalona.service.ProfileService.updateAboutMe(ProfileService.java:43)\r\n\tat com.mabsisa.chalona.routes.ProfileRoute.sync(ProfileRoute.java:43)\r\n\tat com.mabsisa.chalona.routes.ProfileRoute_Subclass.sync$$superforward(Unknown Source)\r\n\tat com.mabsisa.chalona.routes.ProfileRoute_Subclass$$function$$1.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:74)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:63)\r\n\tat io.quarkus.hibernate.validator.runtime.interceptor.AbstractMethodValidationInterceptor.validateMethodInvocation(AbstractMethodValidationInterceptor.java:71)\r\n\tat io.quarkus.hibernate.validator.runtime.jaxrs.ResteasyReactiveEndPointValidationInterceptor.validateMethodInvocation(ResteasyReactiveEndPointValidationInterceptor.java:21)\r\n\tat io.quarkus.hibernate.validator.runtime.jaxrs.ResteasyReactiveEndPointValidationInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n\tat com.mabsisa.chalona.routes.ProfileRoute_Subclass.sync(Unknown Source)\r\n\tat com.mabsisa.chalona.routes.ProfileRoute_ClientProxy.sync(Unknown Source)\r\n\tat com.mabsisa.chalona.routes.ProfileRoute$quarkusrestinvoker$sync_793ca314ec66d88518392f861de2144da4c4cb8f.invoke(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n\tat io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:141)\r\n\tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:145)\r\n\tat org.jboss.resteasy.reactive.server.vertx.VertxResteasyReactiveRequestContext$1$1.handle(VertxResteasyReactiveRequestContext.java:78)\r\n\tat org.jboss.resteasy.reactive.server.vertx.VertxResteasyReactiveRequestContext$1$1.handle(VertxResteasyReactiveRequestContext.java:75)\r\n\tat io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:264)\r\n\tat io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:246)\r\n\tat io.vertx.core.impl.EventLoopContext.lambda$runOnContext$0(EventLoopContext.java:43)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:566)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base@17.0.7/java.lang.Thread.run(Thread.java:833)\r\n\tat org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:775)\r\n\tat org.graalvm.nativeimage.builder/com.oracle.svm.core.posix.thread.PosixPlatformThreads.pthreadStartRoutine(PosixPlatformThreads.java:203)\r\n```\n\n### How to Reproduce?\n\n1. Use quarkus.platform.version `3.0.1.Final`\r\n2. Add  `quarkus-elasticsearch-java-client` extension\r\n3. Inject the ElasticsearchAsyncClient bean\r\n```\r\n@Inject\r\nElasticsearchAsyncClient client;\r\n```\r\n4. Call any search operation using this client with the `withJson` method. For example:\r\n```\r\ntry (Reader query = new StringReader(/*my json query String*/)) {\r\n  var request = UpdateByQueryRequest.of(fn -> fn.index(index).withJson(query));\r\n\r\n  return client.updateByQuery(request);\r\n} catch (IOException e) {\r\n  throw new RuntimeException(e);\r\n}\r\n```\r\n5. This should raise this exception: `ERROR [com.mab.cha.con.exc.ServerExceptionHandler] (vert.x-eventloop-thread-1) Unhandled error: java.lang.RuntimeException: No deserializer found in 'co.elastic.clients.elasticsearch.core.UpdateByQueryRequest._DESERIALIZER'`\r\n\n\n### Output of `uname -a` or `ver`\n\nquay.io/quarkus/ubi-quarkus-mandrel-builder-image:22.3-java17\n\n### Output of `java -version`\n\nopenjdk 17.0.6 2023-01-17\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n3.0.1.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.8\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/33072/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/33072/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
