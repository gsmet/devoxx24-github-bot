{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27326",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27326/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27326/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27326/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/27326",
  "id": 1341338027,
  "node_id": "I_kwDOCFbutM5P8zGr",
  "number": 27326,
  "title": "MongoDB panache generates invalid update documents when updating a list or array with HQL",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026134,
      "node_id": "MDU6TGFiZWwxMjczMDI2MTM0",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/panache",
      "name": "area/panache",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1470336085,
      "node_id": "MDU6TGFiZWwxNDcwMzM2MDg1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/mongodb",
      "name": "area/mongodb",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/345",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/345",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/345/labels",
    "id": 11440331,
    "node_id": "MI_kwDOCFbutM4ArpDL",
    "number": 345,
    "title": "3.16 - main",
    "description": "",
    "creator": {
      "login": "quarkusbot",
      "id": 61254497,
      "node_id": "MDQ6VXNlcjYxMjU0NDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/61254497?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/quarkusbot",
      "html_url": "https://github.com/quarkusbot",
      "followers_url": "https://api.github.com/users/quarkusbot/followers",
      "following_url": "https://api.github.com/users/quarkusbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/quarkusbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/quarkusbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/quarkusbot/subscriptions",
      "organizations_url": "https://api.github.com/users/quarkusbot/orgs",
      "repos_url": "https://api.github.com/users/quarkusbot/repos",
      "events_url": "https://api.github.com/users/quarkusbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/quarkusbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 110,
    "state": "open",
    "created_at": "2024-08-14T07:55:40Z",
    "updated_at": "2024-09-02T12:40:31Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 6,
  "created_at": "2022-08-17T07:55:05Z",
  "updated_at": "2024-08-22T12:50:16Z",
  "closed_at": "2024-08-22T12:50:13Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen using the `update` method on a MongoDB panache entity with an HQL-like update description and a list or array parameter, the update fails, because an invalid update document is created.\r\n\r\n### Expected behavior\r\n\r\nArrays or lists of primitives can be updated using HQL or a proper exception is thrown in case this is not supported.\r\n\r\n### Actual behavior\r\n\r\nThe update fails with\r\n\r\n```\r\n2022-08-17 09:49:26,619 ERROR [org.jbo.res.rea.com.cor.AbstractResteasyReactiveContext] (executor-thread-0) Request failed: org.bson.json.JsonParseException: JSON reader was expecting ':' but found '}'.\r\n\tat org.bson.json.JsonReader.readBsonType(JsonReader.java:151)\r\n\tat org.bson.codecs.DocumentCodec.decode(DocumentCodec.java:178)\r\n\tat org.bson.codecs.DocumentCodec.decode(DocumentCodec.java:44)\r\n\tat org.bson.internal.LazyCodec.decode(LazyCodec.java:48)\r\n\tat org.bson.codecs.ContainerCodecHelper.readValue(ContainerCodecHelper.java:61)\r\n\tat org.bson.codecs.DocumentCodec.decode(DocumentCodec.java:180)\r\n\tat org.bson.codecs.DocumentCodec.decode(DocumentCodec.java:44)\r\n\tat org.bson.Document.parse(Document.java:127)\r\n\tat org.bson.Document.parse(Document.java:112)\r\n\tat io.quarkus.mongodb.panache.common.runtime.MongoOperations.executeUpdate(MongoOperations.java:762)\r\n\tat io.quarkus.mongodb.panache.common.runtime.MongoOperations.update(MongoOperations.java:753)\r\n\tat org.acme.TestEntity.update(TestEntity.java)\r\n\tat org.acme.GreetingResource.hello(GreetingResource.java:24)\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nReproduder: https://github.com/languitar/quarkus-mongodb-panache-update-list-reproducer\r\n\r\n1. start the project in dev mode\r\n2. `curl -v http://localhost:8080/hello`\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n_No response_\r\n\r\n### Output of `java -version`\r\n\r\n_No response_\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.11.2.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nCurrently, if the list with the new values to set in the update operation contains only one element, the data in the database will be switched from an array to string, consequently breaking any further reads using the POJO.\r\n\r\nAll this happens, because `PanacheQlQueryBinder` expands a list into multiple comma-separated tokens, omitting the surrounding array square brackets:\r\n\r\n```java\r\nPanacheQlQueryBinder.bindQuery(clazz, \"list = ?1\", new Object[] {Arrays.asList(\"test\", \"foo\")})\r\n```\r\n\r\nresults in:\r\n\r\n```\r\n{'list':'test', 'foo'}\r\n```",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27326/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27326/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
