{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/36446",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36446/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36446/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36446/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/36446",
  "id": 1939989092,
  "node_id": "I_kwDOCFbutM5zoeJk",
  "number": 36446,
  "title": "Regression: Liquibase fails to migrate on Quarkus start, crashing the application",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1341157944,
      "node_id": "MDU6TGFiZWwxMzQxMTU3OTQ0",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/upstream",
      "name": "triage/upstream",
      "color": "7db4d8",
      "default": false,
      "description": "Used for issues which are caused by issues in upstream projects/dependency"
    },
    {
      "id": 1956491735,
      "node_id": "MDU6TGFiZWwxOTU2NDkxNzM1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/liquibase",
      "name": "area/liquibase",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/283",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/283",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/283/labels",
    "id": 10061188,
    "node_id": "MI_kwDOCFbutM4AmYWE",
    "number": 283,
    "title": "3.5.0",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 34,
    "state": "closed",
    "created_at": "2023-10-17T15:15:06Z",
    "updated_at": "2023-11-02T12:52:54Z",
    "due_on": null,
    "closed_at": "2023-10-18T14:31:42Z"
  },
  "comments": 7,
  "created_at": "2023-10-12T13:18:57Z",
  "updated_at": "2023-10-22T08:28:38Z",
  "closed_at": "2023-10-18T07:20:31Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nAn application using Liquibase to set up the database or to migrate it when starting up crashes because of a Liquibase problem â€“ looks like Liquibase tries to re-create its own changelog tables and fails.\r\n\r\nThe behaviour appeared after upgrading Quarkus, last working version was 3.3.3, upgrading to 3.4.x starts the issue to appear.\n\n### Expected behavior\n\nThe application should behave like it did before upgrading Quarkus.\n\n### Actual behavior\n\nThe application, when starting, terminates with such a stack trace:\r\n\r\n```\r\n__  ____  __  _____   ___  __ ____  ______\r\n --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/\r\n -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\\ \\\r\n--\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/\r\n2023-10-12 13:56:40,203 INFO  [liq.database] (main) Set default schema name to PUBLIC\r\n2023-10-12 13:56:40,303 INFO  [liq.lockservice] (main) Successfully acquired change log lock\r\n2023-10-12 13:56:40,542 INFO  [liq.changelog] (main) Creating database history table with name: PUBLIC.changelog\r\n2023-10-12 13:56:40,549 INFO  [liq.changelog] (main) Reading from PUBLIC.changelog\r\nNo validation errors found.\r\n2023-10-12 13:56:40,555 INFO  [liq.command] (main) Command execution complete\r\n2023-10-12 13:56:40,582 INFO  [liq.changelog] (main) Creating database history table with name: PUBLIC.changelog\r\n2023-10-12 13:56:40,584 INFO  [liq.command] (main) Command execution complete\r\n2023-10-12 13:56:40,586 INFO  [liq.lockservice] (main) Successfully released change log lock\r\n2023-10-12 13:56:40,639 ERROR [io.qua.run.Application] (main) Failed to start application (with profile [prod]): java.lang.RuntimeException: Failed to start quarkus\r\n        at io.quarkus.runner.ApplicationImpl.doStart(Unknown Source)\r\n        at io.quarkus.runtime.Application.start(Application.java:101)\r\n        at io.quarkus.runtime.ApplicationLifecycleManager.run(ApplicationLifecycleManager.java:111)\r\n        at io.quarkus.runtime.Quarkus.run(Quarkus.java:71)\r\n        at io.quarkus.runtime.Quarkus.run(Quarkus.java:44)\r\n        at io.quarkus.runtime.Quarkus.run(Quarkus.java:124)\r\n        at io.quarkus.runner.GeneratedMain.main(Unknown Source)\r\n        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n        at io.quarkus.bootstrap.runner.QuarkusEntryPoint.doRun(QuarkusEntryPoint.java:61)\r\n        at io.quarkus.bootstrap.runner.QuarkusEntryPoint.main(QuarkusEntryPoint.java:32)\r\nCaused by: java.lang.IllegalStateException: Error starting Liquibase\r\n        at io.quarkus.liquibase.runtime.LiquibaseRecorder.doStartActions(LiquibaseRecorder.java:88)\r\n        at io.quarkus.deployment.steps.LiquibaseProcessor$startLiquibase1744275855.deploy_0(Unknown Source)\r\n        at io.quarkus.deployment.steps.LiquibaseProcessor$startLiquibase1744275855.deploy(Unknown Source)\r\n        ... 11 more\r\nCaused by: liquibase.exception.CommandExecutionException: liquibase.exception.DatabaseException: liquibase.exception.DatabaseException: Table \"CHANGELOG\" already exists; SQL statement:\r\nCREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10)) [42101-220] [Failed SQL: (42101) CREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10))]\r\n        at liquibase.command.CommandScope.execute(CommandScope.java:236)\r\n        at liquibase.Liquibase.lambda$update$0(Liquibase.java:223)\r\n        at liquibase.Scope.lambda$child$0(Scope.java:197)\r\n        at liquibase.Scope.child(Scope.java:206)\r\n        at liquibase.Scope.child(Scope.java:196)\r\n        at liquibase.Scope.child(Scope.java:175)\r\n        at liquibase.Liquibase.runInScope(Liquibase.java:1361)\r\n        at liquibase.Liquibase.update(Liquibase.java:215)\r\n        at liquibase.Liquibase.update(Liquibase.java:197)\r\n        at io.quarkus.liquibase.runtime.LiquibaseRecorder.doStartActions(LiquibaseRecorder.java:77)\r\n        ... 13 more\r\nCaused by: liquibase.exception.DatabaseException: liquibase.exception.DatabaseException: Table \"CHANGELOG\" already exists; SQL statement:\r\nCREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10)) [42101-220] [Failed SQL: (42101) CREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10))]\r\n        at liquibase.executor.jvm.ChangelogJdbcMdcListener.execute(ChangelogJdbcMdcListener.java:39)\r\n        at liquibase.changelog.StandardChangeLogHistoryService.init(StandardChangeLogHistoryService.java:277)\r\n        at liquibase.command.core.helpers.DatabaseChangelogCommandStep.checkLiquibaseTables(DatabaseChangelogCommandStep.java:127)\r\n        at liquibase.command.core.helpers.DatabaseChangelogCommandStep.run(DatabaseChangelogCommandStep.java:94)\r\n        at liquibase.command.CommandScope.execute(CommandScope.java:213)\r\n        ... 22 more\r\nCaused by: liquibase.exception.DatabaseException: Table \"CHANGELOG\" already exists; SQL statement:\r\nCREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10)) [42101-220] [Failed SQL: (42101) CREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10))]\r\n        at liquibase.executor.jvm.JdbcExecutor$ExecuteStatementCallback.doInStatement(JdbcExecutor.java:467)\r\n        at liquibase.executor.jvm.JdbcExecutor.execute(JdbcExecutor.java:77)\r\n        at liquibase.executor.jvm.JdbcExecutor.execute(JdbcExecutor.java:180)\r\n        at liquibase.executor.jvm.JdbcExecutor.execute(JdbcExecutor.java:145)\r\n        at liquibase.changelog.StandardChangeLogHistoryService.lambda$init$2(StandardChangeLogHistoryService.java:277)\r\n        at liquibase.executor.jvm.ChangelogJdbcMdcListener.lambda$execute$0(ChangelogJdbcMdcListener.java:33)\r\n        at liquibase.Scope.lambda$child$0(Scope.java:197)\r\n        at liquibase.Scope.child(Scope.java:206)\r\n        at liquibase.Scope.child(Scope.java:196)\r\n        at liquibase.Scope.child(Scope.java:175)\r\n        at liquibase.executor.jvm.ChangelogJdbcMdcListener.execute(ChangelogJdbcMdcListener.java:32)\r\n        ... 26 more\r\nCaused by: org.h2.jdbc.JdbcSQLSyntaxErrorException: Table \"CHANGELOG\" already exists; SQL statement:\r\nCREATE TABLE PUBLIC.changelog (ID VARCHAR(255) NOT NULL, AUTHOR VARCHAR(255) NOT NULL, FILENAME VARCHAR(255) NOT NULL, DATEEXECUTED TIMESTAMP NOT NULL, ORDEREXECUTED INT NOT NULL, EXECTYPE VARCHAR(10) NOT NULL, MD5SUM VARCHAR(35), DESCRIPTION VARCHAR(255), COMMENTS VARCHAR(255), TAG VARCHAR(255), LIQUIBASE VARCHAR(20), CONTEXTS VARCHAR(255), LABELS VARCHAR(255), DEPLOYMENT_ID VARCHAR(10)) [42101-220]\r\n        at org.h2.message.DbException.getJdbcSQLException(DbException.java:514)\r\n        at org.h2.message.DbException.getJdbcSQLException(DbException.java:489)\r\n        at org.h2.message.DbException.get(DbException.java:223)\r\n        at org.h2.message.DbException.get(DbException.java:199)\r\n        at org.h2.command.ddl.CreateTable.update(CreateTable.java:91)\r\n        at org.h2.command.CommandContainer.update(CommandContainer.java:169)\r\n        at org.h2.command.Command.executeUpdate(Command.java:252)\r\n        at org.h2.jdbc.JdbcStatement.executeInternal(JdbcStatement.java:252)\r\n        at org.h2.jdbc.JdbcStatement.execute(JdbcStatement.java:223)\r\n        at io.agroal.pool.wrapper.StatementWrapper.execute(StatementWrapper.java:235)\r\n        at liquibase.executor.jvm.JdbcExecutor$ExecuteStatementCallback.doInStatement(JdbcExecutor.java:461)\r\n        ... 36 more\r\n```\r\n\n\n### How to Reproduce?\n\nReproducer in the form of a Maven project: [liquibase-issue.zip](https://github.com/quarkusio/quarkus/files/12882830/liquibase-issue.zip)\r\n\r\n1. Build and run the attached reproducer: it uses Quarkus 3.3.3 and it should start without any issue.\r\n2. Change the `quarkus.version` property in the `pom.xml` to `3.4.2` (currently the latest Quarkus release).\r\n3. Rebuild and re-run the reproducer. It should terminate with a stack trace as the one above.\r\n\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\nopenjdk version \"21\" 2023-09-19\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n3.4.2\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.9.4 (dfbb324ad4a7c8fb0bf182e6d91b0ae20e3d2dd9)\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/36446/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/36446/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
