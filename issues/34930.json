{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/34930",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34930/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34930/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34930/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/34930",
  "id": 1816609274,
  "node_id": "I_kwDOCFbutM5sR0H6",
  "number": 34930,
  "title": "Bug when using quarkus-infinispan-client and quarkus-scheduler together",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1282122953,
      "node_id": "MDU6TGFiZWwxMjgyMTIyOTUz",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/infinispan",
      "name": "area/infinispan",
      "color": "0366d6",
      "default": false,
      "description": "Infinispan"
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 6,
  "created_at": "2023-07-22T04:45:21Z",
  "updated_at": "2023-07-31T11:18:31Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nIt looks like there is a bug when using quarkus-infinispan-client and quarkus-scheduler together.\r\nThis bug only appears if the Infinispan client is running in a docker environment. If the Infinispan client is running outside of docker, then everything works fine.\r\nTo reproduce the error, I took the [infinispan-client-quickstart](https://github.com/quarkusio/quarkus-quickstarts/tree/main/infinispan-client-quickstart) project as a basis.\r\n\r\n### Expected behavior\r\n\r\nThe normal behavior of a quarkus application with \"quarkus-infnispan-client\" and \"quarkus-scheduler\" running in a docker environment is expected to be the same as if it were launched without docker.\r\n\r\n### Actual behavior\r\n\r\nThis is the  stack trace snippet after running docker-compose:\r\n```shell\r\nclient      | 2023-07-22 04:00:00,324 ERROR [org.inf.HOTROD] (HotRod-client-async-pool-2-12) ISPN004007: Exception encountered. Retry 10 out of 10: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /172.25.0.4:11222\r\nclient      | Caused by: java.net.ConnectException: Connection refused\r\nclient      |   at java.base/sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\r\nclient      |   at java.base/sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:777)\r\nclient      |   at io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:337)\r\nclient      |   at io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:334)\r\nclient      |   at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:776)\r\nclient      |   at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:689)\r\nclient      |   at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:652)\r\nclient      |   at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562)\r\nclient      |   at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\nclient      |   at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\nclient      |   at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\nclient      |   at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\nclient      |   at java.base/java.lang.Thread.run(Thread.java:829)\r\nclient      | \r\nclient      | 2023-07-22 04:00:00,326 ERROR [io.qua.sch.com.run.StatusEmitterInvoker] (executor-thread-1) Error occurred while executing task for trigger IntervalTrigger [id=1_org.acme.infinispan.client.Schedulator#run, interval=10000]: java.util.concurrent.CompletionException: java.lang.RuntimeException: Error injecting org.infinispan.client.hotrod.RemoteCache<java.lang.String, org.acme.infinispan.client.Greeting> org.acme.infinispan.client.Schedulator.cache\r\nclient      |   at java.base/java.util.concurrent.CompletableFuture.encodeThrowable(CompletableFuture.java:331)\r\nclient      |   at java.base/java.util.concurrent.CompletableFuture.completeThrowable(CompletableFuture.java:346)\r\nclient      |   at java.base/java.util.concurrent.CompletableFuture.uniWhenComplete(CompletableFuture.java:870)\r\nclient      |   at java.base/java.util.concurrent.CompletableFuture.uniWhenCompleteStage(CompletableFuture.java:883)\r\nclient      |   at java.base/java.util.concurrent.CompletableFuture.whenComplete(CompletableFuture.java:2251)\r\nclient      |   at java.base/java.util.concurrent.CompletableFuture$MinimalStage.whenComplete(CompletableFuture.java:2820)\r\nclient      |   at io.quarkus.scheduler.common.runtime.DefaultInvoker.invoke(DefaultInvoker.java:24)\r\nclient      |   at io.quarkus.scheduler.common.runtime.StatusEmitterInvoker.invoke(StatusEmitterInvoker.java:35)\r\nclient      |   at io.quarkus.scheduler.runtime.SimpleScheduler$ScheduledTask.doInvoke(SimpleScheduler.java:416)\r\nclient      |   at io.quarkus.scheduler.runtime.SimpleScheduler$ScheduledTask$1.handle(SimpleScheduler.java:397)\r\nclient      |   at io.quarkus.scheduler.runtime.SimpleScheduler$ScheduledTask$1.handle(SimpleScheduler.java:393)\r\nclient      |   at io.vertx.core.impl.ContextBase.lambda$null$0(ContextBase.java:137)\r\nclient      |   at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:264)\r\nclient      |   at io.vertx.core.impl.ContextBase.lambda$executeBlocking$1(ContextBase.java:135)\r\nclient      |   at io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:581)\r\nclient      |   at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\r\nclient      |   at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\r\nclient      |   at org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\nclient      |   at org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\nclient      |   at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\nclient      |   at java.base/java.lang.Thread.run(Thread.java:829)\r\nclient      | Caused by: java.lang.RuntimeException: Error injecting org.infinispan.client.hotrod.RemoteCache<java.lang.String, org.acme.infinispan.client.Greeting> org.acme.infinispan.client.Schedulator.cache\r\nclient      |   at org.acme.infinispan.client.Schedulator_Bean.doCreate(Unknown Source)\r\nclient      |   at org.acme.infinispan.client.Schedulator_Bean.create(Unknown Source)\r\nclient      |   at org.acme.infinispan.client.Schedulator_Bean.create(Unknown Source)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:113)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:37)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:34)\r\nclient      |   at io.quarkus.arc.impl.LazyValue.get(LazyValue.java:26)\r\nclient      |   at io.quarkus.arc.impl.ComputingCache.computeIfAbsent(ComputingCache.java:69)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:34)\r\nclient      |   at io.quarkus.arc.impl.ClientProxies.getApplicationScopedDelegate(ClientProxies.java:21)\r\nclient      |   at org.acme.infinispan.client.Schedulator_ClientProxy.arc$delegate(Unknown Source)\r\nclient      |   at org.acme.infinispan.client.Schedulator_ClientProxy.run(Unknown Source)\r\nclient      |   at org.acme.infinispan.client.Schedulator_ScheduledInvoker_run_72e66771a77415a7284d3ae42331659c186071de.invokeBean(Unknown Source)\r\nclient      |   ... 15 more\r\nclient      | Caused by: jakarta.enterprise.inject.CreationException: Error creating synthetic bean [47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa]: jakarta.enterprise.inject.CreationException: Error creating synthetic bean [ddee68cd3f60c96290f55bc237588d70e5c96aab]: org.infinispan.client.hotrod.exceptions.TransportException:: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /172.25.0.4:11222\r\nclient      |   at org.infinispan.client.hotrod.RemoteCache_47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa_Synthetic_Bean.doCreate(Unknown Source)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCache_47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa_Synthetic_Bean.create(Unknown Source)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCache_47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa_Synthetic_Bean.create(Unknown Source)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:113)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:37)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:34)\r\nclient      |   at io.quarkus.arc.impl.LazyValue.get(LazyValue.java:26)\r\nclient      |   at io.quarkus.arc.impl.ComputingCache.computeIfAbsent(ComputingCache.java:69)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:34)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCache_47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa_Synthetic_Bean.get(Unknown Source)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCache_47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa_Synthetic_Bean.get(Unknown Source)\r\nclient      |   ... 28 more\r\nclient      | Caused by: jakarta.enterprise.inject.CreationException: Error creating synthetic bean [ddee68cd3f60c96290f55bc237588d70e5c96aab]: org.infinispan.client.hotrod.exceptions.TransportException:: io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /172.25.0.4:11222\r\nclient      |   at org.infinispan.client.hotrod.RemoteCacheManager_ddee68cd3f60c96290f55bc237588d70e5c96aab_Synthetic_Bean.doCreate(Unknown Source)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCacheManager_ddee68cd3f60c96290f55bc237588d70e5c96aab_Synthetic_Bean.create(Unknown Source)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCacheManager_ddee68cd3f60c96290f55bc237588d70e5c96aab_Synthetic_Bean.create(Unknown Source)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:113)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:37)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:34)\r\nclient      |   at io.quarkus.arc.impl.LazyValue.get(LazyValue.java:26)\r\nclient      |   at io.quarkus.arc.impl.ComputingCache.computeIfAbsent(ComputingCache.java:69)\r\nclient      |   at io.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:34)\r\nclient      |   at io.quarkus.arc.impl.ClientProxies.getApplicationScopedDelegate(ClientProxies.java:21)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCacheManager_ddee68cd3f60c96290f55bc237588d70e5c96aab_Synthetic_ClientProxy.arc$delegate(Unknown Source)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCacheManager_ddee68cd3f60c96290f55bc237588d70e5c96aab_Synthetic_ClientProxy.getCache(Unknown Source)\r\nclient      |   at io.quarkus.infinispan.client.runtime.InfinispanClientProducer.getRemoteCache(InfinispanClientProducer.java:374)\r\nclient      |   at io.quarkus.infinispan.client.runtime.InfinispanRecorder$3.apply(InfinispanRecorder.java:54)\r\nclient      |   at io.quarkus.infinispan.client.runtime.InfinispanRecorder$3.apply(InfinispanRecorder.java:51)\r\nclient      |   at io.quarkus.infinispan.client.runtime.InfinispanRecorder$InfinispanClientSupplier.get(InfinispanRecorder.java:82)\r\nclient      |   at io.quarkus.arc.runtime.ArcRecorder$4.apply(ArcRecorder.java:129)\r\nclient      |   at io.quarkus.arc.runtime.ArcRecorder$4.apply(ArcRecorder.java:126)\r\nclient      |   at org.infinispan.client.hotrod.RemoteCache_47af2c2b34baea5f4bf1e7f4e2217e68a09e3aaa_Synthetic_Bean.createSynthetic(Unknown Source)\r\nclient      |   ... 39 more\r\n```\r\n\r\n\r\n### How to Reproduce?\r\n\r\n\r\n1. Download sources from GitHub\r\n```shell\r\ngit clone git@github.com:vitaly-masterov/infinispan-client-quickstart.git\r\n```\r\n2. Change to the project directory\r\n```shell\r\ncd infinispan-client-quickstart\r\n```\r\n3. Build maven project:\r\n```shell\r\n./mvnw clean package\r\n```\r\n4. Build docker image\r\n```shell\r\ndocker build --file src/main/docker/Dockerfile.jvm --tag quarkus/infinispan-client .\r\n```\r\n5. Run docker-compose\r\n```shell\r\ndocker-compose up\r\n```\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux calculate 6.1.39-calculate #1 SMP PREEMPT_DYNAMIC Wed Jul 19 21:20:18 UTC 2023 x86_64 AMD Ryzen 5 3600 6-Core Processor AuthenticAMD GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\n11, 17\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n3.2.1.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.6\r\n\r\n### Additional information\r\n\r\nIf I comment out this piece of code, then docker-compose starts without errors\r\n```java\r\n    @Inject\r\n    @Remote(\"mycache\")\r\n    RemoteCache<String, Greeting> cache;\r\n```\r\nand\r\n```java\r\ncache.put(\"hello\", greeting);\r\n```\r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/34930/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34930/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
