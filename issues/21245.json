{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21245",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21245/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21245/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21245/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/21245",
  "id": 1046316250,
  "node_id": "I_kwDOCFbutM4-XYTa",
  "number": 21245,
  "title": "Quarkus Tests with SmallRye Health Extension Sometimes Fail When Run In Parallel",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1283619446,
      "node_id": "MDU6TGFiZWwxMjgzNjE5NDQ2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/smallrye",
      "name": "area/smallrye",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 2236032169,
      "node_id": "MDU6TGFiZWwyMjM2MDMyMTY5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/health",
      "name": "area/health",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/157",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/157",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/157/labels",
    "id": 7320620,
    "node_id": "MI_kwDOCFbutM4Ab7Qs",
    "number": 157,
    "title": "2.4.2.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 40,
    "state": "closed",
    "created_at": "2021-11-03T11:17:28Z",
    "updated_at": "2021-11-25T07:41:47Z",
    "due_on": null,
    "closed_at": "2021-11-12T08:45:43Z"
  },
  "comments": 3,
  "created_at": "2021-11-06T00:03:03Z",
  "updated_at": "2021-11-11T13:35:36Z",
  "closed_at": "2021-11-08T18:03:58Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nAfter adding extension `io.quarkus:quarkus-smallrye-health` running multiple tests in parallel sometimes causes `NoSuchFileException`.\r\n\r\n```\r\nCaused by: java.nio.file.NoSuchFileException: /var/folders/1z/vlh4t0fj7qx8dldd244qst9w0000gp/T/quarkus/com.example/health-ui-no-such-file/io.smallrye/smallrye-health-ui/3.1.2/healthui.js\r\n\tat java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:92)\r\n\tat java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)\r\n\tat java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116)\r\n\tat java.base/sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:219)\r\n\tat java.base/java.nio.file.Files.newByteChannel(Files.java:371)\r\n\tat java.base/java.nio.file.Files.newByteChannel(Files.java:422)\r\n\tat java.base/java.nio.file.Files.readAllBytes(Files.java:3206)\r\n\tat io.quarkus.smallrye.health.deployment.SmallRyeHealthProcessor.updateApiUrl(SmallRyeHealthProcessor.java:500)\r\n\tat io.quarkus.smallrye.health.deployment.SmallRyeHealthProcessor.registerUiExtension(SmallRyeHealthProcessor.java:436)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat io.quarkus.deployment.ExtensionLoader$2.execute(ExtensionLoader.java:821)\r\n```\r\n\r\nBest I can tell digging through the source, ui resources are being extracted from the `smallrye-health-ui` jar and put into a temporary directory, but that location is not unique per test and is being cleaned prior to extraction, so tests running in parallel can cause already extracted files to be deleted and subsequent errors on read.\r\n\r\nI'm running multiple tests in parallel in gradle with:\r\n\r\n```\r\ntest {\r\n  maxParallelForks = 4\r\n}\r\n```\r\n\r\nThis is still an issue even with the health ui is disabled via `quarkus.smallrye-health.ui.enable = false`\n\n### Expected behavior\n\nTests run in parallel do not fail due to the extension `io.quarkus:quarkus-smallrye-health` being applied.\n\n### Actual behavior\n\nBuild fails with above exception.\n\n### How to Reproduce?\n\n[health-ui-no-such-file.zip](https://github.com/quarkusio/quarkus/files/7489383/health-ui-no-such-file.zip)\r\n\r\nThe above project reproduces the issue pretty consistently for me just running `./gradlew build`\n\n### Output of `uname -a` or `ver`\n\nDarwin WMac5205964 20.6.0 Darwin Kernel Version 20.6.0: Tue Oct 12 18:33:42 PDT 2021; root:xnu-7195.141.8~1/RELEASE_X86_64 x86_64\n\n### Output of `java -version`\n\nopenjdk version \"11.0.11\" 2021-04-20\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.4.1.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nGradle 7.2\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21245/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21245/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
