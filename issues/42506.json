{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42506",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42506/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42506/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42506/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/42506",
  "id": 2463089265,
  "node_id": "I_kwDOCFbutM6Sz8Jx",
  "number": 42506,
  "title": "RSS usage increase between Quarkus 3.11 and 3.13 in MP application in native mode",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273027849,
      "node_id": "MDU6TGFiZWwxMjczMDI3ODQ5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/core",
      "name": "area/core",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1283619446,
      "node_id": "MDU6TGFiZWwxMjgzNjE5NDQ2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/smallrye",
      "name": "area/smallrye",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 2497075451,
      "node_id": "MDU6TGFiZWwyNDk3MDc1NDUx",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/native-image",
      "name": "area/native-image",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/349",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/349",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/349/labels",
    "id": 11519060,
    "node_id": "MI_kwDOCFbutM4Ar8RU",
    "number": 349,
    "title": "3.14.2",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 1,
    "closed_issues": 66,
    "state": "open",
    "created_at": "2024-08-30T16:14:50Z",
    "updated_at": "2024-08-30T16:32:00Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 72,
  "created_at": "2024-08-13T11:17:50Z",
  "updated_at": "2024-08-30T16:28:45Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nAfter recent update from Quarkus 3.11 to 3.13 in QE StartStopTS (https://github.com/quarkus-qe/quarkus-startstop) we noticed RSS usage increase / failures due to threshold hit in native mode for application using MicroProfile / SmallRye extensions.\r\n\r\nI was running my experiments on local Apple MBP M3 Pro, limiting running applications to the minimum, using 21.0.2-graalce. JVM mode runs didn't reveal noticeable difference\r\n\r\nI did checks on more version, but these are the key ones:\r\n```\r\n3.13.2\r\nAVG RSS (kB) without min and max values: 65446\r\n\r\n3.12.3\r\nAVG RSS (kB) without min and max values: 61893\r\n\r\n3.11.3\r\nAVG RSS (kB) without min and max values: 60969\r\n```\r\n\r\nThese numbers are relevant to my system, you may see slightly different values when running the reproducer steps. But the key thing is that there is trend in increase of RSS usage with the same app after first successful request. The issue manifests in native mode, but imho it's not related to native-image tooling. Just FYI, I notice that RSS was slightly smaller when using Mandrel (23.1.4.r21-mandrel) to build the binary.\r\n\r\nThere is a slight increase between 3.11.3 and 3.12.3, difference between 3.11.3 / 3.12.3 and 3.13.2 is more noticeable, ~ 5-7 %.\r\n\r\nSome details from native-image command:\r\n3.13.2\r\n```\r\n  29.65MB (46.02%) for code area:    51,790 compilation units\r\n  33.88MB (52.58%) for image heap:  377,317 objects and 78 resources\r\n 921.53kB ( 1.40%) for other data\r\n  64.43MB in total\r\n------------------------------------------------------------------------------------------------------------------------\r\nTop 10 origins of code area:                                Top 10 object types in image heap:\r\n  12.10MB java.base                                           10.03MB byte[] for code metadata\r\n   1.86MB quarkus-runner.jar                                   5.29MB byte[] for java.lang.String\r\n   1.81MB c.f.jackson.core.jackson-databind-2.17.2.jar         4.07MB java.lang.Class\r\n   1.34MB svm.jar (Native Image)                               3.49MB java.lang.String\r\n   1.26MB modified-io.vertx.vertx-core-4.5.9.jar               1.39MB com.oracle.svm.core.hub.DynamicHubCompanion\r\n 637.69kB io.netty.netty-buffer-4.1.111.Final.jar           1005.64kB byte[] for general heap data\r\n 589.17kB com.fasterxml.jackson.core.jackson-core-2.17.2.jar 908.41kB byte[] for reflection metadata\r\n 509.34kB io.netty.netty-common-4.1.111.Final.jar            704.97kB java.lang.String[]\r\n 440.35kB io.netty.netty-codec-http-4.1.111.Final.jar        597.46kB c.o.svm.core.hub.DynamicHub$ReflectionMetadata\r\n 401.02kB io.netty.netty-transport-4.1.111.Final.jar         510.38kB java.util.HashMap$Node\r\n   8.47MB for 148 more packages                                5.97MB for 4166 more object types\r\n```\r\n\r\n3.12.3\r\n```\r\n  29.33MB (45.84%) for code area:    51,075 compilation units\r\n  33.77MB (52.77%) for image heap:  374,656 objects and 76 resources\r\n 910.64kB ( 1.39%) for other data\r\n  63.99MB in total\r\n------------------------------------------------------------------------------------------------------------------------\r\nTop 10 origins of code area:                                Top 10 object types in image heap:\r\n  12.09MB java.base                                            9.93MB byte[] for code metadata\r\n   1.81MB c.f.jackson.core.jackson-databind-2.17.2.jar         5.25MB byte[] for java.lang.String\r\n   1.73MB quarkus-runner.jar                                   4.02MB java.lang.Class\r\n   1.41MB svm.jar (Native Image)                               3.47MB java.lang.String\r\n   1.25MB modified-io.vertx.vertx-core-4.5.7.jar               1.37MB com.oracle.svm.core.hub.DynamicHubCompanion\r\n 589.17kB com.fasterxml.jackson.core.jackson-core-2.17.2.jar1002.65kB byte[] for general heap data\r\n 588.80kB io.netty.netty-buffer-4.1.108.Final.jar            896.98kB byte[] for reflection metadata\r\n 494.40kB io.netty.netty-common-4.1.108.Final.jar            699.94kB java.lang.String[]\r\n 447.51kB io.netty.netty-codec-http-4.1.108.Final.jar        591.60kB c.o.svm.core.hub.DynamicHub$ReflectionMetadata\r\n 399.07kB io.netty.netty-transport-4.1.108.Final.jar         510.56kB java.util.HashMap$Node\r\n   8.28MB for 147 more packages                                6.12MB for 4139 more object types\r\n```\r\n\r\n3.11.3\r\n```\r\n  29.06MB (45.68%) for code area:    50,844 compilation units\r\n  33.67MB (52.92%) for image heap:  373,003 objects and 76 resources\r\n 912.34kB ( 1.40%) for other data\r\n  63.62MB in total\r\n------------------------------------------------------------------------------------------------------------------------\r\nTop 10 origins of code area:                                Top 10 object types in image heap:\r\n  12.09MB java.base                                            9.84MB byte[] for code metadata\r\n   1.81MB c.f.jackson.core.jackson-databind-2.17.1.jar         5.21MB byte[] for java.lang.String\r\n   1.61MB quarkus-runner.jar                                   4.01MB java.lang.Class\r\n   1.40MB svm.jar (Native Image)                               3.45MB java.lang.String\r\n   1.25MB modified-io.vertx.vertx-core-4.5.7.jar               1.37MB com.oracle.svm.core.hub.DynamicHubCompanion\r\n 589.09kB com.fasterxml.jackson.core.jackson-core-2.17.1.jar1001.41kB byte[] for general heap data\r\n 588.80kB io.netty.netty-buffer-4.1.108.Final.jar            888.38kB byte[] for reflection metadata\r\n 494.98kB io.netty.netty-common-4.1.108.Final.jar            696.34kB java.lang.String[]\r\n 447.51kB io.netty.netty-codec-http-4.1.108.Final.jar        589.49kB c.o.svm.core.hub.DynamicHub$ReflectionMetadata\r\n 399.07kB io.netty.netty-transport-4.1.108.Final.jar         510.19kB java.util.HashMap$Node\r\n   8.16MB for 145 more packages                                6.20MB for 4134 more object types\r\n```\r\n\r\n\r\n\r\n### Expected behavior\r\n\r\nRSS usage stays similar between Quarkus 3.11 and 3.13 in MP application\r\n\r\n### Actual behavior\r\n\r\nRSS usage increase between Quarkus 3.11 and 3.13 in MP application\r\n\r\n### How to Reproduce?\r\n\r\n```\r\ngit clone https://github.com/quarkus-qe/quarkus-startstop\r\ncd quarkus-startstop\r\n\r\nsdk use java 21.0.2-graalce\r\n\r\nmvn clean verify -pl testsuite -Dtest=StartStopTest#fullMicroProfileNative -Dquarkus.version=3.13.2 -Dstart-stop.iterations=25 | grep \"AVG RSS\"\r\nmvn clean verify -pl testsuite -Dtest=StartStopTest#fullMicroProfileNative -Dquarkus.version=3.12.3 -Dstart-stop.iterations=25 | grep \"AVG RSS\"\r\nmvn clean verify -pl testsuite -Dtest=StartStopTest#fullMicroProfileNative -Dquarkus.version=3.11.3 -Dstart-stop.iterations=25 | grep \"AVG RSS\"\r\n```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nmacOS\r\n\r\n### Output of `java -version`\r\n\r\nJava 21\r\n\r\n### Quarkus version or git rev\r\n\r\n3.13.2\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/42506/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/42506/timeline",
  "performed_via_github_app": null,
  "state_reason": "reopened"
}
