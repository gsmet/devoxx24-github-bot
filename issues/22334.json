{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/22334",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22334/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22334/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22334/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/22334",
  "id": 1083638997,
  "node_id": "I_kwDOCFbutM5AlwTV",
  "number": 22334,
  "title": "Optional mapping error with ConfigMapping using Maps with enum keys, Nested Groups and Optional",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273030910,
      "node_id": "MDU6TGFiZWwxMjczMDMwOTEw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/config",
      "name": "area/config",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/161",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/161",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/161/labels",
    "id": 7468359,
    "node_id": "MI_kwDOCFbutM4AcfVH",
    "number": 161,
    "title": "2.7.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 334,
    "state": "closed",
    "created_at": "2021-12-08T07:48:18Z",
    "updated_at": "2022-02-03T19:52:11Z",
    "due_on": null,
    "closed_at": "2022-01-19T12:42:36Z"
  },
  "comments": 5,
  "created_at": "2021-12-17T21:51:15Z",
  "updated_at": "2021-12-23T12:06:24Z",
  "closed_at": "2021-12-23T12:06:21Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI'm seeing an error when mapping configuration to objects using a combination of nested groups (https://quarkus.io/guides/config-mappings#nested-groups), maps (https://quarkus.io/guides/config-mappings#maps) with Enums as key and conditional mapping (https://smallrye.io/docs/smallrye-config/mapping/mapping.html#_optional_config_mapping) that I think is an (obscure) bug.\r\n\r\nThe problem I'm seeing appears to be somewhat related to https://github.com/quarkusio/quarkus/issues/21407, because the same \"key\" used in different part levels of the config hierarchy somehow wreaks havoc. This time the example also involves conditional mapping and using Enums as keys maps.\r\n\r\nFirst I'm giving a short example with some code that is commented out. The test in this example works. \r\n\r\nWhen re-inserting the commented out code, the test in the example fails. (Note that I'm only experiencing the problem when using enums as keys in the map - not with Strings)\r\n\r\nHaving\r\n\r\n```java\r\n@ConfigMapping(prefix = \"clients\", namingStrategy = ConfigMapping.NamingStrategy.VERBATIM)\r\npublic interface ClientsConfiguration {\r\n    enum ClientId { SOS_DAH, NAF }\r\n\r\n    @WithParentName\r\n    Map<ClientId, ClientConfiguration> clients();\r\n\r\n    interface ClientConfiguration {\r\n        Optional<CreatedByProperties> app();\r\n        CreatedByProperties web();\r\n//        MediumProperties medium();\r\n    }\r\n\r\n    interface CreatedByProperties {\r\n        String createdByApplication();\r\n    }\r\n\r\n//    interface MediumProperties {\r\n//        boolean web();\r\n//        @WithDefault(\"false\")\r\n//        boolean app();\r\n//    }\r\n}\r\n```\r\n\r\nand application.properties:\r\n\r\n```\r\nclients.SOS_DAH.web.createdByApplication=RoadrunnerWeb\r\nclients.SOS_DAH.app.createdByApplication=Roadrunner\r\n#clients.SOS_DAH.medium.web=true\r\n#clients.SOS_DAH.medium.app=true\r\n\r\nclients.NAF.web.createdByApplication=RoadrunnerWebNAF\r\n#clients.NAF.medium.web=true\r\n```\r\n\r\nA resource:\r\n```java\r\n@Path(\"/greeting\")\r\npublic class GreetingResource {\r\n    @Inject\r\n    ClientsConfiguration clientsConfiguration;\r\n\r\n    @GET\r\n    @Produces(MediaType.TEXT_PLAIN)\r\n    public String hello() {\r\n        return clientsConfiguration.clients().get(ClientId.SOS_DAH).app().get().createdByApplication();\r\n    }\r\n}\r\n```\r\n\r\nand a test:\r\n\r\n```java\r\n@QuarkusTest\r\npublic class GreetingResourceTest {\r\n    @Inject\r\n    ClientsConfiguration clientsConfiguration;\r\n\r\n    @Test\r\n    public void testHelloEndpoint() {\r\n        given()\r\n                .when().get(\"/greeting\")\r\n                .then()\r\n                .statusCode(200)\r\n                .body(is(\"Roadrunner\"));\r\n    }\r\n}\r\n```\r\n\r\nThe test runs **successfully**.\r\n\r\nWhen re-inserting the commented out code, i.e. removing the // in the ClientsConfiguration interface and the # in the application.properties, the test now fails with:\r\n\r\n```\r\n2021-12-17 21:58:14,428 ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (executor-thread-0) HTTP Request to /greeting failed, error id: dc908705-d552-4525-ab95-f15938f3d64c-1: org.jboss.resteasy.spi.UnhandledException: java.util.NoSuchElementException: No value present\r\n\tat org.jboss.resteasy.core.ExceptionHandler.handleApplicationException(ExceptionHandler.java:105)\r\n<OMITTED>\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: java.util.NoSuchElementException: No value present\r\n\tat java.base/java.util.Optional.get(Optional.java:143)\r\n\tat org.acme.config.GreetingResource.hello(GreetingResource.java:31)\r\n<OMITTED>\r\n\tat org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:492)\r\n\t... 15 more\r\n```\r\n\r\n### Expected behavior\r\n\r\nThe same key used in different part levels of the config hierarchy, should not affect conditional mapping (when using enums).\r\n\r\n### Actual behavior\r\n\r\nThe same key used in different part levels of the config hierarchy affects conditional mapping (when using enums).\r\n\r\n### How to Reproduce?\r\n\r\n1. git clone https://github.com/quarkusio/quarkus-quickstarts/tree/main/config-quickstart\r\n2. cd config-quickstart\r\n3. Add ClientsConfiguration.java and the properties from the \"Describe the error\" section to application.properties\r\n4. Modify GreetingResource.java and GreetingResourceTest.java as per the description above.\r\n5. Run the GreetingResourceTest.java\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nDarwin everythingsruined.local 20.6.0 Darwin Kernel Version 20.6.0: Tue Oct 12 18:33:42 PDT 2021; root:xnu-7195.141.8~1/RELEASE_X86_64 x86_64\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk 17 2021-09-14 OpenJDK Runtime Environment Temurin-17+35 (build 17+35) OpenJDK 64-Bit Server VM Temurin-17+35 (build 17+35, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n_No response_\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\nTagging @radcortez as he fixed the bugs that I previously submitted :)",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/22334/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22334/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
