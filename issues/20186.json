{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20186",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20186/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20186/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20186/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/20186",
  "id": 997555504,
  "node_id": "I_kwDOCFbutM47dX0w",
  "number": 20186,
  "title": "Hibernate bytecode enhancement applied by quarkus generates invalid bytecode for embeddedId value objects",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026509,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTA5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/persistence",
      "name": "area/persistence",
      "color": "FBCA04",
      "default": false,
      "description": "OBSOLETE, DO NOT USE"
    },
    {
      "id": 1341157944,
      "node_id": "MDU6TGFiZWwxMzQxMTU3OTQ0",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/upstream",
      "name": "triage/upstream",
      "color": "7db4d8",
      "default": false,
      "description": "Used for issues which are caused by issues in upstream projects/dependency"
    },
    {
      "id": 1425555736,
      "node_id": "MDU6TGFiZWwxNDI1NTU1NzM2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-orm",
      "name": "area/hibernate-orm",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate ORM"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/144",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/144",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/144/labels",
    "id": 7068928,
    "node_id": "MI_kwDOCFbutM4Aa90A",
    "number": 144,
    "title": "2.3.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 289,
    "state": "closed",
    "created_at": "2021-08-18T08:27:09Z",
    "updated_at": "2022-02-22T17:41:43Z",
    "due_on": null,
    "closed_at": "2021-09-22T10:46:00Z"
  },
  "comments": 11,
  "created_at": "2021-09-15T22:00:45Z",
  "updated_at": "2021-09-21T15:44:16Z",
  "closed_at": "2021-09-21T15:44:12Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\n\r\nGiven the following JPA Entity class with an EmbeddedId class modeled as a value Object, the Hibernate bytecode enhancement that is triggered by Quarkus generates invalid bytecode (shown below). This leads to `java.lang.IllegalAccessError: Update to non-static final field com.example.Drink$DrinkId.id attempted from a different method ($$_hibernate_write_id) than the initializer method <init>` errors.\r\n\r\nExample class\r\n```java\r\npackage com.example;\r\n\r\nimport org.hibernate.annotations.Immutable;\r\n\r\nimport javax.persistence.Embeddable;\r\nimport javax.persistence.EmbeddedId;\r\nimport javax.persistence.Entity;\r\nimport java.io.Serializable;\r\nimport java.util.Objects;\r\nimport java.util.UUID;\r\n\r\n@Entity\r\npublic class Drink {\r\n\r\n    @EmbeddedId\r\n    private DrinkId id;\r\n\r\n    private String name;\r\n\r\n    public Drink() {\r\n        this.id = DrinkId.of(UUID.randomUUID().toString());\r\n    }\r\n\r\n    public DrinkId getId() {\r\n        return id;\r\n    }\r\n\r\n    public void setId(DrinkId id) {\r\n        this.id = id;\r\n    }\r\n\r\n    public String getName() {\r\n        return name;\r\n    }\r\n\r\n    public void setName(String name) {\r\n        this.name = name;\r\n    }\r\n\r\n    @Immutable\r\n    @Embeddable\r\n    public static class DrinkId implements Serializable {  // invalid bytecode is generated for this class\r\n\r\n        private final String id;\r\n\r\n        public DrinkId() {\r\n            this.id = null;\r\n        }\r\n\r\n        private DrinkId(String id) {\r\n            this.id = id;\r\n        }\r\n\r\n        public static DrinkId of(String string) {\r\n            return new DrinkId(string);\r\n        }\r\n\r\n        @Override\r\n        public boolean equals(Object o) {\r\n            if (this == o) return true;\r\n            if (!(o instanceof DrinkId)) return false;\r\n            DrinkId drinkId = (DrinkId) o;\r\n            return Objects.equals(id, drinkId.id);\r\n        }\r\n\r\n        @Override\r\n        public int hashCode() {\r\n            return Objects.hash(id);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nStacktrace:\r\n```\r\njava.lang.IllegalAccessError: Update to non-static final field com.example.Drink$DrinkId.id attempted from a different method ($$_hibernate_write_id) than the initializer method <init> \r\n\tat com.example.Drink$DrinkId.$$_hibernate_write_id(Drink.java)\r\n\tat com.example.Drink$DrinkId.<init>(Drink.java:50)\r\n\tat com.example.Drink$DrinkId.of(Drink.java:54)\r\n\tat com.example.Drink.<init>(Drink.java:20)\r\n\tat com.example.ExampleResource.hello(ExampleResource.java:25)\r\n\tat com.example.ExampleResource_Subclass.hello$$superforward1(ExampleResource_Subclass.zig:157)\r\n\tat com.example.ExampleResource_Subclass$$function$$1.apply(ExampleResource_Subclass$$function$$1.zig:24)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:54)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.proceed(InvocationInterceptor.java:62)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.monitor(InvocationInterceptor.java:49)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor_Bean.intercept(InvocationInterceptor_Bean.zig:521)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:50)\r\n\tat io.quarkus.narayana.jta.runtime.interceptor.TransactionalInterceptorBase.invokeInOurTx(TransactionalInterceptorBase.java:132)\r\n....\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\nResulted in: org.jboss.resteasy.spi.UnhandledException: java.lang.IllegalAccessError: Update to non-static final field com.example.Drink$DrinkId.id attempted from a different method ($$_hibernate_write_id) than the initializer method <init> \r\n\tat org.jboss.resteasy.core.ExceptionHandler.handleApplicationException(ExceptionHandler.java:106)\r\n\tat org.jboss.resteasy.core.ExceptionHandler.handleException(ExceptionHandler.java:372)\r\n\tat org.jboss.resteasy.core.SynchronousDispatcher.writeException(SynchronousDispatcher.java:218)\r\n\tat org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:519)\r\n\t... 15 more\r\n```\r\n\r\nThe decompiled generated bytecode for the class `DrinkId` looks like this:\r\n```java\r\n @Immutable\r\n  @Embeddable\r\n  public static final class DrinkIdentifier implements Identifier, Serializable, ManagedComposite, PersistentAttributeInterceptable, CompositeTracker {\r\n\r\n    private final String id;\r\n    \r\n    @Transient\r\n    private transient PersistentAttributeInterceptor $$_hibernate_attributeInterceptor;\r\n    \r\n    @Transient\r\n    private transient CompositeOwnerTracker $$_hibernate_compositeOwners;\r\n    \r\n    private DrinkIdentifier(String id) {\r\n      $$_hibernate_write_id(id); // This triggers the IllegalAccessError \r\n    }\r\n...\r\n\r\n    public void $$_hibernate_write_id(String param1String) {\r\n      if (this.$$_hibernate_compositeOwners != null)\r\n        this.$$_hibernate_compositeOwners.callOwner(\"\"); \r\n      if ($$_hibernate_getInterceptor() != null) {\r\n        this.id = (String)$$_hibernate_getInterceptor().writeObject(this, \"id\", this.id, param1String);\r\n        return;\r\n      } \r\n      this.id = param1String; // This triggers the IllegalAccessError\r\n    }\r\n```\r\n\r\n\r\n### Expected behavior\r\n\r\nThe hibernate bytecode enhancement applied by quarkus should not emit unnecessary / invalid change tracking bytecode.\r\n\r\n### Actual behavior\r\n\r\nThe hibernate bytecode enhancement applied by quarkus emits invalid bytecode which leads to errors at runtime.\r\n\r\n### How to Reproduce?\r\n\r\n1) Download and build the example https://github.com/thomasdarimont/quarkus-bugs-invalid-hibernate-bytecode\r\n2) Open http://localhost:8080/hello\r\n3) Observe the stacktrace\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux neumann 5.13.14-200.fc34.x86_64 #1 SMP Fri Sep 3 15:33:01 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"17\" 2021-09-14 OpenJDK Runtime Environment (build 17+35-2724) OpenJDK 64-Bit Server VM (build 17+35-2724, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.2.2.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.2 (ea98e05a04480131370aa0c110b8c54cf726c06f)\r\n\r\n### Additional information\r\n\r\nI'm not 100% sure if this is a quarkus issue or a plain hibernate issue. \r\n\r\nThe original example comes from a Spring Boot application (https://github.com/odrotbohm/spring-restbucks/blob/main/server/src/main/java/org/springsource/restbucks/drinks/Drink.java#L53) which uses Hibernate 5.5.6. In the spring app the bytecode of the `DrinkIdentifier` class is not enhanced.\r\n\r\nThe quarkus version 2.2.2.Final seems to use Hibernate 5.5.7. Perhaps this is an hibernate issue that is \r\ntriggered by quarkus due to the explicit bytecode enhancement...",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/20186/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/20186/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
