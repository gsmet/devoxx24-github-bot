{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32650",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32650/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32650/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32650/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/32650",
  "id": 1668160754,
  "node_id": "I_kwDOCFbutM5jbhzy",
  "number": 32650,
  "title": "Quarkus 3: Using `@TestReactiveTransaction` at the class level doesn't work",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1375177076,
      "node_id": "MDU6TGFiZWwxMzc1MTc3MDc2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/testing",
      "name": "area/testing",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/246",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/246",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/246/labels",
    "id": 9296662,
    "node_id": "MI_kwDOCFbutM4AjdsW",
    "number": 246,
    "title": "3.0.1.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 115,
    "state": "closed",
    "created_at": "2023-04-18T08:50:05Z",
    "updated_at": "2023-05-15T14:00:32Z",
    "due_on": null,
    "closed_at": "2023-04-26T09:04:58Z"
  },
  "comments": 6,
  "created_at": "2023-04-14T12:27:12Z",
  "updated_at": "2023-04-25T04:43:33Z",
  "closed_at": "2023-04-19T14:44:29Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nIn Quarkus 3, using `@TestReactiveTransaction` at the class level doesn't work. It causes all the tests in the class to throw an exception.\r\n\r\nIf the annotation shouldn't be used at the class level then the annotation should be marked with only `@Target({ ElementType.METHOD })` rather than `@Target({ ElementType.TYPE, ElementType.METHOD })`.\r\n\r\nOtherwise if it _should_ be able to be used at the class level, then this should be fixed.\r\n\r\n### Expected behavior\r\n\r\nI would expect that using the annotation on the class would work the same as putting the annotation individually on each test method.\r\n\r\n### Actual behavior\r\n\r\nIf I put the `@TestReactiveTransaction` annotation on a test class, all the tests fail with the following exception. If I move the annotation to each test method then all the tests work fine.\r\n\r\n```\r\n\r\njava.lang.AssertionError: Reflective call to UniAsserter parameter failed, please file a bug report\r\n\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor.handleSpecialTestMethod(TestReactiveTransactionalInterceptor.java:79)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor.intercept(TestReactiveTransactionalInterceptor.java:23)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptorGenerated_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n\tat io.quarkus.sample.superheroes.hero.repository.HeroRepositoryTests_Subclass.findRandomNotFound(Unknown Source)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat io.quarkus.test.vertx.RunOnVertxContextTestMethodInvoker$RunTestMethodOnContextHandler.doRun(RunOnVertxContextTestMethodInvoker.java:148)\r\n\tat io.quarkus.test.vertx.RunOnVertxContextTestMethodInvoker$RunTestMethodOnContextHandler.handle(RunOnVertxContextTestMethodInvoker.java:137)\r\n\tat io.quarkus.test.vertx.RunOnVertxContextTestMethodInvoker$RunTestMethodOnContextHandler.handle(RunOnVertxContextTestMethodInvoker.java:108)\r\n\tat io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:264)\r\n\tat io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:246)\r\n\tat io.vertx.core.impl.EventLoopContext.lambda$runOnContext$0(EventLoopContext.java:43)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: java.lang.reflect.InvocationTargetException\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor.handleSpecialTestMethod(TestReactiveTransactionalInterceptor.java:66)\r\n\t... 24 more\r\nCaused by: java.lang.IllegalStateException: Can't get the context safety flag: the current context is not a duplicated context\r\n\tat io.quarkus.vertx.core.runtime.context.VertxContextSafetyToggle.checkIsSafe(VertxContextSafetyToggle.java:78)\r\n\tat io.quarkus.vertx.core.runtime.context.VertxContextSafetyToggle.validateContextIfExists(VertxContextSafetyToggle.java:72)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.vertxContext(SessionOperations.java:183)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.withSession(SessionOperations.java:112)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.withTransaction(SessionOperations.java:99)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor$1.apply(TestReactiveTransactionalInterceptor.java:69)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor$1.apply(TestReactiveTransactionalInterceptor.java:66)\r\n\tat io.quarkus.test.vertx.DefaultUniAsserter.surroundWith(DefaultUniAsserter.java:129)\r\n\t... 29 more\r\n```\r\n\r\n### How to Reproduce?\r\n\r\n1. Clone the Quarkus superheroes from my fork on the `quarkus3` branch (https://github.com/edeandrea/quarkus-super-heroes/tree/quarkus3)\r\n2. cd into `rest-heroes`\r\n3. Run ` ./mvnw test -Dtest=HeroRepositoryTests`\r\n4. Notice all tests pass\r\n5. Open `src/test/java/io/quarkus/sample/superheroes/hero/repository/HeroRepositoryTests.java`\r\n6. Notice that the `@TestReactiveTransaction` is on all the test methods\r\n7. Remove the `@TestReactiveTransaction` from each test method and place it at the class level\r\n8. Re-run ` ./mvnw test -Dtest=HeroRepositoryTests` and notice that the tests fail.\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n`Darwin edeandrea-m1pro 22.4.0 Darwin Kernel Version 22.4.0: Mon Mar  6 20:59:28 PST 2023; root:xnu-8796.101.5~3/RELEASE_ARM64_T6000 arm64`\r\n\r\n### Output of `java -version`\r\n\r\n```\r\nopenjdk version \"17.0.6\" 2023-01-17\r\nOpenJDK Runtime Environment Temurin-17.0.6+10 (build 17.0.6+10)\r\nOpenJDK 64-Bit Server VM Temurin-17.0.6+10 (build 17.0.6+10, mixed mode)\r\n```\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n`3.0.0.CR2`\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n```\r\nApache Maven 3.9.1 (2e178502fcdbffc201671fb2537d0cb4b4cc58f8)\r\nMaven home: /Users/edeandre/.m2/wrapper/dists/apache-maven-3.9.1-bin/320285b4/apache-maven-3.9.1\r\nJava version: 17.0.6, vendor: Eclipse Adoptium, runtime: /Users/edeandre/.sdkman/candidates/java/17.0.6-tem\r\nDefault locale: en_US, platform encoding: UTF-8\r\nOS name: \"mac os x\", version: \"13.3.1\", arch: \"aarch64\", family: \"mac\"\r\n```\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32650/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32650/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
