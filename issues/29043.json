{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/29043",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29043/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29043/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29043/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/29043",
  "id": 1434894968,
  "node_id": "I_kwDOCFbutM5VhsJ4",
  "number": 29043,
  "title": "Parent first dependencies method in Class Loading Reference guide not working for applications",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273027849,
      "node_id": "MDU6TGFiZWwxMjczMDI3ODQ5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/core",
      "name": "area/core",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/220",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/220",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/220/labels",
    "id": 8714894,
    "node_id": "MI_kwDOCFbutM4AhPqO",
    "number": 220,
    "title": "2.15.0.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 38,
    "state": "closed",
    "created_at": "2022-12-02T18:02:10Z",
    "updated_at": "2022-12-14T09:33:38Z",
    "due_on": null,
    "closed_at": "2022-12-07T14:18:28Z"
  },
  "comments": 5,
  "created_at": "2022-11-03T15:53:17Z",
  "updated_at": "2022-12-06T18:36:54Z",
  "closed_at": "2022-11-04T11:17:30Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nA Quarkus application that wants to use byteman to intercept and startup and shutdown events will suffer issues like this with default fast-jar.\r\n\r\nOn startup, byteman is loaded with the system classloader and it successfully injects the rule:\r\n\r\n```\r\n[1830908236 null] Rule.execute called for restore_1:0\r\nHelperManager.install for helper class org.acme.JigawattsService\r\ncalling activated() for helper class org.jboss.byteman.rule.helper.Helper\r\nDefault helper activated\r\ncalling installed(restore) for helper classorg.jboss.byteman.rule.helper.Helper\r\nInstalled rule using default helper : restore\r\ncalling activated() for helper class org.acme.JigawattsService\r\nDefault helper activated\r\ncalling installed(restore) for helper classorg.acme.JigawattsService\r\nInstalled rule using default helper : restore\r\nrestore execute()\r\nRestore::entry\r\nRestore::exit\r\n```\r\n\r\nThen on shutdown, the rule won't trigger and you will see these messages appearing on byteman:\r\n\r\n```\r\n^C[33293669 io.quarkus.bootstrap.runner.RunnerClassLoader@3d24753a] Rule.execute called for checkpoint_0:0\r\nRule.execute for decommissioned key checkpoint_0:0\r\n```\r\n\r\nWhat is happening is that on shutdown, byteman classes are being loaded with a different classloader (the `RunnerClassLoader`). This is problematic because Byteman's rule has a static cache of rules, and when the class is loaded with another classloader different to the system one, the cache is empty and it won't trigger the rule. The above (tweaked) byteman log messages show that.\r\n\r\nThe classloading guide indicates how to avoid this issue in the [parent first dependencies section](https://quarkus.io/guides/class-loading-reference#parent-first-dependencies). The guide suggests to do add this to the pom.xml but for Quarkus applications (not extensions) it has no effect:\r\n\r\n```\r\n<plugin>\r\n    <groupId>io.quarkus</groupId>\r\n    <artifactId>quarkus-extension-maven-plugin</artifactId>\r\n    <configuration>\r\n        <parentFirstArtifacts>\r\n            <parentFirstArtifact>org.jboss.byteman:byteman</parentFirstArtifact>\r\n        </parentFirstArtifacts>\r\n    </configuration>\r\n</plugin>\r\n```\r\n\r\nHowever, if you instead modify the app's `application.properties` file and add this:\r\n\r\n```\r\nquarkus.class-loading.parent-first-artifacts=org.jboss.byteman:byteman\r\n```\r\n\r\nThen things will work:\r\n\r\n```\r\n^C[1288354730 null] Rule.execute called for checkpoint_0:0\r\nHelperManager.install for helper class org.jboss.byteman.rule.helper.Helper\r\ncalling installed(checkpoint) for helper classorg.jboss.byteman.rule.helper.Helper\r\nInstalled rule using default helper : checkpoint\r\ncheckpoint execute\r\nCheckpoint::entry\r\n```\r\n\r\nWhat you're seeing above is the rule being loaded with the system classloader once again and things working as expected.\r\n\r\nDocumentation should make this clear.\r\n\r\nMoreover, the following statement in the classloader guide is outdated:\r\n\r\n> When running a production application everything is loaded in the system ClassLoader, so it is a completely flat class path.\r\n\r\nThere should be an explanation about fast-jar (vs legacy-jar)...etc.\n\n### Expected behavior\n\n_No response_\n\n### Actual behavior\n\n_No response_\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n_No response_\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/29043/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/29043/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
