{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/39792",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39792/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39792/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39792/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/39792",
  "id": 2215918586,
  "node_id": "I_kwDOCFbutM6EFDv6",
  "number": 39792,
  "title": "Hibernate dirty checking doesn't work and updates are generated for merged objects which haven't changed",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026509,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTA5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/persistence",
      "name": "area/persistence",
      "color": "FBCA04",
      "default": false,
      "description": "OBSOLETE, DO NOT USE"
    },
    {
      "id": 1341157944,
      "node_id": "MDU6TGFiZWwxMzQxMTU3OTQ0",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/upstream",
      "name": "triage/upstream",
      "color": "7db4d8",
      "default": false,
      "description": "Used for issues which are caused by issues in upstream projects/dependency"
    },
    {
      "id": 1425555736,
      "node_id": "MDU6TGFiZWwxNDI1NTU1NzM2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-orm",
      "name": "area/hibernate-orm",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate ORM"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 9,
  "created_at": "2024-03-29T19:42:01Z",
  "updated_at": "2024-07-08T13:47:09Z",
  "closed_at": "2024-07-08T13:46:58Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nSimilar to https://github.com/quarkusio/quarkus/issues/30234 but perhaps different.\r\nI have a versioned entity (optimistic locking) which i persist by making a REST call which responds with a JSON representation of that entity. The response contains version 0. I make a change to a field on that JSON and post it back to the server which does a merge. The field is updated in the database and the version is set to 1, which is expected.\r\n\r\nI then post the same JSON, and the response contains version 2. I debugged into org.hibernate.event.internal.DefaultMergedEventListener#markInterceptorDirty and it seems to discover that the field has changed, even though the debugger confirms that the values are identical. The methods which hibernate uses at this stage are generated bytecode, so it isn't possible to debug into them.\r\n\r\nUsing the DirtyCheckInterceptor class posted in the other issue (linked above) solves the problem.\r\n\r\nReproducer: [quarkus-dirty-check.zip](https://github.com/quarkusio/quarkus/files/14807974/quarkus-dirty-check.zip)\r\n\r\nI also created a simple unit test which is similar to this article, to check that hibernate doesn't normally update the version number if no fields have changed when merging the object. https://vladmihalcea.com/jpa-persist-and-merge/\n\n### Expected behavior\n\nVersion numbers should only be updated if a field changes.\r\nMore importantly the update sql statement should only be generated if a field changes.\r\nOtherwise merging a tree of objects causes every row to be unnecessarily updated. \n\n### Actual behavior\n\nVersion and row are updated every time a detached object is merged.\n\n### How to Reproduce?\n\nSee the reproducer attached above.\r\nRun the GreetingResourceTest, which also contains documentation about what is going wrong.\n\n### Output of `uname -a` or `ver`\n\nLinux cronus 6.2.0-39-generic #40-Ubuntu SMP PREEMPT_DYNAMIC Tue Nov 14 14:18:00 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux\n\n### Output of `java -version`\n\nopenjdk 21.0.2 2024-01-16 OpenJDK Runtime Environment GraalVM CE 21.0.2+13.1 (build 21.0.2+13-jvmci-23.1-b30) OpenJDK 64-Bit Server VM GraalVM CE 21.0.2+13.1 (build 21.0.2+13-jvmci-23.1-b30, mixed mode, sharing)\n\n### Quarkus version or git rev\n\n3.9.1\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.7 Maven home: /usr/share/maven Java version: 21.0.2, vendor: GraalVM Community, runtime: /shared2/graalvm/graalvm-community-openjdk-21.0.2+13.1 Default locale: en_GB, platform encoding: UTF-8 OS name: \"linux\", version: \"6.2.0-39-generic\", arch: \"amd64\", family: \"unix\"\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/39792/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39792/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
