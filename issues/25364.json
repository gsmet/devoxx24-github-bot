{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/25364",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25364/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25364/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25364/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/25364",
  "id": 1225297307,
  "node_id": "I_kwDOCFbutM5JCI2b",
  "number": 25364,
  "title": "Arc - Inherited Observer methods clash with type variables",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1282102389,
      "node_id": "MDU6TGFiZWwxMjgyMTAyMzg5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/arc",
      "name": "area/arc",
      "color": "0366d6",
      "default": false,
      "description": "Issue related to ARC (dependency injection)"
    },
    {
      "id": 1676631606,
      "node_id": "MDU6TGFiZWwxNjc2NjMxNjA2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/windows",
      "name": "env/windows",
      "color": "edea47",
      "default": false,
      "description": "Impacts Windows machines"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/186",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/186",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/186/labels",
    "id": 7946482,
    "node_id": "MI_kwDOCFbutM4AeUDy",
    "number": 186,
    "title": "2.8.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 23,
    "state": "closed",
    "created_at": "2022-05-05T10:23:16Z",
    "updated_at": "2023-01-25T08:58:51Z",
    "due_on": null,
    "closed_at": "2022-05-06T14:18:52Z"
  },
  "comments": 4,
  "created_at": "2022-05-04T12:23:18Z",
  "updated_at": "2022-05-18T11:19:16Z",
  "closed_at": "2022-05-05T10:29:26Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nIf an observer method is defined in a superclass of two bean classes and observes a type variable, then the the concrete type of this type variable in the context of the implementing classes is seemingly not taken into account. It seems that only the bounds at the declaration are taken into account.\n\n### Expected behavior\n\nThe test shown below should succeed when executed with Arc\n\n### Actual behavior\n\nAnnotated with `@EnableAutoWeld` the test succeeds. Annotated with `@QuarkusTest` the test fails with a `ClassCastException`:\r\n\r\n```\r\nAService#onEvent:class com.example.MyAEvent\r\n\r\njava.lang.ClassCastException: class com.example.MyAEvent cannot be cast to class com.example.MyBEvent (com.example.MyAEvent and com.example.MyBEvent are in unnamed module of loader io.quarkus.bootstrap.classloading.QuarkusClassLoader @4e38d975)\r\n\r\n\tat com.example.MyBService.doSomething(MyBService.java:5)\r\n\tat com.example.AbstractService.onEvent(AbstractService.java:15)\r\n\tat com.example.AbstractService_Observer_onEvent_323a4600e644fd71f7085886ea60198dd4e67c76.notify(Unknown Source)\r\n\tat io.quarkus.arc.impl.EventImpl$Notifier.notifyObservers(EventImpl.java:323)\r\n\tat io.quarkus.arc.impl.EventImpl$Notifier.notify(EventImpl.java:301)\r\n\tat io.quarkus.arc.impl.EventImpl.fire(EventImpl.java:73)\r\n\tat com.example.EventSource.sendA(EventSource.java:17)\r\n\tat com.example.TestObserverInheritance.testObservers(TestObserverInheritance.java:23)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat io.quarkus.test.junit.QuarkusTestExtension.runExtensionMethod(QuarkusTestExtension.java:1008)\r\n// rest omitted\r\n```\r\nsuggesting that the event was delivered to the inherited observer method in `MyBService`. The same happens for async observer methods which I have omitted for brevity.\r\n\r\nAdmittedly, it is not entirely clear (to me) from the CDI Spec that Weld's behaviour is correct and Arc's is incorrect. The Spec DOES say that an observer method must be non-abstract, so the difference in behaviour for a similar test in which the observer method itself is abstract is not that surprising; it's simply something Weld allows and Arc doesn't. But the spec does not forbid calling abstract methods from a non-abstract observer method.\r\n\r\nAt the very least, Weld's behaviour is the more intuitive (to me) of the two. \n\n### How to Reproduce?\n\nConsider this application\r\n```\r\nclass MyEvent {}\r\nclass MyAEvent extends MyEvent {}\r\nclass MyBEvent extends MyEvent {}\r\n\r\nabstract class AbstractService<E extends MyEvent> {\r\n    int count;\r\n\r\n    public int getCount() {\r\n        return count;\r\n    }\r\n\r\n    void onEvent(@Observes E myEvent) {\r\n        count++;\r\n        doSomething(myEvent);\r\n    }\r\n\r\n    abstract void doSomething(E myEvent);\r\n}\r\n\r\n\r\n@ApplicationScoped\r\nclass MyAService extends AbstractService<MyAEvent>{\r\n\r\n    @Override\r\n    protected void doSomething(MyAEvent myEvent) {\r\n        System.out.println(\"AService#onEvent:\"+myEvent.getClass());\r\n    }\r\n}\r\n\r\n@ApplicationScoped\r\nclass MyBService extends AbstractService<MyBEvent>{\r\n// analogously defined as MyAService\r\n}\r\n\r\n@Unremovable\r\n@Dependent\r\npublic class EventSource {\r\n    @Inject\r\n    Event<MyEvent> event;\r\n\r\n    void sendA(){\r\n        event.fire(new MyAEvent());\r\n    }\r\n}\r\n```\r\n\r\nand the following test:\r\n```\r\npublic abstract class TestObserverInheritance {\r\n\r\n    @Inject\r\n    MyAService myAService;\r\n\r\n    @Inject\r\n    MyBService myBService;\r\n\r\n    @Inject\r\n    EventSource eventSource;\r\n\r\n    @Test\r\n    void testObservers() {\r\n        eventSource.sendA();\r\n\r\n        assertThat(myAService.getCount()).isEqualTo(1);\r\n        assertThat(myBService.getCount()).isEqualTo(0);\r\n    }\r\n}\r\n```\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.8.2.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.4 (9b656c72d54e5bacbed989b64718c159fe39b537) Maven home: C:\\Users\\<me>\\.m2\\wrapper\\dists\\apache-maven-3.8.4-bin\\52ccbt68d252mdldqsfsn03jlf\\apache-maven-3.8.4 Java version: 11, vendor: Oracle Corporation, runtime: C:\\Program Files\\Java\\jdk-11 Default locale: de_DE, platform encoding: UTF-8 OS name: \"windows 10\", version: \"10.0\", arch: \"amd64\", family: \"windows\"\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/25364/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25364/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
