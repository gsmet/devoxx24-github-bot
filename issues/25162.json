{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/25162",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25162/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25162/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25162/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/25162",
  "id": 1215642199,
  "node_id": "I_kwDOCFbutM5IdTpX",
  "number": 25162,
  "title": "Doublon of StatefulSet generated by Kubernetes extension",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1654772125,
      "node_id": "MDU6TGFiZWwxNjU0NzcyMTI1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kubernetes",
      "name": "area/kubernetes",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/186",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/186",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/186/labels",
    "id": 7946482,
    "node_id": "MI_kwDOCFbutM4AeUDy",
    "number": 186,
    "title": "2.8.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 23,
    "state": "closed",
    "created_at": "2022-05-05T10:23:16Z",
    "updated_at": "2023-01-25T08:58:51Z",
    "due_on": null,
    "closed_at": "2022-05-06T14:18:52Z"
  },
  "comments": 2,
  "created_at": "2022-04-26T09:07:28Z",
  "updated_at": "2022-05-05T10:26:16Z",
  "closed_at": "2022-04-27T10:38:58Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nI want to define a `volumeClaimTemplates` for my Quarkus app which is meant to be a `StatefulSet`.\r\n\r\nI follow the documentation here: https://quarkus.io/guides/deploying-to-kubernetes#using-existing-resources\r\nSo it should be possible to have a \"base template\" provided I am using the expected name and container-name, which I do here: https://github.com/tarilabs/hello-pvdf/blob/8fa82c58a3d9889c75d86bd0317a4443440c2ca2/src/main/kubernetes/kubernetes.yml#L2-L18\r\n\r\nPlease notice I configured the Quarkus app as StatefulSet as described in the guide, I do so here: https://github.com/tarilabs/hello-pvdf/blob/8fa82c58a3d9889c75d86bd0317a4443440c2ca2/src/main/resources/application.properties#L11\r\n\r\nHowever despite using the expected name and container-name, I end up with the file inside of `target/kubernetes/kubernetes.yml` to contain 2 duplicated entries of the StatefulSet.\r\n\r\nIt should be noted if I did a classic `Deployment`, so reflecting the change by omitting the line in the `application.properties` and changing the line: https://github.com/tarilabs/hello-pvdf/blob/8fa82c58a3d9889c75d86bd0317a4443440c2ca2/src/main/kubernetes/kubernetes.yml#L2\r\nto read `kind: Deployment` the duplication in the generated `target/kubernetes/kubernetes.yml` file does not happen\n\n### Expected behavior\n\nOnly single \"StatefulSet\" inside of `target/kubernetes/kubernetes.yml`\n\n### Actual behavior\n\nThere are two `StatefulSet` generated inside the `target/kubernetes/kubernetes.yml` file, with the same \"name\".\r\nFortunately the correct one comes first, so it still \"works\" but using `kubectl apply -f <file>` will give you error on the command line for the second definition, since trying to modify a StatefulSet which was already applied.\r\n\r\n```yaml\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  annotations:\r\n    app.quarkus.io/commit-id: 8fa82c58a3d9889c75d86bd0317a4443440c2ca2\r\n    app.quarkus.io/build-timestamp: 2022-04-26 - 09:00:49 +0000\r\n  labels:\r\n    app.kubernetes.io/name: hello-pvdf\r\n    app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n  name: hello-pvdf\r\n  namespace: default\r\nspec:\r\n  ports:\r\n    - name: http\r\n      port: 80\r\n      targetPort: 8080\r\n  selector:\r\n    app.kubernetes.io/name: hello-pvdf\r\n    app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n  type: ClusterIP\r\n---\r\napiVersion: apps/v1\r\nkind: StatefulSet\r\nmetadata:\r\n  annotations:\r\n    app.quarkus.io/commit-id: 8fa82c58a3d9889c75d86bd0317a4443440c2ca2\r\n    app.quarkus.io/build-timestamp: 2022-04-26 - 09:00:49 +0000\r\n  labels:\r\n    app.kubernetes.io/name: hello-pvdf\r\n    app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n  name: hello-pvdf\r\n  namespace: default\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app.kubernetes.io/name: hello-pvdf\r\n      app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n  serviceName: hello-pvdf\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app.kubernetes.io/name: hello-pvdf\r\n        app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n    spec:\r\n      containers:\r\n        - env:\r\n            - name: KUBERNETES_NAMESPACE\r\n              valueFrom:\r\n                fieldRef:\r\n                  fieldPath: metadata.namespace\r\n            - name: PVDF_DIRECTORY\r\n              value: /mnt/data\r\n          image: quay.io/mmortari/hello-pvdf:1.0.0-SNAPSHOT\r\n          imagePullPolicy: Always\r\n          livenessProbe:\r\n            failureThreshold: 3\r\n            httpGet:\r\n              path: /q/health/live\r\n              port: 8080\r\n              scheme: HTTP\r\n            initialDelaySeconds: 0\r\n            periodSeconds: 30\r\n            successThreshold: 1\r\n            timeoutSeconds: 10\r\n          name: hello-pvdf\r\n          ports:\r\n            - containerPort: 8080\r\n              name: http\r\n              protocol: TCP\r\n          readinessProbe:\r\n            failureThreshold: 3\r\n            httpGet:\r\n              path: /q/health/ready\r\n              port: 8080\r\n              scheme: HTTP\r\n            initialDelaySeconds: 0\r\n            periodSeconds: 30\r\n            successThreshold: 1\r\n            timeoutSeconds: 10\r\n          resources:\r\n            limits:\r\n              cpu: 1000m\r\n              memory: 512Mi\r\n            requests:\r\n              cpu: 250m\r\n              memory: 64Mi\r\n          volumeMounts:\r\n            - mountPath: /mnt/data\r\n              name: my-pvc-claim\r\n              readOnly: false\r\n      terminationGracePeriodSeconds: 10\r\n  volumeClaimTemplates:\r\n    - apiVersion: v1\r\n      kind: PersistentVolumeClaim\r\n      metadata:\r\n        annotations:\r\n          app.quarkus.io/commit-id: 8fa82c58a3d9889c75d86bd0317a4443440c2ca2\r\n          app.quarkus.io/build-timestamp: 2022-04-26 - 09:00:49 +0000\r\n        labels:\r\n          app.kubernetes.io/name: hello-pvdf\r\n          app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n        name: my-pvc-claim\r\n        namespace: default\r\n      spec:\r\n        accessModes:\r\n          - ReadWriteOnce\r\n        resources:\r\n          requests:\r\n            storage: 10Mi\r\n        storageClassName: standard\r\n---\r\napiVersion: apps/v1\r\nkind: StatefulSet\r\nmetadata:\r\n  annotations:\r\n    app.quarkus.io/commit-id: 8fa82c58a3d9889c75d86bd0317a4443440c2ca2\r\n    app.quarkus.io/build-timestamp: 2022-04-26 - 09:00:49 +0000\r\n  labels:\r\n    app.kubernetes.io/name: hello-pvdf\r\n    app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n  name: hello-pvdf\r\n  namespace: default\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app.kubernetes.io/name: hello-pvdf\r\n      app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n  serviceName: hello-pvdf\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app.kubernetes.io/name: hello-pvdf\r\n        app.kubernetes.io/version: 1.0.0-SNAPSHOT\r\n    spec:\r\n      containers:\r\n        - env:\r\n            - name: KUBERNETES_NAMESPACE\r\n              valueFrom:\r\n                fieldRef:\r\n                  fieldPath: metadata.namespace\r\n            - name: PVDF_DIRECTORY\r\n              value: /mnt/data\r\n          image: quay.io/mmortari/hello-pvdf:1.0.0-SNAPSHOT\r\n          imagePullPolicy: Always\r\n          livenessProbe:\r\n            failureThreshold: 3\r\n            httpGet:\r\n              path: /q/health/live\r\n              port: 8080\r\n              scheme: HTTP\r\n            initialDelaySeconds: 0\r\n            periodSeconds: 30\r\n            successThreshold: 1\r\n            timeoutSeconds: 10\r\n          name: hello-pvdf\r\n          ports:\r\n            - containerPort: 8080\r\n              name: http\r\n              protocol: TCP\r\n          readinessProbe:\r\n            failureThreshold: 3\r\n            httpGet:\r\n              path: /q/health/ready\r\n              port: 8080\r\n              scheme: HTTP\r\n            initialDelaySeconds: 0\r\n            periodSeconds: 30\r\n            successThreshold: 1\r\n            timeoutSeconds: 10\r\n          resources:\r\n            limits:\r\n              cpu: 1000m\r\n              memory: 512Mi\r\n            requests:\r\n              cpu: 250m\r\n              memory: 64Mi\r\n          volumeMounts:\r\n            - mountPath: /mnt/data\r\n              name: my-pvc-claim\r\n              readOnly: false\r\n      terminationGracePeriodSeconds: 10\r\n```\n\n### How to Reproduce?\n\n1. checkout https://github.com/tarilabs/hello-pvdf\r\n2. mvn clean install\r\n3. open target/kubernetes/kubernetes.yml you will notice the doublon\n\n### Output of `uname -a` or `ver`\n\nDarwin mmortari1-mac 20.6.0 Darwin Kernel Version 20.6.0: Tue Feb 22 21:10:41 PST 2022; root:xnu-7195.141.26~1/RELEASE_X86_64 x86_64\n\n### Output of `java -version`\n\nopenjdk version \"18.0.1\" 2022-04-19\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\nquarkus.platform.version>2.8.1.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.5 (3599d3414f046de2324203b78ddcf9b5e4388aa0)\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/25162/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/25162/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
