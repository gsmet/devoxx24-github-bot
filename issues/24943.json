{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/24943",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24943/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24943/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24943/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/24943",
  "id": 1204726411,
  "node_id": "I_kwDOCFbutM5HzqqL",
  "number": 24943,
  "title": "Continuous testing fails when a dependency brings in an optional dependency and a Jandex index",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2955098535,
      "node_id": "MDU6TGFiZWwyOTU1MDk4NTM1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/continuous-testing",
      "name": "area/continuous-testing",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/182",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/182",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/182/labels",
    "id": 7891214,
    "node_id": "MI_kwDOCFbutM4AeGkO",
    "number": 182,
    "title": "2.8.2.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 37,
    "state": "closed",
    "created_at": "2022-04-19T12:35:34Z",
    "updated_at": "2022-05-24T21:01:39Z",
    "due_on": null,
    "closed_at": "2022-04-26T12:43:51Z"
  },
  "comments": 5,
  "created_at": "2022-04-14T16:11:10Z",
  "updated_at": "2022-04-24T19:03:17Z",
  "closed_at": "2022-04-20T13:17:11Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen in a multi-module maven project, with a quarkus module `A` depending on a regular java module `B`. If module `B` contains both an optional dependecy (not declared by `A` too) and a Jandex index, then continuous testing fails with a `BuildException`.\r\n\r\nIt makes no difference whether the classes in `B` using the optional dependencies are used by the quarkus module or its tests.\r\n\r\nRegular testing via maven still works correctly, though.\r\n\r\n### Expected behavior\r\n\r\nContinuous testing should build and execute the tests.\r\n\r\n### Actual behavior\r\n\r\nA `BuildException` is thrown:\r\n\r\n```\r\n[INFO] --- quarkus-maven-plugin:2.8.0.Final:test (default-cli) @ code-with-quarkus ---\r\n[INFO] Invoking org.apache.maven.plugins:maven-resources-plugin:2.6:resources) @ code-with-quarkus\r\n[INFO] Using 'UTF-8' encoding to copy filtered resources.\r\n[INFO] Copying 2 resources\r\n[INFO] Invoking io.quarkus.platform:quarkus-maven-plugin:2.8.0.Final:generate-code) @ code-with-quarkus\r\n[INFO] Invoking org.apache.maven.plugins:maven-compiler-plugin:3.8.1:compile) @ code-with-quarkus\r\n[INFO] Changes detected - recompiling the module!\r\n[INFO] Compiling 1 source file to /home/bnazare/Projects/quarkus-21226-reproducer/code-with-quarkus/target/classes\r\n[INFO] Invoking org.apache.maven.plugins:maven-resources-plugin:2.6:testResources) @ code-with-quarkus\r\n[INFO] Using 'UTF-8' encoding to copy filtered resources.\r\n[INFO] skip non existing resourceDirectory /home/bnazare/Projects/quarkus-21226-reproducer/code-with-quarkus/src/test/resources\r\n[INFO] Invoking io.quarkus.platform:quarkus-maven-plugin:2.8.0.Final:generate-code-tests) @ code-with-quarkus\r\n[INFO] Invoking org.apache.maven.plugins:maven-compiler-plugin:3.8.1:testCompile) @ code-with-quarkus\r\n[INFO] Changes detected - recompiling the module!\r\n[INFO] Compiling 2 source files to /home/bnazare/Projects/quarkus-21226-reproducer/code-with-quarkus/target/test-classes\r\n[INFO] /home/bnazare/Projects/quarkus-21226-reproducer/code-with-quarkus/src/test/java/org/acme/NativeGreetingResourceIT.java: /home/bnazare/Projects/quarkus-21226-reproducer/code-with-quarkus/src/test/java/org/acme/NativeGreetingResourceIT.java uses or overrides a deprecated API that is marked for removal.\r\n[INFO] /home/bnazare/Projects/quarkus-21226-reproducer/code-with-quarkus/src/test/java/org/acme/NativeGreetingResourceIT.java: Recompile with -Xlint:removal for details.\r\nListening for transport dt_socket at address: 5005\r\n__  ____  __  _____   ___  __ ____  ______ \r\n --/ __ \\/ / / / _ | / _ \\/ //_/ / / / __/ \r\n -/ /_/ / /_/ / __ |/ , _/ ,< / /_/ /\\ \\   \r\n--\\___\\_\\____/_/ |_/_/|_/_/|_|\\____/___/   \r\n2022-04-14 16:59:51,823 INFO  [io.qua.test] (main) Quarkus continuous testing mode started\r\n\r\n2022-04-14 16:59:52,032 INFO  [io.qua.test] (Test runner thread) Running 1/1. Running: #JUnit Jupiter\r\n2022-04-14 16:59:52,041 INFO  [io.qua.test] (Test runner thread) Running 1/1. Running: #JUnit Jupiter\r\n2022-04-14 16:59:52,051 INFO  [io.qua.test] (Test runner thread) Running 1/1. Running: org.acme.GreetingResourceTest#GreetingResourceTest\r\n2022-04-14 16:59:52,220 INFO  [org.jbo.threads] (Test runner thread) JBoss Threads version 3.4.2.Final\r\n2022-04-14 16:59:52,684 INFO  [io.qua.test] (Test runner thread) Running 1/1. Running: org.acme.GreetingResourceTest#testHelloEndpoint()\r\n2022-04-14 16:59:52,690 ERROR [io.qua.test] (Test runner thread) ==================== TEST REPORT #1 ====================\r\n2022-04-14 16:59:52,691 ERROR [io.qua.test] (Test runner thread) Test GreetingResourceTest#testHelloEndpoint() failed \r\n: java.lang.RuntimeException: java.lang.RuntimeException: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n        [error]: Build step io.quarkus.deployment.steps.ClassTransformingBuildStep#handleClassTransformation threw an exception: java.lang.IllegalStateException: java.util.concurrent.ExecutionException: java.lang.TypeNotPresentException: Type com/itextpdf/text/DocumentException not present\r\n        at io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:934)\r\n        at io.quarkus.builder.BuildContext.run(BuildContext.java:277)\r\n        at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n        at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n        at java.base/java.lang.Thread.run(Thread.java:829)\r\n        at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\nCaused by: java.util.concurrent.ExecutionException: java.lang.TypeNotPresentException: Type com/itextpdf/text/DocumentException not present\r\n        at java.base/java.util.concurrent.FutureTask.report(FutureTask.java:122)\r\n        at java.base/java.util.concurrent.FutureTask.get(FutureTask.java:191)\r\n        at io.quarkus.deployment.steps.ClassTransformingBuildStep.handleClassTransformation(ClassTransformingBuildStep.java:234)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n        at io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:925)\r\n        ... 6 more\r\n```\r\n(the stack trace goes on for around 300 lines, but this is the most relevant part)\r\n\r\n### How to Reproduce?\r\n\r\nReproducer: https://github.com/linkareti/quarkus-optional-dep-test-issue-reproducer\r\n\r\nSteps to reproduce the behaviour:\r\n1. run `mvn clean install` in the project's root\r\n2. change to folder `code-with-quarkus`\r\n3. run `mvn clean quarkus:test`\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux [...] 5.16.18-200.fc35.x86_64 #1 SMP PREEMPT Mon Mar 28 14:10:07 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"11.0.14.1\" 2022-02-08\r\nOpenJDK Runtime Environment 18.9 (build 11.0.14.1+1)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11.0.14.1+1, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\nn/a\r\n\r\n### Quarkus version or git rev\r\n\r\n2.8.0.Final, but I've seen the issue since 2.6.3.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nApache Maven 3.8.1 (05c21c65bdfed0f71a2f2ada8b84da59348c4c5d)\r\nMaven home: /home/bnazare/tools/apache-maven-3.8.1\r\nJava version: 11.0.14.1, vendor: Red Hat, Inc., runtime: /usr/lib/jvm/java-11-openjdk-11.0.14.1.1-5.fc35.x86_64\r\nDefault locale: pt_PT, platform encoding: UTF-8\r\nOS name: \"linux\", version: \"5.16.18-200.fc35.x86_64\", arch: \"amd64\", family: \"unix\"\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/24943/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/24943/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
