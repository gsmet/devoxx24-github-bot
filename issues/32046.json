{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32046",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32046/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32046/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32046/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/32046",
  "id": 1636177009,
  "node_id": "I_kwDOCFbutM5hhhRx",
  "number": 32046,
  "title": "quarkus-grpc: gRPC Context including Deadline not propagated to gRPC server",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2062531368,
      "node_id": "MDU6TGFiZWwyMDYyNTMxMzY4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/grpc",
      "name": "area/grpc",
      "color": "0366d6",
      "default": false,
      "description": "gRPC"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/280",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/280",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/280/labels",
    "id": 10034258,
    "node_id": "MI_kwDOCFbutM4AmRxS",
    "number": 280,
    "title": "3.6.0.CR1",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 185,
    "state": "closed",
    "created_at": "2023-10-11T07:34:36Z",
    "updated_at": "2024-01-14T09:44:21Z",
    "due_on": null,
    "closed_at": "2023-11-15T12:08:43Z"
  },
  "comments": 6,
  "created_at": "2023-03-22T17:07:13Z",
  "updated_at": "2023-10-23T15:55:54Z",
  "closed_at": "2023-10-23T15:55:48Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nWhen trying to retrieve the gRPC Context object from the gRPC API via `Context.current()` in a Quarkus gRPC server implementation, the retrieved Context is empty. E.g. a deadline set on client side via `stub.withDeadline(Deadline.after(30, TimeUnit.SECONDS))` results on a null Deadline on server side: `Context.current().getDeadline()`, even though the deadline is transported correctly via the gRPC Metadata.\r\n\r\nWhen trying to retrieve and log the deadline with\r\n```\r\nDeadline deadline = Context.current().getDeadline();\r\nif (deadline != null) {\r\n    log.info(name + \" - Deadline: {} - seconds remaining: {}\", deadline,\r\n            deadline.timeRemaining(TimeUnit.SECONDS));\r\n} else {\r\n    log.info(name + \" - Received no deadline\");\r\n}\r\n```\r\nthe logs show\r\n\r\n> 2023-03-22 17:53:00,666 INFO  [org.acm.LoggingHelper] (vert.x-eventloop-thread-0) HelloGrpcService - Received no deadline\r\n\r\nAdditionally, when logging the meta data in a ServerInterceptor with\r\n```\r\nlog.info(\"Metadata received: {}\", metadata);\r\n```\r\nthe logs show, that the deadline definitely reaches the server:\r\n> 2023-03-22 17:53:00,660 INFO  [org.acm.MetadataInterceptor] (vert.x-eventloop-thread-0) Metadata received: Metadata(content-type=application/grpc,user-agent=grpc-java-netty/1.51.1,grpc-accept-encoding=gzip,grpc-timeout=29914666u)\r\n\r\nSee the reproducer for the code. The Context is also empty when removing the ServerInterceptor.\r\n\r\nI am not sure at which version this problem was introduced, but can tell, that it worked correctly with Quarkus 2.3.0, but failed with Quarkus 2.14.0 and 2.16.4. My assumption is, that this was introduced with this PR: https://github.com/quarkusio/quarkus/pull/23731 in version 2.7.2.\n\n### Expected behavior\n\n- The io.grpc.Context given by `Context.current()` should return the actual Context object.\r\n- When the gRPC client sets a deadline, running `Context.current().getDeadline()` should return a non-null Deadline object representing the actual deadline set by the client.\n\n### Actual behavior\n\n- The io.grpc.Context given by `Context.current()` returns an empty Context object.\r\n- `Context.current().getDeadline()` returns null.\n\n### How to Reproduce?\n\nReproducer: https://github.com/theWalli/quarkus-grpc-bug-empty-context-reproducer\r\n\r\nSteps to reproduce:\r\n1. Either check out the reproducer and skip to step 5, or:\r\n2. Generate application from https://code.quarkus.io/ including quarkus-grpc extension.\r\n3. Add the following to `application.properties`:\r\n```\r\nquarkus.grpc.clients.\"helloGrpc\".host=localhost\r\nquarkus.grpc.clients.\"helloGrpc\".port=9001\r\nquarkus.grpc.clients.\"helloGrpc\".deadline=30\r\n```\r\n4. Add following to `HelloGrpcService.sayHello`:\r\n```\r\nDeadline deadline = Context.current().getDeadline();\r\nif (deadline != null) {\r\n    System.out.println(name + \" - Deadline: \" + deadline);\r\n} else {\r\n    System.out.println(name + \" - Received no deadline\");\r\n}\r\n```\r\n5. Run `./mvnw test`\n\n### Output of `uname -a` or `ver`\n\nLinux NB-PF3ALRDL 5.10.102.1-microsoft-standard-WSL2 #1 SMP Wed Mar 2 00:30:59 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux\n\n### Output of `java -version`\n\nopenjdk version \"17.0.6\" 2023-01-17 OpenJDK Runtime Environment (build 17.0.6+10-Ubuntu-0ubuntu120.04.1) OpenJDK 64-Bit Server VM (build 17.0.6+10-Ubuntu-0ubuntu120.04.1, mixed mode, sharing)\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.16.4.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.6 (84538c9988a25aec085021c365c560670ad80f63) Maven home: /home/<user>/.m2/wrapper/dists/apache-maven-3.8.6-bin/67568434/apache-maven-3.8.6 Java version: 17.0.6, vendor: Private Build, runtime: /usr/lib/jvm/java-17-openjdk-amd64 Default locale: en, platform encoding: UTF-8 OS name: \"linux\", version: \"5.10.102.1-microsoft-standard-wsl2\", arch: \"amd64\", family: \"unix\"\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/32046/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/32046/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
