{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21827",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21827/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21827/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21827/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/21827",
  "id": 1067599989,
  "node_id": "I_kwDOCFbutM4_okh1",
  "number": 21827,
  "title": "Amazon Lambda tests fail with 404, but devmode works fine",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1326073020,
      "node_id": "MDU6TGFiZWwxMzI2MDczMDIw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/amazon-lambda",
      "name": "area/amazon-lambda",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 8,
  "created_at": "2021-11-30T19:32:01Z",
  "updated_at": "2023-12-04T13:06:29Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nFollowing along with the guide for the updates to the amazon-lambda dependency where we can now call the `MockEventServer` both in devmode and in tests; I've updated our project and devmode works fine, but tests all fail with a 404 not found. \r\n\r\n\r\n\r\n### Expected behavior\r\n\r\nI would expect tests to work the same way devmode does. I should be able to hit the test port with an event, and have it respond. \r\n\r\n### Actual behavior\r\n\r\nThe tests always fail with a 404 not found, but sometimes the error includes the below `this.http` one:\r\n\r\nError:\r\n\r\n```\r\n2021-11-29 16:11:22,652 DEBUG [org.jbo.res.res.i18n] (executor-thread-1) RESTEASY002315: PathInfo: /_lambda_/2018-06-01/runtime/invocation/next\r\n2021-11-29 16:11:22,652 DEBUG [org.jbo.res.res.i18n] (executor-thread-1) RESTEASY002305: Failed executing GET /_lambda_/2018-06-01/runtime/invocation/next: javax.ws.rs.NotFoundException: RESTEASY003210: Could not find resource for full path: http://localhost:8083/_lambda_/2018-06-01/runtime/invocation/next\r\n    at org.jboss.resteasy.core.registry.ClassNode.match(ClassNode.java:70)\r\n    at org.jboss.resteasy.core.registry.RootClassNode.match(RootClassNode.java:47)\r\n    at org.jboss.resteasy.core.ResourceMethodRegistry.getResourceInvoker(ResourceMethodRegistry.java:480)\r\n    at org.jboss.resteasy.core.SynchronousDispatcher.getInvoker(SynchronousDispatcher.java:332)\r\n    at org.jboss.resteasy.core.SynchronousDispatcher.lambda$invoke$4(SynchronousDispatcher.java:253)\r\n    at org.jboss.resteasy.core.SynchronousDispatcher.lambda$preprocess$0(SynchronousDispatcher.java:161)\r\n    at org.jboss.resteasy.core.interception.jaxrs.PreMatchContainerRequestContext.filter(PreMatchContainerRequestContext.java:364)\r\n    at org.jboss.resteasy.core.SynchronousDispatcher.preprocess(SynchronousDispatcher.java:164)\r\n    at org.jboss.resteasy.core.SynchronousDispatcher.invoke(SynchronousDispatcher.java:247)\r\n    at org.jboss.resteasy.plugins.server.servlet.ServletContainerDispatcher.service(ServletContainerDispatcher.java:249)\r\n    at io.quarkus.resteasy.runtime.ResteasyFilter$ResteasyResponseWrapper.service(ResteasyFilter.java:70)\r\n    at io.quarkus.resteasy.runtime.ResteasyFilter$ResteasyResponseWrapper.sendError(ResteasyFilter.java:76)\r\n    at io.undertow.servlet.handlers.DefaultServlet.doGet(DefaultServlet.java:172)\r\n    at javax.servlet.http.HttpServlet.service(HttpServlet.java:503)\r\n    at javax.servlet.http.HttpServlet.service(HttpServlet.java:590)\r\n    at io.undertow.servlet.handlers.ServletHandler.handleRequest(ServletHandler.java:74)\r\n    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:129)\r\n    at io.quarkus.resteasy.runtime.ResteasyFilter.doFilter(ResteasyFilter.java:31)\r\n    at io.undertow.servlet.core.ManagedFilter.doFilter(ManagedFilter.java:61)\r\n    at io.undertow.servlet.handlers.FilterHandler$FilterChainImpl.doFilter(FilterHandler.java:131)\r\n    at io.undertow.servlet.handlers.FilterHandler.handleRequest(FilterHandler.java:84)\r\n    at io.undertow.servlet.handlers.security.ServletSecurityRoleHandler.handleRequest(ServletSecurityRoleHandler.java:63)\r\n    at io.undertow.servlet.handlers.ServletChain$1.handleRequest(ServletChain.java:68)\r\n    at io.undertow.servlet.handlers.ServletDispatchingHandler.handleRequest(ServletDispatchingHandler.java:36)\r\n    at io.undertow.servlet.handlers.RedirectDirHandler.handleRequest(RedirectDirHandler.java:67)\r\n    at io.undertow.servlet.handlers.security.SSLInformationAssociationHandler.handleRequest(SSLInformationAssociationHandler.java:133)\r\n    at io.undertow.servlet.handlers.security.ServletAuthenticationCallHandler.handleRequest(ServletAuthenticationCallHandler.java:57)\r\n    at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)\r\n    at io.undertow.security.handlers.AbstractConfidentialityHandler.handleRequest(AbstractConfidentialityHandler.java:46)\r\n    at io.undertow.servlet.handlers.security.ServletConfidentialityConstraintHandler.handleRequest(ServletConfidentialityConstraintHandler.java:65)\r\n    at io.undertow.security.handlers.AuthenticationMechanismsHandler.handleRequest(AuthenticationMechanismsHandler.java:60)\r\n    at io.undertow.servlet.handlers.security.CachedAuthenticatedSessionHandler.handleRequest(CachedAuthenticatedSessionHandler.java:77)\r\n    at io.undertow.security.handlers.NotificationReceiverHandler.handleRequest(NotificationReceiverHandler.java:50)\r\n    at io.undertow.security.handlers.AbstractSecurityContextAssociationHandler.handleRequest(AbstractSecurityContextAssociationHandler.java:43)\r\n    at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)\r\n    at io.undertow.server.handlers.PredicateHandler.handleRequest(PredicateHandler.java:43)\r\n    at io.undertow.servlet.handlers.ServletInitialHandler.handleFirstRequest(ServletInitialHandler.java:247)\r\n    at io.undertow.servlet.handlers.ServletInitialHandler.access$100(ServletInitialHandler.java:56)\r\n    at io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:111)\r\n    at io.undertow.servlet.handlers.ServletInitialHandler$2.call(ServletInitialHandler.java:108)\r\n    at io.undertow.servlet.core.ServletRequestContextThreadSetupAction$1.call(ServletRequestContextThreadSetupAction.java:48)\r\n    at io.undertow.servlet.core.ContextClassLoaderSetupAction$1.call(ContextClassLoaderSetupAction.java:43)\r\n    at io.quarkus.undertow.runtime.UndertowDeploymentRecorder$9$1.call(UndertowDeploymentRecorder.java:584)\r\n    at io.undertow.servlet.handlers.ServletInitialHandler.dispatchRequest(ServletInitialHandler.java:227)\r\n    at io.undertow.servlet.handlers.ServletInitialHandler.handleRequest(ServletInitialHandler.java:152)\r\n    at io.quarkus.undertow.runtime.UndertowDeploymentRecorder$1.handleRequest(UndertowDeploymentRecorder.java:119)\r\n    at io.undertow.server.Connectors.executeRootHandler(Connectors.java:290)\r\n    at io.undertow.server.DefaultExchangeHandler.handle(DefaultExchangeHandler.java:18)\r\n    at io.quarkus.undertow.runtime.UndertowDeploymentRecorder$5$1.run(UndertowDeploymentRecorder.java:406)\r\n    at java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n    at io.quarkus.vertx.core.runtime.VertxCoreRecorder$13.runWith(VertxCoreRecorder.java:543)\r\n    at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n    at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n    at org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n    at org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n    at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n    at java.base/java.lang.Thread.run(Thread.java:831)\r\n\r\n2021-11-29 16:11:22,659 ERROR [io.qua.ama.lam.run.AbstractLambdaPollLoop] (Lambda Thread (TEST)) Error running lambda (TEST): java.lang.NullPointerException: Cannot invoke \"sun.net.www.http.HttpClient.getInputStream()\" because \"this.http\" is null\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1690)\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1577)\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:3206)\r\n    at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:82)\r\n    at java.base/java.lang.Thread.run(Thread.java:831)\r\n\r\n2021-11-29 16:11:22,661 ERROR [io.qua.ama.lam.run.AbstractLambdaPollLoop] (Lambda Thread (TEST)) Lambda init error (TEST): java.lang.RuntimeException: java.lang.NullPointerException: Cannot invoke \"sun.net.www.http.HttpClient.getInputStream()\" because \"this.http\" is null\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1595)\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1577)\r\n    at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:149)\r\n    at java.base/java.lang.Thread.run(Thread.java:831)\r\nCaused by: java.lang.NullPointerException: Cannot invoke \"sun.net.www.http.HttpClient.getInputStream()\" because \"this.http\" is null\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1690)\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1577)\r\n    at java.base/sun.net.www.protocol.http.HttpURLConnection.getHeaderField(HttpURLConnection.java:3206)\r\n    at io.quarkus.amazon.lambda.runtime.AbstractLambdaPollLoop$1.run(AbstractLambdaPollLoop.java:82)\r\n    ... 1 more\r\n\r\n2021-11-29 16:11:22,692 DEBUG [io.qua.arc.impl] (main) ArC DI container shut down\r\n\r\n```\r\n\r\n### How to Reproduce?\r\n\r\n[example-bug.zip](https://github.com/quarkusio/quarkus/files/7628298/example-bug.zip)\r\n\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nDarwin SR-MB-300245 21.1.0 Darwin Kernel Version 21.1.0: Wed Oct 13 17:33:23 PDT 2021; root:xnu-8019.41.5~1/RELEASE_X86_64 x86_64\r\n\r\n### Output of `java -version`\r\n\r\n openjdk version \"11.0.10\" 2021-01-19 OpenJDK Runtime Environment GraalVM CE 21.0.0 (build 11.0.10+8-jvmci-21.0-b06) OpenJDK 64-Bit Server VM GraalVM CE 21.0.0 (build 11.0.10+8-jvmci-21.0-b06, mixed mode, sharing) (use asdf to get the exact version)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\ngraalvm-21.0.0+java11\r\n\r\n### Quarkus version or git rev\r\n\r\n2.4.2.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n3.6.3 (asdf)\r\n\r\n### Additional information\r\n\r\nhttps://quarkusio.zulipchat.com/#narrow/stream/187030-users/topic/AWS.20Lambda.20MockEventServer.20tests",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21827/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21827/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
