{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/35580",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35580/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35580/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35580/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/35580",
  "id": 1868161590,
  "node_id": "I_kwDOCFbutM5vWeI2",
  "number": 35580,
  "title": "Running QuarkusUnitTest with Gradle causes LogManager class cast exceptions",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026591,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTkx",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/gradle",
      "name": "area/gradle",
      "color": "0366d6",
      "default": false,
      "description": "Gradle"
    },
    {
      "id": 1287515315,
      "node_id": "MDU6TGFiZWwxMjg3NTE1MzE1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kotlin",
      "name": "area/kotlin",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 2,
  "created_at": "2023-08-26T16:18:41Z",
  "updated_at": "2023-08-26T21:19:16Z",
  "closed_at": "2023-08-26T21:09:23Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nPerhaps there's a miss in the instructions or my setup, but I couldn't really find any extensions built on Gradle to use as an example, so marking this as a bug given that the Gradle code has been the same for 8 years, but the Quarkus unit test code changed 3 years ago.\r\n\r\nWhen Gradle launches a build, it initializes the root JUL logger in this class: https://github.com/gradle/gradle/blob/master/subprojects/logging/src/main/java/org/gradle/internal/logging/source/JavaUtilLoggingSystem.java#L55. \r\n\r\nThis happens just as the Gradle process is launching and before any dependencies are resolved, so at this point it's impossible to set the log manager to be `org.jboss.logmanager.LogManager`, as that'll result in a `java.lang.ClassNotFoundException` when the JUL logger tries to find it, before the build continues as normal.\r\n\r\nThe `QuarkusUnitTest` class however gets the root logger and tries to cast it to an instance of the `org.jboss.logmanager.Logger` class here: https://github.com/quarkusio/quarkus/blob/main/test-framework/junit5-internal/src/main/java/io/quarkus/test/QuarkusUnitTest.java#L97.\r\n\r\nThat however results in tests failing because of a `java.lang.ClassCastException` when trying to cast `java.util.logging.LogManager$RootLogger` to `org.jboss.logmanager.Logger`, as the root logger has already been initialized to the default JUL log manager, not the jboss one.\r\n\r\nAs a result of this, no extension unit tests can run as part of a Gradle build.\n\n### Expected behavior\n\nThe tests should be able to initialize and run.\n\n### Actual behavior\n\nAll tests using the `QuarkusUnitTest` extension fail on initialization when running `./gradlew build test` with the following stack trace:\r\n```\r\njava.lang.ExceptionInInitializerError\r\n\tat com.rivian.services.platform.http.RestClientProducerTest.<clinit>(RestClientProducerTest.java:17)\r\n\tat java.base/jdk.internal.misc.Unsafe.ensureClassInitialized0(Native Method)\r\n\tat java.base/jdk.internal.misc.Unsafe.ensureClassInitialized(Unsafe.java:1155)\r\n\tat java.base/jdk.internal.reflect.UnsafeFieldAccessorFactory.newFieldAccessor(UnsafeFieldAccessorFactory.java:42)\r\n\tat java.base/jdk.internal.reflect.ReflectionFactory.newFieldAccessor(ReflectionFactory.java:185)\r\n\tat java.base/java.lang.reflect.Field.acquireFieldAccessor(Field.java:1132)\r\n\tat java.base/java.lang.reflect.Field.getFieldAccessor(Field.java:1113)\r\n\tat java.base/java.lang.reflect.Field.get(Field.java:425)\r\n\tat org.junit.platform.commons.util.ReflectionUtils.lambda$tryToReadFieldValue$5(ReflectionUtils.java:673)\r\n\tat org.junit.platform.commons.function.Try.lambda$call$0(Try.java:57)\r\n\tat org.junit.platform.commons.function.Try.of(Try.java:93)\r\n\tat org.junit.platform.commons.function.Try.call(Try.java:57)\r\n\tat org.junit.platform.commons.util.ReflectionUtils.tryToReadFieldValue(ReflectionUtils.java:673)\r\n\tat org.junit.jupiter.engine.descriptor.ExtensionUtils.lambda$registerExtensionsFromFields$4(ExtensionUtils.java:106)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n\tat java.base/java.util.stream.SortedOps$SizedRefSortingSink.end(SortedOps.java:357)\r\n\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:510)\r\n\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n\tat java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n\tat java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596)\r\n\tat org.junit.jupiter.engine.descriptor.ExtensionUtils.registerExtensionsFromFields(ExtensionUtils.java:98)\r\n\tat org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.prepare(ClassBasedTestDescriptor.java:154)\r\n\tat org.junit.jupiter.engine.descriptor.ClassBasedTestDescriptor.prepare(ClassBasedTestDescriptor.java:84)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$prepare$2(NodeTestTask.java:123)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.prepare(NodeTestTask.java:123)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:90)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:147)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:127)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:90)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:55)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:102)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:54)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:114)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:86)\r\n\tat org.junit.platform.launcher.core.DefaultLauncherSession$DelegatingLauncher.execute(DefaultLauncherSession.java:86)\r\n\tat org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor$CollectAllTestClassesExecutor.processAllTestClasses(JUnitPlatformTestClassProcessor.java:118)\r\n\tat org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor$CollectAllTestClassesExecutor.access$000(JUnitPlatformTestClassProcessor.java:93)\r\n\tat org.gradle.api.internal.tasks.testing.junitplatform.JUnitPlatformTestClassProcessor.stop(JUnitPlatformTestClassProcessor.java:88)\r\n\tat org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.stop(SuiteTestClassProcessor.java:62)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36)\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)\r\n\tat org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:33)\r\n\tat org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:94)\r\n\tat jdk.proxy2/jdk.proxy2.$Proxy5.stop(Unknown Source)\r\n\tat org.gradle.api.internal.tasks.testing.worker.TestWorker$3.run(TestWorker.java:193)\r\n\tat org.gradle.api.internal.tasks.testing.worker.TestWorker.executeAndMaintainThreadName(TestWorker.java:129)\r\n\tat org.gradle.api.internal.tasks.testing.worker.TestWorker.execute(TestWorker.java:100)\r\n\tat org.gradle.api.internal.tasks.testing.worker.TestWorker.execute(TestWorker.java:60)\r\n\tat org.gradle.process.internal.worker.child.ActionExecutionWorker.execute(ActionExecutionWorker.java:56)\r\n\tat org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call(SystemApplicationClassLoaderWorker.java:113)\r\n\tat org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call(SystemApplicationClassLoaderWorker.java:65)\r\n\tat worker.org.gradle.process.internal.worker.GradleWorkerMain.run(GradleWorkerMain.java:69)\r\n\tat worker.org.gradle.process.internal.worker.GradleWorkerMain.main(GradleWorkerMain.java:74)\r\nCaused by: java.lang.ClassCastException: class java.util.logging.LogManager$RootLogger cannot be cast to class org.jboss.logmanager.Logger (java.util.logging.LogManager$RootLogger is in module java.logging of loader 'bootstrap'; org.jboss.logmanager.Logger is in unnamed module of loader 'app')\r\n\tat io.quarkus.test.QuarkusUnitTest.<clinit>(QuarkusUnitTest.java:97)\r\n\t... 73 more\r\n```\r\n\r\nWhen running `./gradlew -Djava.util.logging.manager=org.jboss.logmanager.LogManager build test`, tests fail with the exact same exception, but the following stack trace is also logged before any Gradle task begins running:\r\n```\r\nCould not load Logmanager \"org.jboss.logmanager.LogManager\"\r\njava.lang.ClassNotFoundException: org.jboss.logmanager.LogManager\r\n\tat java.base/java.net.URLClassLoader.findClass(URLClassLoader.java:445)\r\n\tat java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:587)\r\n\tat java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:520)\r\n\tat java.logging/java.util.logging.LogManager$1.run(LogManager.java:239)\r\n\tat java.logging/java.util.logging.LogManager$1.run(LogManager.java:223)\r\n\tat java.base/java.security.AccessController.doPrivileged(AccessController.java:318)\r\n\tat java.logging/java.util.logging.LogManager.<clinit>(LogManager.java:222)\r\n\tat java.logging/java.util.logging.Logger.demandLogger(Logger.java:649)\r\n\tat java.logging/java.util.logging.Logger.getLogger(Logger.java:718)\r\n\tat java.logging/java.util.logging.Logger.getLogger(Logger.java:702)\r\n\tat org.gradle.internal.logging.source.JavaUtilLoggingSystem.<init>(JavaUtilLoggingSystem.java:55)\r\n\tat org.gradle.internal.logging.services.LoggingServiceRegistry.createLoggingManagerFactory(LoggingServiceRegistry.java:136)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat org.gradle.internal.reflect.JavaMethod.invoke(JavaMethod.java:125)\r\n\tat org.gradle.internal.service.ReflectionBasedServiceMethod.invoke(ReflectionBasedServiceMethod.java:34)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry$FactoryMethodService.invokeMethod(DefaultServiceRegistry.java:911)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry$FactoryService.createServiceInstance(DefaultServiceRegistry.java:838)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry$ManagedObjectServiceProvider.getInstance(DefaultServiceRegistry.java:623)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry$SingletonService.get(DefaultServiceRegistry.java:686)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry.find(DefaultServiceRegistry.java:324)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry.get(DefaultServiceRegistry.java:308)\r\n\tat org.gradle.internal.service.DefaultServiceRegistry.get(DefaultServiceRegistry.java:303)\r\n\tat org.gradle.internal.logging.services.LoggingServiceRegistry.newCommandLineProcessLogging(LoggingServiceRegistry.java:76)\r\n\tat org.gradle.launcher.cli.DefaultCommandLineActionFactory.createLoggingServices(DefaultCommandLineActionFactory.java:119)\r\n\tat org.gradle.launcher.cli.DefaultCommandLineActionFactory.convert(DefaultCommandLineActionFactory.java:75)\r\n\tat org.gradle.launcher.Main.doAction(Main.java:35)\r\n\tat org.gradle.launcher.bootstrap.EntryPoint.run(EntryPoint.java:50)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat org.gradle.launcher.bootstrap.ProcessBootstrap.runNoExit(ProcessBootstrap.java:60)\r\n\tat org.gradle.launcher.bootstrap.ProcessBootstrap.run(ProcessBootstrap.java:37)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat org.gradle.launcher.GradleMain.main(GradleMain.java:34)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat org.gradle.wrapper.BootstrapMainStarter.start(BootstrapMainStarter.java:35)\r\n\tat org.gradle.wrapper.WrapperExecutor.execute(WrapperExecutor.java:103)\r\n\tat org.gradle.wrapper.GradleWrapperMain.main(GradleWrapperMain.java:66)\r\n```\n\n### How to Reproduce?\n\nFollow the Gradle documentation here: https://github.com/quarkusio/quarkus/blob/main/docs/src/main/asciidoc/building-my-first-extension.adoc to build a Gradle extension. Note some things in that document don't work, for example changing the name of a project via `name = 'greeting-extension'` is not supported as it's a read-only value.\r\n\r\nAlternatively, clone https://github.com/michaeldimchuk/quarkus-greeting-extension and run `./gradlew build test` in the root of the project.\n\n### Output of `uname -a` or `ver`\n\nDarwin 22.5.0 Darwin Kernel Version 22.5.0: Thu Jun  8 22:22:22 PDT 2023; root:xnu-8796.121.3~7/RELEASE_X86_64 x86_64\n\n### Output of `java -version`\n\nopenjdk version \"17.0.4.1\" 2022-08-12\n\n### GraalVM version (if different from Java)\n\nN/A\n\n### Quarkus version or git rev\n\n3.3.0\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nGradle 8.2.1\n\n### Additional information\n\nopenjdk version \"17.0.4.1\" 2022-08-12\r\nOpenJDK Runtime Environment Homebrew (build 17.0.4.1+1)\r\nOpenJDK 64-Bit Server VM Homebrew (build 17.0.4.1+1, mixed mode, sharing)\r\n\r\n------------------------------------------------------------\r\nGradle 8.2.1\r\n------------------------------------------------------------\r\n\r\nBuild time:   2023-07-10 12:12:35 UTC\r\nRevision:     a38ec64d3c4612da9083cc506a1ccb212afeecaa\r\n\r\nKotlin:       1.8.20\r\nGroovy:       3.0.17\r\nAnt:          Apache Ant(TM) version 1.10.13 compiled on January 4 2023\r\nJVM:          17.0.4.1 (Homebrew 17.0.4.1+1)\r\nOS:           Mac OS X 13.4.1 x86_64",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/35580/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35580/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
