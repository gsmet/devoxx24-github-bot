{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/38814",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38814/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38814/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38814/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/38814",
  "id": 2138319563,
  "node_id": "I_kwDOCFbutM5_dCrL",
  "number": 38814,
  "title": "Memory usage increased between Quarkus 3.6 and 3.7",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/345",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/345",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/345/labels",
    "id": 11440331,
    "node_id": "MI_kwDOCFbutM4ArpDL",
    "number": 345,
    "title": "3.16 - main",
    "description": "",
    "creator": {
      "login": "quarkusbot",
      "id": 61254497,
      "node_id": "MDQ6VXNlcjYxMjU0NDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/61254497?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/quarkusbot",
      "html_url": "https://github.com/quarkusbot",
      "followers_url": "https://api.github.com/users/quarkusbot/followers",
      "following_url": "https://api.github.com/users/quarkusbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/quarkusbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/quarkusbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/quarkusbot/subscriptions",
      "organizations_url": "https://api.github.com/users/quarkusbot/orgs",
      "repos_url": "https://api.github.com/users/quarkusbot/repos",
      "events_url": "https://api.github.com/users/quarkusbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/quarkusbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 110,
    "state": "open",
    "created_at": "2024-08-14T07:55:40Z",
    "updated_at": "2024-09-02T12:40:31Z",
    "due_on": null,
    "closed_at": null
  },
  "comments": 55,
  "created_at": "2024-02-16T10:38:50Z",
  "updated_at": "2024-08-30T08:46:59Z",
  "closed_at": "2024-08-30T07:36:02Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nI have an extension test in the quarkus-pact project that started OOMing in the ecosystem CI recently. I've worked around the issue by increasing the memory available to the test, but we may want to investigate why the memory requirements have increased.\r\n\r\nI can reproduce just by starting the Quarkus application with constrained memory (it fails to start). The application has two pact extensions in it, so it does more classloading than a simpler application. With Quarkus 3.6, the app starts, and with 3.7, it fails to start. I can force a failure on Quarkus 3.6 by dropping the available memory down to 110mb (from 128mb), so even with Quarkus 3.6, the memory usage was fairly high - 3.7 just happens to be the release that tipped it over the edge into failure. \r\n\r\nThe ecosystem CI caught the change: https://github.com/quarkiverse/quarkiverse/issues/94#issuecomment-1837901693. This is the CI run where the problem first appeared, which might help us identify a specific change: https://github.com/quarkiverse/quarkus-pact/actions/runs/7082294368\r\n\r\nMy initial guess is that this is related to classloading, but I don't have firm evidence. It could also be test execution. If I give the applications more memory, so that it doesn't OOM, and then trigger a dump once startup is finished, the 3.6 and 3.7 dumps both use about 81mb of memory, and look similar.\n\n### Expected behavior\n\n_No response_\n\n### Actual behavior\n\n_No response_\n\n### How to Reproduce?\n\nI've attached a reproducer app. Unzip it, and then run \r\n\r\n```\r\nmvn quarkus:dev -Djvm.args=\"-Xmx128m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=pact-dump.hprof\"\r\n```\r\n\r\nFor more control, another way to reproduce is \r\n\r\n1. Clone https://github.com/quarkiverse/quarkus-pact\r\n2. Build with `mvn install`. It should pass.\r\n3. Edit https://github.com/quarkiverse/quarkus-pact/blob/e00179e4f5e0ab5c3b434393edd4e80ab3551766/cross-extension-integration-tests/src/test/java/io/quarkiverse/pact/it/DevModeContractTestIT.java#L76 and change `140m` to `128m`, the default. (I had to override the default memory allocation from the parent test class to get the test to pass.)\r\n4. `cd cross-extension-integration-tests && mvn clean install` should now show the failure\r\n5. Once everything is built, you can also\r\n[happy-everyone-all-together-processed.zip](https://github.com/quarkusio/quarkus/files/14309817/happy-everyone-all-together-processed.zip)\r\n run the test project standalone. \r\n\r\n```\r\ncd quarkus-pact/cross-extension-integration-tests/target/test-classes/projects/happy-everyone-all-together-processed\r\nmvn quarkus:dev -Djvm.args=\"-Xmx110m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=pact-dump.hprof\"\r\n```\r\n\r\n\r\n\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### Quarkus version or git rev\n\n_No response_\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/38814/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/38814/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
