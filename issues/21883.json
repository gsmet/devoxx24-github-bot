{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21883",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21883/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21883/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21883/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/21883",
  "id": 1069457517,
  "node_id": "I_kwDOCFbutM4_vqBt",
  "number": 21883,
  "title": "Quarkus:Native build fails when using azure-identity pom dependencies",
  "labels": [
    {
      "id": 985346626,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjY=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/question",
      "name": "kind/question",
      "color": "d876e3",
      "default": false,
      "description": "Further information is requested"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 2,
  "created_at": "2021-12-02T11:50:31Z",
  "updated_at": "2021-12-02T13:06:55Z",
  "closed_at": "2021-12-02T13:02:44Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI was trying to authenticate a serviceclient using service principal . On using the azure-identity dependency , it builds a lot of reflections . I tried removing them using lazy initialization by using the --initialize-at-run-time , but even after including the java.security.SecureRandom  class in the args , the class gets initialized at build time ,resulting a build failure. Please check the reproducer code's application.properties file for further details\r\n\r\n### Expected behavior\r\n\r\nNative Build should be built successfully\r\n\r\n### Actual behavior\r\n\r\n```\r\n/project:z --name build-native-dHJoo quay.io/quarkus/ubi-quarkus-native-image:21.3-java11 -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dsun.nio.ch.maxUpdateArraySize=100 -J-Dvertx.logger-delegate-factory-class-name=io.quarkus.vertx.core.runtime.VertxLogDelegateFactory -J-Dvertx.disableDnsResolver=true -J-Dio.netty.leakDetection.level=DISABLED -J-Dio.netty.allocator.maxOrder=3 -J-Duser.language=en -J-Duser.country=US -J-Dfile.encoding=UTF-8 -H:-ParseOnce --initialize-at-run-time=com.microsoft.aad.msal4jextensions.persistence.linux.ISecurityLibrary,com.microsoft.aad.msal4jextensions.persistence.mac.ISecurityLibrary,com.sun.jna.platform.win32.Crypt32,com.sun.jna.platform.win32.Kernel32,java.security.SecureRandom,com.nimbusds.jwt.JWTClaimsSet --trace-class-initialization=java.security.SecureRandom -H:InitialCollectionPolicy=com.oracle.svm.core.genscavenge.CollectionPolicy\\$BySpaceAndTime -H:+JNI -H:+AllowFoldMethods -H:FallbackThreshold=0 -H:+ReportExceptionStackTraces -H:-AddAllCharsets -H:EnableURLProtocols=http -H:-UseServiceLoaderFeature -H:+StackTrace -H:AdditionalSecurityProviders=com.sun.security.sasl.Provider,org.apache.kafka.common.security.oauthbearer.internals.OAuthBearerSaslClientProvider,org.apache.kafka.common.security.scram.internals.ScramSaslClientProvider 2.0v-runner -jar 2.0v-runner.jar\r\n[2.0v-runner:25] classlist: 8,111.60 ms, 2.68 GB\r\n[2.0v-runner:25] (cap): 682.64 ms, 2.68 GB\r\n[2.0v-runner:25] setup: 2,899.51 ms, 2.68 GB\r\n11:12:21,924 INFO [com.azu.cor.imp.jac.JacksonVersion] Package versions: jackson-annotations=2.12.5, jackson-core=2.12.5, jackson-databind=2.12.5, jackson-dataformat-xml=2.12.5, jackson-datatype-jsr310=2.12.5, azure-core=1.21.0\r\nTo see how the classes got initialized, use --trace-class-initialization=java.security.SecureRandom\r\n[nm-iot-egress-2.0v-runner:25] analysis: 9,061.83 ms, 2.64 GB\r\nError: Classes that should be initialized at run time got initialized during image building:\r\njava.security.SecureRandom the class was requested to be initialized at run time (from the command line with 'java.security.SecureRandom'). To see why java.security.SecureRandom got initialized use --trace-class-initialization=java.security.SecureRandom\r\n\r\n\r\n\r\ncom.oracle.svm.core.util.UserError$UserException: Classes that should be initialized at run time got initialized during image building:\r\njava.security.SecureRandom the class was requested to be initialized at run time (from the command line with 'java.security.SecureRandom'). To see why java.security.SecureRandom got initialized use --trace-class-initialization=java.security.SecureRandom\r\n\r\n\r\n\r\nat com.oracle.svm.core.util.UserError.abort(UserError.java:73)\r\nat com.oracle.svm.hosted.classinitialization.ConfigurableClassInitialization.checkDelayedInitialization(ConfigurableClassInitialization.java:555)\r\nat com.oracle.svm.hosted.classinitialization.ClassInitializationFeature.duringAnalysis(ClassInitializationFeature.java:168)\r\nat com.oracle.svm.hosted.NativeImageGenerator.lambda$runPointsToAnalysis$12(NativeImageGenerator.java:727)\r\nat com.oracle.svm.hosted.FeatureHandler.forEachFeature(FeatureHandler.java:73)\r\nat com.oracle.svm.hosted.NativeImageGenerator.runPointsToAnalysis(NativeImageGenerator.java:727)\r\nat com.oracle.svm.hosted.NativeImageGenerator.doRun(NativeImageGenerator.java:529)\r\nat com.oracle.svm.hosted.NativeImageGenerator.run(NativeImageGenerator.java:488)\r\nat com.oracle.svm.hosted.NativeImageGeneratorRunner.buildImage(NativeImageGeneratorRunner.java:403)\r\nat com.oracle.svm.hosted.NativeImageGeneratorRunner.build(NativeImageGeneratorRunner.java:569)\r\nat com.oracle.svm.hosted.NativeImageGeneratorRunner.main(NativeImageGeneratorRunner.java:122)\r\nat com.oracle.svm.hosted.NativeImageGeneratorRunner$JDK9Plus.main(NativeImageGeneratorRunner.java:599)\r\n[nm-iot-egress-2.0v-runner:25] [total]: 20,469.69 ms, 2.64 GB\r\n# Printing build artifacts to: /project/nm-iot-egress-2.0v-runner.build_artifacts.txt\r\nError: Image build request failed with exit status 1\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] BUILD FAILURE\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] Total time: 46.364 s\r\n[INFO] Finished at: 2021-12-02T16:42:25+05:30\r\n[INFO] ------------------------------------------------------------------------\r\n[ERROR] Failed to execute goal io.quarkus:quarkus-maven-plugin:2.5.0.Final:build (default) on project nm-iot-egress: Failed to build quarkus application: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n[ERROR] [error]: Build step io.quarkus.deployment.pkg.steps.NativeImageBuildStep#build threw an exception: java.lang.RuntimeException: Failed to build native image\r\n[ERROR] at io.quarkus.deployment.pkg.steps.NativeImageBuildStep.build(NativeImageBuildStep.java:233)\r\n[ERROR] at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n[ERROR] at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n[ERROR] at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n[ERROR] at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n[ERROR] at io.quarkus.deployment.ExtensionLoader$2.execute(ExtensionLoader.java:887)\r\n[ERROR] at io.quarkus.builder.BuildContext.run(BuildContext.java:277)\r\n[ERROR] at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n[ERROR] at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n[ERROR] at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n[ERROR] at java.base/java.lang.Thread.run(Thread.java:829)\r\n[ERROR] at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\n[ERROR] Caused by: java.lang.RuntimeException: Image generation failed. Exit code: 1\r\n[ERROR] at io.quarkus.deployment.pkg.steps.NativeImageBuildStep.imageGenerationFailed(NativeImageBuildStep.java:369)\r\n[ERROR] at io.quarkus.deployment.pkg.steps.NativeImageBuildStep.build(NativeImageBuildStep.java:213)\r\n[ERROR] ... 11 more\r\n[ERROR] -> [Help 1]\r\n[ERROR]\r\n[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.\r\n[ERROR] Re-run Maven using the -X switch to enable full debug logging.\r\n[ERROR]\r\n[ERROR] For more information about the errors and possible solutions, please read the following articles:\r\n[ERROR] [Help 1\r\n```\r\n\r\n### How to Reproduce?\r\n\r\nReproducing the issue:\r\n1.  Clone the project from\r\n(https://github.com/uttamsingh0107/quarkus-reproducable)\r\n 2.Run the command \"mvn package -Pnative -Dquarkus.native.container-build=true\"\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nLinux\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"11.0.13\" 2021-10-19 LTS OpenJDK Runtime Environment 18.9 (build 11.0.13+8-LTS) OpenJDK 64-Bit Server VM 18.9 (build 11.0.13+8-LTS, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n 21.3.0\r\n\r\n### Quarkus version or git rev\r\n\r\n2.5.0.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n3.6.3\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/21883/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/21883/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
