{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27162",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27162/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27162/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27162/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/27162",
  "id": 1330394003,
  "node_id": "I_kwDOCFbutM5PTDOT",
  "number": 27162,
  "title": "\"No RESTEasy Reactive request in progress\" raised in @RequestScoped bean",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 985346625,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjU=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/triage/invalid",
      "name": "triage/invalid",
      "color": "e4e669",
      "default": false,
      "description": "This doesn't seem right"
    },
    {
      "id": 2552031458,
      "node_id": "MDU6TGFiZWwyNTUyMDMxNDU4",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/rest",
      "name": "area/rest",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 3,
  "created_at": "2022-08-05T21:06:33Z",
  "updated_at": "2022-08-08T19:28:25Z",
  "closed_at": "2022-08-08T04:31:57Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen a `@RequestScoped` bean is injected with an HTTP request context bean such as `HttpHeaders`, a error occurs when accessing the HTTP request context bean if both:\r\n\r\n- The request processing is accessing the bean on a thread other than the request thread, as may occur when returning a `Uni` from the handler.\r\n- The HTTP request context bean has *not* been previously accessed on the request thread. If was previously accessed, then it works.\r\n\r\n### Expected behavior\r\n\r\nHitting the endpoint should echo back the headers:\r\n\r\n```shell\r\n$ curl http://localhost:8080/test\r\nHeaders: [Accept=*/*,Host=localhost:8080,User-Agent=curl/7.54.0]\r\n$\r\n```\r\n\r\n### Actual behavior\r\n\r\nThe curl request fails with an exception (from server's logging since it's more readable):\r\n\r\n```posh\r\n2022-08-05 15:01:59,085 ERROR [io.qua.ver.htt.run.QuarkusErrorHandler] (vert.x-eventloop-thread-0) HTTP Request to /test failed, error id: ca5ea351-f172-4123-aeb5-1c85e1a70a73-2: java.lang.IllegalStateException: No RESTEasy Reactive request in progress\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers.getContext(ContextProducers.java:138)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers.headers(ContextProducers.java:51)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_Subclass.headers$$superforward1(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_Subclass$$function$$5.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:53)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.proceed(InvocationInterceptor.java:62)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.monitor(InvocationInterceptor.java:49)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:40)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:32)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_Subclass.headers(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_Bean.create(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_Bean.create(Unknown Source)\r\n\tat io.quarkus.arc.impl.RequestContext.getIfActive(RequestContext.java:73)\r\n\tat io.quarkus.arc.impl.ClientProxies.getDelegate(ClientProxies.java:28)\r\n\tat javax.ws.rs.core.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_ClientProxy.arc$delegate(Unknown Source)\r\n\tat javax.ws.rs.core.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_ClientProxy.getRequestHeaders(Unknown Source)\r\n\tat org.acme.TestResource$RequestDetails.dumpHeaders(TestResource.java:62)\r\n\tat org.acme.TestResource_RequestDetails_Subclass.dumpHeaders$$superforward1(Unknown Source)\r\n\tat org.acme.TestResource_RequestDetails_Subclass$$function$$1.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:53)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.proceed(InvocationInterceptor.java:62)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.monitor(InvocationInterceptor.java:49)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:40)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:32)\r\n\tat org.acme.TestResource_RequestDetails_Subclass.dumpHeaders(Unknown Source)\r\n\tat org.acme.TestResource_RequestDetails_ClientProxy.dumpHeaders(Unknown Source)\r\n\tat org.acme.TestResource.lambda$echoHeaderGood$0(TestResource.java:45)\r\n\tat io.smallrye.context.impl.wrappers.SlowContextualSupplier.get(SlowContextualSupplier.java:21)\r\n\tat io.smallrye.mutiny.operators.uni.builders.UniCreateFromItemSupplier.subscribe(UniCreateFromItemSupplier.java:28)\r\n\tat io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n\tat io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n\tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:555)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n\tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n\tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n\r\n\r\n2022-08-05 15:01:59,097 ERROR [org.jbo.res.rea.com.cor.AbstractResteasyReactiveContext] (vert.x-eventloop-thread-0) Request failed: java.lang.IllegalStateException: No RESTEasy Reactive request in progress\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers.getContext(ContextProducers.java:138)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers.headers(ContextProducers.java:51)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_Subclass.headers$$superforward1(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_Subclass$$function$$5.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:53)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.proceed(InvocationInterceptor.java:62)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.monitor(InvocationInterceptor.java:49)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:40)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:32)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_Subclass.headers(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_Bean.create(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.injection.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_Bean.create(Unknown Source)\r\n\tat io.quarkus.arc.impl.RequestContext.getIfActive(RequestContext.java:73)\r\n\tat io.quarkus.arc.impl.ClientProxies.getDelegate(ClientProxies.java:28)\r\n\tat javax.ws.rs.core.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_ClientProxy.arc$delegate(Unknown Source)\r\n\tat javax.ws.rs.core.ContextProducers_ProducerMethod_headers_e2f74da907ba522e84abeecb299d68e340ff6250_ClientProxy.getRequestHeaders(Unknown Source)\r\n\tat org.acme.TestResource$RequestDetails.dumpHeaders(TestResource.java:62)\r\n\tat org.acme.TestResource_RequestDetails_Subclass.dumpHeaders$$superforward1(Unknown Source)\r\n\tat org.acme.TestResource_RequestDetails_Subclass$$function$$1.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:53)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.proceed(InvocationInterceptor.java:62)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor.monitor(InvocationInterceptor.java:49)\r\n\tat io.quarkus.arc.runtime.devconsole.InvocationInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:41)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:40)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:32)\r\n\tat org.acme.TestResource_RequestDetails_Subclass.dumpHeaders(Unknown Source)\r\n\tat org.acme.TestResource_RequestDetails_ClientProxy.dumpHeaders(Unknown Source)\r\n\tat org.acme.TestResource.lambda$echoHeaderGood$0(TestResource.java:45)\r\n\tat io.smallrye.context.impl.wrappers.SlowContextualSupplier.get(SlowContextualSupplier.java:21)\r\n\tat io.smallrye.mutiny.operators.uni.builders.UniCreateFromItemSupplier.subscribe(UniCreateFromItemSupplier.java:28)\r\n\tat io.smallrye.mutiny.operators.AbstractUni.subscribe(AbstractUni.java:36)\r\n\tat io.smallrye.mutiny.operators.uni.UniRunSubscribeOn.lambda$subscribe$0(UniRunSubscribeOn.java:27)\r\n\tat io.quarkus.vertx.core.runtime.VertxCoreRecorder$14.runWith(VertxCoreRecorder.java:555)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n\tat org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n\tat org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:29)\r\n\tat org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:29)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\n### How to Reproduce?\r\n\r\n```java\r\n@Path(\"/test\")\r\npublic class TestResource {\r\n    private RequestDetails details;\r\n\r\n    TestResource(RequestDetails details) {\r\n        this.details = details;\r\n    }\r\n\r\n    @GET\r\n    @Produces(MediaType.TEXT_PLAIN)\r\n    public Uni<String> echoHeaders(@QueryParam(\"action\") String action) {\r\n        if (action == null) {\r\n            action = \"\";\r\n        }\r\n        switch (action) {\r\n            case \"accessHTTP\":\r\n                // Access HttpHeaders proxy through proxied bean\r\n                details.dumpHeaders();\r\n                break;\r\n            case \"accessBean\":\r\n                // Access proxied bean, but not HttpHeaders proxy\r\n                details.ping();\r\n                break;\r\n        }\r\n        return Uni.createFrom()\r\n                .item(() -> details.dumpHeaders())\r\n                .runSubscriptionOn(Infrastructure.getDefaultExecutor());\r\n    }\r\n\r\n    @RequestScoped\r\n    public static class RequestDetails {\r\n        private HttpHeaders headers;\r\n\r\n        RequestDetails(HttpHeaders headers) {\r\n            this.headers = headers;\r\n        }\r\n\r\n        public void ping() {\r\n            System.out.println(\"Ping!\");\r\n        }\r\n\r\n        public String dumpHeaders() {\r\n            return \"Headers: \" + headers.getRequestHeaders() + \"\\n\";\r\n        }\r\n\r\n        @PostConstruct\r\n        void postConstruct() {\r\n            System.out.println(\"Constructed\");\r\n        }\r\n\r\n        @PreDestroy\r\n        void preDestroy() {\r\n            System.out.println(\"Destroying\");\r\n        }\r\n    }\r\n\r\n    @ApplicationScoped\r\n    public static class EagerAccessor {\r\n        private HttpHeaders headers;\r\n\r\n        EagerAccessor(HttpHeaders headers) {\r\n            this.headers = headers;\r\n        }\r\n\r\n        @ServerRequestFilter\r\n        void eagerAccess(ContainerRequestContext ctx) {\r\n            String action = ctx.getUriInfo().getQueryParameters().getFirst(\"action\");\r\n            if (action != null && action.equalsIgnoreCase(\"accessHTTPInFilter\")) {\r\n                // Access HttpHeaders proxy directly\r\n                System.out.println(\"HttpHeaders accessed\");\r\n                headers.getLength();\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nIncluded are some additional execution paths, selected by the `action` query parameter:\r\n\"accessHTTP\" accesses the HTTP context bean in the request thread (and will succeed)\r\n\"accessBean\" accesses the RequestScoped bean in the request thread (and will fail), so that the RequestScoped bean is created.\r\n\"accessHTTPInFilter\" accesses the HTTP context bean in a filter (and will succeed). \r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n18.7.0 Darwin Kernel Version 18.7.0: Tue Jun 22 19:37:08 PDT 2021; root:xnu-4903.278.70~1/RELEASE_X86_64 x86_64\r\n\r\n### Output of `java -version`\r\n\r\nopenjdk version \"17.0.4\" 2022-07-19 LTS OpenJDK Runtime Environment Corretto-17.0.4.8.1 (build 17.0.4+8-LTS) OpenJDK 64-Bit Server VM Corretto-17.0.4.8.1 (build 17.0.4+8-LTS, mixed mode, sharing)\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n2.11.2.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\nGradle 7.4.2\r\n\r\n### Additional information\r\n\r\nResults are the same regardless of whether quarkus-smallrye-context-propagation is included.\r\n\r\nThe cases in which it does work suggests to me that the lazy instantiation of the proxied HTTP request context bean is pushed outside the RestEASY request scope, but the CDI request scope is still active.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/27162/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/27162/timeline",
  "performed_via_github_app": null,
  "state_reason": "not_planned"
}
