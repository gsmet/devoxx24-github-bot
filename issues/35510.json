{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/35510",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35510/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35510/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35510/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/35510",
  "id": 1863853824,
  "node_id": "I_kwDOCFbutM5vGCcA",
  "number": 35510,
  "title": "Native Build Fails using -Dquarkus.native.builder-image ",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 2260340367,
      "node_id": "MDU6TGFiZWwyMjYwMzQwMzY3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/mandrel",
      "name": "area/mandrel",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 3,
  "created_at": "2023-08-23T18:56:14Z",
  "updated_at": "2023-09-06T08:49:25Z",
  "closed_at": "2023-09-06T08:48:54Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nWhen trying to use a GraalVM image that has `musl' libraries in it so we can build more portable native binaries, the build process fails with:\r\n\r\n```console\r\nError: Invalid Path entry licensing-cli-1.0-SNAPSHOT-runner.jar\r\nCaused by: java.nio.file.NoSuchFileException: /app/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n```\r\nThe binaries that the default Mandrel container generates doesn't work on `Centos` which is where we need to run the native  binary. We get the following error when trying to run the binary on `Centos 7`:\r\n\r\n```console\r\nThe current machine does not support all of the following CPU features that are required by the image: [CX8, CMOV, FXSR, MMX, SSE, SSE2, SSE3, SSSE3, SSE4_1, SSE4_2, POPCNT, LZCNT, AVX, AVX2, BMI1, BMI2, FMA].\r\nPlease rebuild the executable with an appropriate setting of the -march option\r\n```\r\n\r\nSo, talking with our linux guys they said we should use `muslib` and static for better portability and I am trying to use\r\nthe image from: `https://github.com/graalvm/container/pkgs/container/native-image/112524739?tag=muslib-22.3.3`\r\n\r\nThis is the command I'm using:\r\n`mvn package -P native -Dquarkus.native.container-build=true -Dquarkus.native.additional-build-args=\"--static\" -Dquarkus.native.builder-image=ghcr.io/graalvm/native-image:muslib-22.3.3`\r\n\r\nI read the following in the help docs at: https://quarkus.io/guides/building-native-image and tried the option `-Dquarkus.native.remote-container-build=true` as specified, but I still get a little different error...\r\n\r\n--- OUTPUT using -Dquarkus.native.remote-container-build ---\r\n```console\r\n[WARNING] [io.quarkus.deployment.steps.ReflectiveHierarchyStep] Unable to properly register the hierarchy of the following classes for reflection as they are not in the Jandex index:\r\n\t- jakarta.enterprise.event.Event (source: PicocliNativeImageProcessor)\r\nConsider adding them to the index either by creating a Jandex index for your dependency via the Maven plugin, an empty META-INF/beans.xml or quarkus.index-dependency properties.\r\n[INFO] [io.quarkus.deployment.pkg.steps.JarResultBuildStep] Building native image source jar: /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Building native image from /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Using docker to run the native image builder\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Checking status of builder image 'ghcr.io/graalvm/native-image:muslib-22.3.3'\r\nmuslib-22.3.3: Pulling from graalvm/native-image\r\nDigest: sha256:e3821892da6be0f0b505addd6f2c6864dc00c311ce9e4e4c661374d3bf1fb5bd\r\nStatus: Image is up to date for ghcr.io/graalvm/native-image:muslib-22.3.3\r\nghcr.io/graalvm/native-image:muslib-22.3.3\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Running Quarkus native-image plugin on GraalVM 22.3.3 Java 17 CE (Java Version 17.0.8+7-jvmci-22.3-b22)\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker volume rm quarkus-native-builder-image-project-volume\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRemoteContainerRunner] docker create --env LANG=C --rm -v quarkus-native-builder-image-project-volume:/project ghcr.io/graalvm/native-image:muslib-22.3.3\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker cp /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar/. c03d814b2847d0d08dd5c16cf74b5adc88e6892238a37cb6a75532c4770d6887:/project\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker run --env LANG=C --rm -v quarkus-native-builder-image-project-volume:/project --name build-native-PPUbc ghcr.io/graalvm/native-image:muslib-22.3.3 -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dsun.nio.ch.maxUpdateArraySize=100 -J-Dlogging.initial-configurator.min-level=500 -J-Dvertx.logger-delegate-factory-class-name=io.quarkus.vertx.core.runtime.VertxLogDelegateFactory -J-Dvertx.disableDnsResolver=true -J-Dio.netty.leakDetection.level=DISABLED -J-Dio.netty.allocator.maxOrder=3 -J-Duser.language=en -J-Duser.country=US -J-Dfile.encoding=UTF-8 --features=io.quarkus.runner.Feature,io.quarkus.runtime.graal.DisableLoggingFeature -J--add-exports=java.security.jgss/sun.security.krb5=ALL-UNNAMED -J--add-opens=java.base/java.text=ALL-UNNAMED -J--add-opens=java.base/java.io=ALL-UNNAMED -J--add-opens=java.base/java.lang.invoke=ALL-UNNAMED -J--add-opens=java.base/java.util=ALL-UNNAMED -H:+CollectImageBuildStatistics -H:ImageBuildStatisticsFile=licensing-cli-1.0-SNAPSHOT-runner-timing-stats.json -H:BuildOutputJSONFile=licensing-cli-1.0-SNAPSHOT-runner-build-output-stats.json --static -H:+AllowFoldMethods -J-Djava.awt.headless=true --no-fallback --link-at-build-time -H:+ReportExceptionStackTraces -H:-AddAllCharsets --enable-url-protocols=http,https -H:-UseServiceLoaderFeature -H:+StackTrace -J--add-exports=org.graalvm.sdk/org.graalvm.nativeimage.impl=ALL-UNNAMED --exclude-config io\\.netty\\.netty-codec /META-INF/native-image/io\\.netty/netty-codec/generated/handlers/reflect-config\\.json --exclude-config io\\.netty\\.netty-handler /META-INF/native-image/io\\.netty/netty-handler/generated/handlers/reflect-config\\.json licensing-cli-1.0-SNAPSHOT-runner -jar licensing-cli-1.0-SNAPSHOT-runner.jar\r\nError: Invalid Path entry licensing-cli-1.0-SNAPSHOT-runner.jar\r\nCaused by: java.nio.file.NoSuchFileException: /app/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker cp c03d814b2847d0d08dd5c16cf74b5adc88e6892238a37cb6a75532c4770d6887:/project/licensing-cli-1.0-SNAPSHOT-runner /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar\r\n[ERROR] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] Failed to copy native image from container volume back to the host.\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker container rm c03d814b2847d0d08dd5c16cf74b5adc88e6892238a37cb6a75532c4770d6887\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker volume rm quarkus-native-builder-image-project-volume\r\n```\r\n\r\n\r\n```\r\nIf you see the following invalid path error for your application JAR when trying to create a native executable using a container build, even though your JAR was built successfully, youâ€™re most likely using a remote daemon for your container runtime.\r\n\r\nError: Invalid Path entry getting-started-1.0.0-SNAPSHOT-runner.jar\r\nCaused by: java.nio.file.NoSuchFileException: /project/getting-started-1.0.0-SNAPSHOT-runner.jar\r\nIn this case, use the parameter -Dquarkus.native.remote-container-build=true instead of -Dquarkus.native.container-build=true.\r\n\r\nThe reason for this is that the local build driver invoked through -Dquarkus.native.container-build=true uses volume mounts to make the JAR available in the build container, but volume mounts do not work with remote daemons. The remote container build driver copies the necessary files instead of mounting them. Note that even though the remote driver also works with local daemons, the local driver should be preferred in the local case because mounting is usually more performant than copying.\r\n```\r\n\r\n---- BUILD OUTPUT using -Dquarkus.native.container-build-----\r\n```console\r\n[WARNING] [io.quarkus.deployment.steps.ReflectiveHierarchyStep] Unable to properly register the hierarchy of the following classes for reflection as they are not in the Jandex index:\r\n\t- jakarta.enterprise.event.Event (source: PicocliNativeImageProcessor)\r\nConsider adding them to the index either by creating a Jandex index for your dependency via the Maven plugin, an empty META-INF/beans.xml or quarkus.index-dependency properties.\r\n[INFO] [io.quarkus.deployment.pkg.steps.JarResultBuildStep] Building native image source jar: /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Building native image from /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Using docker to run the native image builder\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildContainerRunner] Checking status of builder image 'ghcr.io/graalvm/native-image:muslib-22.3.3'\r\nmuslib-22.3.3: Pulling from graalvm/native-image\r\nDigest: sha256:e3821892da6be0f0b505addd6f2c6864dc00c311ce9e4e4c661374d3bf1fb5bd\r\nStatus: Image is up to date for ghcr.io/graalvm/native-image:muslib-22.3.3\r\nghcr.io/graalvm/native-image:muslib-22.3.3\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildStep] Running Quarkus native-image plugin on GraalVM 22.3.3 Java 17 CE (Java Version 17.0.8+7-jvmci-22.3-b22)\r\n[INFO] [io.quarkus.deployment.pkg.steps.NativeImageBuildRunner] docker run --env LANG=C --rm --user 1003:1004 -v /home/tmulle/Development/licensing/licensing-cli/target/licensing-cli-1.0-SNAPSHOT-native-image-source-jar:/project:z --name build-native-sTbmb ghcr.io/graalvm/native-image:muslib-22.3.3 -J-Djava.util.logging.manager=org.jboss.logmanager.LogManager -J-Dsun.nio.ch.maxUpdateArraySize=100 -J-Dlogging.initial-configurator.min-level=500 -J-Dvertx.logger-delegate-factory-class-name=io.quarkus.vertx.core.runtime.VertxLogDelegateFactory -J-Dvertx.disableDnsResolver=true -J-Dio.netty.leakDetection.level=DISABLED -J-Dio.netty.allocator.maxOrder=3 -J-Duser.language=en -J-Duser.country=US -J-Dfile.encoding=UTF-8 --features=io.quarkus.runner.Feature,io.quarkus.runtime.graal.DisableLoggingFeature -J--add-exports=java.security.jgss/sun.security.krb5=ALL-UNNAMED -J--add-opens=java.base/java.text=ALL-UNNAMED -J--add-opens=java.base/java.io=ALL-UNNAMED -J--add-opens=java.base/java.lang.invoke=ALL-UNNAMED -J--add-opens=java.base/java.util=ALL-UNNAMED -H:+CollectImageBuildStatistics -H:ImageBuildStatisticsFile=licensing-cli-1.0-SNAPSHOT-runner-timing-stats.json -H:BuildOutputJSONFile=licensing-cli-1.0-SNAPSHOT-runner-build-output-stats.json --static -H:+AllowFoldMethods -J-Djava.awt.headless=true --no-fallback --link-at-build-time -H:+ReportExceptionStackTraces -H:-AddAllCharsets --enable-url-protocols=http,https -H:-UseServiceLoaderFeature -H:+StackTrace -J--add-exports=org.graalvm.sdk/org.graalvm.nativeimage.impl=ALL-UNNAMED --exclude-config io\\.netty\\.netty-codec /META-INF/native-image/io\\.netty/netty-codec/generated/handlers/reflect-config\\.json --exclude-config io\\.netty\\.netty-handler /META-INF/native-image/io\\.netty/netty-handler/generated/handlers/reflect-config\\.json licensing-cli-1.0-SNAPSHOT-runner -jar licensing-cli-1.0-SNAPSHOT-runner.jar\r\nError: Invalid Path entry licensing-cli-1.0-SNAPSHOT-runner.jar\r\nCaused by: java.nio.file.NoSuchFileException: /app/licensing-cli-1.0-SNAPSHOT-runner.jar\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] BUILD FAILURE\r\n[INFO] ------------------------------------------------------------------------\r\n[INFO] Total time:  18.623 s\r\n[INFO] Finished at: 2023-08-23T14:36:48-04:00\r\n[INFO] ------------------------------------------------------------------------\r\n[ERROR] Failed to execute goal io.quarkus.platform:quarkus-maven-plugin:3.2.4.Final:build (default) on project licensing-cli: Failed to build quarkus application: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n```\r\n\r\nAny ideas? We are looking for a solution that will run on both Fedora and Centos based systems..\r\n\r\n### Expected behavior\r\n\r\nNative binary should be successfully built\r\n\r\n### Actual behavior\r\n\r\n_No response_\r\n\r\n### How to Reproduce?\r\n\r\n_No response_\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nFedora 36\r\n\r\n### Output of `java -version`\r\n\r\n_No response_\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n_No response_\r\n\r\n### Quarkus version or git rev\r\n\r\n3.2.4.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/35510/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35510/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
