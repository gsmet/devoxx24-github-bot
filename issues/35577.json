{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/35577",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35577/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35577/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35577/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/35577",
  "id": 1868073440,
  "node_id": "I_kwDOCFbutM5vWIng",
  "number": 35577,
  "title": "dev mode is not working in a gradle multimodule setup when kotlin code is used",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026591,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTkx",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/gradle",
      "name": "area/gradle",
      "color": "0366d6",
      "default": false,
      "description": "Gradle"
    },
    {
      "id": 1273039603,
      "node_id": "MDU6TGFiZWwxMjczMDM5NjAz",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/devmode",
      "name": "area/devmode",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1287515315,
      "node_id": "MDU6TGFiZWwxMjg3NTE1MzE1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kotlin",
      "name": "area/kotlin",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 2323889171,
      "node_id": "MDU6TGFiZWwyMzIzODg5MTcx",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/jbang",
      "name": "area/jbang",
      "color": "0052cc",
      "default": false,
      "description": "Issues related to when using jbang.dev with Quarkus"
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 33,
  "created_at": "2023-08-26T12:01:49Z",
  "updated_at": "2024-05-29T10:00:52Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI am in a multi-module gradle project.\r\n\r\n*  `:core-lib` shared lib\r\n     * contains java and kotlin code (classes annotated with `@ApplicationScoped`)\r\n     * jandex plugin is configured\r\n     * kotlin for quarkus is configured (incl.  the allopen plugin)\r\n* `:app1` quarkus app\r\n     * contains a Rest endpoint using `@Inject` to get the services from the`core-lib`\r\n\r\n_In a real setup there are more modules (multiple shared modules, and multiple quarkus app that achieve different tasks of a more complex system)_\r\n\r\nBuilding the app and running it with `java -jar app1/build/quarkus-app/quarkus-run.jar` runs perfectly fine.\r\nRunning with dev mode `./gradlew app1:quarkusDev` is failing:\r\n\r\n``` \r\njakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.Beans.resolveInjectionPoint(Beans.java:477)\r\n        at io.quarkus.arc.processor.BeanInfo.init(BeanInfo.java:624)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:299)\r\n... \r\n```\r\n_(complete trace at the bottom of this message)_\r\n\r\nThe error is similar to when the jandex plugin in not running in `core-lib` (from the docs: [Working with multi-module gradle projects](https://quarkus.io/guides/gradle-tooling#multi-module-gradle)).\r\nBut this is not the case here. Jandex is configured and is working. \r\nAlso  a work-around for https://github.com/kordamp/jandex-gradle-plugin/issues/24 is in place.\r\n\r\nBut what is wired is that:\r\n```\r\n./gradlew (clean) build\r\njava -jar app1/build/quarkus-app/quarkus-run.jar\r\n```\r\nworks perfectly.\r\n\r\nAlso when we build the docker image of the quarkus app, everything is working correctly.\r\n\r\nAnd the issue is only present when the `core-lib` module contains kotlin code. With only java code everything works as expected.\r\n\r\n**This is only a dev-mode issue.**\r\n\r\n### How to Reproduce?\r\n\r\nSee repository:\r\nhttps://github.com/jmini/quarkus_issue35577\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n```\r\n22.3.0 Darwin Kernel Version 22.3.0: Mon Jan 30 20:42:11 PST 2023; root:xnu-8792.81.3~2/RELEASE_X86_64 x86_64\r\n```\r\n\r\nmacOS, but it doesn't matter.\r\n\r\nWe observe the same on Linux.\r\n\r\n### Output of `java -version`\r\n\r\n```\r\nopenjdk version \"17.0.5\" 2022-10-18\r\nOpenJDK Runtime Environment Temurin-17.0.5+8 (build 17.0.5+8)\r\nOpenJDK 64-Bit Server VM Temurin-17.0.5+8 (build 17.0.5+8, mixed mode, sharing)\r\n```\r\n\r\n### GraalVM version (if different from Java)\r\n\r\nnot relevant\r\n\r\n### Quarkus version or git rev\r\n\r\n3.3.0 (reproducible as well with lower versions)\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n```\r\n------------------------------------------------------------\r\nGradle 8.1.1\r\n------------------------------------------------------------\r\n\r\nBuild time:   2023-04-21 12:31:26 UTC\r\nRevision:     1cf537a851c635c364a4214885f8b9798051175b\r\n\r\nKotlin:       1.8.10\r\nGroovy:       3.0.15\r\nAnt:          Apache Ant(TM) version 1.10.11 compiled on July 10 2021\r\nJVM:          17.0.5 (Eclipse Adoptium 17.0.5+8)\r\nOS:           Mac OS X 13.2.1 x86_64\r\n```\r\n\r\n### Additional information\r\n\r\n<details>\r\n  <summary>Complete error when running `./gradlew app1:quarkusDev`</summary>\r\n  \r\n```\r\n2023-08-26 13:38:06,883 INFO  [io.qua.dep.dev.IsolatedDevModeMain] (main) Attempting to start live reload endpoint to recover from previous Quarkus startup failure\r\n> :ap2023-08-26 13:38:07,507 ERROR [io.qua.dep.dev.IsolatedDevModeMain] (main) Failed to start quarkus: java.lang.RuntimeException: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n        [error]: Build step io.quarkus.arc.deployment.ArcProcessor#validate threw an exception: jakarta.enterprise.inject.spi.DeploymentException: jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.BeanDeployment.processErrors(BeanDeployment.java:1447)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:311)\r\n        at io.quarkus.arc.processor.BeanProcessor.initialize(BeanProcessor.java:158)\r\n        at io.quarkus.arc.deployment.ArcProcessor.validate(ArcProcessor.java:469)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n        at io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:858)\r\n        at io.quarkus.builder.BuildContext.run(BuildContext.java:282)\r\n        at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n        at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\r\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\n        at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\nCaused by: jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.Beans.resolveInjectionPoint(Beans.java:477)\r\n        at io.quarkus.arc.processor.BeanInfo.init(BeanInfo.java:624)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:299)\r\n        ... 13 more\r\n\r\n        at io.quarkus.runner.bootstrap.AugmentActionImpl.runAugment(AugmentActionImpl.java:336)\r\n        at io.quarkus.runner.bootstrap.AugmentActionImpl.createInitialRuntimeApplication(AugmentActionImpl.java:253)\r\n        at io.quarkus.runner.bootstrap.AugmentActionImpl.createInitialRuntimeApplication(AugmentActionImpl.java:60)\r\n        at io.quarkus.deployment.dev.IsolatedDevModeMain.firstStart(IsolatedDevModeMain.java:82)\r\n        at io.quarkus.deployment.dev.IsolatedDevModeMain.accept(IsolatedDevModeMain.java:423)\r\n        at io.quarkus.deployment.dev.IsolatedDevModeMain.accept(IsolatedDevModeMain.java:55)\r\n        at io.quarkus.bootstrap.app.CuratedApplication.runInCl(CuratedApplication.java:138)\r\n        at io.quarkus.bootstrap.app.CuratedApplication.runInAugmentClassLoader(CuratedApplication.java:93)\r\n        at io.quarkus.deployment.dev.DevModeMain.start(DevModeMain.java:131)\r\n        at io.quarkus.deployment.dev.DevModeMain.main(DevModeMain.java:62)\r\nCaused by: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n        [error]: Build step io.quarkus.arc.deployment.ArcProcessor#validate threw an exception: jakarta.enterprise.inject.spi.DeploymentException: jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.BeanDeployment.processErrors(BeanDeployment.java:1447)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:311)\r\n        at io.quarkus.arc.processor.BeanProcessor.initialize(BeanProcessor.java:158)\r\n        at io.quarkus.arc.deployment.ArcProcessor.validate(ArcProcessor.java:469)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n        at io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:858)\r\n        at io.quarkus.builder.BuildContext.run(BuildContext.java:282)\r\n        at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n        at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\r\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\n        at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\nCaused by: jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.Beans.resolveInjectionPoint(Beans.java:477)\r\n        at io.quarkus.arc.processor.BeanInfo.init(BeanInfo.java:624)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:299)\r\n        ... 13 more\r\n\r\n        at io.quarkus.builder.Execution.run(Execution.java:123)\r\n        at io.quarkus.builder.BuildExecutionBuilder.execute(BuildExecutionBuilder.java:79)\r\n        at io.quarkus.deployment.QuarkusAugmentor.run(QuarkusAugmentor.java:160)\r\n        at io.quarkus.runner.bootstrap.AugmentActionImpl.runAugment(AugmentActionImpl.java:332)\r\n        ... 9 more\r\nCaused by: jakarta.enterprise.inject.spi.DeploymentException: jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.BeanDeployment.processErrors(BeanDeployment.java:1447)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:311)\r\n        at io.quarkus.arc.processor.BeanProcessor.initialize(BeanProcessor.java:158)\r\n        at io.quarkus.arc.deployment.ArcProcessor.validate(ArcProcessor.java:469)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n        at io.quarkus.deployment.ExtensionLoader$3.execute(ExtensionLoader.java:858)\r\n        at io.quarkus.builder.BuildContext.run(BuildContext.java:282)\r\n        at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n        at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2513)\r\n        at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1538)\r\n        at java.base/java.lang.Thread.run(Thread.java:833)\r\n        at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\nCaused by: jakarta.enterprise.inject.UnsatisfiedResolutionException: Unsatisfied dependency for type org.acme.core.kt.ConfigService and qualifiers [@Default]\r\n        - java member: org.acme.app1.App1Controller#config\r\n        - declared on CLASS bean [types=[org.acme.app1.App1Controller, java.lang.Object], qualifiers=[@Default, @Any], target=org.acme.app1.App1Controller]\r\n        at io.quarkus.arc.processor.Beans.resolveInjectionPoint(Beans.java:477)\r\n        at io.quarkus.arc.processor.BeanInfo.init(BeanInfo.java:624)\r\n        at io.quarkus.arc.processor.BeanDeployment.init(BeanDeployment.java:299)\r\n        ... 13 more\r\n```\r\n</details>\r\n\r\n----\r\n\r\nI have tried to inspect the generated jandex file in `core-lib` (using a jbang script) and it looks OK (my classes and its annotation are present)\r\n\r\n<details>\r\n  <summary>Script to inspect the jandex index</summary>\r\n\r\n```java\r\n///usr/bin/env jbang \"$0\" \"$@\" ; exit $?\r\n\r\n//DEPS io.smallrye:jandex:3.1.2\r\n//JAVA 17\r\n\r\nimport java.io.FileInputStream;\r\n\r\nimport org.jboss.jandex.AnnotationInstance;\r\nimport org.jboss.jandex.ClassInfo;\r\nimport org.jboss.jandex.Index;\r\nimport org.jboss.jandex.IndexReader;\r\n\r\npublic class JandexMain {\r\n    public static void main(String[] args) throws Exception {\r\n        try (FileInputStream input = new FileInputStream(\"core-lib/build/resources/main/META-INF/jandex.idx\")) {\r\n            IndexReader reader = new IndexReader(input);\r\n            Index index = reader.read();\r\n\r\n            // java.util.Collection<ClassInfo> knownClasses = index.getKnownClasses();\r\n            // System.out.println(knownClasses.size());\r\n            // for (ClassInfo classInfo : knownClasses) {\r\n            //     System.out.println(classInfo.name());\r\n            // }\r\n\r\n            System.out.println(\"--- org.acme.core.CoreProcessor\");\r\n            ClassInfo reportingService = index.getClassByName(\"org.acme.core.CoreProcessor\");\r\n            for (AnnotationInstance a : reportingService.annotations()) {\r\n                System.out.println(a.name());\r\n            }\r\n\r\n            System.out.println(\"--- org.acme.core.kt.ConfigService\");\r\n            ClassInfo foo = index.getClassByName(\"org.acme.core.kt.ConfigService\");\r\n            for (AnnotationInstance a : foo.annotations()) {\r\n                System.out.println(a.name());\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n</details>\r\n\r\n---\r\n\r\nAlso when look at the trace logs of the Annotation Transformers (see [docs](https://quarkus.io/guides/cdi-integration#how-to-enable-trace-logging-for-annotation-transformers)), configured with:\r\n\r\n```\r\nquarkus.log.category.\"io.quarkus.arc.processor\".min-level=TRACE\r\nquarkus.log.category.\"io.quarkus.arc.processor\".level=TRACE\r\n```\r\n\r\nI see only the line for the class written in java:\r\n\r\n```\r\n2023-08-26 13:56:06,883 TRACE [io.qua.arc.pro.BeanDeployment] (build-17) Created CLASS bean [types=[java.lang.Object, org.acme.core.CoreProcessor], qualifiers=[@Default, @Any], target=org.acme.core.CoreProcessor]\r\n```\r\n\r\nNothing for the class written in Kotin, so it makes sense that it can not be injected later on.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/35577/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/35577/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
