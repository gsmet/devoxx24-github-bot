{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41709",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41709/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41709/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41709/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/41709",
  "id": 2392442234,
  "node_id": "I_kwDOCFbutM6OmcV6",
  "number": 41709,
  "title": "QuarkusComponentTest does not register Quarkus Config Converters",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273030910,
      "node_id": "MDU6TGFiZWwxMjczMDMwOTEw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/config",
      "name": "area/config",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1375177076,
      "node_id": "MDU6TGFiZWwxMzc1MTc3MDc2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/testing",
      "name": "area/testing",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/335",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/335",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/335/labels",
    "id": 11174659,
    "node_id": "MI_kwDOCFbutM4AqoMD",
    "number": 335,
    "title": "3.13.0.CR1",
    "description": "",
    "creator": {
      "login": "quarkusbot",
      "id": 61254497,
      "node_id": "MDQ6VXNlcjYxMjU0NDk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/61254497?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/quarkusbot",
      "html_url": "https://github.com/quarkusbot",
      "followers_url": "https://api.github.com/users/quarkusbot/followers",
      "following_url": "https://api.github.com/users/quarkusbot/following{/other_user}",
      "gists_url": "https://api.github.com/users/quarkusbot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/quarkusbot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/quarkusbot/subscriptions",
      "organizations_url": "https://api.github.com/users/quarkusbot/orgs",
      "repos_url": "https://api.github.com/users/quarkusbot/repos",
      "events_url": "https://api.github.com/users/quarkusbot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/quarkusbot/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 241,
    "state": "closed",
    "created_at": "2024-06-12T08:02:47Z",
    "updated_at": "2024-07-19T11:47:06Z",
    "due_on": null,
    "closed_at": "2024-07-17T11:55:13Z"
  },
  "comments": 3,
  "created_at": "2024-07-05T11:42:35Z",
  "updated_at": "2024-07-10T09:05:06Z",
  "closed_at": "2024-07-10T09:05:02Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nA QuarkusComponentTest fails for components which rely on MicroProfile Config Converters provided by Quarkus. \r\nE.g. `io.quarkus.runtime.configuration.DurationConverter`.\r\n\r\nTesting a component using\r\n```\r\n@ConfigProperty(name = \"my.duration\", defaultValue = \"60s\")\r\nprivate Duration myDuration;\r\n```\r\nfails with an exception: `java.lang.RuntimeException: Error injecting java.time.Duration io.quarkus.issue.MyComponent.myDuration`.\r\n\r\nRunning the application works fine since then the Quarkus Config Converters are available.\n\n### Expected behavior\n\nExpected the Quarkus Config Converters to be available and used when running a QuarkusComponentTest test\r\nor to have some kind of mechanism with which custom converters can be registered.\n\n### Actual behavior\n\nNone of the Quarkus Config Converters are registered.\r\n\r\nThe exception is caused by the default Duration converter provided by SmallRye's `io.smallrye.config.ImplicitConverters` which tries to use the `java.time.Duration.parse` function to parse the value but this does not support the syntax: `60s`.\r\n\r\nFull stack trace:\r\n```\r\n2024-07-05 13:31:32,203 INFO  [io.qua.arc.pro.BeanProcessor] (main) Found unrecommended usage of private members (use package-private instead) in application beans:\r\n\t- @Inject field io.quarkus.issue.MyComponent#myDuration\r\n\r\njava.lang.RuntimeException: Error injecting java.time.Duration io.quarkus.issue.MyComponent.myDuration\r\n\r\n\tat io.quarkus.issue.MyComponent_Bean.doCreate(Unknown Source)\r\n\tat io.quarkus.issue.MyComponent_Bean.create(Unknown Source)\r\n\tat io.quarkus.issue.MyComponent_Bean.create(Unknown Source)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext.createInstanceHandle(AbstractSharedContext.java:119)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:38)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext$1.get(AbstractSharedContext.java:35)\r\n\tat io.quarkus.arc.impl.LazyValue.get(LazyValue.java:32)\r\n\tat io.quarkus.arc.impl.ComputingCache.computeIfAbsent(ComputingCache.java:69)\r\n\tat io.quarkus.arc.impl.ComputingCacheContextInstances.computeIfAbsent(ComputingCacheContextInstances.java:19)\r\n\tat io.quarkus.arc.impl.AbstractSharedContext.get(AbstractSharedContext.java:35)\r\n\tat io.quarkus.arc.impl.ClientProxies.getApplicationScopedDelegate(ClientProxies.java:21)\r\n\tat io.quarkus.issue.MyComponent_ClientProxy.arc$delegate(Unknown Source)\r\n\tat io.quarkus.issue.MyComponent_ClientProxy.getMyDuration(Unknown Source)\r\n\tat io.quarkus.issue.MyComponentTest.testMyDuration(MyComponentTest.java:17)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1597)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1597)\r\nCaused by: jakarta.enterprise.inject.CreationException: Error creating synthetic bean [WtUE35eXet8tKWS0XAkVy-_OpGY]: java.lang.IllegalArgumentException: SRCFG00039: The config property sco.maxcurrentlistener.down.duration with the config value \"60s\" threw an Exception whilst being converted SRCFG00020: Failed to convert value with static method\r\n\tat io.quarkus.arc.generator.Object_WtUE35eXet8tKWS0XAkVy-_OpGY_Synthetic_Bean.doCreate(Unknown Source)\r\n\tat io.quarkus.arc.generator.Object_WtUE35eXet8tKWS0XAkVy-_OpGY_Synthetic_Bean.create(Unknown Source)\r\n\tat io.quarkus.arc.generator.Object_WtUE35eXet8tKWS0XAkVy-_OpGY_Synthetic_Bean.get(Unknown Source)\r\n\tat io.quarkus.arc.impl.CurrentInjectionPointProvider.get(CurrentInjectionPointProvider.java:48)\r\n\t... 17 more\r\nCaused by: java.lang.IllegalArgumentException: SRCFG00039: The config property sco.maxcurrentlistener.down.duration with the config value \"60s\" threw an Exception whilst being converted SRCFG00020: Failed to convert value with static method\r\n\tat io.smallrye.config.SmallRyeConfig.convertValue(SmallRyeConfig.java:421)\r\n\tat io.smallrye.config.inject.ConfigProducerUtil.getValue(ConfigProducerUtil.java:100)\r\n\tat io.smallrye.config.inject.ConfigProducerUtil.getValue(ConfigProducerUtil.java:60)\r\n\tat io.quarkus.test.component.ConfigPropertyBeanCreator.create(ConfigPropertyBeanCreator.java:40)\r\n\tat io.quarkus.arc.generator.Object_WtUE35eXet8tKWS0XAkVy-_OpGY_Synthetic_Bean.createSynthetic(Unknown Source)\r\n\t... 21 more\r\nCaused by: java.lang.IllegalArgumentException: SRCFG00020: Failed to convert value with static method\r\n\tat io.smallrye.config.ImplicitConverters$StaticMethodConverter.convert(ImplicitConverters.java:133)\r\n\tat io.smallrye.config.SmallRyeConfig.convertValue(SmallRyeConfig.java:419)\r\n\t... 25 more\r\nCaused by: java.lang.reflect.InvocationTargetException\r\n\tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:118)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:580)\r\n\tat io.smallrye.config.ImplicitConverters$StaticMethodConverter.convert(ImplicitConverters.java:131)\r\n\t... 26 more\r\nCaused by: java.time.format.DateTimeParseException: Text cannot be parsed to a Duration\r\n\tat java.base/java.time.Duration.parse(Duration.java:419)\r\n\tat java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103)\r\n\t... 28 more\r\n\r\n\r\nProcess finished with exit code 255\r\n```\n\n### How to Reproduce?\n\nComponent:\r\n```\r\npackage io.quarkus.issue;\r\n\r\nimport jakarta.enterprise.context.ApplicationScoped;\r\nimport org.eclipse.microprofile.config.inject.ConfigProperty;\r\n\r\nimport java.time.Duration;\r\n\r\n@ApplicationScoped\r\npublic class MyComponent {\r\n\r\n    @ConfigProperty(name = \"sco.maxcurrentlistener.down.duration\", defaultValue = \"60s\")\r\n    private Duration myDuration;\r\n\r\n    public String getMyDuration() {\r\n        return myDuration.toString();\r\n    }\r\n}\r\n```\r\n\r\nComponent Test:\r\n```\r\npackage io.quarkus.issue;\r\n\r\nimport io.quarkus.test.component.QuarkusComponentTest;\r\nimport jakarta.inject.Inject;\r\nimport org.junit.jupiter.api.Test;\r\n\r\nimport static org.junit.jupiter.api.Assertions.assertEquals;\r\n\r\n@QuarkusComponentTest\r\nclass MyComponentTest {\r\n\r\n    @Inject\r\n    MyComponent myComponent;\r\n\r\n    @Test\r\n    public void testMyDuration() {\r\n        assertEquals(\"60s\", myComponent.getMyDuration());\r\n    }\r\n}\r\n```\n\n### Output of `uname -a` or `ver`\n\nDarwin MacBook-Pro-8.local 22.5.0 Darwin Kernel Version 22.5.0: Mon Apr 24 20:53:19 PDT 2023; root:xnu-8796.121.2~5/RELEASE_ARM64_T6020 arm64\n\n### Output of `java -version`\n\nopenjdk version \"22\" 2024-03-19 OpenJDK Runtime Environment Temurin-22+36 (build 22+36) OpenJDK 64-Bit Server VM Temurin-22+36 (build 22+36, mixed mode)\n\n### Quarkus version or git rev\n\n3.11.1\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nMaven home: /Users/user/.m2/wrapper/dists/apache-maven-3.9.3-bin/326f10f4/apache-maven-3.9.3 Java version: 22, vendor: Eclipse Adoptium, runtime: /Users/user/.sdkman/candidates/java/22-tem Default locale: en_GB, platform encoding: UTF-8 OS name: \"mac os x\", version: \"13.4\", arch: \"aarch64\", family: \"mac\"\n\n### Additional information\n\nI tried adding the converter manually in test code by\r\n```java\r\n    @BeforeEach\r\n    public void registerConverter() {\r\n        var instance = ConfigProviderResolver.instance();\r\n        var builder = instance.getBuilder()\r\n                .withConverters(new DurationConverter())\r\n                .build();\r\n        instance.registerConfig(builder, MyComponentTest.class.getClassLoader());\r\n    }\r\n```\r\nor adding in the test method itself but this does not work.\r\nThe actual used `Config` from which the `Converter` is obtained is different than the one created in the test.\r\nWhen trying to use the correct ClassLoader\r\n```java\r\n        var contextClassLoader = Thread.currentThread().getContextClassLoader();\r\n        instance.registerConfig(builder, contextClassLoader);\r\n```\r\nthe test failed since a `Config` is already registered for that class loader.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/41709/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/41709/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
