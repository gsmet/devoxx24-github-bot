{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/22685",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22685/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22685/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22685/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/22685",
  "id": 1095302632,
  "node_id": "I_kwDOCFbutM5BSP3o",
  "number": 22685,
  "title": "java.lang.StackOverflowError during build when using hibernate-orm with CompositeAttribute within hbm.xml",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1273026509,
      "node_id": "MDU6TGFiZWwxMjczMDI2NTA5",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/persistence",
      "name": "area/persistence",
      "color": "FBCA04",
      "default": false,
      "description": "OBSOLETE, DO NOT USE"
    },
    {
      "id": 1425555736,
      "node_id": "MDU6TGFiZWwxNDI1NTU1NzM2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-orm",
      "name": "area/hibernate-orm",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate ORM"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/169",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/169",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/169/labels",
    "id": 7538964,
    "node_id": "MI_kwDOCFbutM4AcwkU",
    "number": 169,
    "title": "2.6.2.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 69,
    "state": "closed",
    "created_at": "2022-01-04T09:38:47Z",
    "updated_at": "2022-08-18T14:34:16Z",
    "due_on": null,
    "closed_at": "2022-01-10T13:56:14Z"
  },
  "comments": 3,
  "created_at": "2022-01-06T13:04:43Z",
  "updated_at": "2022-01-07T16:39:14Z",
  "closed_at": "2022-01-07T13:38:50Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nAs part of migration our legacy Java Hibernate project to Quarkus, we faced this issue.\r\n\r\nDuring compilation we got this error:\r\n```\r\n[ERROR] Failed to execute goal io.quarkus.platform:quarkus-maven-plugin:2.6.1.Final:build (default) on project code-with-quarkus: Failed to build quarkus application: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n[ERROR] \t[error]: Build step io.quarkus.hibernate.orm.deployment.HibernateOrmProcessor#defineJpaEntities threw an exception: java.lang.StackOverflowError\r\n[ERROR] \tat java.base/java.util.HashMap.hash(HashMap.java:340)\r\n[ERROR] \tat java.base/java.util.HashMap.get(HashMap.java:553)\r\n[ERROR] \tat java.base/java.util.Collections$UnmodifiableMap.get(Collections.java:1454)\r\n[ERROR] \tat org.jboss.jandex.Index.getClassByName(Index.java:301)\r\n[ERROR] \tat org.jboss.jandex.CompositeIndex.getClassByName(CompositeIndex.java:201)\r\n[ERROR] \tat org.jboss.jandex.CompositeIndex.getClassByName(CompositeIndex.java:201)\r\n[ERROR] \tat io.quarkus.deployment.index.IndexWrapper.getClassByName(IndexWrapper.java:62)\r\n[ERROR] \tat org.jboss.jandex.CompositeIndex.getClassByName(CompositeIndex.java:201)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.addClassHierarchyToReflectiveList(JpaJandexScavenger.java:429)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.enlistExplicitClass(JpaJandexScavenger.java:312)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:300)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n[ERROR] \tat io.quarkus.hibernate.orm.deployment.JpaJandexScavenger.collectHbmXmlEmbeddedTypes(JpaJandexScavenger.java:304)\r\n```\r\n\r\nI tried to check in the source as pointed in stack trace and found this method. Last line of the method call caught my eye, as we are passing the same attributes again in recursive call.\r\n```\r\nprivate void collectHbmXmlEmbeddedTypes(Collector collector, String packagePrefix, List<?> attributes) {\r\n        for (Object attribute : attributes) {\r\n            if (attribute instanceof JaxbHbmCompositeAttributeType) {\r\n                JaxbHbmCompositeAttributeType compositeAttribute = (JaxbHbmCompositeAttributeType) attribute;\r\n                String name = packagePrefix + compositeAttribute.getClazz();\r\n                enlistExplicitClass(collector, name);\r\n                // The call to 'enlistExplicitClass' above may not\r\n                // detect that this class is an entity if it is not annotated\r\n                collector.entityTypes.add(name);\r\n                collectHbmXmlEmbeddedTypes(collector, packagePrefix, attributes);\r\n            }\r\n        }\r\n    }\r\n```\r\nI made some modification to the code and this solved my StackOverflowError issue. But not sure if this is the correct way to fix it.\r\n```\r\nprivate void collectHbmXmlEmbeddedTypes(Collector collector, String packagePrefix, List<?> attributes) {\r\n        for (Object attribute : attributes) {\r\n            if (attribute instanceof JaxbHbmCompositeAttributeType) {\r\n                JaxbHbmCompositeAttributeType compositeAttribute = (JaxbHbmCompositeAttributeType) attribute;\r\n                String name = packagePrefix + compositeAttribute.getClazz();\r\n                enlistExplicitClass(collector, name);\r\n                // The call to 'enlistExplicitClass' above may not\r\n                // detect that this class is an entity if it is not annotated\r\n                collector.entityTypes.add(name);\r\n                collectHbmXmlEmbeddedTypes(collector, packagePrefix,\r\n                        ((JaxbHbmCompositeAttributeType) attribute).getAttributes());\r\n            }\r\n        }\r\n    }\r\n```\n\n### Expected behavior\n\nBuild should complete successfully.\n\n### Actual behavior\n\nGetting java.lang.StackOverflowError\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\nLinux ubuntu 4.15.0-159-generic #167-Ubuntu SMP Tue Sep 21 08:55:05 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux\n\n### Output of `java -version`\n\nopenjdk version \"11.0.11\" 2021-04-20 OpenJDK Runtime Environment (build 11.0.11+9-Ubuntu-0ubuntu2.18.04) OpenJDK 64-Bit Server VM (build 11.0.11+9-Ubuntu-0ubuntu2.18.04, mixed mode, sharing)\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n2.6.1.Final\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\nApache Maven 3.8.1 (05c21c65bdfed0f71a2f2ada8b84da59348c4c5d)\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/22685/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/22685/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
