{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/39440",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39440/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39440/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39440/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/39440",
  "id": 2186600463,
  "node_id": "I_kwDOCFbutM6CVOAP",
  "number": 39440,
  "title": "graal-sdk in 23.1.x brings in `org.graalvm.polyglot` which causes a couple of issues (wrap up)",
  "labels": [
    {
      "id": 1710069947,
      "node_id": "MDU6TGFiZWwxNzEwMDY5OTQ3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/housekeeping",
      "name": "area/housekeeping",
      "color": "d1d86a",
      "default": false,
      "description": "Issue type for generalized tasks not related to bugs or enhancements"
    },
    {
      "id": 2497075451,
      "node_id": "MDU6TGFiZWwyNDk3MDc1NDUx",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/native-image",
      "name": "area/native-image",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/316",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/316",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/316/labels",
    "id": 10687661,
    "node_id": "MI_kwDOCFbutM4AoxSt",
    "number": 316,
    "title": "3.8.3",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 46,
    "state": "closed",
    "created_at": "2024-03-15T08:52:39Z",
    "updated_at": "2024-04-11T14:28:38Z",
    "due_on": null,
    "closed_at": "2024-03-15T17:50:56Z"
  },
  "comments": 5,
  "created_at": "2024-03-14T15:00:33Z",
  "updated_at": "2024-03-15T09:01:55Z",
  "closed_at": "2024-03-14T22:54:16Z",
  "active_lock_reason": null,
  "body": "### Description\r\n\r\nStarting with 23.1 `org.graalvm.sdk:graal-sdk` (which was first introduced in 22.3) is just a wrapper (for backwards compatibility) that depends on the new (in 23.1) artifacts:\r\n\r\n* `org.graalvm.sdk:collections`\r\n* `org.graalvm.sdk:nativeimage`\r\n* `org.graalvm.sdk:word`\r\n* `org.graalvm.polyglot:polyglot`\r\n\r\nThe APIs that Quarkus depends on (for substitutions, Features etc.) used to come from `org.graalvm.sdk:graal-sdk` (<23.1) and are now (>= 23.1) all packaged in `org.graalvm.sdk:nativeimage` so there is no need to depend on the rest.\r\n\r\nWhile this would normally not be a big issue, specifically bringing `org.graalvm.polyglot:polyglot` in the dependency tree causes the following issues:\r\n\r\n1. The heuristic used to see if Truffle is being used [becomes always true](https://github.com/quarkusio/quarkus/issues/39350#issuecomment-1991248094)\r\n2. [Native builds with Mandrel 23.0 break](https://github.com/quarkusio/quarkus/issues/39322)\r\n\r\nBoth issues are now fixed for Quarkus (to be backported to 3.8 as well) by https://github.com/quarkusio/quarkus/pull/39372 (depend on `nativeimage` instead of `graal-sdk`). Although the first one may still manifest if a user explicitly depends on `org.graalvm.polyglot:polyglot`, this is tracked in https://github.com/quarkusio/quarkus/issues/39387.\r\n\r\n**However**, since quarkus-extensions may depend on `graal-sdk`, removing it from the Quarkus BOM would break them (at a quiet late stage for 3.8) and that is too aggressive. As a result, we [decided to keep `graal-sdk` in the Quarkus BOM for 3.8 and 3.9](https://github.com/quarkusio/quarkus/pull/39372#discussion_r1522970423), and [remove it in 3.10](https://github.com/quarkusio/quarkus/pull/39372#issuecomment-1994115032).\r\n\r\nThat means that if a quarkus-extension depends on `graal-sdk` they will still be able to trigger both issues mentioned above.\r\n\r\n### Implementation ideas\r\n\r\nAs discussed in a call, **one option** proposed to resolve the issue was to add an exclusion in the Quarkus BOM so that `org.graalvm.polyglot:polyglot` is excluded from the `graal-sdk` dependency.\r\nSince we expect most quarkus-extensions to rely on `graal-sdk` just for substitutions and GraalVM Features, we expect that the impact of this would be minimal, i.e. it would only affect extensions actually using the polyglot API.\r\n\r\nAnother option to resolve the issue regarding building with Mandrel 23.0 is to [explicitly and unconditionally remove the `polyglot` dependency from the classpath when building with Mandrel 23.0](https://github.com/quarkusio/quarkus/pull/39397). The risk with this approach is that the `polyglot` implementation the user expect (by using the 23.1.x version from the Quarkus POM file) might be different than the provided by Mandrel 23.0.x implementation and the user won't know about it. The first option is probably better, since users depending on the polyglot API and are willing to build with Mandrel 23.0.x will have to manually add the dependency (with `provided` scope) and they should use the right version of it instead of the one from the Quarkus BOM.\r\n\r\ncc @ppalaga @gsmet @maxandersen @galderz @geoand @aloubyansky @gemmellr @jerboaa \r\n",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/39440/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/39440/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
