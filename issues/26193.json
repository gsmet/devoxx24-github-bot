{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/26193",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26193/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26193/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26193/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/26193",
  "id": 1273977181,
  "node_id": "I_kwDOCFbutM5L71ld",
  "number": 26193,
  "title": "Container Image Build Fails - quarkus-container-image-jib",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1676631606,
      "node_id": "MDU6TGFiZWwxNjc2NjMxNjA2",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/windows",
      "name": "env/windows",
      "color": "edea47",
      "default": false,
      "description": "Impacts Windows machines"
    },
    {
      "id": 1891982257,
      "node_id": "MDU6TGFiZWwxODkxOTgyMjU3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/container-image",
      "name": "area/container-image",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 4,
  "created_at": "2022-06-16T19:11:33Z",
  "updated_at": "2022-06-17T05:47:05Z",
  "closed_at": "2022-06-16T21:58:04Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nThere appears to be an issue within the quarkus-container-image-jib extension while processing a container image build. The error seems to be focused around [line 233 in JibProcessor.java](https://github.com/quarkusio/quarkus/blob/e09da15f47c09b20082d7e9bc46216df69560c39/extensions/container-image/container-image-jib/deployment/src/main/java/io/quarkus/container/image/jib/deployment/JibProcessor.java#L233)\r\n\r\nIt appears the call to `jibContainerBuilder.containerize(containerizer);` is trying to make a connection to `registry.access.redhat.com` in an attempt to pull the `ubi8/openjdk-11-runtime:1.11` image. This call fails repeatedly with the following information:\r\n\r\n> [WARNING] [io.quarkus.container.image.jib.deployment.JibProcessor] GET https://registry.access.redhat.com/v2/ubi8/openjdk-11-runtime/manifests/sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b failed and will be retried\r\n\r\nThe build process ultimately fails with the following error/stacktrace\r\n\r\n>[ERROR] Failed to execute goal io.quarkus.platform:quarkus-maven-plugin:2.7.1.Final:build (default) on project location-lookup: Failed to build quarkus application: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n[ERROR]         [error]: Build step io.quarkus.container.image.jib.deployment.JibProcessor#buildFromJar threw an exception: java.lang.RuntimeException: Unable to create container image\r\n[ERROR]         at io.quarkus.container.image.jib.deployment.JibProcessor.containerize(JibProcessor.java:234)\r\n[ERROR]         at io.quarkus.container.image.jib.deployment.JibProcessor.buildFromJar(JibProcessor.java:161)\r\n[ERROR]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n[ERROR]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n[ERROR]         at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n[ERROR]         at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n[ERROR]         at io.quarkus.deployment.ExtensionLoader$2.execute(ExtensionLoader.java:882)\r\n[ERROR]         at io.quarkus.builder.BuildContext.run(BuildContext.java:277)\r\n[ERROR]         at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n[ERROR]         at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n[ERROR]         at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n[ERROR]         at java.base/java.lang.Thread.run(Thread.java:834)\r\n[ERROR]         at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\n[ERROR] Caused by: com.google.cloud.tools.jib.api.InsecureRegistryException: Failed to verify the server at https://registry.access.redhat.com/v2/ubi8/openjdk-11-runtime/manifests/sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b because only secure connections are allowed.\r\n[ERROR]         at com.google.cloud.tools.jib.registry.RegistryEndpointCaller.call(RegistryEndpointCaller.java:179)\r\n[ERROR]         at com.google.cloud.tools.jib.registry.RegistryEndpointCaller.call(RegistryEndpointCaller.java:114)\r\n[ERROR]         at com.google.cloud.tools.jib.registry.RegistryClient.callRegistryEndpoint(RegistryClient.java:625)\r\n[ERROR]         at com.google.cloud.tools.jib.registry.RegistryClient.pullManifest(RegistryClient.java:436)\r\n[ERROR]         at com.google.cloud.tools.jib.registry.RegistryClient.pullManifest(RegistryClient.java:441)\r\n[ERROR]         at com.google.cloud.tools.jib.builder.steps.PullBaseImageStep.pullBaseImages(PullBaseImageStep.java:334)\r\n[ERROR]         at com.google.cloud.tools.jib.builder.steps.PullBaseImageStep.call(PullBaseImageStep.java:157)\r\n[ERROR]         at com.google.cloud.tools.jib.builder.steps.PullBaseImageStep.call(PullBaseImageStep.java:69)\r\n[ERROR]         at com.google.common.util.concurrent.TrustedListenableFutureTask$TrustedFutureInterruptibleTask.runInterruptibly(TrustedListenableFutureTask.java:125)\r\n[ERROR]         at com.google.common.util.concurrent.InterruptibleTask.run(InterruptibleTask.java:69)\r\n[ERROR]         at com.google.common.util.concurrent.TrustedListenableFutureTask.run(TrustedListenableFutureTask.java:78)\r\n[ERROR]         at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n[ERROR]         at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n[ERROR]         at java.base/java.lang.Thread.run(Thread.java:834)\r\n[ERROR] Caused by: javax.net.ssl.SSLException: Received fatal alert: internal_error\r\n[ERROR]         at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:129)\r\n[ERROR]         at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)\r\n[ERROR]         at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:308)\r\n[ERROR]         at java.base/sun.security.ssl.Alert$AlertConsumer.consume(Alert.java:279)\r\n[ERROR]         at java.base/sun.security.ssl.TransportContext.dispatch(TransportContext.java:181)\r\n[ERROR]         at java.base/sun.security.ssl.SSLTransport.decode(SSLTransport.java:164)\r\n[ERROR]         at java.base/sun.security.ssl.SSLSocketImpl.decode(SSLSocketImpl.java:1152)\r\n[ERROR]         at java.base/sun.security.ssl.SSLSocketImpl.readHandshakeRecord(SSLSocketImpl.java:1063)\r\n[ERROR]         at java.base/sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:402)\r\n[ERROR]         at org.apache.http.conn.ssl.SSLConnectionSocketFactory.createLayeredSocket(SSLConnectionSocketFactory.java:436)\r\n[ERROR]         at org.apache.http.conn.ssl.SSLConnectionSocketFactory.connectSocket(SSLConnectionSocketFactory.java:384)\r\n[ERROR]         at org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)\r\n[ERROR]         at org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:376)\r\n[ERROR]         at org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:393)\r\n[ERROR]         at org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:236)\r\n[ERROR]         at org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)\r\n[ERROR]         at org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\r\n[ERROR]         at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)\r\n[ERROR]         at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:108)\r\n[ERROR]         at org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:56)\r\n[ERROR]         at com.google.api.client.http.apache.v2.ApacheHttpRequest.execute(ApacheHttpRequest.java:73)\r\n[ERROR]         at com.google.api.client.http.HttpRequest.execute(HttpRequest.java:1012)\r\n[ERROR]         at com.google.cloud.tools.jib.http.FailoverHttpClient.call(FailoverHttpClient.java:349)\r\n[ERROR]         at com.google.cloud.tools.jib.http.FailoverHttpClient.call(FailoverHttpClient.java:266)\r\n[ERROR]         at com.google.cloud.tools.jib.registry.RegistryEndpointCaller.call(RegistryEndpointCaller.java:138)\r\n[ERROR]         ... 13 more\r\n[ERROR] -> [Help 1]\r\n\r\nComplete debug/trace output of this step is attached\r\n\r\nI am behind a corporate firewall, so I disconnected from VPN and tried again with the same results. I recently moved to a different state and internet provider so I thought maybe my new provider may have been blocking somehow. I ran `docker pull registry.access.redhat.com/ubi8/openjdk-11-runtime@sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b` with the following results:\r\n\r\n```\r\nregistry.access.redhat.com/ubi8/openjdk-11-runtime@sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b: Pulling from ubi8/openjdk-11-runtime\r\na9e23b64ace0: Already exists\r\n38b71301a1d9: Already exists\r\n21e3f6d4169e: Pulling fs layer\r\n21e3f6d4169e: Verifying Checksum\r\n21e3f6d4169e: Download complete\r\n21e3f6d4169e: Pull complete\r\nDigest: sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b\r\nStatus: Downloaded newer image for registry.access.redhat.com/ubi8/openjdk-11-runtime@sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b\r\nregistry.access.redhat.com/ubi8/openjdk-11-runtime@sha256:64acf3403b5c2c85f7a28f326c63f1312b568db059c66d90b34e3c59fde3a74b\r\n```\r\n\r\nI then ran a wireshark trace while running the build and found something very interesting. During the Jib build process, there are calls made from `host.docker.internal` to (at least in my case) `e40408.d.akamaiedge.net (23.48.11.106)` I'm assuming this is the pull of the image in question which do coincide with the \"GET ... will be retried\" messages. `host.docker.internal` sends a \"Client Hello\" packet. After an acknowledgement, `e40408.d.akamaiedge.net` returns a message \"Alert (Level: Fatal, Description: Internal Error)\". A sample of these packets have been dumped and attached\r\n\r\nSystem Stats:\r\nMaven:\r\n```\r\n$ mvn --version\r\nApache Maven 3.8.4 (9b656c72d54e5bacbed989b64718c159fe39b537)\r\nMaven home: F:\\development\\Apache\\Maven\\Latest\r\nJava version: 11, vendor: Oracle Corporation, runtime: C:\\Users\\aa99988\\development\\languages\\Java\\openJDK_11\r\nDefault locale: en_US, platform encoding: Cp1252\r\nOS name: \"windows 10\", version: \"10.0\", arch: \"amd64\", family: \"windows\"\r\n```\r\n\r\nJava: \r\n```\r\n$ java --version\r\nopenjdk 11 2018-09-25\r\nOpenJDK Runtime Environment 18.9 (build 11+28)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11+28, mixed mode)\r\n```\r\n\r\nOS: Microsoft Windows 10 1809 210q - 20200218 [Version 10.0.19041.1415]\r\n\r\nGIt for Windows: \r\n```\r\n$ git --version\r\ngit version 2.36.1.windows.1\r\n```\r\n\r\nGit-bash:\r\n```\r\n$ bash --version\r\nGNU bash, version 4.4.23(1)-release (x86_64-pc-msys)\r\nCopyright (C) 2016 Free Software Foundation, Inc.\r\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\r\n```\r\n\r\nQuarkus version:\r\n```\r\n$ quarkus --version\r\n2.9.2.Final\r\n```\r\n[jibprocessor_fail.txt](https://github.com/quarkusio/quarkus/files/8921127/jibprocessor_fail.txt)\r\n[jib_fail_alert_fatal.zip](https://github.com/quarkusio/quarkus/files/8921317/jib_fail_alert_fatal.zip)\n\n### Expected behavior\n\nThe build would complete and a container image of the application would be available for use.\n\n### Actual behavior\n\nBuild fails as described above\n\n### How to Reproduce?\n\nUsing quarkus-quickstarts:getting-started. I added the following properties to `application.properties`\r\n\r\n'''\r\nquarkus.native.container-runtime=docker\r\nquarkus.native.container-build=true\r\n\r\nquarkus.container-image.build=true\r\nquarkus.container-image.name=getting-started-test\r\n'''\r\n\r\nA zip file of this minimally reproducible project is attached\r\n[getting-started.zip](https://github.com/quarkusio/quarkus/files/8921673/getting-started.zip)\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n_No response_\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/26193/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/26193/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
