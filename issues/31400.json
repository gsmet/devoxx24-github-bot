{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31400",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31400/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31400/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31400/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/31400",
  "id": 1598656882,
  "node_id": "I_kwDOCFbutM5fSZFy",
  "number": 31400,
  "title": "Quarkus Superheroes Quarkus 2 -> 3 upgrade issues",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 4147701997,
      "node_id": "LA_kwDOCFbutM73OOjt",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/env/m1",
      "name": "env/m1",
      "color": "edea47",
      "default": false,
      "description": "Impacts Apple M1 machines"
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": null,
  "comments": 68,
  "created_at": "2023-02-24T13:41:58Z",
  "updated_at": "2023-04-13T19:25:37Z",
  "closed_at": "2023-04-12T13:44:38Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nI'm in process of upgrading the Quarkus Superheroes to use Quarkus 3. I'm working on my own personal fork for the moment (https://github.com/edeandrea/quarkus-super-heroes on the `quarkus3` branch - https://github.com/edeandrea/quarkus-super-heroes/tree/quarkus3).\r\n\r\nI've run into a few things that I can't seem to figure out how to solve and could use some help/guidance\r\n1. Using the `io.quarkus.test.TestReactiveTransaction` annotation at the class level causes lots of errors\r\n2. Hibernate reactive not finding Vertx context\r\n3. No current `Mutiny.Session` found\r\n4. Mocking/stubbing/spying not working right\r\n\r\n# Using the `io.quarkus.test.TestReactiveTransaction` annotation at the class level causes lots of errors\r\nRemoving the annotation from the class and instead placing it on each & every test method in the class removes the errors. I would still call it a bug, though, but at least I can get past it.\r\n\r\nThis is the error I was seeing when `@TestReactiveTransaction` was placed at the class level:\r\n\r\n```\r\njava.lang.AssertionError: Reflective call to UniAsserter parameter failed, please file a bug report\r\n\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor.handleSpecialTestMethod(TestReactiveTransactionalInterceptor.java:79)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor.intercept(TestReactiveTransactionalInterceptor.java:23)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptorGenerated_Bean.intercept(Unknown Source)\r\n    at io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n    at io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n    at io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n    at io.quarkus.sample.superheroes.hero.repository.HeroRepositoryTests_Subclass.findAllWhereNameLikeNotFound(Unknown Source)\r\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n    at io.quarkus.test.vertx.RunOnVertxContextTestMethodInvoker$RunTestMethodOnContextHandler.doRun(RunOnVertxContextTestMethodInvoker.java:148)\r\n    at io.quarkus.test.vertx.RunOnVertxContextTestMethodInvoker$RunTestMethodOnContextHandler.handle(RunOnVertxContextTestMethodInvoker.java:137)\r\n    at io.quarkus.test.vertx.RunOnVertxContextTestMethodInvoker$RunTestMethodOnContextHandler.handle(RunOnVertxContextTestMethodInvoker.java:108)\r\n    at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:264)\r\n    at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:246)\r\n    at io.vertx.core.impl.EventLoopContext.lambda$runOnContext$0(EventLoopContext.java:43)\r\n    at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\n    at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\n    at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\n    at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)\r\n    at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n    at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n    at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n    at java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: java.lang.reflect.InvocationTargetException\r\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n    at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor.handleSpecialTestMethod(TestReactiveTransactionalInterceptor.java:66)\r\n    ... 24 more\r\nCaused by: java.lang.IllegalStateException: Can't get the context safety flag: the current context is not a duplicated context\r\n    at io.quarkus.vertx.core.runtime.context.VertxContextSafetyToggle.checkIsSafe(VertxContextSafetyToggle.java:78)\r\n    at io.quarkus.vertx.core.runtime.context.VertxContextSafetyToggle.validateContextIfExists(VertxContextSafetyToggle.java:72)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.vertxContext(SessionOperations.java:183)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.withSession(SessionOperations.java:112)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.withTransaction(SessionOperations.java:99)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor$1.apply(TestReactiveTransactionalInterceptor.java:69)\r\n    at io.quarkus.hibernate.reactive.panache.common.runtime.TestReactiveTransactionalInterceptor$1.apply(TestReactiveTransactionalInterceptor.java:66)\r\n    at io.quarkus.test.vertx.DefaultUniAsserter.surroundWith(DefaultUniAsserter.java:129)\r\n    ... 29 more\r\n ```\r\n\r\n# Hibernate reactive not finding Vertx context\r\nIn the [`rest-heroes` application](https://github.com/edeandrea/quarkus-super-heroes/tree/quarkus3/rest-heroes) there's some issue with hibernate reactive where its not finding a Vertx context (see https://github.com/edeandrea/quarkus-super-heroes/actions/runs/4257167883/jobs/7406959691 the full test execution, failures, and errors). It seems to be the same problem causing all the failures.\r\n\r\nWhat's somewhat interesting is that the tests that fail are tests that mutate data. Tests which only read data all run fine.\r\n\r\nI did replace all instances of `@ReactiveTransactional` with `@WithTransaction` because `@ReactiveTransactional` is deprecated. Changing back to `@ReactiveTransactional` doesn't change anything. I still see the same failures.\r\n\r\nHere's an excerpt of one of them:\r\n\r\n```\r\nError:  io.quarkus.sample.superheroes.hero.service.HeroServiceTests.persistInvalidHero  Time elapsed: 0.002 s  <<< ERROR!\r\njava.lang.IllegalStateException: No current Vertx context found\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.vertxContext(SessionOperations.java:186)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.withSession(SessionOperations.java:112)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.withTransaction(SessionOperations.java:86)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.WithTransactionInterceptor.intercept(WithTransactionInterceptor.java:19)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.WithTransactionInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:71)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:63)\r\n\tat io.quarkus.opentelemetry.runtime.tracing.cdi.WithSpanInterceptor.span(WithSpanInterceptor.java:66)\r\n\tat io.quarkus.opentelemetry.runtime.tracing.cdi.WithSpanInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass.persistHero(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_ClientProxy.persistHero(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroServiceTests.persistInvalidHero(HeroServiceTests.java:308)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat io.quarkus.test.junit.QuarkusTestExtension.runExtensionMethod(QuarkusTestExtension.java:1002)\r\n\tat io.quarkus.test.junit.QuarkusTestExtension.interceptTestMethod(QuarkusTestExtension.java:816)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:217)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:213)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:138)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:68)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:147)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:127)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:90)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:55)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:102)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:54)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:114)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:86)\r\n\tat org.junit.platform.launcher.core.DefaultLauncherSession$DelegatingLauncher.execute(DefaultLauncherSession.java:86)\r\n\tat org.apache.maven.surefire.junitplatform.LazyLauncher.execute(LazyLauncher.java:55)\r\n\tat org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.execute(JUnitPlatformProvider.java:223)\r\n\tat org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invokeAllTests(JUnitPlatformProvider.java:175)\r\n\tat org.apache.maven.surefire.junitplatform.JUnitPlatformProvider.invoke(JUnitPlatformProvider.java:139)\r\n\tat org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:456)\r\n\tat org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:169)\r\n\tat org.apache.maven.surefire.booter.ForkedBooter.run(ForkedBooter.java:595)\r\n\tat org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:581)\r\n\r\nError:    HeroServiceTests.deleteAllHeroes:650 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.deleteHero:632 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.fullyUpdateHero:469 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.fullyUpdateInvalidHero:415 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.fullyUpdateNotFoundHero:451 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.fullyUpdateNullHero:378 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.partiallyUpdateHero:597 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.partiallyUpdateInvalidHero:540 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.partiallyUpdateNotFoundHero:579 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.partiallyUpdateNullHero:502 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.persistHero:347 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.persistInvalidHero:308 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.persistNullHero:271 » IllegalState No current Vertx context found\r\nError:    HeroServiceTests.replaceAllHeroes:675 » IllegalState No current Vertx context found\r\n```\r\n\r\n# No current `Mutiny.Session` found\r\nWhat's a little more interesting is if I run the `rest-heroes` app in dev mode and then try to hit the `/api/heroes/random` endpoint (or any other endpoint) I get the following error, even though the tests which call these same operations pass.\r\n\r\nIf I add the `@WithSession` or `@WithSessionOnDemand` annotation to the `HeroService` class, then this error goes away. but then ALL the tests in `HeroServiceTests` fail (not just the ones that mutate data) with the `No current Vertx context found` error mentioned above.\r\n\r\n```\r\n10:23:50 ERROR [io.qu.ve.ht.ru.QuarkusErrorHandler] (vert.x-eventloop-thread-2) HTTP Request to /api/heroes/random failed, error id: e4ec7875-f766-411f-a9a3-62d7f3c32f69-1: java.lang.IllegalStateException: No current Mutiny.Session found\r\n\t- no reactive session was found in the context and the context was not marked to open a new session lazily\r\n\t- you might need to annotate the business method with @WithSession\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.getSession(SessionOperations.java:155)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.AbstractJpaOperations.getSession(AbstractJpaOperations.java:351)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.AbstractJpaOperations.findAll(AbstractJpaOperations.java:179)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.AbstractJpaOperations.listAll(AbstractJpaOperations.java:190)\r\n\tat io.quarkus.sample.superheroes.hero.repository.HeroRepository.listAll(HeroRepository.java)\r\n\tat io.quarkus.sample.superheroes.hero.repository.HeroRepository_ClientProxy.listAll(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService.findAllHeroes(HeroService.java:43)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass.findAllHeroes$$superforward1(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass$$function$$9.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:74)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:63)\r\n\tat io.quarkus.opentelemetry.runtime.tracing.cdi.WithSpanInterceptor.span(WithSpanInterceptor.java:66)\r\n\tat io.quarkus.opentelemetry.runtime.tracing.cdi.WithSpanInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass.findAllHeroes(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_ClientProxy.findAllHeroes(Unknown Source)\r\n\tat java.base/java.util.Optional.orElseGet(Optional.java:364)\r\n\tat io.quarkus.sample.superheroes.hero.rest.HeroResource.getAllHeroes(HeroResource.java:94)\r\n\tat io.quarkus.sample.superheroes.hero.rest.HeroResource$quarkusrestinvoker$getAllHeroes_1c553b14073777e9b0f596eae9928c0c15d745dd.invoke(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n\tat io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:114)\r\n\tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:145)\r\n\tat org.jboss.resteasy.reactive.server.handlers.RestInitialHandler.beginProcessing(RestInitialHandler.java:48)\r\n\tat org.jboss.resteasy.reactive.server.vertx.ResteasyReactiveVertxHandler.handle(ResteasyReactiveVertxHandler.java:23)\r\n\tat org.jboss.resteasy.reactive.server.vertx.ResteasyReactiveVertxHandler.handle(ResteasyReactiveVertxHandler.java:10)\r\n\tat io.vertx.ext.web.impl.RouteState.handleContext(RouteState.java:1284)\r\n\tat io.vertx.ext.web.impl.RoutingContextImplBase.iterateNext(RoutingContextImplBase.java:177)\r\n\tat io.vertx.ext.web.impl.RoutingContextImpl.next(RoutingContextImpl.java:141)\r\n\tat io.quarkus.vertx.http.runtime.StaticResourcesRecorder$2.handle(StaticResourcesRecorder.java:101)\r\n\tat io.quarkus.vertx.http.runtime.StaticResourcesRecorder$2.handle(StaticResourcesRecorder.java:87)\r\n\tat io.vertx.ext.web.impl.RouteState.handleContext(RouteState.java:1284)\r\n\tat io.vertx.ext.web.impl.RoutingContextImplBase.iterateNext(RoutingContextImplBase.java:140)\r\n\tat io.vertx.ext.web.impl.RoutingContextImpl.next(RoutingContextImpl.java:141)\r\n\tat io.vertx.ext.web.handler.impl.StaticHandlerImpl.lambda$sendStatic$1(StaticHandlerImpl.java:290)\r\n\tat io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\n\tat io.vertx.core.impl.future.FutureBase.lambda$emitSuccess$0(FutureBase.java:54)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n\r\n\r\n10:23:50 ERROR [or.jb.re.re.co.co.AbstractResteasyReactiveContext] (vert.x-eventloop-thread-2) Request failed: java.lang.IllegalStateException: No current Mutiny.Session found\r\n\t- no reactive session was found in the context and the context was not marked to open a new session lazily\r\n\t- you might need to annotate the business method with @WithSession\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.SessionOperations.getSession(SessionOperations.java:155)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.AbstractJpaOperations.getSession(AbstractJpaOperations.java:351)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.AbstractJpaOperations.findAll(AbstractJpaOperations.java:179)\r\n\tat io.quarkus.hibernate.reactive.panache.common.runtime.AbstractJpaOperations.listAll(AbstractJpaOperations.java:190)\r\n\tat io.quarkus.sample.superheroes.hero.repository.HeroRepository.listAll(HeroRepository.java)\r\n\tat io.quarkus.sample.superheroes.hero.repository.HeroRepository_ClientProxy.listAll(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService.findAllHeroes(HeroService.java:43)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass.findAllHeroes$$superforward1(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass$$function$$9.apply(Unknown Source)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:74)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.proceed(AroundInvokeInvocationContext.java:63)\r\n\tat io.quarkus.opentelemetry.runtime.tracing.cdi.WithSpanInterceptor.span(WithSpanInterceptor.java:66)\r\n\tat io.quarkus.opentelemetry.runtime.tracing.cdi.WithSpanInterceptor_Bean.intercept(Unknown Source)\r\n\tat io.quarkus.arc.impl.InterceptorInvocation.invoke(InterceptorInvocation.java:42)\r\n\tat io.quarkus.arc.impl.AroundInvokeInvocationContext.perform(AroundInvokeInvocationContext.java:38)\r\n\tat io.quarkus.arc.impl.InvocationContexts.performAroundInvoke(InvocationContexts.java:26)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_Subclass.findAllHeroes(Unknown Source)\r\n\tat io.quarkus.sample.superheroes.hero.service.HeroService_ClientProxy.findAllHeroes(Unknown Source)\r\n\tat java.base/java.util.Optional.orElseGet(Optional.java:364)\r\n\tat io.quarkus.sample.superheroes.hero.rest.HeroResource.getAllHeroes(HeroResource.java:94)\r\n\tat io.quarkus.sample.superheroes.hero.rest.HeroResource$quarkusrestinvoker$getAllHeroes_1c553b14073777e9b0f596eae9928c0c15d745dd.invoke(Unknown Source)\r\n\tat org.jboss.resteasy.reactive.server.handlers.InvocationHandler.handle(InvocationHandler.java:29)\r\n\tat io.quarkus.resteasy.reactive.server.runtime.QuarkusResteasyReactiveRequestContext.invokeHandler(QuarkusResteasyReactiveRequestContext.java:114)\r\n\tat org.jboss.resteasy.reactive.common.core.AbstractResteasyReactiveContext.run(AbstractResteasyReactiveContext.java:145)\r\n\tat org.jboss.resteasy.reactive.server.handlers.RestInitialHandler.beginProcessing(RestInitialHandler.java:48)\r\n\tat org.jboss.resteasy.reactive.server.vertx.ResteasyReactiveVertxHandler.handle(ResteasyReactiveVertxHandler.java:23)\r\n\tat org.jboss.resteasy.reactive.server.vertx.ResteasyReactiveVertxHandler.handle(ResteasyReactiveVertxHandler.java:10)\r\n\tat io.vertx.ext.web.impl.RouteState.handleContext(RouteState.java:1284)\r\n\tat io.vertx.ext.web.impl.RoutingContextImplBase.iterateNext(RoutingContextImplBase.java:177)\r\n\tat io.vertx.ext.web.impl.RoutingContextImpl.next(RoutingContextImpl.java:141)\r\n\tat io.quarkus.vertx.http.runtime.StaticResourcesRecorder$2.handle(StaticResourcesRecorder.java:101)\r\n\tat io.quarkus.vertx.http.runtime.StaticResourcesRecorder$2.handle(StaticResourcesRecorder.java:87)\r\n\tat io.vertx.ext.web.impl.RouteState.handleContext(RouteState.java:1284)\r\n\tat io.vertx.ext.web.impl.RoutingContextImplBase.iterateNext(RoutingContextImplBase.java:140)\r\n\tat io.vertx.ext.web.impl.RoutingContextImpl.next(RoutingContextImpl.java:141)\r\n\tat io.vertx.ext.web.handler.impl.StaticHandlerImpl.lambda$sendStatic$1(StaticHandlerImpl.java:290)\r\n\tat io.vertx.core.impl.future.FutureImpl$3.onSuccess(FutureImpl.java:141)\r\n\tat io.vertx.core.impl.future.FutureBase.lambda$emitSuccess$0(FutureBase.java:54)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:174)\r\n\tat io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:167)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:470)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:997)\r\n\tat io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\r\n\tat io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\nAs an additional troubleshooting step, I added `@WithSession` to the `HeroService` class, then added `@RunOnVertxContext` to the `HeroServiceTests` class and got lots of these errors:\r\n\r\n```\r\n16:30:34 WARN  [io.ve.co.im.BlockedThreadChecker] (vertx-blocked-thread-checker) Thread Thread[vert.x-eventloop-thread-3,5,main] has been blocked for 2365 ms, time limit is 2000 ms: io.vertx.core.VertxException: Thread blocked\r\n```\r\n\r\n# Mocking/stubbing/spying not working right\r\nIn the [`rest-fights` application](https://github.com/edeandrea/quarkus-super-heroes/tree/quarkus3/rest-fights) there's some issue with mocking/stubbing/spying within tests. See https://github.com/edeandrea/quarkus-super-heroes/actions/runs/4257167883/jobs/7406959585 for full the full test execution, failures, and errors.\r\n\r\nFor example, if you look at the [test failure for `io.quarkus.sample.superheroes.fight.service.FightServiceTests.findRandomFightersNoneFound`](https://github.com/edeandrea/quarkus-super-heroes/actions/runs/4257167883/jobs/7406959585#step:4:4476) it says\r\n\r\n```\r\nWanted but not invoked:\r\nfightService_Subclass.findRandomHero();\r\n-> at io.quarkus.sample.superheroes.fight.service.FightService_Subclass.findRandomHero(Unknown Source)\r\n\r\nHowever, there was exactly 1 interaction with this mock:\r\nfightService_Subclass.findRandomFighters();\r\n```\r\n\r\nwhich isn't at all true. If you [look at the code in `io.quarkus.sample.superheroes.fight.service.FightService`](https://github.com/edeandrea/quarkus-super-heroes/blob/8ada10cf4ec66274b51a33a433d1d98deb3da099/rest-fights/src/main/java/io/quarkus/sample/superheroes/fight/service/FightService.java#L84-L117):\r\n\r\n```java\r\n@Timeout(value = 4, unit = ChronoUnit.SECONDS)\r\n@Fallback(fallbackMethod = \"fallbackRandomFighters\")\r\n@WithSpan(\"FightService.findRandomFighters\")\r\npublic Uni<Fighters> findRandomFighters() {\r\n  Log.debug(\"Finding random fighters\");\r\n\r\n  var villain = findRandomVillain()\r\n    .onItem().ifNull().continueWith(this::createFallbackVillain);\r\n\r\n  var hero = findRandomHero()\r\n    .onItem().ifNull().continueWith(this::createFallbackHero);\r\n\r\n  return addDelay(Uni.combine()\r\n    .all()\r\n    .unis(hero, villain)\r\n    .combinedWith(Fighters::new)\r\n  );\r\n}\r\n\r\n@Timeout(value = 2, unit = ChronoUnit.SECONDS)\r\n@Fallback(fallbackMethod = \"fallbackRandomHero\")\r\nUni<Hero> findRandomHero() {\r\n  Log.debug(\"Finding a random hero\");\r\n  return this.heroClient.findRandomHero()\r\n    .invoke(hero -> Log.debugf(\"Got random hero: %s\", hero));\r\n}\r\n\r\n@Timeout(value = 2, unit = ChronoUnit.SECONDS)\r\n@Fallback(fallbackMethod = \"fallbackRandomVillain\")\r\nUni<Villain> findRandomVillain() {\r\n  Log.debug(\"Finding a random villain\");\r\n  return this.villainClient.findRandomVillain()\r\n    .invoke(villain -> Log.debugf(\"Got random villain: %s\", villain));\r\n}\r\n```\r\n\r\nYou can see that `findRandomFighters` definitely calls `findRandomHero` and `findRandomVillain`. You can even [see this in the test log output](https://github.com/edeandrea/quarkus-super-heroes/actions/runs/4257167883/jobs/7406959585#step:4:4457):\r\n\r\n```\r\n21:55:54 DEBUG [io.quarkus.sample.superheroes.fight.service.FightService.findRandomFighters(FightService.java:88)] (main) Finding random fighters\r\n21:55:54 DEBUG [io.quarkus.sample.superheroes.fight.service.FightService.findRandomHero(FightService.java:106)] (main) Finding a random hero\r\n21:55:54 DEBUG [io.quarkus.sample.superheroes.fight.service.FightService.lambda$findRandomHero$1(FightService.java:108)] (main) Got random hero: null\r\n21:55:54 DEBUG [io.quarkus.sample.superheroes.fight.service.FightService.findRandomVillain(FightService.java:114)] (main) Finding a random villain\r\n21:55:54 DEBUG [io.quarkus.sample.superheroes.fight.service.FightService.lambda$findRandomVillain$2(FightService.java:116)] (main) Got random villain: null\r\n```\r\n\r\nIn [the test in `io.quarkus.sample.superheroes.fight.service.FIghtServiceTests.findRandomFightersNoneFound`](https://github.com/edeandrea/quarkus-super-heroes/blob/34b91cef45c4a15f7dd08088ca2ea7dd6e842ceb/rest-fights/src/test/java/io/quarkus/sample/superheroes/fight/service/FightServiceTests.java#L219-L247):\r\n\r\n```java\r\n@InjectSpy\r\nFightService fightService;\r\n\r\n@InjectMock\r\nHeroClient heroClient;\r\n\r\n@InjectMock\r\nVillainClient villainClient;\r\n\r\n@Test\r\npublic void findRandomFightersNoneFound() {\r\n  PanacheMock.mock(Fight.class);\r\n  when(this.heroClient.findRandomHero())\r\n    .thenReturn(Uni.createFrom().nullItem());\r\n\r\n  when(this.villainClient.findRandomVillain())\r\n    .thenReturn(Uni.createFrom().nullItem());\r\n\r\n  var fighters = this.fightService.findRandomFighters()\r\n    .subscribe().withSubscriber(UniAssertSubscriber.create())\r\n    .assertSubscribed()\r\n    .awaitItem(Duration.ofSeconds(5))\r\n    .getItem();\r\n\r\n  assertThat(fighters)\r\n    .isNotNull()\r\n    .usingRecursiveComparison()\r\n    .isEqualTo(new Fighters(createFallbackHero(), createFallbackVillain()));\r\n\r\n  verify(this.heroClient).findRandomHero();\r\n  verify(this.villainClient).findRandomVillain();\r\n  verify(this.fightService).findRandomHero();\r\n  verify(this.fightService).findRandomVillain();\r\n  verify(this.fightService).addDelay(any(Uni.class));\r\n  verify(this.fightService, never()).fallbackRandomHero();\r\n  verify(this.fightService, never()).fallbackRandomVillain();\r\n  PanacheMock.verifyNoInteractions(Fight.class);\r\n}\r\n```\r\n\r\nyou can see that it is verifying that the `findRandomHero` and `findRandomVillain` methods should have been called once, which the logs clearly show they did, but yet the mocking/spying doesn't see that they did.\r\n\r\n### Expected behavior\r\n\r\n_No response_\r\n\r\n### Actual behavior\r\n\r\n_No response_\r\n\r\n### How to Reproduce?\r\n\r\nReproducer: https://github.com/edeandrea/quarkus-super-heroes/tree/quarkus3 (`quarkus3` branch from https://github.com/edeandrea/quarkus-super-heroes)\r\n\r\nFor seeing the issues in `rest-heroes`:\r\n1. `cd` into `rest-heroes`\r\n5. Run `./mvnw clean verify`\r\n\r\nFor seeing the issues in `rest-fights`:\r\n1. `cd` into `rest-fights`\r\n2. Run `./mvnw clean verify`\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\nDoesn't really matter. My local machine is a mac m1, but the GH action (https://github.com/edeandrea/quarkus-super-heroes/actions/runs/4257167883) uses ubuntu.\r\n\r\n### Output of `java -version`\r\n\r\nTemurin 11 or 17. The GH action (https://github.com/edeandrea/quarkus-super-heroes/actions/runs/4257167883) tests using both.\r\n\r\n### GraalVM version (if different from Java)\r\n\r\n22.3.1\r\n\r\n### Quarkus version or git rev\r\n\r\n3.0.0.Alpha4\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n_No response_\r\n\r\n### Additional information\r\n\r\n_No response_",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/31400/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/31400/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
