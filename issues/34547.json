{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/34547",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34547/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34547/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34547/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/34547",
  "id": 1789411200,
  "node_id": "I_kwDOCFbutM5qqD-A",
  "number": 34547,
  "title": "Exception on application shutdown with quarkus-hibernate-search-orm-coordination-outbox-polling",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1664142960,
      "node_id": "MDU6TGFiZWwxNjY0MTQyOTYw",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/hibernate-search",
      "name": "area/hibernate-search",
      "color": "0366d6",
      "default": false,
      "description": "Hibernate Search / Elasticsearch"
    }
  ],
  "state": "open",
  "locked": false,
  "milestone": null,
  "comments": 8,
  "created_at": "2023-07-05T12:04:02Z",
  "updated_at": "2024-08-26T14:59:02Z",
  "closed_at": null,
  "active_lock_reason": null,
  "body": "### Describe the bug\n\nWhen using the extension `quarkus-hibernate-search-orm-coordination-outbox-polling` and stopping the application in dev mode, exception gets thrown, caused by Hibernate Search not being able to create a connection to the database (it needs to in order to re-register agents).\n\n### Expected behavior\n\nNo exception.\n\n### Actual behavior\n\n```\r\n2023-07-05 13:57:12,576 ERROR [org.hib.sea.eng.rep.spi.RootFailureCollector] (Shutdown thread) HSEARCH000521: Hibernate Search encountered a failure during %1$s; continuing for now to list all problems, but the process will ultimately be aborted.\r\nContext: %2$s\r\nFailure: [Error Occurred After Shutdown]: org.hibernate.exception.GenericJDBCException: Unable to acquire JDBC Connection [This pool is closed and does not handle any more connections!] [n/a]\r\n        at org.hibernate.exception.internal.StandardSQLExceptionConverter.convert(StandardSQLExceptionConverter.java:61)\r\n        at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:108)\r\n        at org.hibernate.engine.jdbc.spi.SqlExceptionHelper.convert(SqlExceptionHelper.java:94)\r\n        at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.acquireConnectionIfNeeded(LogicalConnectionManagedImpl.java:116)\r\n        at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.getPhysicalConnection(LogicalConnectionManagedImpl.java:143)\r\n        at org.hibernate.engine.jdbc.internal.StatementPreparerImpl.connection(StatementPreparerImpl.java:51)\r\n        at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$1.doPrepare(StatementPreparerImpl.java:91)\r\n        at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$StatementPreparationTemplate.prepareStatement(StatementPreparerImpl.java:177)\r\n        at org.hibernate.engine.jdbc.internal.StatementPreparerImpl.prepareStatement(StatementPreparerImpl.java:76)\r\n        at org.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.lambda$list$0(JdbcSelectExecutorStandardImpl.java:102)\r\n        at org.hibernate.sql.results.jdbc.internal.DeferredResultSetAccess.executeQuery(DeferredResultSetAccess.java:226)\r\n        at org.hibernate.sql.results.jdbc.internal.DeferredResultSetAccess.getResultSet(DeferredResultSetAccess.java:163)\r\n        at org.hibernate.sql.results.jdbc.internal.JdbcValuesResultSetImpl.advanceNext(JdbcValuesResultSetImpl.java:254)\r\n        at org.hibernate.sql.results.jdbc.internal.JdbcValuesResultSetImpl.processNext(JdbcValuesResultSetImpl.java:134)\r\n        at org.hibernate.sql.results.jdbc.internal.AbstractJdbcValues.next(AbstractJdbcValues.java:19)\r\n        at org.hibernate.sql.results.internal.RowProcessingStateStandardImpl.next(RowProcessingStateStandardImpl.java:66)\r\n        at org.hibernate.sql.results.spi.ListResultsConsumer.consume(ListResultsConsumer.java:178)\r\n        at org.hibernate.sql.results.spi.ListResultsConsumer.consume(ListResultsConsumer.java:33)\r\n        at org.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.doExecuteQuery(JdbcSelectExecutorStandardImpl.java:361)\r\n        at org.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.executeQuery(JdbcSelectExecutorStandardImpl.java:168)\r\n        at org.hibernate.sql.exec.internal.JdbcSelectExecutorStandardImpl.list(JdbcSelectExecutorStandardImpl.java:93)\r\n        at org.hibernate.sql.exec.spi.JdbcSelectExecutor.list(JdbcSelectExecutor.java:31)\r\n        at org.hibernate.loader.ast.internal.LoaderHelper.loadByArrayParameter(LoaderHelper.java:215)\r\n        at org.hibernate.loader.ast.internal.EntityBatchLoaderArrayParam.initializeEntities(EntityBatchLoaderArrayParam.java:141)\r\n        at org.hibernate.loader.ast.internal.EntityBatchLoaderArrayParam.load(EntityBatchLoaderArrayParam.java:98)\r\n        at org.hibernate.loader.ast.internal.EntityBatchLoaderArrayParam.load(EntityBatchLoaderArrayParam.java:170)\r\n        at org.hibernate.persister.entity.AbstractEntityPersister.doLoad(AbstractEntityPersister.java:3481)\r\n        at org.hibernate.persister.entity.AbstractEntityPersister.load(AbstractEntityPersister.java:3471)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.loadFromDatasource(DefaultLoadEventListener.java:581)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.loadFromCacheOrDatasource(DefaultLoadEventListener.java:567)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.load(DefaultLoadEventListener.java:536)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.doLoad(DefaultLoadEventListener.java:529)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.load(DefaultLoadEventListener.java:202)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.loadWithRegularProxy(DefaultLoadEventListener.java:282)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.proxyOrLoad(DefaultLoadEventListener.java:237)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.doOnLoad(DefaultLoadEventListener.java:106)\r\n        at org.hibernate.event.internal.DefaultLoadEventListener.onLoad(DefaultLoadEventListener.java:78)\r\n        at org.hibernate.event.service.internal.EventListenerGroupImpl.fireEventOnEachListener(EventListenerGroupImpl.java:138)\r\n        at org.hibernate.internal.SessionImpl.fireLoadNoChecks(SessionImpl.java:1231)\r\n        at org.hibernate.internal.SessionImpl.fireLoad(SessionImpl.java:1219)\r\n        at org.hibernate.loader.internal.IdentifierLoadAccessImpl.doLoad(IdentifierLoadAccessImpl.java:194)\r\n        at org.hibernate.loader.internal.IdentifierLoadAccessImpl.lambda$load$1(IdentifierLoadAccessImpl.java:160)\r\n        at org.hibernate.loader.internal.IdentifierLoadAccessImpl.perform(IdentifierLoadAccessImpl.java:107)\r\n        at org.hibernate.loader.internal.IdentifierLoadAccessImpl.load(IdentifierLoadAccessImpl.java:160)\r\n        at org.hibernate.internal.SessionImpl.find(SessionImpl.java:2406)\r\n        at org.hibernate.internal.SessionImpl.find(SessionImpl.java:2372)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.cluster.impl.DefaultAgentRepository.find(DefaultAgentRepository.java:31)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.cluster.impl.AgentPersister.leaveCluster(AgentPersister.java:61)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.event.impl.AbstractAgentClusterLink.leaveCluster(AbstractAgentClusterLink.java:138)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.event.impl.AgentClusterLinkContextProvider.lambda$inTransaction$0(AgentClusterLinkContextProvider.java:31)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.event.impl.AgentClusterLinkContextProvider.inTransaction(AgentClusterLinkContextProvider.java:42)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.event.impl.AgentClusterLinkContextProvider.inTransaction(AgentClusterLinkContextProvider.java:30)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.event.impl.OutboxPollingEventProcessor.leaveCluster(OutboxPollingEventProcessor.java:216)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.push(AbstractCloser.java:53)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.push(AbstractCloser.java:33)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.event.impl.OutboxPollingEventProcessor.stop(OutboxPollingEventProcessor.java:211)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.push(AbstractCloser.java:53)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.pushAll(AbstractCloser.java:92)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.pushAll(AbstractCloser.java:73)\r\n        at org.hibernate.search.mapper.orm.coordination.outboxpolling.impl.OutboxPollingCoordinationStrategy.stop(OutboxPollingCoordinationStrategy.java:197)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.push(AbstractCloser.java:53)\r\n        at org.hibernate.search.mapper.orm.mapping.impl.HibernateOrmMapping.doStop(HibernateOrmMapping.java:196)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.push(AbstractCloser.java:53)\r\n        at org.hibernate.search.util.common.impl.AbstractCloser.push(AbstractCloser.java:33)\r\n        at org.hibernate.search.mapper.pojo.mapping.spi.AbstractPojoMappingImplementor.stop(AbstractPojoMappingImplementor.java:68)\r\n        at org.hibernate.search.engine.common.impl.SearchIntegrationImpl.lambda$close$2(SearchIntegrationImpl.java:132)\r\n        at org.hibernate.search.engine.common.impl.SearchIntegrationImpl.stopAllSafely(SearchIntegrationImpl.java:178)\r\n        at org.hibernate.search.engine.common.impl.SearchIntegrationImpl.close(SearchIntegrationImpl.java:131)\r\n        at org.hibernate.search.mapper.orm.mapping.impl.HibernateSearchContextProviderService.close(HibernateSearchContextProviderService.java:36)\r\n        at org.hibernate.search.mapper.orm.bootstrap.impl.HibernateOrmIntegrationBooterImpl.lambda$orchestrateBootAndShutdown$5(HibernateOrmIntegrationBooterImpl.java:156)\r\n        at java.base/java.util.concurrent.CompletableFuture.biAccept(CompletableFuture.java:1386)\r\n        at java.base/java.util.concurrent.CompletableFuture$BiAccept.tryFire(CompletableFuture.java:1355)\r\n        at java.base/java.util.concurrent.CompletableFuture$CoCompletion.tryFire(CompletableFuture.java:1219)\r\n        at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n        at java.base/java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2147)\r\n        at org.hibernate.search.mapper.orm.bootstrap.impl.HibernateSearchSessionFactoryObserver.sessionFactoryClosing(HibernateSearchSessionFactoryObserver.java:50)\r\n        at org.hibernate.internal.SessionFactoryObserverChain.sessionFactoryClosing(SessionFactoryObserverChain.java:48)\r\n        at org.hibernate.internal.SessionFactoryImpl.close(SessionFactoryImpl.java:869)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig$LazyPersistenceUnit.close(JPAConfig.java:168)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig$Destroyer.destroy(JPAConfig.java:130)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig$Destroyer.destroy(JPAConfig.java:125)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig_b44400079827d7cae558c390d8d94cadbd711498_Synthetic_Bean.doDestroy(Unknown Source)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig_b44400079827d7cae558c390d8d94cadbd711498_Synthetic_Bean.destroy(Unknown Source)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig_b44400079827d7cae558c390d8d94cadbd711498_Synthetic_Bean.destroy(Unknown Source)\r\n        at io.quarkus.arc.impl.AbstractInstanceHandle.destroyInternal(AbstractInstanceHandle.java:82)\r\n        at io.quarkus.arc.impl.ContextInstanceHandleImpl.destroy(ContextInstanceHandleImpl.java:21)\r\n        at io.quarkus.arc.impl.AbstractSharedContext.destroy(AbstractSharedContext.java:96)\r\n        at io.quarkus.arc.impl.ArcContainerImpl.shutdown(ArcContainerImpl.java:468)\r\n        at io.quarkus.arc.Arc.shutdown(Arc.java:66)\r\n        at io.quarkus.arc.runtime.ArcRecorder$1.run(ArcRecorder.java:53)\r\n        at io.quarkus.runtime.StartupContext.runAllInReverseOrder(StartupContext.java:84)\r\n        at io.quarkus.runtime.StartupContext.close(StartupContext.java:73)\r\n        at io.quarkus.runner.ApplicationImpl.doStop(Unknown Source)\r\n        at io.quarkus.runtime.Application.stop(Application.java:208)\r\n        at io.quarkus.runtime.Application.stop(Application.java:155)\r\n        at io.quarkus.runtime.ApplicationLifecycleManager$ShutdownHookThread.run(ApplicationLifecycleManager.java:436)\r\nCaused by: java.sql.SQLException: This pool is closed and does not handle any more connections!\r\n        at io.agroal.pool.ConnectionPool.beforeAcquire(ConnectionPool.java:209)\r\n        at io.agroal.pool.ConnectionPool.getConnection(ConnectionPool.java:235)\r\n        at io.agroal.pool.DataSource.getConnection(DataSource.java:86)\r\n        at io.quarkus.hibernate.orm.runtime.customized.QuarkusConnectionProvider.getConnection(QuarkusConnectionProvider.java:23)\r\n        at org.hibernate.internal.NonContextualJdbcConnectionAccess.obtainConnection(NonContextualJdbcConnectionAccess.java:38)\r\n        at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.acquireConnectionIfNeeded(LogicalConnectionManagedImpl.java:113)\r\n        ... 92 more\r\n\r\n2023-07-05 13:57:12,581 ERROR [org.hib.sea.map.orm.boo.imp.HibernateOrmIntegrationBooterImpl] (Shutdown thread) HSEARCH800035: Unable to shut down Hibernate Search: %1$s [Error Occurred After Shutdown]: org.hibernate.search.util.common.SearchException: HSEARCH000520: Hibernate Search encountered failures during shutdown. Failures:\r\n\r\n    Hibernate ORM mapping: \r\n        failures: \r\n          - Unable to acquire JDBC Connection [This pool is closed and does not handle any more connections!] [n/a]\r\n        at org.hibernate.search.engine.reporting.spi.RootFailureCollector.checkNoFailure(RootFailureCollector.java:53)\r\n        at org.hibernate.search.engine.common.impl.SearchIntegrationImpl.close(SearchIntegrationImpl.java:168)\r\n        at org.hibernate.search.mapper.orm.mapping.impl.HibernateSearchContextProviderService.close(HibernateSearchContextProviderService.java:36)\r\n        at org.hibernate.search.mapper.orm.bootstrap.impl.HibernateOrmIntegrationBooterImpl.lambda$orchestrateBootAndShutdown$5(HibernateOrmIntegrationBooterImpl.java:156)\r\n        at java.base/java.util.concurrent.CompletableFuture.biAccept(CompletableFuture.java:1386)\r\n        at java.base/java.util.concurrent.CompletableFuture$BiAccept.tryFire(CompletableFuture.java:1355)\r\n        at java.base/java.util.concurrent.CompletableFuture$CoCompletion.tryFire(CompletableFuture.java:1219)\r\n        at java.base/java.util.concurrent.CompletableFuture.postComplete(CompletableFuture.java:510)\r\n        at java.base/java.util.concurrent.CompletableFuture.complete(CompletableFuture.java:2147)\r\n        at org.hibernate.search.mapper.orm.bootstrap.impl.HibernateSearchSessionFactoryObserver.sessionFactoryClosing(HibernateSearchSessionFactoryObserver.java:50)\r\n        at org.hibernate.internal.SessionFactoryObserverChain.sessionFactoryClosing(SessionFactoryObserverChain.java:48)\r\n        at org.hibernate.internal.SessionFactoryImpl.close(SessionFactoryImpl.java:869)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig$LazyPersistenceUnit.close(JPAConfig.java:168)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig$Destroyer.destroy(JPAConfig.java:130)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig$Destroyer.destroy(JPAConfig.java:125)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig_b44400079827d7cae558c390d8d94cadbd711498_Synthetic_Bean.doDestroy(Unknown Source)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig_b44400079827d7cae558c390d8d94cadbd711498_Synthetic_Bean.destroy(Unknown Source)\r\n        at io.quarkus.hibernate.orm.runtime.JPAConfig_b44400079827d7cae558c390d8d94cadbd711498_Synthetic_Bean.destroy(Unknown Source)\r\n        at io.quarkus.arc.impl.AbstractInstanceHandle.destroyInternal(AbstractInstanceHandle.java:82)\r\n        at io.quarkus.arc.impl.ContextInstanceHandleImpl.destroy(ContextInstanceHandleImpl.java:21)\r\n        at io.quarkus.arc.impl.AbstractSharedContext.destroy(AbstractSharedContext.java:96)\r\n        at io.quarkus.arc.impl.ArcContainerImpl.shutdown(ArcContainerImpl.java:468)\r\n        at io.quarkus.arc.Arc.shutdown(Arc.java:66)\r\n        at io.quarkus.arc.runtime.ArcRecorder$1.run(ArcRecorder.java:53)\r\n        at io.quarkus.runtime.StartupContext.runAllInReverseOrder(StartupContext.java:84)\r\n        at io.quarkus.runtime.StartupContext.close(StartupContext.java:73)\r\n        at io.quarkus.runner.ApplicationImpl.doStop(Unknown Source)\r\n        at io.quarkus.runtime.Application.stop(Application.java:208)\r\n        at io.quarkus.runtime.Application.stop(Application.java:155)\r\n```\n\n### How to Reproduce?\n\n_No response_\n\n### Output of `uname -a` or `ver`\n\n_No response_\n\n### Output of `java -version`\n\n_No response_\n\n### GraalVM version (if different from Java)\n\n_No response_\n\n### Quarkus version or git rev\n\n_No response_\n\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\n\n_No response_\n\n### Additional information\n\nWe should probably shut down Agroal *after* Hibernate ORM to avoid this exception.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/34547/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/34547/timeline",
  "performed_via_github_app": null,
  "state_reason": null
}
