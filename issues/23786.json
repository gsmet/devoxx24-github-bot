{
  "url": "https://api.github.com/repos/quarkusio/quarkus/issues/23786",
  "repository_url": "https://api.github.com/repos/quarkusio/quarkus",
  "labels_url": "https://api.github.com/repos/quarkusio/quarkus/issues/23786/labels{/name}",
  "comments_url": "https://api.github.com/repos/quarkusio/quarkus/issues/23786/comments",
  "events_url": "https://api.github.com/repos/quarkusio/quarkus/issues/23786/events",
  "html_url": "https://github.com/quarkusio/quarkus/issues/23786",
  "id": 1141212558,
  "node_id": "I_kwDOCFbutM5EBYWO",
  "number": 23786,
  "title": "Knative autoscaling properties create incorrect manifest files",
  "labels": [
    {
      "id": 985346620,
      "node_id": "MDU6TGFiZWw5ODUzNDY2MjA=",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/kind/bug",
      "name": "kind/bug",
      "color": "d73a4a",
      "default": false,
      "description": "Something isn't working"
    },
    {
      "id": 1654772125,
      "node_id": "MDU6TGFiZWwxNjU0NzcyMTI1",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/kubernetes",
      "name": "area/kubernetes",
      "color": "0366d6",
      "default": false,
      "description": ""
    },
    {
      "id": 1891982257,
      "node_id": "MDU6TGFiZWwxODkxOTgyMjU3",
      "url": "https://api.github.com/repos/quarkusio/quarkus/labels/area/container-image",
      "name": "area/container-image",
      "color": "0366d6",
      "default": false,
      "description": ""
    }
  ],
  "state": "closed",
  "locked": false,
  "milestone": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/milestones/176",
    "html_url": "https://github.com/quarkusio/quarkus/milestone/176",
    "labels_url": "https://api.github.com/repos/quarkusio/quarkus/milestones/176/labels",
    "id": 7721855,
    "node_id": "MI_kwDOCFbutM4AddN_",
    "number": 176,
    "title": "2.7.3.Final",
    "description": "",
    "creator": {
      "login": "gsmet",
      "id": 1279749,
      "node_id": "MDQ6VXNlcjEyNzk3NDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1279749?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gsmet",
      "html_url": "https://github.com/gsmet",
      "followers_url": "https://api.github.com/users/gsmet/followers",
      "following_url": "https://api.github.com/users/gsmet/following{/other_user}",
      "gists_url": "https://api.github.com/users/gsmet/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gsmet/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gsmet/subscriptions",
      "organizations_url": "https://api.github.com/users/gsmet/orgs",
      "repos_url": "https://api.github.com/users/gsmet/repos",
      "events_url": "https://api.github.com/users/gsmet/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gsmet/received_events",
      "type": "User",
      "site_admin": false
    },
    "open_issues": 0,
    "closed_issues": 65,
    "state": "closed",
    "created_at": "2022-02-28T18:06:00Z",
    "updated_at": "2022-03-02T13:50:20Z",
    "due_on": null,
    "closed_at": "2022-03-02T13:50:20Z"
  },
  "comments": 3,
  "created_at": "2022-02-17T11:24:38Z",
  "updated_at": "2022-03-01T20:03:36Z",
  "closed_at": "2022-03-01T07:09:47Z",
  "active_lock_reason": null,
  "body": "### Describe the bug\r\n\r\nAttempting to switch off Knative autoscaling via configuration properties does not work as expected.\r\n\r\nThis affects the following properties and values:\r\n1. `quarkus.knative.scale-to-zero-enabled = false`\r\n2. `quarkus.knative.min-scale = 1`\r\n\r\nDeploying a sample application to a local Kubernetes cluster produces the following behaviour:\r\n1. When `quarkus.knative.scale-to-zero-enabled` is set to false this property is ignored and the pod will still terminate after ~60-90s.\r\n2. When `quarkus.knative.min-scale` is set to 1 the maven build will fail when the fabric8 K8s client attempts a deployment with the following stack trace:\r\n```\r\n[ERROR] Failed to execute goal io.quarkus.platform:quarkus-maven-plugin:2.7.1.Final:build (default) on project knative-demo: Failed to build quarkus application: io.quarkus.builder.BuildException: Build failure: Build failed due to errors\r\n[ERROR]         [error]: Build step io.quarkus.kubernetes.deployment.KubernetesDeployer#deploy threw an exception: io.fabric8.kubernetes.client.KubernetesClientException: Failure executing: POST at: https://127.0.0.1:52678/apis/serving.knative.dev/v1/namespaces/default/services. Message: admission webhook \"validation.webhook.serving.knative.dev\" denied the request: validation failed: invalid key name \"autoscaling.knative.dev/minScale\": metadata.annotations\r\n[ERROR] autoscaling annotations must be put under \"spec.template.metadata.annotations\" to work. Received status: Status(apiVersion=v1, code=400, details=null, kind=Status, message=admission webhook \"validation.webhook.serving.knative.dev\" denied the request: validation failed: invalid key name \"autoscaling.knative.dev/minScale\": metadata.annotations\r\n[ERROR] autoscaling annotations must be put under \"spec.template.metadata.annotations\" to work, metadata=ListMeta(_continue=null, remainingItemCount=null, resourceVersion=null, selfLink=null, additionalProperties={}), reason=BadRequest, status=Failure, additionalProperties={}).\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.OperationSupport.requestFailure(OperationSupport.java:682)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.OperationSupport.requestFailure(OperationSupport.java:661)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.OperationSupport.assertResponseCode(OperationSupport.java:612)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.OperationSupport.handleResponse(OperationSupport.java:555)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.OperationSupport.handleResponse(OperationSupport.java:518)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.OperationSupport.handleCreate(OperationSupport.java:305)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.BaseOperation.handleCreate(BaseOperation.java:644)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.BaseOperation.handleCreate(BaseOperation.java:83)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.CreateOnlyResourceOperation.create(CreateOnlyResourceOperation.java:61)\r\n[ERROR]         at io.fabric8.kubernetes.client.utils.CreateOrReplaceHelper.createOrReplace(CreateOrReplaceHelper.java:48)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.BaseOperation.createOrReplace(BaseOperation.java:318)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.base.BaseOperation.createOrReplace(BaseOperation.java:83)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.internal.NamespaceVisitFromServerGetWatchDeleteRecreateWaitApplicableImpl.createOrReplace(NamespaceVisitFromServerGetWatchDeleteRecreateWaitApplicableImpl.java:105)\r\n[ERROR]         at io.fabric8.kubernetes.client.dsl.internal.NamespaceVisitFromServerGetWatchDeleteRecreateWaitApplicableImpl.createOrReplace(NamespaceVisitFromServerGetWatchDeleteRecreateWaitApplicableImpl.java:63)\r\n[ERROR]         at io.quarkus.kubernetes.deployment.KubernetesDeployer.lambda$deploy$4(KubernetesDeployer.java:224)\r\n[ERROR]         at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183)\r\n[ERROR]         at java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:177)\r\n[ERROR]         at java.base/java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1655)\r\n[ERROR]         at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484)\r\n[ERROR]         at java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474)\r\n[ERROR]         at java.base/java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150)\r\n[ERROR]         at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173)\r\n[ERROR]         at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\r\n[ERROR]         at java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497)\r\n[ERROR]         at io.quarkus.kubernetes.deployment.KubernetesDeployer.deploy(KubernetesDeployer.java:199)\r\n[ERROR]         at io.quarkus.kubernetes.deployment.KubernetesDeployer.deploy(KubernetesDeployer.java:110)\r\n[ERROR]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n[ERROR]         at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n[ERROR]         at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n[ERROR]         at java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n[ERROR]         at io.quarkus.deployment.ExtensionLoader$2.execute(ExtensionLoader.java:882)\r\n[ERROR]         at io.quarkus.builder.BuildContext.run(BuildContext.java:277)\r\n[ERROR]         at org.jboss.threads.ContextHandler$1.runWith(ContextHandler.java:18)\r\n[ERROR]         at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2449)\r\n[ERROR]         at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1478)\r\n[ERROR]         at java.base/java.lang.Thread.run(Thread.java:829)\r\n[ERROR]         at org.jboss.threads.JBossThread.run(JBossThread.java:501)\r\n```\r\n\r\nThe use case is having at least one pod instance running for local development in order to retain application logs (scale to zero removes the pod after a period of no activity and therefore also the logs).\r\n\r\n### Expected behavior\r\n\r\nThe Kubernetes pod running the application code should not terminate and a single instance should be kept alive.\r\n\r\nWhen `quarkus.knative.scale-to-zero-enabled` is set to false the `knative.yml` manifest should include the missing namespace as per the [Knative docs](https://knative.dev/docs/serving/autoscaling/scale-to-zero/#enable-scale-to-zero):\r\n```diff\r\napiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n name: config-autoscaler\r\n+ namespace: knative-serving\r\ndata:\r\n enable-scale-to-zero: \"false\"\r\n```\r\n\r\nWhen `quarkus.knative.min-scale` is set to 1, the relevant Knative annotation should be present in the correct location in the `knative.yml` manifest as per the [Knative docs](https://knative.dev/docs/serving/autoscaling/scale-bounds/#lower-bound):\r\n```diff\r\napiVersion: serving.knative.dev/v1\r\nkind: Service\r\nmetadata:\r\n  name: knative-demo\r\n  namespace: default\r\n-  annotations:\r\n-        autoscaling.knative.dev/minScale: \"1\"\r\n+spec:\r\n+  template:\r\n+    metadata:\r\n+      annotations:\r\n+        autoscaling.knative.dev/min-scale: \"1\"\r\n```\r\n\r\n### Actual behavior\r\n\r\nWhen `quarkus.knative.scale-to-zero-enabled` is set to false the pod running the application will terminate ~60-90s.\r\nThe `knative.yml` file will include a ConfigMap for autoscaling, however the required namespace `knative-serving` will be missing.\r\n\r\nWhen `quarkus.knative.min-scale` is set to 1, the maven build will fail with a deployment error.\r\n\r\n### How to Reproduce?\r\n\r\nPrerequisites:\r\n- [docker](https://www.docker.com/products/docker-desktop) installed and running\r\n- [kind](https://kind.sigs.k8s.io/) installed\r\n- [ctlptl](https://github.com/tilt-dev/ctlptl) installed\r\n- [kubectl](https://kubernetes.io/docs/reference/kubectl/kubectl/) installed\r\n\r\n```shell\r\n# Bootstrap Quarkus K8s project\r\nmvn io.quarkus.platform:quarkus-maven-plugin:2.7.1.Final:create \\\r\n    -DprojectGroupId=org.acme \\\r\n    -DprojectArtifactId=knative-demo \\\r\n    -Dextensions=\"resteasy,kubernetes,jib\"\r\n\r\ncd knative-demo\r\n\r\n# Create local KinD K8s cluster with image registry\r\nctlptl create registry ctlptl-registry --port=5005\r\nctlptl create cluster kind --registry=ctlptl-registry\r\n\r\n# Install Knative on cluster\r\nkubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.2.0/serving-crds.yaml\r\nkubectl wait --for=condition=Established --all crd\r\nkubectl apply -f https://github.com/knative/serving/releases/download/knative-v1.2.0/serving-core.yaml\r\nkubectl wait pod --timeout=-1s --for=condition=Ready -l '!job-name' -n knative-serving\r\n\r\nkubectl patch configmap/config-deployment \\\r\n  --namespace knative-serving \\\r\n  --type merge \\\r\n  --patch '{\"data\":{\"registriesSkippingTagResolving\":\"localhost:5005\"}}'\r\n\r\n# Issue 1 - Disable scale to zero\r\nmvn clean package \\\r\n  -Dquarkus.container-image.registry=localhost:5005 \\\r\n  -Dquarkus.container-image.insecure=true \\\r\n  -Dquarkus.kubernetes.deployment-target=knative \\\r\n  -Dquarkus.kubernetes.deploy=true \\\r\n  -Dquarkus.kubernetes-client.namespace=default \\\r\n  -Dquarkus.knative.scale-to-zero-enabled=false\r\n\r\n# Check pod autoscaling\r\nkubectl get pod --watch\r\n\r\n# Issue 2 - Set min scale for autoscaling\r\nmvn clean package \\\r\n  -Dquarkus.container-image.registry=localhost:5005 \\\r\n  -Dquarkus.container-image.insecure=true \\\r\n  -Dquarkus.kubernetes.deployment-target=knative \\\r\n  -Dquarkus.kubernetes.deploy=true \\\r\n  -Dquarkus.kubernetes-client.namespace=default \\\r\n  -Dquarkus.knative.min-scale=1\r\n\r\n# Cleanup\r\nctlptl delete cluster kind-kind\r\nctlptl delete registry ctlptl-registry\r\n\r\n```\r\n\r\n### Output of `uname -a` or `ver`\r\n\r\n```\r\nDarwin Thomass-MacBook-Pro.local 19.6.0 Darwin Kernel Version 19.6.0: Thu Oct 29 22:56:45 PDT 2020; root:xnu-6153.141.2.2~1/RELEASE_X86_64 x86_64\r\n```\r\n\r\n### Output of `java -version`\r\n\r\n```\r\nopenjdk version \"11.0.10\" 2021-01-19 LTS\r\nOpenJDK Runtime Environment Corretto-11.0.10.9.1 (build 11.0.10+9-LTS)\r\nOpenJDK 64-Bit Server VM Corretto-11.0.10.9.1 (build 11.0.10+9-LTS, mixed mode)\r\n```\r\n\r\n### GraalVM version (if different from Java)\r\n\r\nN/A\r\n\r\n### Quarkus version or git rev\r\n\r\n2.7.1.Final\r\n\r\n### Build tool (ie. output of `mvnw --version` or `gradlew --version`)\r\n\r\n```\r\nApache Maven 3.8.3 (ff8e977a158738155dc465c6a97ffaf31982d739)\r\nMaven home: /Users/t.lloyd/.asdf/installs/maven/3.8.3\r\nJava version: 11.0.10, vendor: Amazon.com Inc., runtime: /Users/t.lloyd/.asdf/installs/java/corretto-11.0.10.9.1\r\nDefault locale: en_GB, platform encoding: UTF-8\r\nOS name: \"mac os x\", version: \"10.15.7\", arch: \"x86_64\", family: \"mac\"\r\n```\r\n\r\n### Additional information\r\n\r\nIt would be useful if the [Kubernetes documentation](https://quarkus.io/guides/deploying-to-kubernetes) could be updated to include more information on Knative autoscaling. I only discovered these properties by consulting the [configuration properties reference](https://quarkus.io/guides/all-config).\r\n\r\nIt would also be worth explaining the difference between the 2 properties listed i.e. `quarkus.knative.scale-to-zero-enabled` will create a ConfigMap affecting autoscaling for **all** Knative functions in the cluster whereas `quarkus.knative.min-scale` will affect the target function revision only.",
  "reactions": {
    "url": "https://api.github.com/repos/quarkusio/quarkus/issues/23786/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/quarkusio/quarkus/issues/23786/timeline",
  "performed_via_github_app": null,
  "state_reason": "completed"
}
